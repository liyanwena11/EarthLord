# é—®é¢˜è¯Šæ–­æŠ¥å‘Š - 2026-02-21

## ğŸ“‹ é—®é¢˜æ±‡æ€»

æ ¹æ®ç”¨æˆ·åé¦ˆï¿½ï¿½ä¸‰ä¸ªæˆªå›¾ï¼Œå‘ç°ä»¥ä¸‹é—®é¢˜ï¼š

### 1. âš ï¸ Googleè´¦å·æ— æ³•ç™»å½•
### 2. âš ï¸ åœˆåœ°åæ²¡æœ‰å®æ—¶æ˜¾ç¤ºæ–°çš„é¢†åœ°
### 3. âš ï¸ ç‰©èµ„å•†åŸä¸æ˜¾ç¤ºå…·ä½“å†…å®¹

---

## ğŸ” é—®é¢˜1: Googleè´¦å·æ— æ³•ç™»å½•

### å¯èƒ½åŸå› ï¼š

1. **Google Sign-In é…ç½®é—®é¢˜**
   - `Info.plist` ä¸­çš„ `CFBundleURLSchemes` å¯èƒ½æ²¡æœ‰æ­£ç¡®é…ç½®
   - Google Client ID å¯èƒ½é…ç½®é”™è¯¯
   - URL Scheme æ ¼å¼ä¸æ­£ç¡®

2. **Supabase Auth é…ç½®é—®é¢˜**
   - Supabase é¡¹ç›®ä¸­æ²¡æœ‰å¯ç”¨ Google Provider
   - Google OAuth å›è°ƒ URL é…ç½®é”™è¯¯

### è¯Šæ–­æ­¥éª¤ï¼š

#### æ£€æŸ¥1: Info.plist é…ç½®
æŸ¥çœ‹ `EarthLord/info.plist` æ–‡ä»¶ï¼Œç¡®ä¿æœ‰ä»¥ä¸‹é…ç½®ï¼š

```xml
<key>CFBundleURLTypes</key>
<array>
    <dict>
        <key>CFBundleURLSchemes</key>
        <array>
            <string>com.googleusercontent.apps.YOUR_REVERSED_CLIENT_ID</string>
        </array>
    </dict>
</array>
```

#### æ£€æŸ¥2: Supabase é¡¹ç›®è®¾ç½®
1. ç™»å½• Supabase æ§åˆ¶å°
2. è¿›å…¥ Authentication â†’ Providers
3. ç¡®ä¿ Google Provider å·²å¯ç”¨
4. æ£€æŸ¥ Callback URL: `https://lkekxzssfrspkyxtqysx.supabase.co/auth/v1/callback`

#### æ£€æŸ¥3: æ§åˆ¶å°æ—¥å¿—
æŸ¥çœ‹ Xcode æ§åˆ¶å°æ˜¯å¦æœ‰ä»¥ä¸‹æ—¥å¿—ï¼š
- `ğŸ”µ [AuthManager] å¼€å§‹ Google ç™»å½•æµç¨‹...`
- `âŒ [AuthManager] æ— æ³•è·å– RootViewController`
- `âŒ [AuthManager] æ— æ³•è·å– Google ID Token`

### ä¿®å¤æ–¹æ¡ˆï¼š

å¦‚æœé…ç½®æ­£ç¡®ä½†ä»ç„¶æ— æ³•ç™»å½•ï¼Œå¯èƒ½éœ€è¦ï¼š
1. åœ¨ Firebase æ§åˆ¶å°é‡æ–°ç”Ÿæˆ iOS Client ID
2. ç¡®ä¿ Google Sign-In SDK ç‰ˆæœ¬å…¼å®¹
3. æ£€æŸ¥ iPhone çš„ç³»ç»Ÿè®¾ç½®ä¸­æ˜¯å¦å…è®¸ Google ç™»å½•

---

## ğŸ” é—®é¢˜2: åœˆåœ°åæ²¡æœ‰å®æ—¶æ˜¾ç¤ºæ–°çš„é¢†åœ°

### å¯èƒ½åŸå› ï¼š

1. **é€šçŸ¥æœºåˆ¶é—®é¢˜**
   - `territoryAdded` é€šçŸ¥æ²¡æœ‰æ­£ç¡®å‘é€
   - `MainMapView` æ²¡æœ‰æ­£ç¡®æ¥æ”¶é€šçŸ¥

2. **é¢†åœ°æ•°æ®åŠ è½½é—®é¢˜**
   - `loadTerritories()` æ–¹æ³•æ²¡æœ‰æ­£ç¡®åˆ·æ–°
   - Supabase æŸ¥è¯¢æ¡ä»¶ä¸æ­£ç¡®

3. **ç”¨æˆ·è®¤è¯é—®é¢˜**
   - ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•æŸ¥è¯¢é¢†åœ°æ•°æ®
   - `user_id` ä¸åŒ¹é…

### è¯Šæ–­æ­¥éª¤ï¼š

#### æ£€æŸ¥1: æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—
åœˆåœ°å®Œæˆååº”è¯¥çœ‹åˆ°ï¼š
```
ğŸš© [åœˆåœ°] âœ… é¢†åœ°ç¡®è®¤ï¼é¢ç§¯: XXã¡ï¼Œé‡‡æ ·ç‚¹: X
ğŸ·ï¸ [åœˆåœ°] é¢†åœ°å‘½åä¸º: XXX
ğŸš© [åœˆåœ°] é¢†åœ°ä¸Šä¼ æˆåŠŸï¼
```

#### æ£€æŸ¥2: éªŒè¯é€šçŸ¥æ˜¯å¦å‘é€
åœ¨ `EarthLordEngine.swift:253` ç¡®ä¿å‘é€äº† `territoryAdded` é€šçŸ¥ï¼š
```swift
NotificationCenter.default.post(name: .territoryAdded, object: territoryToAdd)
```

#### æ£€æŸ¥3: éªŒè¯é€šçŸ¥æ˜¯å¦è¢«æ¥æ”¶
åœ¨ `MainMapView.swift:113-122` ç¡®ä¿ç›‘å¬äº†é€šçŸ¥ï¼š
```swift
.onReceive(NotificationCenter.default.publisher(for: .territoryAdded)) { notification in
    if let newTerritory = notification.object as? Territory {
        withAnimation {
            if !supabaseTerritories.contains(where: { $0.id == newTerritory.id }) {
                supabaseTerritories.append(newTerritory)
            }
        }
    }
}
```

### ä¿®å¤æ–¹æ¡ˆï¼š

å¦‚æœé€šçŸ¥æœºåˆ¶æ­£å¸¸ï¼Œä½†é¢†åœ°ä»ç„¶ä¸æ˜¾ç¤ºï¼Œæ£€æŸ¥ï¼š
1. `Territory.toCoordinates()` æ–¹æ³•æ˜¯å¦æ­£ç¡®è¿”å›åæ ‡
2. `MapPolygon` æ˜¯å¦æ­£ç¡®æ¸²æŸ“å¤šè¾¹å½¢
3. Supabase æ•°æ®åº“ä¸­ `territories` è¡¨æ˜¯å¦æœ‰æ•°æ®

---

## ğŸ” é—®é¢˜3: ç‰©èµ„å•†åŸä¸æ˜¾ç¤ºå…·ä½“å†…å®¹

### å¯èƒ½åŸå› ï¼š

1. **StoreKit äº§å“æœªåŠ è½½**
   - App Store Connect ä¸­æ²¡æœ‰é…ç½®äº§å“
   - Product ID ä¸åŒ¹é…
   - æ²™ç›’è´¦å·æœªç™»å½•

2. **IAPManager åˆå§‹åŒ–å¤±è´¥**
   - `StoreKit` æ¡†æ¶åˆå§‹åŒ–å¤±è´¥
   - äº§å“åˆ—è¡¨ä¸ºç©º

3. **UI æ¸²æŸ“é—®é¢˜**
   - `loadingOrEmpty` è§†å›¾ä¸€ç›´æ˜¾ç¤º
   - `ProductCard` æ²¡æœ‰æ­£ç¡®æ¸²æŸ“

### è¯Šæ–­æ­¥éª¤ï¼š

#### æ£€æŸ¥1: æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—
è¿›å…¥å•†åŸåº”è¯¥çœ‹åˆ°ï¼š
```
âœ… [å•†åŸ] äº§å“åŠ è½½æˆåŠŸï¼Œå…± X ä¸ª
```

å¦‚æœæ²¡æœ‰çœ‹åˆ°æ­¤æ—¥å¿—ï¼Œè¯´æ˜äº§å“åŠ è½½å¤±è´¥ã€‚

#### æ£€æŸ¥2: StoreManager äº§å“åˆ—è¡¨
æ£€æŸ¥ `store.products` æ˜¯å¦ä¸ºç©ºï¼š
```swift
if store.products.isEmpty {
    loadingOrEmpty  // æ˜¾ç¤ºåŠ è½½ä¸­è§†å›¾
} else {
    // æ˜¾ç¤ºäº§å“åˆ—è¡¨
}
```

#### æ£€æŸ¥3: IAPManager åŠ è½½çŠ¶æ€
æŸ¥çœ‹ `IAPManager.swift` ä¸­çš„ `loadProducts()` æ–¹æ³•ï¼š
- æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯æ—¥å¿—
- ç¡®è®¤ Product IDs æ˜¯å¦æ­£ç¡®ï¼š
  - `com.earthlord.supply.survivor`
  - `com.earthlord.supply.explorer`
  - `com.earthlord.supply.lord`
  - `com.earthlord.supply.overlord`

### ä¿®å¤æ–¹æ¡ˆï¼š

#### ä¸´æ—¶æµ‹è¯•æ¨¡å¼ï¼š
å¦‚æœ App Store Connect äº§å“æœªé…ç½®ï¼Œå¯ä»¥æ·»åŠ æµ‹è¯•æ•°æ®ï¼š

åœ¨ `StoreManager.swift` ä¸­ä¿®æ”¹ï¼š
```swift
func loadProducts() async {
    await iapManager.loadProducts()

    // ğŸ”§ æµ‹è¯•æ¨¡å¼ï¼šå¦‚æœæ²¡æœ‰äº§å“ï¼Œåˆ›å»ºå‡äº§å“
    if iapManager.products.isEmpty {
        print("âš ï¸ [å•†åŸ] æœªåŠ è½½åˆ°äº§å“ï¼Œä½¿ç”¨æµ‹è¯•æ•°æ®")
        products = createTestProducts()
    } else {
        products = iapManager.products.map { $0.product }
    }

    print("âœ… [å•†åŸ] äº§å“åŠ è½½æˆåŠŸï¼Œå…± \(products.count) ä¸ª")
}

private func createTestProducts() -> [Product] {
    // åˆ›å»ºæµ‹è¯•ç”¨çš„ Product å¯¹è±¡
    // è¿™éœ€è¦æ ¹æ®å®é™…çš„ StoreKit.Product ç»“æ„æ¥å®ç°
}
```

#### App Store Connect é…ç½®ï¼š
1. ç™»å½• App Store Connect
2. è¿›å…¥ App â†’ In-App Purchases
3. åˆ›å»ºä»¥ä¸‹æ¶ˆè€—å‹é¡¹ç›®ï¼š
   - `com.earthlord.supply.survivor` - Â¥6
   - `com.earthlord.supply.explorer` - Â¥18
   - `com.earthlord.supply.lord` - Â¥30
   - `com.earthlord.supply.overlord` - Â¥68
4. æäº¤å¹¶ç­‰å¾…å¤„ç†ï¼ˆé€šå¸¸éœ€è¦å‡ åˆ†é’Ÿåˆ°å‡ å°æ—¶ï¼‰

---

## ğŸ› ï¸ é€šç”¨è°ƒè¯•å»ºè®®

### 1. æ£€æŸ¥ Supabase è¿æ¥

åœ¨ `SupabaseTestView.swift` ä¸­æ·»åŠ æµ‹è¯•ä»£ç ï¼š

```swift
Button("æµ‹è¯•æ•°æ®åº“è¿æ¥") {
    Task {
        do {
            let response: [Territory] = try await supabaseClient
                .from("territories")
                .select()
                .limit(1)
                .execute()
                .value
            print("âœ… [æµ‹è¯•] æ•°æ®åº“è¿æ¥æ­£å¸¸ï¼Œé¢†åœ°æ•°: \(response.count)")
        } catch {
            print("âŒ [æµ‹è¯•] æ•°æ®åº“è¿æ¥å¤±è´¥: \(error)")
        }
    }
}
```

### 2. æ£€æŸ¥ç”¨æˆ·è®¤è¯çŠ¶æ€

åœ¨æ§åˆ¶å°æ£€æŸ¥ï¼š
```
âœ… [AuthManager] Session æ£€æŸ¥å®Œæˆï¼Œå·²ç™»å½•
```

æˆ–è€…ï¼š
```
âš ï¸ [AuthManager] Session æ£€æŸ¥å®Œæˆï¼Œæœªç™»å½•
```

### 3. æ£€æŸ¥ç½‘ç»œæƒé™

ç¡®ä¿ `EarthLord.entitlements` æˆ– `Info.plist` ä¸­æœ‰ç½‘ç»œæƒé™ï¼š
```xml
<key>NSAppTransportSecurity</key>
<dict>
    <key>NSAllowsArbitraryLoads</key>
    <true/>
</dict>
```

---

## ğŸ“± çœŸæœºæµ‹è¯•æ£€æŸ¥æ¸…å•

åœ¨çœŸæœºä¸Šæµ‹è¯•å‰ï¼Œç¡®ä¿ï¼š

### Google ç™»å½•ï¼š
- [ ] å·²é…ç½® `CFBundleURLSchemes`
- [ ] å·²åœ¨ Supabase å¯ç”¨ Google Provider
- [ ] å·²åœ¨ Firebase é…ç½® OAuth å®¢æˆ·ç«¯
- [ ] çœŸæœºå·²å®‰è£… Google appï¼ˆå¯é€‰ä½†æ¨èï¼‰

### åœˆåœ°åŠŸèƒ½ï¼š
- [ ] å·²æˆæƒä½ç½®æƒé™
- [ ] GPS ç²¾åº¦è¶³å¤Ÿï¼ˆ< 100mï¼‰
- [ ] ç”¨æˆ·å·²ç™»å½•ï¼ˆSupabase Authï¼‰
- [ ] æ•°æ®åº“ä¸­ `territories` è¡¨å­˜åœ¨ä¸”æœ‰æƒé™

### ç‰©èµ„å•†åŸï¼š
- [ ] App Store Connect å·²é…ç½®äº§å“
- [ ] æ²™ç›’è´¦å·å·²ç™»å½•
- [ ] çœŸæœºè¿æ¥åˆ°ç½‘ç»œ
- [ ] StoreKit é…ç½®æ­£ç¡®

---

## ğŸš¨ ç´§æ€¥ä¿®å¤æ–¹æ¡ˆ

### å¦‚æœå•†åŸä»ç„¶ä¸æ˜¾ç¤ºå†…å®¹ï¼š

åœ¨ `ShopView.swift` ä¸­æ·»åŠ è°ƒè¯•ä¿¡æ¯ï¼š

```swift
.task {
    await mailbox.loadPendingItems()
    await store.loadProducts()

    // ğŸ”§ è°ƒè¯•ä¿¡æ¯
    print("ğŸ” [ShopView] äº§å“æ•°é‡: \(store.products.count)")
    for product in store.products {
        print("  - \(product.id): \(product.displayName)")
    }
}
```

### å¦‚æœåœˆåœ°ä¸æ˜¾ç¤ºï¼š

åœ¨ `MainMapView.swift` ä¸­æ·»åŠ è°ƒè¯•ä¿¡æ¯ï¼š

```swift
.onReceive(NotificationCenter.default.publisher(for: .territoryAdded)) { notification in
    print("ğŸ” [MainMapView] æ”¶åˆ° territoryAdded é€šçŸ¥")
    if let newTerritory = notification.object as? Territory {
        print("ğŸ” [MainMapView] æ–°é¢†åœ°: \(newTerritory.displayName), åæ ‡æ•°: \(newTerritory.path.count)")
        withAnimation {
            if !supabaseTerritories.contains(where: { $0.id == newTerritory.id }) {
                supabaseTerritories.append(newTerritory)
                print("âœ… [MainMapView] é¢†åœ°å·²æ·»åŠ åˆ°åœ°å›¾")
            }
        }
    }
}
```

---

## ğŸ“ éœ€è¦çš„ä¿¡æ¯

ä¸ºäº†è¿›ä¸€æ­¥è¯Šæ–­ï¼Œè¯·æä¾›ï¼š

1. **Google ç™»å½•é—®é¢˜**ï¼š
   - Xcode æ§åˆ¶å°çš„å®Œæ•´æ—¥å¿—
   - æ˜¯å¦æœ‰å¼¹çª—å‡ºç°
   - Info.plist ä¸­çš„ URL Scheme é…ç½®

2. **åœˆåœ°æ˜¾ç¤ºé—®é¢˜**ï¼š
   - åœˆåœ°å®Œæˆåçš„æ§åˆ¶å°æ—¥å¿—
   - æ•°æ®åº“ä¸­ territories è¡¨çš„æ•°æ®
   - ç”¨æˆ·æ˜¯å¦å·²ç™»å½•

3. **å•†åŸæ˜¾ç¤ºé—®é¢˜**ï¼š
   - è¿›å…¥å•†åŸåçš„æ§åˆ¶å°æ—¥å¿—
   - App Store Connect äº§å“é…ç½®æˆªå›¾
   - æ˜¯å¦æœ‰é”™è¯¯æç¤º

---

**æ›´æ–°æ—¶é—´**: 2026-02-21
**ç›¸å…³æ–‡ä»¶**:
- `AuthManager.swift`
- `EarthLordEngine.swift`
- `StoreManager.swift`
- `MainMapView.swift`
- `ShopView.swift`
