# 删除账户功能使用指南

## ✅ 已实现的功能

### 1️⃣ UI 界面

#### **个人中心页面**
- ✅ 底部显示红色"删除账户"按钮
- ✅ 点击按钮弹出确认对话框
- ✅ 加载状态显示（转圈动画）

#### **删除确认弹窗**
- ✅ 警告图标（红色三角感叹号）
- ✅ 删除警告标题
- ✅ 详细的数据删除说明
- ✅ 手动输入确认文字（必须输入"删除"）
- ✅ 确认删除按钮（只有输入正确才能点击）
- ✅ 取消按钮
- ✅ 关闭按钮（右上角）
- ✅ 错误提示区域

### 2️⃣ 安全机制

#### **二次确认**
- ✅ 必须手动输入"删除"文字才能确认
- ✅ 输入错误时确认按钮为灰色且禁用
- ✅ 输入正确时确认按钮变为红色

#### **操作提示**
- ✅ 明确告知操作不可撤销
- ✅ 列出将被删除的数据类型
- ✅ 错误信息实时显示

### 3️⃣ 日志系统

#### **UI 操作日志**
```
🔵 [UI] 用户点击删除账户按钮
🔵 [UI] 用户确认删除账户
🔵 [UI] 用户取消删除账户
🔵 [UI] 用户关闭删除账户弹窗
```

#### **删除流程日志**
```
🔵 [删除流程] 开始执行删除账户操作
🔵 [删除流程] 确认文字: 删除
🔵 [删除流程] 调用 AccountService.deleteAccount()
✅ [删除流程] 账户删除成功
🔵 [删除流程] 关闭删除确认弹窗
🔵 [删除流程] 执行退出登录
✅ [删除流程] 删除账户流程完成
```

#### **错误日志**
```
❌ [删除流程] 确认文字不正确
❌ [删除流程] 删除账户失败
❌ [删除流程] 错误: xxx
```

## 📱 使用流程

### 完整操作流程

```
1. 登录账户
   ↓
2. 进入个人中心（点击底部"个人"Tab）
   ↓
3. 滚动到页面底部
   ↓
4. 点击红色"删除账户"按钮
   ↓
   🔵 [UI] 用户点击删除账户按钮
   ↓
5. 弹出删除确认对话框
   ├─ 警告图标
   ├─ 警告内容
   ├─ 输入框
   └─ 按钮
   ↓
6. 阅读警告信息
   ⚠️ 此操作无法撤销！
   删除数据：个人资料、领地信息、兴趣点
   ↓
7. 在输入框中输入"删除"
   ↓
8. 确认按钮从灰色变为红色
   ↓
9. 点击"确认删除"按钮
   ↓
   🔵 [UI] 用户确认删除账户
   🔵 [删除流程] 开始执行删除账户操作
   ↓
10. 显示加载动画（转圈）
   ↓
   🔵 [删除流程] 调用 AccountService.deleteAccount()
   🔵 [删除账户] 开始删除账户流程
   ↓
11. 边缘函数执行删除
   ├─ 验证用户身份
   ├─ 删除 profiles 数据
   ├─ 删除 territories（级联）
   ├─ 删除 pois 引用
   └─ 删除 auth.users 账户
   ↓
   ✅ [删除账户] 账户删除成功
   ✅ [删除流程] 账户删除成功
   ↓
12. 关闭确认弹窗
   ↓
   🔵 [删除流程] 关闭删除确认弹窗
   ↓
13. 自动退出登录
   ↓
   🔵 [删除流程] 执行退出登录
   ↓
14. 跳转到登录页面
   ↓
   ✅ [删除流程] 删除账户流程完成
```

### 取消操作流程

```
1. 点击"删除账户"按钮
   ↓
2. 弹出确认对话框
   ↓
3. 点击"取消"按钮 或 点击"关闭"按钮
   ↓
   🔵 [UI] 用户取消删除账户
   或
   🔵 [UI] 用户关闭删除账户弹窗
   ↓
4. 关闭对话框
   ↓
5. 清空输入框
   ↓
6. 留在个人中心页面
```

## 🎨 UI 展示

### 个人中心页面

```
┌─────────────────────────────┐
│     [用户头像和信息]          │
└─────────────────────────────┘

┌─────────────────────────────┐
│ 设置选项...                  │
└─────────────────────────────┘

┌─────────────────────────────┐
│  🚪  退出登录（红色边框）     │
└─────────────────────────────┘

┌─────────────────────────────┐
│  🗑️  删除账户（红色背景）     │  ← 点击这里
└─────────────────────────────┘
```

### 删除确认弹窗

```
┌─────────────────────────────┐
│              X 关闭           │
├─────────────────────────────┤
│                             │
│    ⚠️ （红色三角感叹号）      │
│                             │
│        删除账户              │
│                             │
├─────────────────────────────┤
│ ⚠️ 此操作无法撤销！          │
│                             │
│ 删除账户将永久删除您的        │
│ 所有数据，包括：              │
│                             │
│   👤 个人资料                │
│   🗺️  领地信息                │
│   📍 发现的兴趣点             │
├─────────────────────────────┤
│                             │
│ 请输入「删除」以确认          │
│                             │
│ ┌─────────────────────────┐ │
│ │ 输入「删除」             │ │  ← 在这里输入
│ └─────────────────────────┘ │
│                             │
├─────────────────────────────┤
│                             │
│ ┌─────────────────────────┐ │
│ │   确认删除（红色/灰色）  │ │  ← 输入正确后变红色
│ └─────────────────────────┘ │
│                             │
│ ┌─────────────────────────┐ │
│ │      取消                │ │
│ └─────────────────────────┘ │
│                             │
└─────────────────────────────┘
```

### 加载状态

```
┌─────────────────────────────┐
│ ┌─────────────────────────┐ │
│ │  ⏳ 确认删除             │ │  ← 转圈动画
│ └─────────────────────────┘ │
│                             │
│ ┌─────────────────────────┐ │
│ │      取消（禁用）         │ │
│ └─────────────────────────┘ │
└─────────────────────────────┘
```

## 🔍 日志输出详解

### 成功删除完整日志

```
🔵 [UI] 用户点击删除账户按钮
🔵 [UI] 用户确认删除账户
🔵 [删除流程] 开始执行删除账户操作
🔵 [删除流程] 确认文字: 删除
🔵 [删除流程] 调用 AccountService.deleteAccount()
🔵 [删除账户] 开始删除账户流程
🔵 [删除账户] 成功获取 JWT token
🔵 [删除账户] 当前用户 ID: 12345678-1234-1234-1234-123456789012
🔵 [删除账户] 当前用户邮箱: user@example.com
🔵 [删除账户] 发送请求到边缘函数
🔵 [删除账户] URL: https://lkekxzssfrspkyxtqysx.supabase.co/functions/v1/delete-account
🔵 [删除账户] 收到响应
🔵 [删除账户] 状态码: 200
✅ [删除账户] 账户删除成功
🔵 [删除账户] 已删除用户 ID: 12345678-1234-1234-1234-123456789012
🔵 [删除账户] 已删除用户邮箱: user@example.com
✅ [删除流程] 账户删除成功
✅ [删除流程] 删除消息: 账户已成功删除
✅ [删除流程] 删除用户 ID: 12345678-1234-1234-1234-123456789012
🔵 [删除流程] 关闭删除确认弹窗
🔵 [删除流程] 执行退出登录
✅ [删除流程] 删除账户流程完成
```

### 边缘函数日志

```
🔵 [删除账户] 开始处理删除账户请求
🔵 [删除账户] 成功获取 JWT token
🔵 [删除账户] 验证用户身份...
✅ [删除账户] 用户验证成功
🔵 [删除账户] 用户 ID: 12345678-1234-1234-1234-123456789012
🔵 [删除账户] 用户邮箱: user@example.com
🔵 [删除账户] 开始删除用户数据...
🔵 [删除账户] 删除用户资料数据...
✅ [删除账户] 成功删除用户资料数据
🔵 [删除账户] 删除用户账户...
✅ [删除账户] 成功删除用户账户
✅ [删除账户] 账户删除完成
```

### 错误场景日志

#### 确认文字错误

```
🔵 [UI] 用户点击删除账户按钮
🔵 [UI] 用户确认删除账户
🔵 [删除流程] 开始执行删除账户操作
🔵 [删除流程] 确认文字: 删
❌ [删除流程] 确认文字不正确
```

显示错误提示："请输入「删除」以确认"

#### 网络错误

```
🔵 [删除流程] 调用 AccountService.deleteAccount()
🔵 [删除账户] 开始删除账户流程
🔵 [删除账户] 成功获取 JWT token
🔵 [删除账户] 发送请求到边缘函数
❌ [删除账户] 无效的响应
❌ [删除流程] 删除账户失败
❌ [删除流程] 错误: 无效的服务器响应
```

显示错误提示："删除账户失败：无效的服务器响应"

## 🧪 测试步骤

### 1. 正常删除流程测试

```bash
# 步骤 1：登录账户
- 打开 App
- 使用测试账户登录

# 步骤 2：进入个人中心
- 点击底部"个人"Tab
- 查看个人信息

# 步骤 3：打开删除确认
- 滚动到底部
- 点击"删除账户"按钮
- 验证弹窗显示正确

# 步骤 4：输入确认文字
- 点击输入框
- 输入"删除"
- 验证确认按钮变为红色

# 步骤 5：确认删除
- 点击"确认删除"
- 查看 Xcode 控制台日志
- 验证显示加载动画

# 步骤 6：验证删除成功
- 等待自动跳转到登录页
- 尝试使用原账户登录
- 应该提示用户不存在

# 预期日志：
✅ [删除账户] 账户删除成功
✅ [删除流程] 删除账户流程完成
```

### 2. 取消删除测试

```bash
# 步骤 1：打开删除确认
- 点击"删除账户"按钮

# 步骤 2：取消操作
- 点击"取消"按钮

# 步骤 3：验证
- 弹窗关闭
- 留在个人中心页面
- 账户未被删除

# 预期日志：
🔵 [UI] 用户取消删除账户
```

### 3. 确认文字错误测试

```bash
# 步骤 1：打开删除确认
- 点击"删除账户"按钮

# 步骤 2：输入错误文字
- 输入"delete"（英文）
- 或输入"删"（不完整）

# 步骤 3：验证
- 确认按钮保持灰色
- 无法点击

# 步骤 4：尝试确认
- 如果通过代码强制调用
- 应该显示错误提示

# 预期日志：
❌ [删除流程] 确认文字不正确
```

### 4. 关闭弹窗测试

```bash
# 步骤 1：打开删除确认
- 点击"删除账户"按钮

# 步骤 2：关闭弹窗
- 点击右上角"关闭"按钮

# 步骤 3：验证
- 弹窗关闭
- 输入框内容清空

# 预期日志：
🔵 [UI] 用户关闭删除账户弹窗
```

## 🎯 关键特性

### ✅ 安全性

1. **二次确认机制**
   - 必须手动输入"删除"文字
   - 防止误操作
   - 确认按钮状态关联

2. **明确警告**
   - 红色警告图标
   - "此操作无法撤销"提示
   - 列出所有将被删除的数据

3. **权限验证**
   - JWT Token 验证
   - 只能删除自己的账户
   - Service Role 权限控制

### ✅ 用户体验

1. **清晰的 UI**
   - 大图标警告
   - 清晰的文字说明
   - 明显的确认按钮

2. **即时反馈**
   - 输入框实时验证
   - 按钮状态变化
   - 加载动画显示

3. **错误处理**
   - 错误信息显示
   - 详细的日志输出
   - 失败后可重试

### ✅ 开发调试

1. **详细日志**
   - UI 操作日志
   - 删除流程日志
   - 边缘函数日志

2. **日志分类**
   - 🔵 蓝色：流程步骤
   - ✅ 绿色：成功操作
   - ❌ 红色：错误失败

3. **便于追踪**
   - 每个步骤都有日志
   - 包含关键数据
   - 便于定位问题

## ⚠️ 注意事项

### 1. 数据备份

在删除账户前，建议：
- 导出重要数据
- 保存领地信息截图
- 记录重要的兴趣点

### 2. 操作不可逆

- 删除后无法恢复
- 所有数据永久丢失
- 需要重新注册

### 3. 级联删除

删除账户会自动删除：
- ✅ profiles 表记录
- ✅ territories 表记录（级联）
- ✅ pois 表中的引用（设为 NULL）
- ✅ auth.users 账户

## 📚 相关文件

- `EarthLord/Managers/AccountService.swift` - 账户服务
- `EarthLord/Views/Tabs/ProfileTabView.swift` - 个人中心页面
- `Supabase Edge Functions/delete-account/index.ts` - 边缘函数
- `删除账户功能说明.md` - API 文档

---

✅ **删除账户功能已完整实现，可以开始测试！**
