# 圈地功能调试指南

## 🔍 问题描述
在真机上运行测试时，圈地后并没有形成对应的领地，功能没有被调用起来。

## ✅ 已修复的问题

### 1. **增加了详细的GPS和圈地日志**
所有GPS回调、圈地采样、距离过滤都会输出详细日志到控制台。

### 2. **放宽了GPS精度过滤**
- 从 `50m` 放宽到 `100m`
- 适应真机室内或信号较弱的环境

### 3. **优化了调试信息**
- 开始圈地时会显示当前配置
- GPS��调会显示精度和坐标
- 每次采样都会显示距离信息

## 🐛 可能的原因和解决方案

### 原因1: GPS权限未授予
**症状**: 控制台没有看到 `🛰️ [GPS] 位置更新` 日志

**解决方案**:
1. 检查 iPhone 设置 → 隐私 → 定位服务 → EarthLord
2. 确保选择了"使用App期间"或"始终"
3. 精确位置开关已打开

### 原因2: 距离过滤太严格
**症状**: 看到GPS回调，但采样点数量不增加

**解决方案**:
- 当前设置需要移动 ≥ 10m 才记录下一个点
- 在室内小范围走动可能无法触发
- **建议**: 在室外开阔地带测试

### 原因3: GPS精度不够
**症状**: 看到 `⚠️ [圈地] 精度差 XXXm，跳过` 日志

**解决方案**:
- 当前过滤条件: < 100m
- 室内GPS精度通常很差（几十到上百米）
- **建议**: 前往室外开阔地带或窗边测试

### 原因4: 采样点未达到要求
**症状**: 有采样点，但始终不自动完成

**解决方案**:
- 默认需要 5 个点
- 负重 > 80kg 时需要 8 个点
- **临时方案**: 点击状态栏右侧的"完成"按钮强制完成

## 📱 测试步骤

### 步骤1: 检查日志输出
在Xcode中打开控制台，应该能看到以下日志：

```
🚀 [Engine] EarthLordEngine 初始化完成
📍 [GPS] 定位服务已启动
🛰️ [GPS] 位置更新: lat=..., lon=..., 精度=XXm
```

### 步骤2: 开始圈地
点击"开始圈地"按钮，应该看到：

```
🚩 [圈地] ========== 开始圈地 ==========
🎯 [圈地] 采样点需求: 5 个点 (当前负重: XXkg)
📍 [圈地] 距离过滤: ≥ 10m
⚠️ [圈地] GPS 精度过滤: < 100m
📍 [圈地] ✅ 起点1已记录: (...), 精度: XXm
```

### 步骤3: 移动并观察采样
边走边观察控制台，应该看到：

```
🛰️ [GPS] 位置更新: lat=..., lon=..., 精度=XXm
📏 [圈地] 距上一个点: XXm (需要 ≥ 10m)
✅ [圈地] 第2点已记录！移动距离: XXm
📐 [面积] 当前闭合面积: XX㎡
```

### 步骤4: 完成圈地
当采样点达到要求（或点击"完成"按钮）：

```
🎉 [圈地] 采样点达标 5/5，自动完成圈地
🚩 [圈地] ✅ 领地确认！面积: XX㎡，采样点: 5
🏷️ [圈地] 领地命名为: XXX
🚩 [圈地] 领地上传成功！
```

## 🔧 临时降低测试门槛

如果需要快速测���，可以临时修改配置：

### 打开 `EarthLord/Models/POIModel.swift`

```swift
struct GameConfig {
    static let POI_TRIGGER_RADIUS: Double = 80.0
    static let CLAIM_RADIUS: Double = 150.0
    static let POI_RESPAWN_SECONDS: Double = 86400

    // 🧪 测试模式：降低门槛
    static let SAMPLING_MIN_DISTANCE: Double = 3.0    // 改为 3米
    static let SAMPLING_MIN_POINTS: Int = 3           // 改为 3个点
}
```

**注意**: 测试完成后务必改回原值！

## 📊 关键日志对照表

| 日志 | 含义 | 正常状态 |
|------|------|----------|
| `🛰️ [GPS] 位置更新` | GPS回调正常 | ✅ 频繁出现 |
| `⚠️ [圈地] 精度差` | GPS精度不够 | ❌ 应该很少出现 |
| `📏 [圈地] 距上一个点: XXm` | 距离检测 | ✅ 应该 ≥ 10m |
| `✅ [圈地] 第X点已记录` | 成功记录采样点 | ✅ 逐步增加 |
| `🎉 [圈地] 采样点达标` | 达到要求，自动完成 | ✅ 达到5个点 |

## 💡 最佳测试环境

1. **室外开阔地带**（推荐）
   - 公园、广场、空旷的街道
   - GPS精度通常 < 10m
   - 可以正常走动

2. **室内窗边**（次优）
   - 靠近窗户的位置
   - GPS精度通常 20-50m
   - 需要来回走动

3. **室内深处**（不推荐）
   - GPS精度可能 > 100m
   - 大部分采样点会被过滤

## 🚨 如果还是无法工作

### 检查清单:
1. [ ] Xcode控制台有 `🛰️ [GPS] 位置更新` 日志
2. [ ] 开始圈地后有 `📍 [圈地] ✅ 起点1已记录` 日志
3. [ ] 走动时有 `✅ [圈地] 第X点已记录` 日志
4. [ ] 采样点数量在增加
5. [ ] 没有频繁出现 `⚠️ [圈地] 精度差` 日志

### 如果上述都没问题:
检查 `MainMapView.swift` 是否正确监听了通知：
- `.territoryAdded` 通知
- `.territoryUpdated` 通知

## 📞 需要进一步调试
如果问题仍然存在，请提供：
1. Xcode控制台的完整日志（从点击"开始圈地"开始）
2. 测试环境（室内/室外）
3. iPhone型号和iOS版本
4. 是否授权了位置权限

---
**更新日期**: 2026-02-21
**相关文件**: `EarthLordEngine.swift`, `TerritoryManager.swift`, `MainMapView.swift`
