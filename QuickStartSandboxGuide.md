# 沙盒测试快速设置指南
## EarthLord IAP 系统

本指南帮助您快速设置沙盒测试环境并测试订阅购买。

---

## 📋 产品配置信息

### 当前订阅产品（已更新）

```
┌─────────────────────────────────────────────────────────────┐
│                    EarthLord 订阅产品                         │
├──────────────────────���──────────────────────────────────────┤
│                                                              │
│  1. 探索者通行证                                             │
│     • 月付: ¥12/月 ($1.99)                                  │
│     • 年付: ¥88/年 ($11.99) - 省39%                         │
│     • 试用: 7天免费                                          │
│     • Product IDs:                                          │
│       - com.earthlord.sub.explorer.monthly                  │
│       - com.earthlord.sub.explorer.yearly                   │
│       - com.earthlord.sub.explorer.trial                    │
│                                                              │
│  2. 领主通行证 (推荐)                                        │
│     • 月付: ¥28/月 ($4.49)                                  │
│     • 年付: ¥188/年 ($26.99) - 省44%                        │
│     • 试用: 7天免费                                          │
│     • Product IDs:                                          │
│       - com.earthlord.sub.lord.monthly                      │
│       - com.earthlord.sub.lord.yearly                       │
│       - com.earthlord.sub.lord.trial                        │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 👤 第一步：创建沙盒测试账号

### 1.1 登录 App Store Connect

1. 访问：https://appstoreconnect.apple.com
2. 使用开发者账号登录

### 1.2 创建测试账号

1. 点击右上角头像 → 用户和角色
2. 点击"沙盒测试员"
3. 点击"+"按钮

### 1.3 填写测试账号信息

**推荐测试账号配置：**

```
账号 1: 探索者测试
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
名字: Explorer
姓氏: Test
Apple ID: test.earthlord+explorer@gmail.com
密码: EarthTest2026

用途: 测试探索者通行证订阅


账号 2: 领主测试
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
名字: Lord
姓氏: Test
Apple ID: test.earthlord+lord@gmail.com
密码: EarthTest2026

用途: 测试领主通行证订阅


账号 3: 补给包测试
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
名字: Supply
姓氏: Test
Apple ID: test.earthlord+supply@gmail.com
密码: EarthTest2026

用途: 测试消耗品购买
```

**重要提示：**
- ✅ 密码必须包含数字和字母，至少8位
- ✅ 测试账号不能与真实Apple ID相同
- ✅ 创建后立即保存，无法找回密码
- ⚠️ 测试账号有数量限制（最多100个）

---

## 📱 第二步：配置测试设备

### 2.1 在 iPhone/iPad 上登录沙盒账号

1. 打开"设置"应用
2. 点击顶部的 Apple ID
3. 滚动到底部，点击"退出登录"
4. 重新登录，输入沙盒测试账号和密码
5. 可能会显示"验证失败"，这是正常的

### 2.2 验证登录

```
设置 → iTunes Store 与 App Store
→ 检查是否显示沙盒账号邮箱
```

**注意：** 沙盒账号只在测试环境有效，不要在真实App Store使用。

---

## 🚀 第三步：在 Xcode 中运行

### 3.1 选择正确的配置

```bash
# 在 Xcode 中
1. 选择设备: 真机（iPhone/iPad）
2. 选择 Team: 你的开发者账号
3. 检查 Bundle Identifier
4. 确保已启用 In-App Purchase 能力
```

### 3.2 运行 App

```bash
快捷键: ⌘R (Run)
或菜单: Product → Run
```

---

## 🧪 第四步：执行购买测试

### 测试 1：探索者通行证 - 月付订阅

**步骤：**

```
1. 启动 App
2. 点击"订阅"或"通行证"
3. 选择"探索者通行证"
4. 点击"月付"选项
5. 点击"立即订阅"
```

**预期结果：**

```
✅ 弹出 Apple Pay Sheet (系统支付界面)
✅ 显示: "订阅 - 探索者通行证"
✅ 显示价格: ¥12/月
✅ 输入 Face ID/Touch ID 或密码
✅ 显示"购买成功"
✅ 用户等级更新为"支持者"
✅ 权益生效（建造加速+10%，背包容量+5kg等）
```

**检查点：**

- [ ] 购买流程无错误
- [ ] 价格显示正确（¥12）
- [ ] 用户等级正确更新
- [ ] 权益已激活

---

### 测试 2：领主通行证 - 年付订阅

**步骤：**

```
1. 返回订阅页面
2. 选择"领主通行证"
3. 点击"年付"选项
4. 查看折扣信息（省44%）
5. 点击"立即订阅"
```

**预期结果：**

```
✅ 显示价格: ¥188/年
✅ 显示折扣信息
✅ 购买成功
✅ 用户等级更新为"领主"
✅ 权益生效（建造加速+25%，背包容量+10kg等）
```

---

### 测试 3：恢复购买

**步骤：**

```
1. 完成一次订阅购买
2. 卸载 App
3. 重新安装并启动
4. 进入订阅页面
5. 点击"恢复购买"按钮
```

**预期结果：**

```
✅ 显示"恢复成功"提示
✅ 订阅状态恢复
✅ 权益继续生效
```

---

### 测试 4：补给包购买

**步骤：**

```
1. 点击"商城"或"物资"
2. 选择"补给包"标签
3. 选择任意补给包（如"幸存者补给包"）
4. 点击"购买"
5. 确认购买弹窗
```

**预期结果：**

```
✅ 显示确认对话框
✅ 显示价格和物品信息
✅ 支付成功
✅ 提示"物品已发送到待领取"
✅ 切换到"待领取"标签
✅ 可以领取物品
```

---

## 📊 测试结果记录表

### 订阅测试结果

| 测试项 | 预期结果 | 实际结果 | 状态 |
|--------|----------|----------|------|
| 探索者月付 | ¥12/月 | ¥___/月 | ☐ 通过 |
| 领主年付 | ¥188/年 | ¥___/年 | ☐ 通过 |
| 恢复购买 | 成功恢复 | ___ | ☐ 通过 |
| 权益激活 | 正确显示 | ___ | ☐ 通过 |

### 消耗品测试结果

| 补给包 | 预期价格 | 实际价格 | 领取成功 | 状态 |
|--------|----------|----------|----------|------|
| 幸存者 | ¥6 | ¥___ | ☐ 是 | ☐ 通过 |
| 探险家 | ¥18 | ¥___ | ☐ 是 | ☐ 通过 |
| 领主 | ¥30 | ¥___ | ☐ 是 | ☐ 通过 |
| 霸主 | ¥68 | ¥___ | ☐ 是 | ☐ 通过 |

---

## ⚠️ 常见问题速查

### Q1: 无法登录沙盒账号

**现象：** 显示"无法验证Apple ID"

**解决：**
1. 确保在"设置 → iTunes Store 与 App Store"中登录
2. 不要在 App Store 应用中登录
3. 等待几分钟后重试

---

### Q2: 产品列表为空

**现象：** 订阅页面不显示产品

**可能原因：**
1. App Store Connect 未配置产品
2. Product ID 不匹配
3. 网络连接问题

**解决：**
1. 检查 App Store Connect 配置
2. 验证 Product ID 是否匹配
3. 等待产品生效（可能需要几分钟）
4. 重启 App

---

### Q3: 购买失败

**现象：** 点击购买没反应或显示错误

**解决：**
1. 检查 Bundle Identifier 是否匹配
2. 确保 Xcode 选择了正确的 Team
3. 清理项目: Product → Clean Build Folder
4. 重新编译运行

---

### Q4: 价格显示错误

**现象：** 显示的价格不是¥12或¥28

**解决：**
1. 检查 App Store Connect 中的价格配置
2. 确保选择了中国区价格
3. 等待价格生效（可能需要几小时）

---

## ✅ 提交前检查清单

在提交到 App Store 审核前，确认以下所有项：

### App Store Connect 配置

- [ ] 2个订阅组已创建
- [ ] 6个订阅产品已创建（每组3个）
- [ ] Product ID 与代码完全一致
- [ ] 价格已设置为中国区价格（¥12, ¥28, ¥88, ¥188）
- [ ] 中文本地化已添加
- [ ] 审核信息已填写

### 功能测试

- [ ] 探索者通行证购买成功
- [ ] 领主通行证购买成功
- [ ] 价格显示正确
- [ ] 恢复购买功能正常
- [ ] 补给包购买成功
- [ ] 物品正确发送到待领取

### UI/UX

- [ ] 订阅页面显示3个选项（免费、探索者、领主）
- [ ] 末日通行证已移除
- [ ] 价格显示¥符号
- [ ] 购买确认对话框显示正确
- [ ] 成功提示清晰友好
- [ ] 待领取功能正常

---

## 📞 需要帮助？

如果遇到无法解决的问题：

1. **查看 Xcode 控制台日志**
   ```
   Window → Show Debug Area
   ```

2. **检查 StoreKit 配置**
   ```
   Target → Signing & Capabilities → In-App Purchase
   ```

3. **参考完整文档**
   - `AppStoreConnectGuide.md` - 完整配置指南
   - `SandboxTestingGuide.md` - 详细测试流程

4. **Apple 官方文档**
   - [StoreKit Testing](https://developer.apple.com/documentation/storekit)
   - [Sandbox Testing](https://developer.apple.com/app-store/connect/sandbox/)

---

## 📝 快速命令参考

```bash
# Xcode 快捷键
⌘R        - 运行
⌘B        - 编译
⌘⇧K      - 清理
⌘.        - 停止运行

# 查看日志
⌘⇧Y      - 打开调试区域
⌘0        - 显示/隐藏导航栏
```

---

**文档版本:** 1.0
**最后更新:** 2026-02-25
**定价版本:** v2.0 (探索者¥12, 领主¥28)
**状态:** ✅ 已更新并移除末日通行证
