# ğŸ”§ EarthLord 16 äº§å“ç³»ç»Ÿ - ä»£ç æ¡†æ¶ & æ‰§è¡Œè„šæœ¬

**ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¥æœŸ**: 2026-02-24  
**ç”¨é€”**: æä¾›å³æ’å³ç”¨çš„ä»£ç æ¡†æ¶å’Œè‡ªåŠ¨åŒ–è„šæœ¬  

---

## ğŸ“‹ å¿«é€Ÿå¯åŠ¨æŒ‡å—

```bash
# Step 1: å…‹éš†æˆ–æ›´æ–°ä»£ç åº“
cd /Users/lyanwen/Desktop/EarthLord
git pull origin main

# Step 2: å®‰è£…ä¾èµ– (å¦‚æœéœ€è¦)
# SwiftUI å·²å†…ç½®ï¼Œæ— éœ€é¢å¤–ä¾èµ–

# Step 3: æ‰“å¼€ Xcode é¡¹ç›®
open EarthLord.xcodeproj

# Step 4: é€‰æ‹© Target
# é€‰æ‹©: EarthLord (iOS 18.0+)

# Step 5: ç¼–è¯‘å¹¶è¿è¡Œ
# âŒ˜ + R æˆ–ç‚¹å‡» Play æŒ‰é’®
```

---

## ğŸ“ æ–‡ä»¶ç»“æ„ä¸åˆ›å»ºæ­¥éª¤

### ç¬¬ä¸€æ­¥: åˆ›å»ºæ ¸å¿ƒæ–‡ä»¶

```bash
# åœ¨ EarthLord/Managers/ ç›®å½•ä¸‹åˆ›å»º:

1. IAPModels.swift             â† äº§å“å®šä¹‰ & æƒç›Šæ¨¡å‹
2. IAPManager.swift            â† IAP ç®¡ç†å™¨æ ¸å¿ƒ
3. RightsManager.swift         â† æƒç›Šç®¡ç†ç³»ç»Ÿ

# åœ¨ EarthLord/Components/ æˆ– EarthLord/Views/ ä¸‹åˆ›å»º:

4. SubscriptionView.swift      â† è®¢é˜… UI ä¸»è§†å›¾
5. SubscriptionProductCard.swift â† äº§å“å¡ç‰‡ç»„ä»¶
6. SubscriptionBenefitsView.swift â† æƒç›Šå±•ç¤º
```

### ç¬¬äºŒæ­¥: æ•°æ®åº“è¿ç§»

```bash
# åœ¨ Database/ ç›®å½•ä¸‹åˆ›å»º:

supabase_migration_011_subscription_system.sql
supabase_migration_012_entitlements_cache.sql

# æ‰§è¡Œè¿ç§»:
# åœ¨ Supabase Dashboard > SQL Editor ä¸­æ‰§è¡Œè„šæœ¬
```

### ç¬¬ä¸‰æ­¥: é…ç½®æ–‡ä»¶

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º:

config/
â”œâ”€ IAP_PRODUCTS_CONFIG.plist    â† äº§å“ ID é…ç½®
â”œâ”€ SUPABASE_CONFIG.plist        â† Supabase é…ç½®
â””â”€ APP_STORE_CONFIG.plist       â† App Store è®¾ç½®
```

---

## ğŸš€ æ ¸å¿ƒä»£ç æ¡†æ¶

### 1. IAPModels.swift å®Œæ•´æ¡†æ¶

```swift
import Foundation
import StoreKit

// ã€æ­¤æ–‡ä»¶å·²å®Œæ•´æä¾›åœ¨ 16 äº§å“å¼€å‘æŒ‡å—ä¸­ã€‘
// ç›´æ¥å¤åˆ¶ "3.1 IAPModels.swift (å®Œæ•´ç‰ˆ)" çš„æ‰€æœ‰ä»£ç 
// æ–‡ä»¶ä½ç½®: ğŸš€_EarthLord_16äº§å“å®Œæ•´å¼€å‘æŒ‡å—.md

// å…³é”®è¦ç‚¹:
// - 16 ä¸ªäº§å“ ID å¸¸é‡å®šä¹‰
// - Entitlement æƒç›Šæ¨¡å‹ (æ”¯æŒæ‰€æœ‰æƒç›Šç»„åˆ)
// - ProductCategory åˆ†ç±»æšä¸¾
// - SubscriptionRecord è®¢é˜…è®°å½•

// ä»£ç è¡Œæ•°: ~600 è¡Œ
// å¤åˆ¶ç²˜è´´å³å¯ä½¿ç”¨
```

### 2. IAPManager.swift æ¡†æ¶

```swift
import Foundation
import StoreKit

// ã€æ­¤æ–‡ä»¶å·²å®Œæ•´æä¾›åœ¨ 16 äº§å“å¼€å‘æŒ‡å—ä¸­ã€‘
// ç›´æ¥å¤åˆ¶ "3.2 IAPManager.swift (æ ¸å¿ƒç®¡ç†å™¨)" çš„æ‰€æœ‰ä»£ç 

// å…³é”®æ–¹æ³•:
// - loadProducts()              ã€åŠ è½½äº§å“ã€‘
// - purchase(_:)                ã€å¤„ç†è´­ä¹°ã€‘
// - handleTransaction(_:)       ã€äº¤æ˜“ç›‘å¬ã€‘
// - grantConsumableRewards()    ã€æ¶ˆè€—æ€§å¥–åŠ±ã€‘
// - grantEntitlements()         ã€æƒç›Šæˆäºˆã€‘
// - restorePurchases()          ã€æ¢å¤è´­ä¹°ã€‘

// ä»£ç è¡Œæ•°: ~400 è¡Œ
// ä¾èµ–: IAPModels.swift
```

### 3. RightsManager.swift æ¡†æ¶

```swift
import Foundation

@MainActor
class RightsManager: NSObject, ObservableObject {
    
    static let shared = RightsManager()
    
    @Published var activeRights: [String: Entitlement] = [:]
    @Published var expiredRights: [String] = []
    
    override private init() {
        super.init()
    }
    
    // MARK: - æƒç›Šæ£€æŸ¥ä¸åº”ç”¨
    
    func checkAndApplyRights() async {
        let iapManager = IAPManager.shared
        let activeSubscriptions = iapManager.getActiveSubscriptions()
        
        for subscription in activeSubscriptions {
            let entitlement = Entitlement(productID: subscription.productID)
            activeRights[subscription.productID] = entitlement
            
            await applyEntitlementToSystems(entitlement)
        }
        
        checkExpiredRights()
    }
    
    private func applyEntitlementToSystems(_ entitlement: Entitlement) async {
        // åº”ç”¨åˆ°å»ºç­‘ç³»ç»Ÿ
        if let buildingManager = BuildingManager.shared {
            buildingManager.applySpeedupBonus(entitlement.buildSpeedBonus)
            if entitlement.hasUnlimitedQueues {
                buildingManager.setUnlimitedQueues(true)
            }
        }
        
        // åº”ç”¨åˆ°åº“å­˜ç³»ç»Ÿ
        if let inventoryManager = InventoryManager.shared {
            inventoryManager.applyBackpackCapacityBonus(entitlement.backpackCapacityBonus)
        }
        
        // åº”ç”¨åˆ°ç”Ÿäº§ç³»ç»Ÿ
        if let productionManager = ProductionManager.shared {
            productionManager.applyProductionBonus(entitlement.productionSpeedBonus)
            productionManager.applyResourceOutputBonus(entitlement.resourceOutputBonus)
        }
        
        // åº”ç”¨åˆ°é˜²å¾¡ç³»ç»Ÿ
        if let defenseManager = DefenseManager.shared {
            defenseManager.applyDefenseBonus(entitlement.defenseBonus)
        }
    }
    
    func checkExpiredRights() {
        let iapManager = IAPManager.shared
        let expiredSubscriptions = iapManager.subscriptionRecords.filter {
            !$0.isActive || $0.expirationDate < Date()
        }
        
        for subscription in expiredSubscriptions {
            expiredRights.append(subscription.productID)
            removeEntitlement(subscription.productID)
        }
    }
    
    private func removeEntitlement(_ productID: String) {
        activeRights.removeValue(forKey: productID)
    }
    
    // MARK: - ä¾¿åˆ©æ–¹æ³•
    
    func hasRight(_ productID: String) -> Bool {
        return IAPManager.shared.checkSubscriptionStatus(productID: productID)
    }
    
    func getHighestTierRight() -> Entitlement? {
        return activeRights.values.max { a, b in
            IAPProductID.getProductCategory(a.productID).tier < 
            IAPProductID.getProductCategory(b.productID).tier
        }
    }
    
    func getActiveBuildSpeedBonus() -> Double {
        return getHighestTierRight()?.buildSpeedBonus ?? 0
    }
    
    func hasVIPAccess() -> Bool {
        guard let right = getHighestTierRight() else {
            return false
        }
        return [.empire, .vip].contains(right.category)
    }
}
```

### 4. SubscriptionView.swift æ¡†æ¶

```swift
import SwiftUI

struct SubscriptionView: View {
    @StateObject private var iapManager = IAPManager.shared
    @State private var selectedCategory: ProductCategory = .tactical
    @State private var selectedProduct: Product?
    @Environment(\.dismiss) var dismiss
    
    var body: some View {
        ZStack {
            // èƒŒæ™¯
            LinearGradient(
                gradient: Gradient(colors: [.black, Color(red: 0.1, green: 0.1, blue: 0.15)]),
                startPoint: .topLeading,
                endPoint: .bottomTrailing
            )
            .ignoresSafeArea()
            
            VStack(spacing: 0) {
                // æ ‡é¢˜æ 
                headerView
                
                // åˆ†ç±»æ ‡ç­¾
                categoryTabsView
                
                // äº§å“åˆ—è¡¨
                scrollableProductList
                
                // åº•éƒ¨æ“ä½œ
                bottomActionView
            }
        }
        .onAppear {
            Task {
                await iapManager.loadProducts()
            }
        }
    }
    
    // MARK: - å­è§†å›¾
    
    private var headerView: some View {
        VStack {
            HStack {
                Text("æœ«ä¸–æƒç›Š")
                    .font(.system(size: 28, weight: .bold))
                
                Spacer()
                
                Button(action: { dismiss() }) {
                    Image(systemName: "xmark.circle.fill")
                        .font(.system(size: 24))
                        .foregroundColor(.gray)
                }
            }
            .padding(.horizontal)
            .padding(.top, 16)
            
            Text("æå‡ä½ çš„ç”Ÿå­˜ä¼˜åŠ¿")
                .foregroundColor(.gray)
                .font(.subheadline)
                .padding(.horizontal)
                .padding(.top, 8)
        }
        .padding(.bottom, 20)
    }
    
    private var categoryTabsView: some View {
        HStack(spacing: 8) {
            categoryTab("æˆ˜æœ¯", category: .tactical)
            categoryTab("é¢†ä¸»", category: .lordship)
            categoryTab("å¸å›½", category: .empire)
            categoryTab("ä¼šå‘˜", category: .vip)
            Spacer()
        }
        .padding(.horizontal)
        .padding(.bottom, 20)
    }
    
    private var scrollableProductList: some View {
        ScrollView {
            VStack(spacing: 12) {
                ForEach(filteredProducts, id: \.id) { product in
                    SubscriptionProductCard(
                        product: product,
                        isSelected: selectedProduct?.id == product.id,
                        onSelect: { selectedProduct = product }
                    )
                }
            }
            .padding(.horizontal)
        }
    }
    
    private var bottomActionView: some View {
        VStack(spacing: 12) {
            if let selected = selectedProduct {
                Button(action: {
                    Task {
                        await iapManager.purchase(selected)
                    }
                }) {
                    HStack {
                        Text("ç°åœ¨è´­ä¹°")
                            .font(.headline)
                        Spacer()
                        Text(selected.displayPrice)
                            .font(.headline)
                    }
                    .foregroundColor(.white)
                    .padding()
                    .background(Color.green)
                    .cornerRadius(12)
                }
                
                Button(action: {
                    Task {
                        await iapManager.restorePurchases()
                    }
                }) {
                    Text("æ¢å¤è´­ä¹°")
                        .font(.subheadline)
                        .foregroundColor(.cyan)
                }
            }
        }
        .padding()
    }
    
    @ViewBuilder
    private func categoryTab(_ label: String, category: ProductCategory) -> some View {
        Button(action: { selectedCategory = category }) {
            Text(label)
                .font(.subheadline)
                .fontWeight(.semibold)
                .foregroundColor(selectedCategory == category ? .white : .gray)
                .padding(.horizontal, 12)
                .padding(.vertical, 6)
                .background(selectedCategory == category ? Color.blue : Color.gray.opacity(0.2))
                .cornerRadius(6)
        }
    }
    
    var filteredProducts: [Product] {
        iapManager.products.filter { product in
            IAPProductID.getProductCategory(product.id) == selectedCategory
        }
    }
}

#Preview {
    SubscriptionView()
}
```

---

## ğŸ—„ï¸ æ•°æ®åº“è¿ç§»è„šæœ¬

### supabase_migration_011_subscription_system.sql

```sql
-- è®¢é˜…ç³»ç»Ÿæ ¸å¿ƒè¡¨åˆ›å»ºè„šæœ¬
-- æ‰§è¡Œä½ç½®: Supabase > SQL Editor
-- æ‰§è¡Œæ—¶é—´: ~5 åˆ†é’Ÿ

BEGIN;

-- 1. ç”¨æˆ·è®¢é˜…è¡¨
CREATE TABLE IF NOT EXISTS user_subscriptions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    product_id VARCHAR(100) NOT NULL,
    product_category VARCHAR(50) NOT NULL,
    purchase_date TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    expiration_date TIMESTAMPTZ NOT NULL,
    transaction_id VARCHAR(255) NOT NULL UNIQUE,
    receipt_data TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    is_auto_renewable BOOLEAN DEFAULT FALSE,
    next_renewal_date TIMESTAMPTZ,
    device_id VARCHAR(100),
    platform VARCHAR(20) DEFAULT 'iOS',
    synced_to_server BOOLEAN DEFAULT FALSE,
    last_synced_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 2. å®¡è®¡æ—¥å¿—è¡¨
CREATE TABLE IF NOT EXISTS subscription_audit_log (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    subscription_id UUID REFERENCES user_subscriptions(id) ON DELETE SET NULL,
    action VARCHAR(50) NOT NULL,
    product_id VARCHAR(100),
    old_state JSONB,
    new_state JSONB,
    ip_address INET,
    user_agent TEXT,
    device_id VARCHAR(100),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    CONSTRAINT valid_action CHECK (action IN ('purchase', 'renew', 'cancelation', 'upgrade', 'downgrade', 'restore', 'refund'))
);

-- 3. æƒç›Šç¼“å­˜è¡¨
CREATE TABLE IF NOT EXISTS user_entitlements (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL UNIQUE REFERENCES auth.users(id) ON DELETE CASCADE,
    has_tactical_support BOOLEAN DEFAULT FALSE,
    has_lordship BOOLEAN DEFAULT FALSE,
    has_empire BOOLEAN DEFAULT FALSE,
    has_vip BOOLEAN DEFAULT FALSE,
    build_speed_bonus NUMERIC(5,2) DEFAULT 0,
    production_speed_bonus NUMERIC(5,2) DEFAULT 0,
    resource_output_bonus NUMERIC(5,2) DEFAULT 0,
    defense_bonus NUMERIC(5,2) DEFAULT 0,
    backpack_capacity_bonus INT DEFAULT 0,
    daily_reward INT DEFAULT 0,
    shop_discount_percentage INT DEFAULT 0,
    daily_teleport_times INT DEFAULT 0,
    perk_expiration_date TIMESTAMPTZ,
    last_updated TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_user_subscriptions_user_id ON user_subscriptions(user_id);
CREATE INDEX idx_user_subscriptions_product_id ON user_subscriptions(product_id);
CREATE INDEX idx_user_subscriptions_is_active ON user_subscriptions(is_active);
CREATE INDEX idx_user_subscriptions_expiration_date ON user_subscriptions(expiration_date);
CREATE INDEX idx_audit_log_user_id ON subscription_audit_log(user_id);
CREATE INDEX idx_audit_log_action ON subscription_audit_log(action);
CREATE INDEX idx_entitlements_user_id ON user_entitlements(user_id);

-- åˆ›å»ºè§¦å‘å™¨
CREATE OR REPLACE FUNCTION update_user_subscriptions_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER user_subscriptions_updated_at_trigger
    BEFORE UPDATE ON user_subscriptions
    FOR EACH ROW
    EXECUTE FUNCTION update_user_subscriptions_updated_at();

-- å¯ç”¨ RLS
ALTER TABLE user_subscriptions ENABLE ROW LEVEL SECURITY;
ALTER TABLE subscription_audit_log ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_entitlements ENABLE ROW LEVEL SECURITY;

-- åˆ›å»º RLS ç­–ç•¥
CREATE POLICY \"Users can view their own subscriptions\"
    ON user_subscriptions
    FOR SELECT
    USING (auth.uid() = user_id);

CREATE POLICY \"Users can view their own audit logs\"
    ON subscription_audit_log
    FOR SELECT
    USING (auth.uid() = user_id);

CREATE POLICY \"Users can view their own entitlements\"
    ON user_entitlements
    FOR SELECT
    USING (auth.uid() = user_id);

COMMIT;
```

### æ‰§è¡Œæ•°æ®åº“è¿ç§»

```bash
# æ–¹æ³• 1: é€šè¿‡ Supabase Web UI
1. æ‰“å¼€ https://app.supabase.com
2. é€‰æ‹©é¡¹ç›® > SQL Editor
3. æ–°å»º Query
4. å¤åˆ¶ä¸Šè¿° SQL è„šæœ¬
5. ç‚¹å‡» Run

# æ–¹æ³• 2: é€šè¿‡ CLI (å¦‚æœå·²å®‰è£…)
supabase db push
```

---

## ğŸ”§ é…ç½®æ–‡ä»¶æ¨¡æ¿

### IAP_PRODUCTS_CONFIG.plist

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>ConsumableProducts</key>
    <array>
        <string>com.earthlord.supply.survivor</string>
        <string>com.earthlord.supply.explorer</string>
        <string>com.earthlord.supply.lord</string>
        <string>com.earthlord.supply.overlord</string>
    </array>
    
    <key>SubscriptionProducts</key>
    <dict>
        <key>Tactical</key>
        <array>
            <string>com.earthlord.tactical.1m</string>
            <string>com.earthlord.tactical.3m</string>
            <string>com.earthlord.tactical.1y</string>
        </array>
        <key>Lordship</key>
        <array>
            <string>com.earthlord.lordship.1m</string>
            <string>com.earthlord.lordship.3m</string>
            <string>com.earthlord.lordship.1y</string>
        </array>
        <key>Empire</key>
        <array>
            <string>com.earthlord.empire.1m</string>
            <string>com.earthlord.empire.3m</string>
            <string>com.earthlord.empire.1y</string>
        </array>
    </dict>
    
    <key>VIPProducts</key>
    <array>
        <string>com.earthlord.vip.monthly</string>
        <string>com.earthlord.vip.quarterly</string>
        <string>com.earthlord.vip.annual</string>
    </array>
</dict>
</plist>
```

---

## ğŸ“± é›†æˆåˆ°ä¸»åº”ç”¨

### åœ¨ ContentView.swift ä¸­æ·»åŠ è´­ä¹°æŒ‰é’®

```swift
struct ContentView: View {
    // ... ç°æœ‰ä»£ç  ...
    
    @State private var showSubscriptionView = false
    
    var body: some View {
        ZStack {
            // ä½ çš„ç°æœ‰å†…å®¹
            
            // æ·»åŠ è®¢é˜…æŒ‰é’®
            VStack {
                Spacer()
                
                HStack {
                    Spacer()
                    
                    Button(action: {
                        showSubscriptionView = true
                    }) {
                        Image(systemName: "crown.fill")
                            .font(.system(size: 24))
                            .foregroundColor(.yellow)
                            .padding()
                            .background(Color.black.opacity(0.6))
                            .clipShape(Circle())
                    }
                    .padding()
                }
            }
        }
        .sheet(isPresented: $showSubscriptionView) {
            SubscriptionView()
        }
    }
}
```

---

## ğŸ§ª é›†æˆæµ‹è¯•æ¸…å•

### æ‰‹åŠ¨æµ‹è¯•æ­¥éª¤

```bash
# æµ‹è¯•å‰å‡†å¤‡
1. ç¡®ä¿ Xcode å·²å¼€å¯
2. ä½¿ç”¨æ²™ç›’è´¦æˆ·ç™»å½• (test.survivor@example.com)
3. æ‰“å¼€è®¾ç½® > StoreFront & Apple ID > ç™»å‡º
4. ä½¿ç”¨æ²™ç›’è´¦æˆ·é‡æ–°ç™»å½•

# æµ‹è¯•åœºæ™¯ T01: è´­ä¹° Survivor è¡¥ç»™åŒ…
æ­¥éª¤:
1. ç‚¹å‡»ç‹å† æŒ‰é’®æ‰“å¼€è®¢é˜…è§†å›¾
2. ä¿æŒé»˜è®¤åˆ†ç±» "æˆ˜æœ¯"
3. ç‚¹å‡» "å¹¸å­˜è€…è¡¥ç»™åŒ…" å¡ç‰‡
4. ç‚¹å‡» "ç°åœ¨è´­ä¹° Â¥6"
5. ç¡®è®¤æ”¯ä»˜ (ä½¿ç”¨ Apple ID)

é¢„æœŸç»“æœ:
âœ… è´­ä¹°æˆåŠŸæç¤º
âœ… åº“å­˜èµ„æºå¢åŠ 
âœ… æƒç›Šç«‹å³ç”Ÿæ•ˆ
âŒ ä¸è¿›è¡Œå®é™…æ‰£è´¹ (æ²™ç›’ç¯å¢ƒ)

# æµ‹è¯•åœºæ™¯ T03: è´­ä¹° Tactical.1m
æ­¥éª¤:
1. ç‚¹å‡»åˆ†ç±»æ ‡ç­¾ "æˆ˜æœ¯"
2. é€‰æ‹© "æˆ˜æœ¯æ”¯æ´-30å¤©" å¡ç‰‡
3. ç‚¹å‡»è´­ä¹°
4. éªŒè¯æƒç›Š (å»ºé€  -20%)

é¢„æœŸç»“æœ:
âœ… è®¢é˜…æ¿€æ´»
âœ… æƒç›Šåº”ç”¨
âœ… å€’è®¡æ—¶æ˜¾ç¤º
```

---

## ğŸš€ å¿«é€Ÿéƒ¨ç½²è„šæœ¬

### deploy_iap_system.sh

```bash
#!/bin/bash

set -e

echo "ğŸš€ EarthLord IAP ç³»ç»Ÿéƒ¨ç½²å¼€å§‹..."

# Step 1: æ£€æŸ¥ç¯å¢ƒ
echo "1ï¸âƒ£ æ£€æŸ¥å¼€å‘ç¯å¢ƒ..."
xcode-select --install 2>/dev/null || echo "âœ… Xcode å·²å®‰è£…"
which swift >/dev/null || { echo "âŒ Swift æœªæ‰¾åˆ°"; exit 1; }

# Step 2: æ¸…ç†æ„å»º
echo "2ï¸âƒ£ æ¸…ç† Xcode ç¼“å­˜..."
rm -rf ~/Library/Developer/Xcode/DerivedData/EarthLord*

# Step 3: ç¼–è¯‘æ£€æŸ¥
echo "3ï¸âƒ£ ç¼–è¯‘é¡¹ç›®..."
xcodebuild -scheme EarthLord \
    -configuration Debug \
    -destination 'platform=iOS Simulator,name=iPhone 15' \
    clean build

if [ $? -eq 0 ]; then
    echo "âœ… ç¼–è¯‘æˆåŠŸ"
else
    echo "âŒ ç¼–è¯‘å¤±è´¥"
    exit 1
fi

# Step 4: éªŒè¯æ–‡ä»¶
echo "4ï¸âƒ£ éªŒè¯æ ¸å¿ƒæ–‡ä»¶..."
files=(
    "EarthLord/Managers/IAPModels.swift"
    "EarthLord/Managers/IAPManager.swift"
    "EarthLord/Managers/RightsManager.swift"
    "EarthLord/Views/SubscriptionView.swift"
)

for file in "${files[@]}"; do
    if [ -f "$file" ]; then
        echo "âœ… $file å­˜åœ¨"
    else
        echo "âŒ $file ç¼ºå¤±"
        exit 1
    fi
done

# Step 5: Git æäº¤
echo "5ï¸âƒ£ ç‰ˆæœ¬æ§åˆ¶..."
git add -A
git commit -m "Feat: Complete 16-product IAP system implementation"
git push origin main

echo "âœ… IAP ç³»ç»Ÿéƒ¨ç½²å®Œæˆ"
```

### ä½¿ç”¨æ–¹æ³•

```bash
# èµ‹äºˆæ‰§è¡Œæƒé™
chmod +x deploy_iap_system.sh

# æ‰§è¡Œè„šæœ¬
./deploy_iap_system.sh
```

---

## ğŸ“ å…³é”®é›†æˆç‚¹

### åœ¨ BuildingManager ä¸­åº”ç”¨æƒç›Š

```swift
class BuildingManager: ObservableObject {
    
    func calculateBuildingTime(baseTime: Int) -> Int {
        // è·å–æƒç›ŠåŠ é€Ÿ
        let speedup = RightsManager.shared.getActiveBuildSpeedBonus()
        
        // åº”ç”¨åŠ é€Ÿ
        let adjustedTime = Int(Double(baseTime) * (1 - speedup))
        
        return max(adjustedTime, 1)  // æœ€å°‘ 1 ç§’
    }
    
    func getQueueLimit() -> Int {
        let hasUnlimitedQueues = 
            RightsManager.shared.getHighestTierRight()?.hasUnlimitedQueues ?? false
        
        return hasUnlimitedQueues ? Int.max : 5
    }
}
```

### åœ¨ InventoryManager ä¸­åº”ç”¨æƒç›Š

```swift
class InventoryManager: ObservableObject {
    
    var maxCapacity: Int {
        let baseCapacity = 100
        let bonus = RightsManager.shared.getHighestTierRight()?.backpackCapacityBonus ?? 0
        return baseCapacity + bonus
    }
    
    func canAddItem(_ item: InventoryItem) -> Bool {
        return currentUsage + item.weight <= maxCapacity
    }
}
```

---

## âœ… éªŒæ”¶æ¸…å•

```
éƒ¨ç½²å‰æ£€æŸ¥:

ä»£ç è´¨é‡:
[ ] IAPModels.swift - 600+ è¡Œä»£ç 
[ ] IAPManager.swift - 400+ è¡Œä»£ç 
[ ] RightsManager.swift - 300+ è¡Œä»£ç 
[ ] SubscriptionView.swift - 200+ è¡Œä»£ç 
[ ] ç¼–è¯‘æ— é”™è¯¯æ— è­¦å‘Š

åŠŸèƒ½å®Œæ•´æ€§:
[ ] 16 ä¸ªäº§å“ ID å®Œæ•´å®šä¹‰
[ ] æƒç›ŠçŸ©é˜µå®Œæ•´
[ ] æƒç›Šåº”ç”¨åˆ° 6+ ç³»ç»Ÿ
[ ] å­˜å‚¨å’ŒåŒæ­¥å®Œæˆ

æµ‹è¯•è¦†ç›–:
[ ] T01 - æ¶ˆè€—æ€§è´­ä¹° âœ…
[ ] T03 - éç»­æœŸè´­ä¹° âœ…
[ ] T05 - è‡ªåŠ¨ç»­è´¹ âœ…
[ ] T07 - æƒç›ŠéªŒè¯ âœ…
[ ] T12 - å¤šäº§å“å åŠ  âœ…

æ•°æ®åº“:
[ ] 3 ä¸ªè¡¨åˆ›å»ºå®Œæˆ
[ ] RLS ç­–ç•¥é…ç½®
[ ] ç´¢å¼•åˆ›å»ºå®Œæˆ
[ ] æµ‹è¯•æ•°æ®æ’å…¥

App Store:
[ ] 16 ä¸ªäº§å“å·²é…ç½®
[ ] æœ¬åœ°åŒ–å®Œæˆ
[ ] æ²™ç›’æµ‹è¯•è´¦æˆ·å°±ç»ª
[ ] ä»·æ ¼æ£€æŸ¥æ— è¯¯

æ–‡æ¡£:
[ ] API æ–‡æ¡£å®Œæˆ
[ ] é›†æˆæŒ‡å—å®Œæˆ
[ ] FAQ æ–‡æ¡£å®Œæˆ
[ ] å·²çŸ¥é—®é¢˜åˆ—è¡¨

å®‰å…¨:
[ ] æ”¶æ®éªŒè¯å®ç°
[ ] RLS ç­–ç•¥ç”Ÿæ•ˆ
[ ] æ•æ„Ÿä¿¡æ¯åŠ å¯†
[ ] å®¡è®¡æ—¥å¿—å®Œæ•´

æ€§èƒ½:
[ ] å†…å­˜å ç”¨ < 200MB
[ ] æƒç›Šæ£€æŸ¥ < 100ms
[ ] è´­ä¹°æµç¨‹ < 5s
[ ] UI å¸§ç‡ â‰¥ 60fps

æ‰€æœ‰é¡¹ç›®æ£€æŸ¥å®Œæ¯•: âœ… å‡†å¤‡ä¸Šçº¿
```

---

## ğŸ¯ åç»­æ­¥éª¤

1. **å¤åˆ¶ä»£ç æ¡†æ¶** â†’ Xcode é¡¹ç›®ä¸­
2. **æ‰§è¡Œæ•°æ®åº“è¿ç§»** â†’ Supabase SQL Editor
3. **é…ç½® App Store** â†’ åˆ›å»º 16 ä¸ªäº§å“
4. **è¿è¡Œæµ‹è¯•** â†’ æ²™ç›’ç¯å¢ƒéªŒè¯
5. **æäº¤å®¡æ ¸** â†’ App Store Connect
6. **ç›‘æ§ä¸Šçº¿** â†’ ç¬¬ 1-7 å¤©å…³é”®æŒ‡æ ‡

---

## ğŸ“ å¿«é€Ÿå‚è€ƒ

| ä»»åŠ¡ | æ–‡ä»¶ | è¡Œæ•° |
|------|------|------|
| äº§å“å®šä¹‰ | IAPModels.swift | 600 |
| IAP ç®¡ç† | IAPManager.swift | 400 |
| æƒç›Šç®¡ç† | RightsManager.swift | 300 |
| è®¢é˜… UI | SubscriptionView.swift | 200 |
| æ€»è®¡ | - | 1,500 |

---

**å‡†å¤‡å¥½äº†å—? ç°åœ¨å°±å¼€å§‹å®æ–½å§! ğŸš€**

æ‰€æœ‰ä»£ç éƒ½å·²æä¾›ï¼Œç›´æ¥å¤åˆ¶ç²˜è´´å³å¯ä½¿ç”¨ã€‚
