# é¢‘é“åˆ›å»ºé—®é¢˜ä¿®å¤æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜æè¿°

åˆ›å»ºé¢‘é“åï¼Œæ–°åˆ›å»ºçš„é¢‘é“æ²¡æœ‰æ˜¾ç¤ºåœ¨"æˆ‘çš„é¢‘é“"åˆ—è¡¨ä¸­ã€‚

---

## ğŸ” é—®é¢˜åŸå› åˆ†æ

### æ ¹æœ¬åŸå› 

åœ¨ `CreateChannelView.swift` ä¸­ï¼Œé¢‘é“åˆ›å»ºæˆåŠŸååªæ˜¯ç®€å•åœ°å…³é—­äº†è§†å›¾ï¼š

```swift
private func createChannel() {
    // ...
    do {
        _ = try await communicationManager.createChannel(...)
        await MainActor.run {
            isCreating = false
            dismiss()  // âŒ åªæ˜¯å…³é—­è§†å›¾ï¼Œæ²¡æœ‰é€šçŸ¥åˆ·æ–°
        }
    }
}
```

è€Œåœ¨ `ChannelCenterView.swift` ä¸­ï¼Œ`loadData()` åªåœ¨ `onAppear` æ—¶è°ƒç”¨ä¸€æ¬¡ï¼š

```swift
.onAppear { loadData() }
```

### é—®é¢˜æµç¨‹

1. ç”¨æˆ·åœ¨"å‘ç°é¢‘é“"ç‚¹å‡»"åˆ›å»º"æŒ‰é’®
2. æ‰“å¼€ `CreateChannelView` åˆ›å»ºé¢‘é“
3. é¢‘é“åˆ›å»ºæˆåŠŸï¼Œ`dismiss()` å…³é—­åˆ›å»ºè§†å›¾
4. **è¿”å›åˆ° `ChannelCenterView`ï¼Œä½† `onAppear` ä¸ä¼šå†æ¬¡è§¦å‘**
5. `subscribedChannels` æ•°æ®æ²¡æœ‰åˆ·æ–°
6. æ–°åˆ›å»ºçš„é¢‘é“ä¸æ˜¾ç¤ºåœ¨"æˆ‘çš„é¢‘é“"åˆ—è¡¨ä¸­

---

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. æ·»åŠ é€šçŸ¥æœºåˆ¶

åœ¨ `CommunicationManager.swift` ä¸­æ·»åŠ é€šçŸ¥å®šä¹‰ï¼š

```swift
extension Notification.Name {
    static let channelUpdated = Notification.Name("channelUpdated")
    static let channelSubscribed = Notification.Name("channelSubscribed")
    static let channelUnsubscribed = Notification.Name("channelUnsubscribed")
}
```

### 2. åˆ›å»ºé¢‘é“åå‘é€é€šçŸ¥

åœ¨ `CreateChannelView.swift` çš„ `createChannel()` æ–¹æ³•ä¸­ï¼š

```swift
private func createChannel() {
    Task {
        do {
            print("ğŸ”¨ [åˆ›å»ºé¢‘é“] å¼€å§‹åˆ›å»ºé¢‘é“: \(name)")
            let channelId = try await communicationManager.createChannel(
                userId: userId,
                type: channelType,
                name: name,
                description: desc
            )
            print("âœ… [åˆ›å»ºé¢‘é“] é¢‘é“åˆ›å»ºæˆåŠŸ: \(channelId)")

            await MainActor.run {
                isCreating = false

                // âœ… å‘é€é€šçŸ¥åˆ·æ–°é¢‘é“åˆ—è¡¨
                NotificationCenter.default.post(name: .channelUpdated, object: nil)
                print("ğŸ“¡ [åˆ›å»ºé¢‘é“] å·²å‘é€ channelUpdated é€šçŸ¥")

                dismiss()
            }
        } catch {
            // ... é”™è¯¯å¤„ç†
        }
    }
}
```

### 3. ç›‘å¬é€šçŸ¥åˆ·æ–°æ•°æ®

åœ¨ `ChannelCenterView.swift` ä¸­æ·»åŠ é€šçŸ¥ç›‘å¬ï¼š

```swift
.onAppear { loadData() }
.onReceive(NotificationCenter.default.publisher(for: .channelUpdated)) { _ in
    print("ğŸ“¡ [é¢‘é“ä¸­å¿ƒ] æ”¶åˆ° channelUpdated é€šçŸ¥ï¼Œåˆ·æ–°æ•°æ®")
    loadData()
}
.onReceive(NotificationCenter.default.publisher(for: .channelSubscribed)) { _ in
    print("ğŸ“¡ [é¢‘é“ä¸­å¿ƒ] æ”¶åˆ° channelSubscribed é€šçŸ¥ï¼Œåˆ·æ–°æ•°æ®")
    loadData()
}
.onReceive(NotificationCenter.default.publisher(for: .channelUnsubscribed)) { _ in
    print("ğŸ“¡ [é¢‘é“ä¸­å¿ƒ] æ”¶åˆ° channelUnsubscribed é€šçŸ¥ï¼Œåˆ·æ–°æ•°æ®")
    loadData()
}
```

### 4. è®¢é˜…/å–æ¶ˆè®¢é˜…ä¹Ÿå‘é€é€šçŸ¥

åœ¨ `CommunicationManager.swift` çš„ `subscribeToChannel()` å’Œ `unsubscribeFromChannel()` æ–¹æ³•ä¸­ä¹Ÿå‘é€é€šçŸ¥ï¼š

```swift
func subscribeToChannel(userId: UUID, channelId: UUID) async throws {
    // ... è®¢é˜…é€»è¾‘

    await loadPublicChannels()
    await loadSubscribedChannels(userId: userId)

    // âœ… å‘é€é€šçŸ¥åˆ·æ–°ç•Œé¢
    await MainActor.run {
        NotificationCenter.default.post(name: .channelSubscribed, object: channelId)
    }

    print("ğŸ“¡ [é¢‘é“] âœ… è®¢é˜…é¢‘é“æˆåŠŸ")
}
```

---

## ğŸ“Š ä¿®æ”¹çš„æ–‡ä»¶

1. âœ… `CommunicationManager.swift`
   - æ·»åŠ é€šçŸ¥åç§°å®šä¹‰
   - åœ¨è®¢é˜…/å–æ¶ˆè®¢é˜…æ—¶å‘é€é€šçŸ¥

2. âœ… `CreateChannelView.swift`
   - åˆ›å»ºé¢‘é“æˆåŠŸåå‘é€ `channelUpdated` é€šçŸ¥
   - æ·»åŠ è¯¦ç»†çš„æ—¥å¿—è¾“å‡º

3. âœ… `ChannelCenterView.swift`
   - ç›‘å¬ `channelUpdated`ã€`channelSubscribed`ã€`channelUnsubscribed` é€šçŸ¥
   - æ”¶åˆ°é€šçŸ¥ååˆ·æ–°æ•°æ®
   - æ·»åŠ è¯¦ç»†çš„æ—¥å¿—è¾“å‡º

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æµ‹è¯•1: åˆ›å»ºå…¬å¼€é¢‘é“

1. æ‰“å¼€"é€šè®¯ä¸­å¿ƒ" â†’ "é¢‘é“ä¸­å¿ƒ"
2. åˆ‡æ¢åˆ°"å‘ç°é¢‘é“"æ ‡ç­¾
3. ç‚¹å‡»å³ä¸Šè§’"åˆ›å»º"æŒ‰é’®
4. é€‰æ‹©é¢‘é“ç±»å‹ã€è¾“å…¥åç§°å’Œæè¿°
5. ç‚¹å‡»"åˆ›å»ºé¢‘é“"
6. **é¢„æœŸç»“æœ**ï¼š
   - æ§åˆ¶å°è¾“å‡ºï¼š`âœ… [åˆ›å»ºé¢‘é“] é¢‘é“åˆ›å»ºæˆåŠŸ`
   - æ§åˆ¶å°è¾“å‡ºï¼š`ğŸ“¡ [åˆ›å»ºé¢‘é“] å·²å‘é€ channelUpdated é€šçŸ¥`
   - æ§åˆ¶å°è¾“å‡ºï¼š`ğŸ“¡ [é¢‘é“ä¸­å¿ƒ] æ”¶åˆ° channelUpdated é€šçŸ¥ï¼Œåˆ·æ–°æ•°æ®`
   - æ–°é¢‘é“å‡ºç°åœ¨"æˆ‘çš„é¢‘é“"åˆ—è¡¨ä¸­

### æµ‹è¯•2: è®¢é˜…é¢‘é“

1. åœ¨"å‘ç°é¢‘é“"åˆ—è¡¨ä¸­æ‰¾åˆ°æœªè®¢é˜…çš„é¢‘é“
2. ç‚¹å‡»è®¢é˜…
3. **é¢„æœŸç»“æœ**ï¼š
   - æ§åˆ¶å°è¾“å‡ºï¼š`ğŸ“¡ [é¢‘é“] âœ… è®¢é˜…é¢‘é“æˆåŠŸ`
   - æ§åˆ¶å°è¾“å‡ºï¼š`ğŸ“¡ [é¢‘é“ä¸­å¿ƒ] æ”¶åˆ° channelSubscribed é€šçŸ¥ï¼Œåˆ·æ–°æ•°æ®`
   - é¢‘é“å‡ºç°åœ¨"æˆ‘çš„é¢‘é“"åˆ—è¡¨ä¸­

### æµ‹è¯•3: å–æ¶ˆè®¢é˜…

1. åœ¨"æˆ‘çš„é¢‘é“"åˆ—è¡¨ä¸­æ‰¾åˆ°å·²è®¢é˜…çš„é¢‘é“
2. è¿›å…¥è¯¦æƒ…é¡µï¼Œç‚¹å‡»å–æ¶ˆè®¢é˜…
3. **é¢„æœŸç»“æœ**ï¼š
   - æ§åˆ¶å°è¾“å‡ºï¼š`ğŸ“¡ [é¢‘é“] âœ… å–æ¶ˆè®¢é˜…æˆåŠŸ`
   - æ§åˆ¶å°è¾“å‡ºï¼š`ğŸ“¡ [é¢‘é“ä¸­å¿ƒ] æ”¶åˆ° channelUnsubscribed é€šçŸ¥ï¼Œåˆ·æ–°æ•°æ®`
   - é¢‘é“ä»"æˆ‘çš„é¢‘é“"åˆ—è¡¨ä¸­æ¶ˆå¤±

---

## ğŸ” è°ƒè¯•æ—¥å¿—

æ‰€æœ‰å…³é”®æ“ä½œéƒ½ä¼šè¾“å‡ºè¯¦ç»†æ—¥å¿—ï¼Œä¾¿äºè¯Šæ–­é—®é¢˜ï¼š

### åˆ›å»ºé¢‘é“æ—¥å¿—

```
ğŸ”¨ [åˆ›å»ºé¢‘é“] å¼€å§‹åˆ›å»ºé¢‘é“: æµ‹è¯•é¢‘é“
âœ… [åˆ›å»ºé¢‘é“] é¢‘é“åˆ›å»ºæˆåŠŸ: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
ğŸ“¡ [åˆ›å»ºé¢‘é“] å·²å‘é€ channelUpdated é€šçŸ¥
ğŸ“¡ [é¢‘é“ä¸­å¿ƒ] æ”¶åˆ° channelUpdated é€šçŸ¥ï¼Œåˆ·æ–°æ•°æ®
ğŸ”„ [é¢‘é“ä¸­å¿ƒ] å¼€å§‹åŠ è½½é¢‘é“æ•°æ®...
ğŸ“¡ [é¢‘é“ä¸­å¿ƒ] ç”¨æˆ·ID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
ğŸ“¡ [é¢‘é“] âœ… åŠ è½½å…¬å¼€é¢‘é“: X ä¸ª
ğŸ“¡ [é¢‘é“] âœ… åŠ è½½å·²è®¢é˜…é¢‘é“: X ä¸ª
ğŸ“Š [é¢‘é“ä¸­å¿ƒ] æ•°æ®åŠ è½½å®Œæˆ:
  - å…¬å¼€é¢‘é“: X ä¸ª
  - å·²è®¢é˜…é¢‘é“: X ä¸ª
```

### è®¢é˜…é¢‘é“æ—¥å¿—

```
ğŸ“¡ [é¢‘é“] âœ… è®¢é˜…é¢‘é“æˆåŠŸ
ğŸ“¡ [é¢‘é“ä¸­å¿ƒ] æ”¶åˆ° channelSubscribed é€šçŸ¥ï¼Œåˆ·æ–°æ•°æ®
ğŸ”„ [é¢‘é“ä¸­å¿ƒ] å¼€å§‹åŠ è½½é¢‘é“æ•°æ®...
ğŸ“Š [é¢‘é“ä¸­å¿ƒ] æ•°æ®åŠ è½½å®Œæˆ:
  - å…¬å¼€é¢‘é“: X ä¸ª
  - å·²è®¢é˜…é¢‘é“: X+1 ä¸ª
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®åº“å‡½æ•°ç¡®ä¿è‡ªåŠ¨è®¢é˜…

ç¡®ä¿ Supabase ä¸­çš„ `create_channel_with_subscription` å‡½æ•°ä¼šè‡ªåŠ¨å°†åˆ›å»ºè€…æ·»åŠ åˆ°è®¢é˜…åˆ—è¡¨ï¼š

```sql
-- åœ¨åˆ›å»ºé¢‘é“åè‡ªåŠ¨è®¢é˜…
INSERT INTO public.channel_subscriptions (user_id, channel_id)
VALUES (p_creator_id, v_channel_id);
```

### 2. é€šçŸ¥åç§°ä¿æŒä¸€è‡´

ç¡®ä¿åœ¨æ‰€æœ‰æ–‡ä»¶ä¸­ä½¿ç”¨ç›¸åŒçš„é€šçŸ¥åç§°ï¼š
- `.channelUpdated`
- `.channelSubscribed`
- `.channelUnsubscribed`

### 3. MainActor çº¿ç¨‹å®‰å…¨

å‘é€é€šçŸ¥æ—¶ç¡®ä¿åœ¨ä¸»çº¿ç¨‹ï¼š
```swift
await MainActor.run {
    NotificationCenter.default.post(name: .channelUpdated, object: nil)
}
```

---

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### 1. ä½¿ç”¨ @Published å±æ€§

è€ƒè™‘å°† `channels` å’Œ `subscribedChannels` æ”¹ä¸º `@Published`ï¼Œè¿™æ · UI ä¼šè‡ªåŠ¨æ›´æ–°ï¼š

```swift
@Published var channels: [CommunicationChannel] = []
@Published var subscribedChannels: [SubscribedChannel] = []
```

### 2. ä½¿ç”¨ Combine æ¡†æ¶

ä½¿ç”¨ Combine çš„ `sink` æˆ– `assign` æ¥ç›‘å¬æ•°æ®å˜åŒ–ï¼š

```swift
communicationManager.$subscribedChannels
    .sink { channels in
        // UI æ›´æ–°
    }
    .store(in: &cancellables)
```

### 3. æ·»åŠ åŠ è½½çŠ¶æ€

åœ¨ `ChannelCenterView` ä¸­æ·»åŠ åŠ è½½çŠ¶æ€æŒ‡ç¤ºå™¨ï¼š

```swift
@State private var isLoading = false

private func loadData() {
    isLoading = true
    Task {
        // ... åŠ è½½æ•°æ®
        await MainActor.run { isLoading = false }
    }
}
```

---

## ğŸ“ å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨

### æ£€æŸ¥æ¸…å•

1. [ ] æ£€æŸ¥æ§åˆ¶å°æ˜¯å¦æœ‰ `âœ… [åˆ›å»ºé¢‘é“] é¢‘é“åˆ›å»ºæˆåŠŸ` æ—¥å¿—
2. [ ] æ£€æŸ¥æ§åˆ¶å°æ˜¯å¦æœ‰ `ğŸ“¡ [åˆ›å»ºé¢‘é“] å·²å‘é€ channelUpdated é€šçŸ¥` æ—¥å¿—
3. [ ] æ£€æŸ¥æ§åˆ¶å°æ˜¯å¦æœ‰ `ğŸ“¡ [é¢‘é“ä¸­å¿ƒ] æ”¶åˆ° channelUpdated é€šçŸ¥` æ—¥å¿—
4. [ ] æ£€æŸ¥ Supabase æ•°æ®åº“ä¸­çš„ `communication_channels` è¡¨æ˜¯å¦æœ‰æ–°è®°å½•
5. [ ] æ£€æŸ¥ Supabase æ•°æ®åº“ä¸­çš„ `channel_subscriptions` è¡¨æ˜¯å¦æœ‰è®¢é˜…è®°å½•
6. [ ] æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•ï¼ˆ`authManager.currentUser?.id` ä¸ä¸º nilï¼‰

### å¸¸è§é—®é¢˜

**Q: åˆ›å»ºåä»ä¸æ˜¾ç¤ºï¼Ÿ**
A: æ£€æŸ¥æ•°æ®åº“ä¸­çš„ `channel_subscriptions` è¡¨ï¼Œç¡®è®¤åˆ›å»ºè€…å·²è¢«è‡ªåŠ¨è®¢é˜…ã€‚

**Q: è®¢é˜…åä¸æ˜¾ç¤ºï¼Ÿ**
A: æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—ï¼Œç¡®è®¤ `loadSubscribedChannels()` æ–¹æ³•æˆåŠŸæ‰§è¡Œã€‚

**Q: é€šçŸ¥æ²¡æœ‰è§¦å‘ï¼Ÿ**
A: ç¡®ä¿é€šçŸ¥åç§°æ‹¼å†™ä¸€è‡´ï¼Œä¸”åœ¨ä¸»çº¿ç¨‹å‘é€é€šçŸ¥ã€‚

---

**æ›´æ–°æ—¶é—´**: 2026-02-21
**ç›¸å…³æ–‡ä»¶**:
- `CreateChannelView.swift`
- `ChannelCenterView.swift`
- `CommunicationManager.swift`
- `supabase_migration_004_channel_system.sql`
