# 产品需求文档 (PRD)
## 地球新主 (EarthLord)

---

## 文档信息

- **项目名称**: 地球新主 (EarthLord)
- **文档版本**: 1.0
- **创建日期**: 2025-12-30
- **产品类型**: LBS生存游戏 (iOS)
- **目标市场**: 全球175个国家和地区

---

## 1. 产品概述

### 1.1 产品定位
地球新主是一款结合GPS定位、AR探索和生存建造的创新型LBS游戏。玩家通过真实世界的行走来圈占领地、探索资源、建造家园,并与其他玩家进行交易和社交。

### 1.2 核心价值主张
- **Walk to Earn**: 通过真实世界的行走获得游戏收益
- **真实地理**: 基于真实地图和真实POI的游戏体验
- **社交互动**: 基于地理位置的玩家交易和通讯系统
- **生存挑战**: 资源管理和生存体征的硬核玩法

### 1.3 世界观设定
- **背景**: 2048年"终末战争"爆发,全球文明在72小时内崩塌,99%人口消失
- **时间**: 2051年,幸存者从废墟中走出
- **核心法则**: 《新开拓者协议》 - "凡以双足丈量之无主土地,皆为开拓者所有"
- **视觉风格**: "希望朋克" - 废土之上的新生,绝望中的希望

---

## 2. 目标用户

### 2.1 核心用户画像
- **年龄**: 18-35岁
- **特征**: 喜欢运动、热爱探索、有游戏经验
- **行为**: 愿意外出行走、喜欢收集和建造、享受社交互动
- **动机**: 健身+游戏、探索城市、社交需求

### 2.2 用户需求
| 用户类型 | 核心需求 | 游戏满足方式 |
|---------|---------|------------|
| 健身爱好者 | 运动激励 | Walk to Earn,探索奖励 |
| 游戏玩家 | 收集建造 | 资源系统、建造系统 |
| 社交用户 | 互动交流 | 交易、聊天、频道 |
| 竞技玩家 | 排名竞争 | 排行榜、成就系统 |

---

## 3. 产品核心循环

```
登录注册 → 圈地占领 → 探索搜刮 → 获得资源
   ↑                              ↓
   │         建造建筑 (消耗资源)
   │         交易换物 (流通资源)
   │         生存消耗 (食物/水)
   │                              ↓
   └────── 通讯社交 ← 成就排行 ← 发展壮大
```

**关键逻辑**: 先圈地有"家" → 探索获得"资源" → 建造和交易

---

## 4. 功能需求详细说明

### 第一部分: 登录与圈地系统

#### 4.1 登录注册系统 (P0)

**功能描述**: 用户身份认证和账号管理

**需求详情**:
- 支持邮箱+密码注册登录
- 支持Apple ID一键登录 (Sign in with Apple)
- 支持Google账号登录
- 自动保持登录状态
- 邮箱验证功能
- 密码找回功能
- 多设备登录支持

**技术要求**:
- 使用Supabase Auth进行认证
- OAuth 2.0协议
- 安全存储用户凭证

**验收标准**:
- 用户可以成功注册新账号
- 用户可以使用邮箱/Apple ID/Google登录
- 登录状态可持久保存
- 登录失败有明确错误提示

---

#### 4.2 GPS圈地系统 (P0)

**功能描述**: 玩家通过GPS定位圈占领地

**需求详情**:
- 实时GPS定位和轨迹记录
- 在卫星地图上绘制行走轨迹(蓝色线条)
- 自动检测轨迹闭合(回到起点±20米)
- 轨迹闭合后形成多边形领地(绿色)
- 自动计算领地面积
- 验证领地合法性:
  - 不与其他玩家领地重叠
  - GPS数据未作弊
  - 面积在合理范围内(最小100m²,最大100,000m²)
- 领地数据存储到云端数据库

**技术要求**:
- 使用iOS MapKit框架
- 使用CoreLocation进行GPS定位
- 使用PostGIS地理数据库存储多边形数据
- 地理围栏技术检测重叠

**验收标准**:
- GPS定位精度在10米以内
- 轨迹绘制流畅无延迟
- 闭合检测准确(20米容差)
- 面积计算误差<5%
- 非法圈地被正确拦截

---

#### 4.3 领地管理 (P0)

**功能描述**: 管理已圈占的领地

**需求详情**:
- 查看领地列表
- 查看领地详情:
  - 领地名称(可自定义)
  - 领地面积
  - 建筑数量
  - 圈地时间
- 允许/禁止交易开关
- 领地在地图上可视化展示
- 领地状态管理:
  - 激活状态: 正常使用
  - 待激活: 30天内必须开始建设
  - 过期: 90天未活跃自动回收

**技术要求**:
- Supabase数据库存储
- PostGIS地理查询
- 实时同步

**验收标准**:
- 用户可以查看所有领地
- 可以编辑领地名称
- 交易开关立即生效
- 领地在地图上正确显示

---

### 第二部分: 探索与资源获取

#### 4.4 POI发现与搜刮 (P0)

**功能描述**: 玩家在真实世界探索并获取资源

**需求详情**:
- 自动识别玩家附近的POI(兴趣点):
  - 医院/药店 → 药品
  - 超市/餐厅 → 食物
  - 工厂/工地 → 金属材料
  - 公园/林地 → 木材
  - 银行/珠宝店 → 稀有材料
- 进入POI范围(50米)时弹出提示
- 点击"搜刮"按钮触发探索
- 根据POI类型随机生成资源奖励
- 记录探索成就:
  - 探索距离
  - 探索时长
  - 获得物品清单
- 同一POI有冷却时间(24小时)

**技术要求**:
- 使用Apple MapKit POI API
- 地理围栏技术
- 资源配置表系统

**验收标准**:
- POI识别准确率>95%
- 资源奖励符合POI类型
- 冷却时间正确计算
- 奖励数量在合理范围内

---

#### 4.5 背包系统 (P0)

**功能描述**: 存储和管理玩家获得的所有物品

**需求详情**:
- 背包容量限制(初始100格)
- 物品分类显示:
  - 食物
  - 材料
  - 工具
  - 稀有物品
- 显示每个物品的:
  - 图标
  - 名称
  - 数量
  - 描述
- 物品排序和筛选
- 使用物品功能(食物/药品)
- 丢弃/销毁物品
- 本地缓存+云端同步

**技术要求**:
- 本地优先架构(Local-first)
- SwiftData本地存储
- Supabase云端同步

**验收标准**:
- 背包数据离线可用
- 物品使用立即生效
- 容量限制正确拦截
- 数据同步无冲突

---

### 第三部分: 建造与交易系统

#### 4.6 建造系统 (P0)

**功能描述**: 在领地上建造各类建筑

**需求详情**:
- 建筑分类:
  - 生存类: 篝火、庇护所
  - 储存类: 小仓库、中仓库、大仓库
  - 生产类: 农田、工作台、熔炉
  - 能源类: 太阳能板、风力发电机
- 建筑等级系统(Tier 1/2/3)
- 建造流程:
  1. 选择建筑类型
  2. 检查资源是否足够
  3. 选择建造位置(拖拽放置)
  4. 消耗资源并创建建筑
- 建筑状态:
  - 建造中
  - 待激活
  - 运行中
  - 已损坏
- 建筑操作:
  - 激活/停用
  - 升级
  - 维修
  - 拆除

**技术要求**:
- 建筑模板配置系统
- 资源消耗事务处理
- 状态机模式

**验收标准**:
- 资源不足时无法建造
- 建筑位置在领地范围内
- 状态流转正确
- 升级消耗资源正确

---

#### 4.7 交易系统 (P1)

**功能描述**: 玩家之间的物品交易

**需求详情**:
- 基于位置的交易发现:
  - 进入其他玩家领地100米范围
  - 对方允许交易时可见挂单
- 发布交易挂单:
  - 选择提供的物品和数量
  - 选择需要的物品和数量
  - 设置有效期
- 浏览附近的交易:
  - 显示距离
  - 显示交易内容
  - 筛选和排序
- 接受交易:
  - 检查双方物品是否足够
  - 原子交换(全部成功或全部失败)
  - 交易记录
- 取消挂单

**技术要求**:
- 地理查询(PostGIS)
- 事务处理保证原子性
- 实时通知(Supabase Realtime)

**验收标准**:
- 交易必须双方资源都足够
- 交易是原子操作
- 距离过远无法交易
- 交易记录正确保存

---

### 第四部分: 通讯系统

#### 4.8 消息中心 (P1)

**功能描述**: 系统消息和通知

**需求详情**:
- 消息分类:
  - 官方公告
  - 生存指南
  - 每日任务
  - 系统通知
- 消息列表展示
- 未读标记
- 消息详情查看
- 消息删除

**技术要求**:
- Supabase数据库
- 推送通知(APNs)

**验收标准**:
- 新消息及时显示
- 未读数正确统计
- 推送通知可送达

---

#### 4.9 公共频道聊天 (P1)

**功能描述**: 基于地理位置的公共聊天室

**需求详情**:
- 覆盖范围3公里
- 只有在范围内的玩家可见消息
- 实时消息推送
- 显示发送者昵称和头像
- 显示消息时间
- 消息历史记录(最近100条)
- 发送文本消息
- 表情支持

**技术要求**:
- Supabase Realtime
- 地理位置过滤
- WebSocket连接

**验收标准**:
- 消息实时送达(<1秒)
- 距离过远看不到消息
- 历史消息正确加载

---

#### 4.10 频道管理 (P1)

**功能描述**: 创建和加入特定主题的聊天频道

**需求详情**:
- 创建频道:
  - 频道名称
  - 频道描述
  - 公开/私密
- 浏览附近频道:
  - 显示距离
  - 显示在线人数
  - 显示频道主题
- 加入/退出频道
- 频道内聊天
- 频道管理(频道主):
  - 踢出成员
  - 设置管理员
  - 修改频道信息

**技术要求**:
- 群组系统设计
- 权限管理
- 实时同步

**验收标准**:
- 用户可以创建频道
- 可以加入公开频道
- 频道消息正确隔离
- 权限控制有效

---

#### 4.11 PTT呼叫 (P2)

**功能描述**: 模拟对讲机的Push-to-Talk功能

**需求详情**:
- 长按麦克风按钮录音
- 松开发送语音消息
- 选择频道(公共频道或私人频道)
- 语音消息在频道内广播
- 播放其他人的语音消息

**技术要求**:
- AVFoundation录音
- 音频压缩
- 音频存储和分发

**验收标准**:
- 录音质量清晰
- 按钮交互符合对讲机操作
- 语音消息及时送达

---

#### 4.12 设备等级 (P1)

**功能描述**: 通讯设备升级系统

**需求详情**:
- 设备类型:
  - 收音机: 只能接收,不能发送
  - 对讲机: 可收发,范围3km
  - 营地电台: 可收发,范围10km
  - 卫星通讯: 全球范围
- 设备升级需要:
  - 消耗特定材料
  - 满足等级要求
- 不同设备有不同功能限制

**技术要求**:
- 设备配置表
- 权限控制系统

**验收标准**:
- 收音机用户无法发送消息
- 升级后功能正确解锁
- 范围限制正确生效

---

### 第五部分: 个人中心与商业化

#### 4.13 个人主页 (P0)

**功能描述**: 玩家个人信息和统计

**需求详情**:
- 基本信息:
  - 用户名
  - 头像
  - 等级
  - 生存天数
- 统计数据:
  - 领地数量和总面积
  - 建筑数量
  - 探索次数
  - 交易次数
- 个人设置:
  - 修改昵称
  - 更换头像
  - 隐私设置

**技术要求**:
- 用户资料存储
- 统计数据聚合

**验收标准**:
- 数据实时更新
- 修改立即生效
- 隐私设置正确执行

---

#### 4.14 多语言设置 (P0)

**功能描述**: 支持多种语言

**需求详情**:
- 支持语言:
  - 简体中文
  - 繁体中文
  - English
  - 日本語
  - 한국어
- 语言切换:
  - 在设置中选择语言
  - 重启应用生效
- 所有文本本地化:
  - UI文本
  - 系统消息
  - 建筑/物品名称和描述

**技术要求**:
- iOS Localization
- String Catalog
- 多语言资源管理

**验收标准**:
- 所有界面文字正确翻译
- 语言切换无遗漏
- 字体适配各语言

---

#### 4.15 付费订阅系统 (P0)

**功能描述**: 内购和订阅功能

**需求详情**:
- 订阅产品:
  - 开拓者月卡: $9.99/月
    - 无限探索次数
    - 探索范围扩大
    - 背包容量+50
  - 领主通行证: $19.99/月
    - 月卡所有特权
    - 独占建筑
    - 稀有资源加成
- 一次性购买:
  - 初级物资包: $0.99
  - 中级物资包: $2.99
  - 高级物资包: $4.99
  - 稀有资源包: $9.99
- 订阅管理:
  - 自动续费
  - 取消订阅
  - 恢复购买
- 购买流程:
  - 选择产品
  - 调起支付
  - 验证收据
  - 发放奖励

**技术要求**:
- StoreKit 2框架
- 服务器端收据验证
- 订阅状态同步

**验收标准**:
- 购买流程顺畅
- 支付安全可靠
- 奖励立即发放
- 自动续费正常

---

#### 4.16 排行榜 (P1)

**功能描述**: 玩家排名系统

**需求详情**:
- 排行榜类型:
  - 领地面积榜
  - 探索废墟榜
  - 建筑数量榜
- 榜单信息:
  - 排名
  - 玩家昵称
  - 头像
  - 数值
  - 自己的排名
- 榜单更新:
  - 每5分钟刷新一次
  - 显示更新时间
- 查看其他玩家资料

**技术要求**:
- 数据库窗口函数
- 排名缓存机制
- 高效查询优化

**验收标准**:
- 排名准确无误
- 查询速度<1秒
- 自己的排名正确高亮

---

#### 4.17 成就系统 (P1)

**功能描述**: 游戏成就和奖励

**需求详情**:
- 成就分类:
  - 新手成就: 引导基础功能
  - 进阶成就: 中级目标
  - 稀有成就: 高难度挑战
  - 隐藏成就: 特殊触发条件
- 成就信息:
  - 图标
  - 名称
  - 描述
  - 完成条件
  - 奖励(金币/道具)
  - 稀有度
- 成就追踪:
  - 进度显示
  - 完成提示
  - 自动发放奖励
- 成就展示:
  - 完成度百分比
  - 已完成/未完成分类

**技术要求**:
- EventBus事件系统
- 成就配置表
- 进度追踪

**验收标准**:
- 达成条件准确触发
- 奖励正确发放
- 进度正确统计

---

#### 4.18 生存体征 (P1)

**功能描述**: 角色生存状态管理

**需求详情**:
- 体征指标:
  - 核心生命: 0-100
  - 饱食度: 0-100%
  - 水分: 0-100%
- 自动衰减:
  - 饱食度: -5/小时
  - 水分: -10/小时
  - 生命: 饥饿或口渴时-1/小时
- 恢复机制:
  - 使用食物恢复饱食度
  - 使用水恢复水分
  - 生命自然恢复(饱食和水分>80时)
- 状态效果:
  - 饱食和水分>80: 探索奖励+20%
  - 饱食或水分<30: 移动速度-20%
  - 生命<20: 无法圈地和建造
- 死亡机制:
  - 生命降到0时死亡
  - 复活消耗稀有材料或付费

**技术要求**:
- 定时器系统
- 后台任务处理
- 状态计算

**验收标准**:
- 衰减速率准确
- 使用物品正确恢复
- 状态效果正确应用
- 死亡机制正常

---

## 5. 非功能性需求

### 5.1 性能要求
- GPS定位响应时间<1秒
- 地图渲染帧率>30fps
- 消息发送到送达<1秒
- 数据库查询<500ms
- 应用启动时间<3秒

### 5.2 可用性要求
- 系统可用性>99.5%
- 支持离线模式(本地缓存)
- 网络异常时有明确提示
- 数据冲突时自动解决

### 5.3 安全性要求
- 用户密码加密存储
- OAuth安全认证
- API请求加密传输(HTTPS)
- 防止GPS作弊检测
- 防止交易欺诈
- 用户隐私保护

### 5.4 兼容性要求
- iOS版本: iOS 15.0+
- 设备: iPhone 8及以上
- 屏幕尺寸: 4.7英寸 - 6.7英寸
- 支持深色模式

### 5.5 可扩展性要求
- 支持百万级用户
- 数据库可水平扩展
- API限流和降级
- CDN加速静态资源

---

## 6. 技术架构

### 6.1 前端技术栈
- 开发语言: Swift 5.9+
- UI框架: SwiftUI
- 地图: MapKit
- 定位: CoreLocation
- 本地存储: SwiftData
- 支付: StoreKit 2
- 音频: AVFoundation

### 6.2 后端技术栈
- BaaS平台: Supabase
- 数据库: PostgreSQL + PostGIS
- 认证: Supabase Auth
- 存储: Supabase Storage
- 实时通讯: Supabase Realtime

### 6.3 第三方服务
- 地图服务: Apple MapKit (免费)
- POI数据: Apple MapKit POI
- 推送通知: Apple Push Notification Service
- 支付: Apple In-App Purchase

---

## 7. 数据模型

### 7.1 核心数据表

#### users (用户表)
```sql
- id: UUID (主键)
- email: String (邮箱)
- username: String (用户名)
- avatar_url: String (头像URL)
- created_at: Timestamp (创建时间)
- last_login: Timestamp (最后登录)
- survival_days: Integer (生存天数)
- level: Integer (等级)
```

#### territories (领地表)
```sql
- id: UUID (主键)
- user_id: UUID (所属用户)
- name: String (领地名称)
- geometry: Geometry(Polygon) (多边形坐标)
- area: Float (面积平方米)
- allow_trade: Boolean (允许交易)
- status: Enum (激活/待激活/过期)
- created_at: Timestamp
```

#### items (物品表)
```sql
- id: UUID (主键)
- user_id: UUID (所属用户)
- item_type: String (物品类型)
- quantity: Integer (数量)
- updated_at: Timestamp
```

#### buildings (建筑表)
```sql
- id: UUID (主键)
- territory_id: UUID (所属领地)
- building_type: String (建筑类型)
- tier: Integer (等级)
- status: Enum (建造中/待激活/运行中/损坏)
- position: JSON (位置坐标)
- created_at: Timestamp
```

#### trades (交易表)
```sql
- id: UUID (主键)
- seller_id: UUID (卖方)
- buyer_id: UUID (买方)
- offer_items: JSON (提供物品)
- request_items: JSON (需求物品)
- status: Enum (挂单中/已完成/已取消)
- created_at: Timestamp
- completed_at: Timestamp
```

#### messages (消息表)
```sql
- id: UUID (主键)
- sender_id: UUID (发送者)
- channel_id: UUID (频道ID,NULL表示公共频道)
- content: Text (消息内容)
- location: Point (发送位置)
- created_at: Timestamp
```

---

## 8. 优先级规划

### P0 (必须有 - MVP)
- 登录注册系统
- GPS圈地系统
- 领地管理
- POI发现与搜刮
- 背包系统
- 建造系统
- 个人主页
- 多语言设置
- 付费订阅系统

### P1 (重要 - V1.1)
- 交易系统
- 消息中心
- 公共频道聊天
- 频道管理
- 设备等级
- 排行榜
- 成就系统
- 生存体征

### P2 (锦上添花 - V1.2)
- PTT呼叫
- 联盟系统
- PVP竞技
- 季度赛事

---

## 9. 商业模式

### 9.1 收入来源
1. **订阅收入** (主要)
   - 开拓者月卡: $9.99/月
   - 领主通行证: $19.99/月
   - 预期转化率: 3-5%

2. **内购收入** (次要)
   - 资源包: $0.99 - $9.99
   - 特殊道具
   - 预期ARPU: $2-5

3. **广告收入** (可选)
   - 视频激励广告
   - Banner广告

### 9.2 增长策略
1. **病毒式传播**
   - 邀请好友奖励
   - 社交分享激励
   - 排行榜炫耀

2. **留存机制**
   - 每日签到奖励
   - 每日任务
   - 时间衰减(生存体征)
   - 排行榜竞争

3. **付费转化**
   - 新手引导优惠
   - 限时折扣
   - 订阅试用期
   - VIP特权展示

---

## 10. 里程碑计划

### Phase 1: MVP开发 (4周)
- Week 1-2: 登录系统 + GPS圈地 + 领地管理
- Week 3: POI探索 + 背包系统
- Week 4: 建造系统 + 个人主页

### Phase 2: 社交功能 (3周)
- Week 5: 交易系统 + 消息中心
- Week 6: 公共频道 + 频道管理
- Week 7: 设备等级 + PTT呼叫

### Phase 3: 商业化 (2周)
- Week 8: 付费订阅 + 内购系统
- Week 9: 排行榜 + 成就系统

### Phase 4: 优化上线 (2周)
- Week 10: 生存体征 + 多语言
- Week 11: 测试优化 + 上架准备

---

## 11. 风险评估

### 11.1 技术风险
| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|---------|
| GPS定位不准确 | 高 | 中 | 增加定位精度检测,过滤异常数据 |
| 地理数据库性能瓶颈 | 中 | 中 | PostGIS索引优化,查询缓存 |
| 实时消息延迟 | 中 | 低 | Supabase Realtime备选WebSocket |
| 内购收据验证失败 | 高 | 低 | 重试机制,人工客服处理 |

### 11.2 运营风险
| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|---------|
| 用户作弊(GPS欺诈) | 高 | 高 | 反作弊算法,人工审核 |
| 用户流失率高 | 高 | 中 | 增强留存机制,优化新手引导 |
| 付费转化率低 | 高 | 中 | A/B测试定价,优化付费点设计 |
| 恶意内容(聊天) | 中 | 中 | 内容审核,举报机制 |

### 11.3 合规风险
| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|---------|
| App Store审核被拒 | 高 | 中 | 严格遵循审核指南 |
| 隐私政策不合规 | 高 | 低 | GDPR/CCPA合规审查 |
| 地图数据使用限制 | 中 | 低 | 使用MapKit遵循Apple协议 |

---

## 12. 成功指标 (KPI)

### 12.1 用户指标
- DAU (日活跃用户): 目标10,000+ (3个月后)
- MAU (月活跃用户): 目标50,000+ (6个月后)
- 留存率:
  - 次日留存: >40%
  - 7日留存: >20%
  - 30日留存: >10%

### 12.2 参与度指标
- 平均游戏时长: >20分钟/天
- 圈地次数: >2次/周/用户
- 探索次数: >5次/周/用户
- 消息发送: >10条/周/用户

### 12.3 商业指标
- 付费转化率: >3%
- ARPU (平均每用户收入): >$2/月
- LTV (用户生命周期价值): >$50
- ROI (投资回报率): >200%

---

## 13. 附录

### 13.1 术语表
- **LBS**: Location Based Service (基于位置的服务)
- **POI**: Point of Interest (兴趣点)
- **GPS**: Global Positioning System (全球定位系统)
- **BaaS**: Backend as a Service (后端即服务)
- **ARPU**: Average Revenue Per User (平均每用户收入)
- **LTV**: Lifetime Value (生命周期价值)
- **DAU**: Daily Active Users (日活跃用户)
- **MAU**: Monthly Active Users (月活跃用户)

### 13.2 参考资料
- Apple MapKit文档
- Supabase官方文档
- StoreKit 2最佳实践
- 宝可梦GO游戏设计分析
- LBS应用最佳实践

---

**文档结束**
