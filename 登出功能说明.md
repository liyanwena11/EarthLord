# EarthLord ç™»å‡ºåŠŸèƒ½è¯´æ˜

## âœ… å·²å®Œæˆçš„åŠŸèƒ½

### 1ï¸âƒ£ ä¸ªäººä¸­å¿ƒé¡µé¢ï¼ˆProfileTabView.swiftï¼‰

#### ğŸ“± UI ç»„ä»¶
- âœ… **ç”¨æˆ·ä¿¡æ¯å¡ç‰‡**
  - ç”¨æˆ·å¤´åƒï¼ˆæ¸å˜åœ†å½¢èƒŒæ™¯ + å›¾æ ‡ï¼‰
  - ç”¨æˆ·åæ˜¾ç¤ºï¼ˆä¼˜å…ˆæ˜¾ç¤º usernameï¼Œå¦åˆ™æ˜¾ç¤ºé‚®ç®±å‰ç¼€ï¼‰
  - ç”¨æˆ·é‚®ç®±
  - ç”¨æˆ· IDï¼ˆæ˜¾ç¤ºå‰ 8 ä½ï¼‰

- âœ… **è®¾ç½®é€‰é¡¹åˆ—è¡¨**
  - ç¼–è¾‘èµ„æ–™ï¼ˆé¢„ç•™ï¼‰
  - è´¦å·ä¸å®‰å…¨ï¼ˆé¢„ç•™ï¼‰
  - å…³äºåœ°çƒæ–°ä¸»ï¼ˆé¢„ç•™ï¼‰

- âœ… **é€€å‡ºç™»å½•æŒ‰é’®**
  - çº¢è‰²å±é™©æ ·å¼
  - é€€å‡ºå›¾æ ‡ + æ–‡å­—
  - åŠ è½½çŠ¶æ€æ˜¾ç¤º
  - ç¡®è®¤å¼¹çª—

#### ğŸ”§ æ ¸å¿ƒåŠŸèƒ½

```swift
// 1. å¯¼å…¥ Supabase æ¨¡å—ï¼ˆè®¿é—® User ç±»å‹ï¼‰
import Supabase

// 2. è¿æ¥ AuthManager
@StateObject private var authManager = AuthManager.shared

// 3. æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
authManager.currentUser?.email
authManager.currentUser?.userMetadata["username"]
authManager.currentUser?.id

// 4. é€€å‡ºç™»å½•
await authManager.signOut()
```

### 2ï¸âƒ£ AuthManager.signOut() æ–¹æ³•

#### åŠŸèƒ½å®ç°
```swift
func signOut() async {
    isLoading = true
    errorMessage = nil

    do {
        // 1. è°ƒç”¨ Supabase é€€å‡º API
        try await supabase.auth.signOut()

        // 2. æ¸…ç©ºæ‰€æœ‰æœ¬åœ°çŠ¶æ€
        currentUser = nil
        isAuthenticated = false
        needsPasswordSetup = false
        otpSent = false
        otpVerified = false
        errorMessage = nil

    } catch {
        // é€€å‡ºå¤±è´¥å¤„ç†
        errorMessage = "é€€å‡ºç™»å½•å¤±è´¥ï¼š\(error.localizedDescription)"
    }

    isLoading = false
}
```

#### æ‰§è¡Œæµç¨‹
```
ç”¨æˆ·ç‚¹å‡»"é€€å‡ºç™»å½•"
  â†“
æ˜¾ç¤ºç¡®è®¤å¼¹çª—ï¼ˆ"ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ"ï¼‰
  â†“
ç¡®è®¤é€€å‡º â†’ handleSignOut()
  â†“
è°ƒç”¨ authManager.signOut()
  â†“
supabase.auth.signOut() â†’ æ¸…ç©ºæœåŠ¡å™¨ä¼šè¯
  â†“
è§¦å‘ authStateChanges äº‹ä»¶ï¼ˆsignedOutï¼‰
  â†“
setupAuthStateListener() è‡ªåŠ¨å¤„ç†ï¼š
  - currentUser = nil
  - isAuthenticated = false
  - æ¸…ç©ºæ‰€æœ‰çŠ¶æ€
  â†“
RootView ç›‘å¬ isAuthenticated å˜åŒ–
  â†“
è‡ªåŠ¨è·³è½¬åˆ° AuthViewï¼ˆç™»å½•é¡µï¼‰âœ…
```

### 3ï¸âƒ£ ä¼šè¯è¿‡æœŸå¤„ç†

#### è‡ªåŠ¨å¤„ç†æœºåˆ¶

```swift
// AuthManager ä¸­çš„çŠ¶æ€ç›‘å¬
private func setupAuthStateListener() async {
    authStateTask = Task {
        for await state in await supabase.auth.authStateChanges {
            await MainActor.run {
                switch state.event {
                case .signedOut:
                    // ğŸ”” ä¼šè¯è¿‡æœŸæ—¶è‡ªåŠ¨è§¦å‘
                    currentUser = nil
                    isAuthenticated = false
                    needsPasswordSetup = false
                    otpSent = false
                    otpVerified = false
                    print("ğŸ”“ ç”¨æˆ·å·²é€€å‡º")

                // ... å…¶ä»–äº‹ä»¶
                }
            }
        }
    }
}
```

#### ä¼šè¯è¿‡æœŸåœºæ™¯

| åœºæ™¯ | Supabase è¡Œä¸º | åº”ç”¨å“åº” |
|------|--------------|---------|
| **Token è¿‡æœŸ** | è§¦å‘ `signedOut` äº‹ä»¶ | è‡ªåŠ¨è·³è½¬ç™»å½•é¡µ |
| **æ‰‹åŠ¨é€€å‡º** | è°ƒç”¨ `signOut()` â†’ è§¦å‘ `signedOut` | è‡ªåŠ¨è·³è½¬ç™»å½•é¡µ |
| **å¼ºåˆ¶ç™»å‡º** | æœåŠ¡å™¨ç«¯æ’¤é”€ä¼šè¯ â†’ è§¦å‘ `signedOut` | è‡ªåŠ¨è·³è½¬ç™»å½•é¡µ |
| **å…¶ä»–è®¾å¤‡ç™»å½•** | ä¼šè¯è¢«æ›¿æ¢ â†’ è§¦å‘ `signedOut` | è‡ªåŠ¨è·³è½¬ç™»å½•é¡µ |

## ğŸ¯ å®Œæ•´ç™»å‡ºæµç¨‹

### ç”¨æˆ·ä¸»åŠ¨é€€å‡º

```
ä¸ªäººä¸­å¿ƒ
  â†“
ç‚¹å‡»"é€€å‡ºç™»å½•"æŒ‰é’®
  â†“
å¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†
  â”œâ”€ ç‚¹å‡»"å–æ¶ˆ" â†’ å…³é—­å¯¹è¯æ¡†
  â””â”€ ç‚¹å‡»"é€€å‡º" â†’ æ‰§è¡Œé€€å‡º
       â†“
       æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼ˆæŒ‰é’®ä¸Šçš„è½¬åœˆåŠ¨ç”»ï¼‰
       â†“
       è°ƒç”¨ authManager.signOut()
       â†“
       Supabase æ¸…ç©ºä¼šè¯
       â†“
       è§¦å‘ authStateChangesï¼ˆsignedOutï¼‰
       â†“
       AuthManager è‡ªåŠ¨æ›´æ–°çŠ¶æ€
       â†“
       isAuthenticated = false
       â†“
       RootView ç›‘å¬åˆ°å˜åŒ–
       â†“
       è‡ªåŠ¨åˆ‡æ¢åˆ° AuthViewï¼ˆç™»å½•é¡µï¼‰âœ…
```

### ä¼šè¯è¿‡æœŸï¼ˆè‡ªåŠ¨ï¼‰

```
æ­£å¸¸ä½¿ç”¨ App
  â†“
Token åˆ°æœŸï¼ˆSupabase è‡ªåŠ¨æ£€æµ‹ï¼‰
  â†“
è§¦å‘ authStateChangesï¼ˆsignedOutï¼‰
  â†“
AuthManager è‡ªåŠ¨æ›´æ–°çŠ¶æ€
  â†“
isAuthenticated = false
  â†“
RootView ç›‘å¬åˆ°å˜åŒ–
  â†“
è‡ªåŠ¨åˆ‡æ¢åˆ° AuthViewï¼ˆç™»å½•é¡µï¼‰âœ…
```

## ğŸ“± UI å±•ç¤º

### ä¸ªäººä¸­å¿ƒé¡µé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ğŸŒï¼ˆæ¸å˜åœ†å½¢å¤´åƒï¼‰         â”‚
â”‚                             â”‚
â”‚        ç”¨æˆ·å/é‚®ç®±å‰ç¼€         â”‚
â”‚      user@example.com       â”‚
â”‚       ID: 12345678...       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ‘¤  ç¼–è¾‘èµ„æ–™            >    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ”’  è´¦å·ä¸å®‰å…¨          >    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â„¹ï¸  å…³äºåœ°çƒæ–°ä¸»         >    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸšª  é€€å‡ºç™»å½•ï¼ˆçº¢è‰²ï¼‰        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é€€å‡ºç¡®è®¤å¼¹çª—

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        ç¡®è®¤é€€å‡º              â”‚
â”‚                             â”‚
â”‚   ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ          â”‚
â”‚                             â”‚
â”‚   [ å–æ¶ˆ ]    [ é€€å‡º ]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ” å…³é”®ä»£ç 

### è·å–ç”¨æˆ·æ˜¾ç¤ºåç§°

```swift
private func getUserDisplayName() -> String {
    // 1. ä¼˜å…ˆæ˜¾ç¤ºç”¨æˆ·å
    if let username = authManager.currentUser?.userMetadata["username"] as? String,
       !username.isEmpty {
        return username
    }

    // 2. å…¶æ¬¡æ˜¾ç¤ºé‚®ç®±å‰ç¼€
    if let email = authManager.currentUser?.email {
        return email.components(separatedBy: "@").first ?? "æœªçŸ¥ç”¨æˆ·"
    }

    // 3. é»˜è®¤å€¼
    return "æœªçŸ¥ç”¨æˆ·"
}
```

### é€€å‡ºç™»å½•å¤„ç†

```swift
private func handleSignOut() {
    isSigningOut = true

    Task {
        await authManager.signOut()

        // é€€å‡ºå®Œæˆåï¼ŒauthStateChanges ä¼šè‡ªåŠ¨è§¦å‘
        // isAuthenticated å˜ä¸º falseï¼ŒRootView ä¼šè‡ªåŠ¨è·³è½¬åˆ° AuthView
        await MainActor.run {
            isSigningOut = false
        }
    }
}
```

## ğŸ§ª æµ‹è¯•åœºæ™¯

### 1. æ­£å¸¸é€€å‡ºæµç¨‹
```
1. ç™»å½•æˆåŠŸ â†’ è¿›å…¥ä¸»ç•Œé¢
2. åˆ‡æ¢åˆ°"ä¸ªäºº"Tab
3. æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯ï¼ˆå¤´åƒã€ç”¨æˆ·åã€é‚®ç®±ï¼‰
4. ç‚¹å‡»"é€€å‡ºç™»å½•"æŒ‰é’®
5. ç¡®è®¤å¼¹çª—å‡ºç°
6. ç‚¹å‡»"é€€å‡º"
7. æŒ‰é’®æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
8. è‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µ âœ…
```

### 2. å–æ¶ˆé€€å‡º
```
1. ç‚¹å‡»"é€€å‡ºç™»å½•"æŒ‰é’®
2. ç¡®è®¤å¼¹çª—å‡ºç°
3. ç‚¹å‡»"å–æ¶ˆ"
4. å¼¹çª—å…³é—­ï¼Œç•™åœ¨ä¸ªäººé¡µé¢ âœ…
```

### 3. ä¼šè¯è¿‡æœŸï¼ˆæ¨¡æ‹Ÿï¼‰
```
1. ç™»å½•æˆåŠŸ
2. ç­‰å¾… Token è¿‡æœŸï¼ˆæˆ–æ‰‹åŠ¨åˆ é™¤ä¼šè¯ï¼‰
3. è‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µ âœ…
4. æ˜¾ç¤º"ä¼šè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•"æç¤ºï¼ˆå¯é€‰ï¼‰
```

### 4. é€€å‡ºåé‡æ–°ç™»å½•
```
1. é€€å‡ºç™»å½• â†’ è·³è½¬åˆ°ç™»å½•é¡µ
2. è¾“å…¥é‚®ç®±å¯†ç  â†’ ç™»å½•
3. è¿›å…¥ä¸»ç•Œé¢
4. åˆ‡æ¢åˆ°ä¸ªäººé¡µé¢
5. æ˜¾ç¤ºæ–°çš„ç”¨æˆ·ä¿¡æ¯ âœ…
```

## ğŸ“Š çŠ¶æ€æµè½¬å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœªç™»å½•çŠ¶æ€      â”‚
â”‚ isAuthenticated â”‚
â”‚    = false      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ ç™»å½•æˆåŠŸ
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å·²ç™»å½•çŠ¶æ€     â”‚
â”‚ isAuthenticated â”‚
â”‚    = true       â”‚
â”‚ currentUser â‰  nilâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ é€€å‡ºç™»å½• / ä¼šè¯è¿‡æœŸ
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœªç™»å½•çŠ¶æ€      â”‚
â”‚ isAuthenticated â”‚
â”‚    = false      â”‚
â”‚ currentUser = nilâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âœ¨ ç‰¹æ€§æ€»ç»“

### âœ… å·²å®ç°
1. **ä¸ªäººä¸­å¿ƒ UI**
   - ç”¨æˆ·ä¿¡æ¯å±•ç¤º
   - è®¾ç½®é€‰é¡¹åˆ—è¡¨
   - é€€å‡ºæŒ‰é’®

2. **é€€å‡ºåŠŸèƒ½**
   - ç¡®è®¤å¼¹çª—
   - åŠ è½½çŠ¶æ€
   - è°ƒç”¨ AuthManager.signOut()
   - è‡ªåŠ¨è·³è½¬ç™»å½•é¡µ

3. **ä¼šè¯ç®¡ç†**
   - çŠ¶æ€ç›‘å¬ï¼ˆauthStateChangesï¼‰
   - è‡ªåŠ¨è¿‡æœŸå¤„ç†
   - Token åˆ·æ–°

4. **å®‰å…¨æ€§**
   - æœåŠ¡å™¨ç«¯æ¸…ç©ºä¼šè¯
   - æœ¬åœ°çŠ¶æ€æ¸…ç†
   - é˜²æ­¢è¯¯æ“ä½œï¼ˆç¡®è®¤å¼¹çª—ï¼‰

### ğŸ¯ ä¼˜åŒ–å»ºè®®ï¼ˆå¯é€‰ï¼‰

1. **Toast æç¤º**
   - é€€å‡ºæˆåŠŸæç¤º
   - ä¼šè¯è¿‡æœŸæç¤º

2. **åŠ¨ç”»æ•ˆæœ**
   - é€€å‡ºæ—¶çš„è¿‡æ¸¡åŠ¨ç”»
   - çŠ¶æ€åˆ‡æ¢åŠ¨ç”»

3. **ç”¨æˆ·å¤´åƒ**
   - æ”¯æŒä¸Šä¼ å¤´åƒ
   - ä» URL åŠ è½½å¤´åƒå›¾ç‰‡

4. **æ›´å¤šè®¾ç½®**
   - ç¼–è¾‘ä¸ªäººèµ„æ–™
   - ä¿®æ”¹å¯†ç 
   - è´¦å·å®‰å…¨è®¾ç½®

---

âœ… **ç™»å‡ºåŠŸèƒ½å·²å®Œæ•´å®ç°ï¼**
