# 如何使用调试面板

## 📱 添加调试入口

在开发模式下，可以通过以下方式快速访问调试面板：

### 方式1: 修改 EarthLordApp.swift（推荐）

在 `EarthLord/EarthLordApp.swift` 中添加调试模式开关：

```swift
@main
struct EarthLordApp: App {
    // 生产模式：正式上架时必须为 false
    private let skipAuthForTesting = false
    private let enableDebugMode = true  // ✅ 新增：启用调试模式

    init() {
        print("🚀🚀🚀 [EarthLordApp] ========== App init 开始 ==========")
        _ = EarthLordEngine.shared
        _ = StoreKitTransactionObserver.shared
        print("🚀🚀🚀 [EarthLordApp] ========== App init 完成 ==========")
    }

    var body: some Scene {
        WindowGroup {
            if enableDebugMode {
                // 调试模式：显示调试面板
                DebugTestView()
            } else if skipAuthForTesting {
                MainTabView()
                    .environmentObject(AuthManager.shared)
            } else {
                AuthFlowView()
            }
        }
    }
}
```

### 方式2: 在 MainTabView 中添加隐藏按钮

在 `EarthLord/Views/MainTabView.swift` 中添加一个隐藏的调试入口：

```swift
// 在某个 Tab 的长按手势中触发
TabView {
    // ... 其他 tabs

    // 添加调试 Tab（仅开发时显示）
    if ProcessInfo.processInfo.environment["XCODE_RUNNING_FOR_PREVIEWS"] == "1" {
        DebugTestView()
            .tabItem {
                Label("调试", systemImage: "wrench.and.screwdriver")
            }
    }
}
```

### 方式3: 通过 TestMenuView（如果存在）

如果项目中有 `TestMenuView.swift`，可以添加调试面板入口：

```swift
NavigationLink(destination: DebugTestView()) {
    Label("调试测试面板", systemImage: "wrench.and.screwdriver")
}
```

---

## 🧪 调试面板功能

### 认证状态
- 显示当前登录状态
- 显示用户 ID 和邮箱
- 检查 Session 是否已验证

### 商城状态
- 显示加载的产品数量
- 如果没有产品，显示可能的原因
- 提供刷新商城按钮

### 邮箱状态
- 显示待领取物资数量
- 提供刷新邮箱按钮

### 领地状态
- 显示是否正在圈地
- 显示采样点数量
- 显示已占领领地数量

### GPS 状态
- 显示位置获取状态
- 显示经纬度坐标
- 显示 GPS 精度（彩色指示）

---

## 🔧 使用方法

### 1. 查看状态
打开调试面板后，所有卡片会显示当前状态：
- ✅ 绿色勾选：功能正常
- ❌ 红色叉号：功能异常

### 2. 刷新数据
点击相应的刷新按钮重新加载数据：
- 🔄 刷新商城：重新加载 StoreKit 产品
- 📬 刷新邮箱：重新加载待领取物资
- 🗺️ 刷新领地：重新加载领地数据

### 3. 运行完整诊断
点击"🧪 运行完整诊断"按钮，会在控制台输出完整的诊断报告：

```
==================================================
🧪 完整诊断结果
==================================================
✅ 认证: 已登录
❌ 商城: 无产品
✅ GPS: 位置正常
✅ 数据库: 领地查询成功 (3 个)
==================================================
```

---

## 📊 诊断结果解读

### ✅ 认证: 已登录
- **正常**：用户已通过 Google/Apple/邮箱登录
- **异常**：需要重新登录

### ❌ 商城: 无产品
- **可能原因**：
  1. App Store Connect 未配置产品
  2. 沙盒账号未登录
  3. Product ID 不匹配
  4. 网络连接问题

### ❌ GPS: 无位置
- **可能原因**：
  1. 位置权限未授予
  2. 定位服务关闭
  3. 室内 GPS 信号弱

### ✅ 数据库: 领地查询成功
- **正常**：Supabase 连接正常，可以查询领地数据
- **异常**：检查网络连接和 Supabase 配置

---

## 🚨 常见问题解决

### 问题1: 商城一直显示"加载商品中"
**诊断**：点击"🔄 刷新商城"，查看控制台日志
**解决**：
1. 检查 App Store Connect 是否配置了产品
2. 在设置中登录沙盒账号
3. 检查 Product ID 是否匹配

### 问题2: 圈地后地图上没有显示新领地
**诊断**：点击"🗺️ 刷新领地"，查看控制台日志
**解决**：
1. 检查用户是否已登录
2. 查看控制台是否有 `territoryAdded` 通知
3. 检查 Supabase 数据库中的 `territories` 表

### 问题3: Google 登录无响应
**诊断**：查看认证状态卡片
**解决**：
1. 检查 Info.plist 中的 URL Scheme 配置
2. 确认 Supabase 项目中启用了 Google Provider
3. 查看控制台的详细错误日志

---

## 📝 测试清单

在真机测试前，确保：

### 认证测试
- [ ] Google 登录可以正常弹出
- [ ] 登录成功后显示用户邮箱
- [ ] 退出登录后状态正确重置

### 商城测试
- [ ] 商城可以正常加载产品
- [ ] 产品价格显示正确
- [ ] 产品图标和描述显示正确

### 邮箱测试
- [ ] 邮箱可以正常加载待领取物资
- [ ] 领取物资功能正常
- [ ] 背包容量显示正确

### 领地测试
- [ ] 圈地功能可以正常启动
- [ ] GPS 采样点正常记录
- [ ] 圈地完成后领地显示在地图上
- [ ] Supabase 数据库中保存了领地数据

### GPS 测试
- [ ] 位置权限正常授予
- [ ] GPS 坐标正常更新
- [ ] 精度在可接受范围内（< 100m）

---

## 🔍 控制台日志

所有操作都会在 Xcode 控制台输出详细日志，查看日志可以快速定位问题：

### 认证日志
```
🔍 [AuthManager] 开始检查 Session...
✅ [AuthManager] Session 检查完成，已登录
  - 用户ID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
  - 邮箱: user@example.com
```

### 商城日志
```
🔄 [商城] 开始加载产品...
✅ [商城] IAPManager 加载了 4 个产品
  - com.earthlord.supply.survivor: 生存者补给包
  - com.earthlord.supply.explorer: 探索者物资包
  - com.earthlord.supply.lord: 领主物资包
  - com.earthlord.supply.overlord: 末日霸主包
📊 [商城] StoreManager 产品总数: 4
```

### 领地日志
```
🔍 [MainMapView] 开始加载领地数据...
✅ [MainMapView] 领地加载成功，共 3 个
  - 领地 #1: 5 个坐标点
  - 领地 #2: 6 个坐标点
  - 领地 #3: 4 个坐标点
```

---

**更新时间**: 2026-02-21
**相关文件**: `DebugTestView.swift`, `EarthLordApp.swift`, `MainTabView.swift`
