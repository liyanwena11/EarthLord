# åˆ é™¤è´¦æˆ·åŠŸèƒ½è¯´æ˜

## âœ… å·²éƒ¨ç½²çš„è¾¹ç¼˜å‡½æ•°

### å‡½æ•°ä¿¡æ¯
- **å‡½æ•°åç§°**ï¼š`delete-account`
- **å‡½æ•° ID**ï¼š`9d70881e-66c2-470b-9486-253b843bdd73`
- **ç‰ˆæœ¬**ï¼šv1
- **çŠ¶æ€**ï¼šACTIVE âœ…
- **JWT éªŒè¯**ï¼šå·²å¯ç”¨ âœ…

### å‡½æ•° URL
```
https://lkekxzssfrspkyxtqysx.supabase.co/functions/v1/delete-account
```

## ğŸ” åŠŸèƒ½è¯´æ˜

### åˆ é™¤æµç¨‹
```
1. éªŒè¯ç”¨æˆ·èº«ä»½ï¼ˆJWT Tokenï¼‰
   â†“
2. è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
   â†“
3. ä½¿ç”¨ service_role æƒé™åˆ é™¤æ•°æ®ï¼š
   - åˆ é™¤ profiles è¡¨æ•°æ®ï¼ˆè‡ªåŠ¨çº§è”åˆ é™¤ territories å’Œ poisï¼‰
   - åˆ é™¤ auth.users ä¸­çš„ç”¨æˆ·è´¦æˆ·
   â†“
4. è¿”å›æˆåŠŸå“åº”
```

### å®‰å…¨ç‰¹æ€§
- âœ… **JWT éªŒè¯**ï¼šè‡ªåŠ¨éªŒè¯ç”¨æˆ·ç™»å½•çŠ¶æ€
- âœ… **èº«ä»½ç¡®è®¤**ï¼šåªèƒ½åˆ é™¤å½“å‰ç™»å½•ç”¨æˆ·çš„è´¦æˆ·
- âœ… **çº§è”åˆ é™¤**ï¼šè‡ªåŠ¨åˆ é™¤æ‰€æœ‰å…³è”æ•°æ®
- âœ… **è¯¦ç»†æ—¥å¿—**ï¼šæ¯ä¸ªæ­¥éª¤éƒ½æœ‰ä¸­æ–‡æ—¥å¿—è®°å½•

## ğŸ“ API æ¥å£

### è¯·æ±‚

**æ–¹æ³•**ï¼š`POST`

**URL**ï¼š
```
https://lkekxzssfrspkyxtqysx.supabase.co/functions/v1/delete-account
```

**è¯·æ±‚å¤´**ï¼š
```http
Content-Type: application/json
Authorization: Bearer <USER_JWT_TOKEN>
```

**è¯·æ±‚ä½“**ï¼š
```json
{}
```
ï¼ˆç©º JSON å¯¹è±¡ï¼Œèº«ä»½ä¿¡æ¯ä» JWT ä¸­è·å–ï¼‰

### å“åº”

#### æˆåŠŸå“åº”ï¼ˆ200ï¼‰
```json
{
  "success": true,
  "message": "è´¦æˆ·å·²æˆåŠŸåˆ é™¤",
  "deleted_user_id": "12345678-1234-1234-1234-123456789012",
  "deleted_email": "user@example.com"
}
```

#### é”™è¯¯å“åº”

**æœªæä¾›è®¤è¯ä¿¡æ¯ï¼ˆ401ï¼‰**
```json
{
  "error": "æœªæä¾›è®¤è¯ä¿¡æ¯"
}
```

**æ— æ•ˆçš„è®¤è¯ä¿¡æ¯ï¼ˆ401ï¼‰**
```json
{
  "error": "æ— æ•ˆçš„è®¤è¯ä¿¡æ¯"
}
```

**ä¸æ”¯æŒçš„è¯·æ±‚æ–¹æ³•ï¼ˆ405ï¼‰**
```json
{
  "error": "ä»…æ”¯æŒ POST è¯·æ±‚"
}
```

**æœåŠ¡å™¨é”™è¯¯ï¼ˆ500ï¼‰**
```json
{
  "error": "åˆ é™¤è´¦æˆ·å¤±è´¥",
  "details": "é”™è¯¯è¯¦æƒ…..."
}
```

## ğŸ“± å®¢æˆ·ç«¯å®ç°

### Swift è°ƒç”¨ç¤ºä¾‹

åˆ›å»º `AccountService.swift`ï¼š

```swift
import Foundation
import Supabase

class AccountService {
    private let supabase = supabaseClient

    /// åˆ é™¤å½“å‰ç”¨æˆ·è´¦æˆ·
    /// - Returns: åˆ é™¤ç»“æœ
    func deleteAccount() async throws -> DeleteAccountResponse {
        print("ğŸ”µ [åˆ é™¤è´¦æˆ·] å¼€å§‹åˆ é™¤è´¦æˆ·æµç¨‹")

        // 1. è·å–å½“å‰ä¼šè¯çš„ JWT token
        let session = try await supabase.auth.session
        let token = session.accessToken

        print("ğŸ”µ [åˆ é™¤è´¦æˆ·] æˆåŠŸè·å– JWT token")

        // 2. è°ƒç”¨è¾¹ç¼˜å‡½æ•°
        let url = URL(string: "https://lkekxzssfrspkyxtqysx.supabase.co/functions/v1/delete-account")!
        var request = URLRequest(url: url)
        request.httpMethod = "POST"
        request.setValue("application/json", forHTTPHeaderField: "Content-Type")
        request.setValue("Bearer \(token)", forHTTPHeaderField: "Authorization")
        request.httpBody = "{}".data(using: .utf8)

        print("ğŸ”µ [åˆ é™¤è´¦æˆ·] å‘é€è¯·æ±‚åˆ°è¾¹ç¼˜å‡½æ•°")

        let (data, response) = try await URLSession.shared.data(for: request)

        guard let httpResponse = response as? HTTPURLResponse else {
            print("âŒ [åˆ é™¤è´¦æˆ·] æ— æ•ˆçš„å“åº”")
            throw AccountError.invalidResponse
        }

        print("ğŸ”µ [åˆ é™¤è´¦æˆ·] æ”¶åˆ°å“åº”ï¼ŒçŠ¶æ€ç : \(httpResponse.statusCode)")

        // 3. è§£æå“åº”
        if httpResponse.statusCode == 200 {
            let result = try JSONDecoder().decode(DeleteAccountResponse.self, from: data)
            print("âœ… [åˆ é™¤è´¦æˆ·] è´¦æˆ·åˆ é™¤æˆåŠŸ")
            print("ğŸ”µ [åˆ é™¤è´¦æˆ·] å·²åˆ é™¤ç”¨æˆ· ID: \(result.deleted_user_id)")
            return result
        } else {
            let errorResponse = try? JSONDecoder().decode(ErrorResponse.self, from: data)
            print("âŒ [åˆ é™¤è´¦æˆ·] åˆ é™¤å¤±è´¥: \(errorResponse?.error ?? "æœªçŸ¥é”™è¯¯")")
            throw AccountError.deleteFailed(errorResponse?.error ?? "åˆ é™¤è´¦æˆ·å¤±è´¥")
        }
    }
}

// MARK: - Response Models

struct DeleteAccountResponse: Codable {
    let success: Bool
    let message: String
    let deleted_user_id: String
    let deleted_email: String
}

struct ErrorResponse: Codable {
    let error: String
    let details: String?
}

// MARK: - Errors

enum AccountError: Error, LocalizedError {
    case invalidResponse
    case deleteFailed(String)

    var errorDescription: String? {
        switch self {
        case .invalidResponse:
            return "æ— æ•ˆçš„æœåŠ¡å™¨å“åº”"
        case .deleteFailed(let message):
            return message
        }
    }
}
```

### åœ¨ ProfileTabView ä¸­ä½¿ç”¨

```swift
// ProfileTabView.swift

@State private var showDeleteAccountAlert = false
@State private var isDeleting = false

// åœ¨ body ä¸­æ·»åŠ åˆ é™¤è´¦æˆ·æŒ‰é’®
var body: some View {
    // ... å…¶ä»–å†…å®¹

    // åˆ é™¤è´¦æˆ·æŒ‰é’®ï¼ˆå±é™©æ“ä½œï¼‰
    Button(action: { showDeleteAccountAlert = true }) {
        HStack {
            Image(systemName: "trash")
            Text("åˆ é™¤è´¦æˆ·")
        }
        .foregroundColor(.red)
        .frame(maxWidth: .infinity)
        .padding()
        .background(Color.red.opacity(0.1))
        .cornerRadius(12)
    }
    .alert("ç¡®è®¤åˆ é™¤è´¦æˆ·", isPresented: $showDeleteAccountAlert) {
        Button("å–æ¶ˆ", role: .cancel) { }
        Button("åˆ é™¤", role: .destructive) {
            handleDeleteAccount()
        }
    } message: {
        Text("âš ï¸ æ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼\\n\\nåˆ é™¤è´¦æˆ·å°†æ°¸ä¹…åˆ é™¤æ‚¨çš„æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬ï¼š\\nâ€¢ ä¸ªäººèµ„æ–™\\nâ€¢ é¢†åœ°ä¿¡æ¯\\nâ€¢ å‘ç°çš„å…´è¶£ç‚¹\\n\\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ")
    }
}

// å¤„ç†åˆ é™¤è´¦æˆ·
private func handleDeleteAccount() {
    isDeleting = true

    Task {
        do {
            let accountService = AccountService()
            let result = try await accountService.deleteAccount()

            print("âœ… è´¦æˆ·åˆ é™¤æˆåŠŸ: \(result.message)")

            // è´¦æˆ·å·²åˆ é™¤ï¼Œé€€å‡ºç™»å½•
            await authManager.signOut()

        } catch {
            print("âŒ åˆ é™¤è´¦æˆ·å¤±è´¥: \(error.localizedDescription)")
            authManager.errorMessage = "åˆ é™¤è´¦æˆ·å¤±è´¥ï¼š\(error.localizedDescription)"
        }

        isDeleting = false
    }
}
```

## ğŸ” æ—¥å¿—è¾“å‡º

### æˆåŠŸåˆ é™¤
```
ğŸ”µ [åˆ é™¤è´¦æˆ·] å¼€å§‹å¤„ç†åˆ é™¤è´¦æˆ·è¯·æ±‚
ğŸ”µ [åˆ é™¤è´¦æˆ·] æˆåŠŸè·å– JWT token
ğŸ”µ [åˆ é™¤è´¦æˆ·] éªŒè¯ç”¨æˆ·èº«ä»½...
âœ… [åˆ é™¤è´¦æˆ·] ç”¨æˆ·éªŒè¯æˆåŠŸ
ğŸ”µ [åˆ é™¤è´¦æˆ·] ç”¨æˆ· ID: 12345678-1234-1234-1234-123456789012
ğŸ”µ [åˆ é™¤è´¦æˆ·] ç”¨æˆ·é‚®ç®±: user@example.com
ğŸ”µ [åˆ é™¤è´¦æˆ·] å¼€å§‹åˆ é™¤ç”¨æˆ·æ•°æ®...
ğŸ”µ [åˆ é™¤è´¦æˆ·] åˆ é™¤ç”¨æˆ·èµ„æ–™æ•°æ®...
âœ… [åˆ é™¤è´¦æˆ·] æˆåŠŸåˆ é™¤ç”¨æˆ·èµ„æ–™æ•°æ®
ğŸ”µ [åˆ é™¤è´¦æˆ·] åˆ é™¤ç”¨æˆ·è´¦æˆ·...
âœ… [åˆ é™¤è´¦æˆ·] æˆåŠŸåˆ é™¤ç”¨æˆ·è´¦æˆ·
âœ… [åˆ é™¤è´¦æˆ·] è´¦æˆ·åˆ é™¤å®Œæˆ
```

### æœªè®¤è¯é”™è¯¯
```
ğŸ”µ [åˆ é™¤è´¦æˆ·] å¼€å§‹å¤„ç†åˆ é™¤è´¦æˆ·è¯·æ±‚
âŒ [åˆ é™¤è´¦æˆ·] ç¼ºå°‘ Authorization header
```

### æ— æ•ˆ Token
```
ğŸ”µ [åˆ é™¤è´¦æˆ·] å¼€å§‹å¤„ç†åˆ é™¤è´¦æˆ·è¯·æ±‚
ğŸ”µ [åˆ é™¤è´¦æˆ·] æˆåŠŸè·å– JWT token
ğŸ”µ [åˆ é™¤è´¦æˆ·] éªŒè¯ç”¨æˆ·èº«ä»½...
âŒ [åˆ é™¤è´¦æˆ·] ç”¨æˆ·éªŒè¯å¤±è´¥: Invalid JWT
```

## ğŸ§ª æµ‹è¯•

### ä½¿ç”¨ curl æµ‹è¯•

```bash
# 1. å…ˆç™»å½•è·å– token
curl -X POST 'https://lkekxzssfrspkyxtqysx.supabase.co/auth/v1/token?grant_type=password' \
-H 'apikey: YOUR_ANON_KEY' \
-H 'Content-Type: application/json' \
-d '{
  "email": "test@example.com",
  "password": "password123"
}'

# 2. ä½¿ç”¨è¿”å›çš„ access_token è°ƒç”¨åˆ é™¤å‡½æ•°
curl -X POST 'https://lkekxzssfrspkyxtqysx.supabase.co/functions/v1/delete-account' \
-H 'Authorization: Bearer YOUR_ACCESS_TOKEN' \
-H 'Content-Type: application/json' \
-d '{}'
```

### æµ‹è¯•åœºæ™¯

1. **æ­£å¸¸åˆ é™¤**
   - ç™»å½•è´¦æˆ·
   - è°ƒç”¨åˆ é™¤å‡½æ•°
   - éªŒè¯å“åº”çŠ¶æ€ 200
   - æ£€æŸ¥æ•°æ®åº“ä¸­ç”¨æˆ·å·²è¢«åˆ é™¤

2. **æœªç™»å½•åˆ é™¤**
   - ä¸æä¾› Authorization header
   - éªŒè¯å“åº”çŠ¶æ€ 401
   - é”™è¯¯ä¿¡æ¯ï¼š"æœªæä¾›è®¤è¯ä¿¡æ¯"

3. **æ— æ•ˆ Token**
   - æä¾›è¿‡æœŸæˆ–æ— æ•ˆçš„ token
   - éªŒè¯å“åº”çŠ¶æ€ 401
   - é”™è¯¯ä¿¡æ¯ï¼š"æ— æ•ˆçš„è®¤è¯ä¿¡æ¯"

4. **æ•°æ®çº§è”åˆ é™¤**
   - åˆ›å»ºç”¨æˆ·å¹¶æ·»åŠ æ•°æ®ï¼ˆprofile, territories, poisï¼‰
   - åˆ é™¤è´¦æˆ·
   - éªŒè¯æ‰€æœ‰å…³è”æ•°æ®éƒ½è¢«åˆ é™¤

## ğŸ“Š æ•°æ®åº“çº§è”å…³ç³»

```
auth.users (ç”¨æˆ·è´¦æˆ·)
  â†“ ON DELETE CASCADE
profiles (ç”¨æˆ·èµ„æ–™)
  â†“ ON DELETE CASCADE
  â”œâ”€ territories (é¢†åœ°)
  â””â”€ pois (å…´è¶£ç‚¹)
```

å½“åˆ é™¤ `auth.users` ä¸­çš„ç”¨æˆ·æ—¶ï¼š
1. âœ… `profiles` è¡¨ä¸­çš„è®°å½•è‡ªåŠ¨åˆ é™¤ï¼ˆå› ä¸ºå¤–é”® `id` å¼•ç”¨ `auth.users.id`ï¼‰
2. âœ… `territories` è¡¨ä¸­çš„è®°å½•è‡ªåŠ¨åˆ é™¤ï¼ˆå› ä¸ºå¤–é”® `user_id` å¼•ç”¨ `profiles.id`ï¼‰
3. âœ… `pois` è¡¨ä¸­çš„è®°å½•ä¸­ `discovered_by` å­—æ®µè®¾ä¸º NULLï¼ˆå› ä¸º `ON DELETE SET NULL`ï¼‰

## âš ï¸ å®‰å…¨æ³¨æ„äº‹é¡¹

### 1. äºŒæ¬¡ç¡®è®¤
- åˆ é™¤è´¦æˆ·å‰å¿…é¡»æ˜¾ç¤ºç¡®è®¤å¼¹çª—
- æ˜ç¡®å‘ŠçŸ¥ç”¨æˆ·åˆ é™¤åæœ
- å»ºè®®æ·»åŠ è¾“å…¥ç¡®è®¤æ–‡å­—ï¼ˆå¦‚"åˆ é™¤"ï¼‰

### 2. æƒé™æ§åˆ¶
- âœ… JWT éªŒè¯ç¡®ä¿åªæœ‰ç™»å½•ç”¨æˆ·æ‰èƒ½è°ƒç”¨
- âœ… ç”¨æˆ·åªèƒ½åˆ é™¤è‡ªå·±çš„è´¦æˆ·
- âœ… Service role key ä»…åœ¨è¾¹ç¼˜å‡½æ•°ä¸­ä½¿ç”¨

### 3. æ•°æ®å¤‡ä»½
- å»ºè®®åœ¨åˆ é™¤å‰åˆ›å»ºæ•°æ®å¤‡ä»½
- å¯ä»¥è€ƒè™‘"è½¯åˆ é™¤"ï¼ˆæ ‡è®°ä¸ºå·²åˆ é™¤è€Œä¸æ˜¯ç‰©ç†åˆ é™¤ï¼‰

### 4. å®¡è®¡æ—¥å¿—
- å¯ä»¥åœ¨åˆ é™¤å‰è®°å½•æ“ä½œæ—¥å¿—
- ä¿å­˜åˆ é™¤æ—¶é—´ã€ç”¨æˆ· IDã€é‚®ç®±ç­‰ä¿¡æ¯

## ğŸ”„ å®Œæ•´åˆ é™¤æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»"åˆ é™¤è´¦æˆ·"
  â†“
æ˜¾ç¤ºç¡®è®¤å¼¹çª—ï¼ˆè¯¦ç»†è¯´æ˜åæœï¼‰
  â†“
ç”¨æˆ·ç¡®è®¤åˆ é™¤
  â†“
è°ƒç”¨ deleteAccount()
  â†“
è·å–å½“å‰ç”¨æˆ·çš„ JWT token
  â†“
å‘é€ POST è¯·æ±‚åˆ°è¾¹ç¼˜å‡½æ•°
  â†“
è¾¹ç¼˜å‡½æ•°éªŒè¯ JWT
  â†“
è¾¹ç¼˜å‡½æ•°è·å–ç”¨æˆ·ä¿¡æ¯
  â†“
è¾¹ç¼˜å‡½æ•°åˆ é™¤æ•°æ®ï¼š
  â”œâ”€ profiles è¡¨æ•°æ®
  â”‚   â”œâ”€ territories (çº§è”åˆ é™¤)
  â”‚   â””â”€ pois (è®¾ä¸º NULL)
  â””â”€ auth.users è´¦æˆ·
  â†“
è¿”å›æˆåŠŸå“åº”
  â†“
å®¢æˆ·ç«¯è‡ªåŠ¨é€€å‡ºç™»å½•
  â†“
è·³è½¬åˆ°ç™»å½•é¡µé¢
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Supabase Edge Functions](https://supabase.com/docs/guides/functions)
- [Supabase Auth Admin API](https://supabase.com/docs/reference/javascript/auth-admin-deleteuser)
- [Supabase JWT](https://supabase.com/docs/guides/auth/jwts)

---

âœ… **åˆ é™¤è´¦æˆ·è¾¹ç¼˜å‡½æ•°å·²æˆåŠŸéƒ¨ç½²å¹¶å¯ä»¥ä½¿ç”¨ï¼**

è¯·æ ¹æ®ä¸Šè¿°ç¤ºä¾‹ä»£ç åœ¨å®¢æˆ·ç«¯å®ç°è°ƒç”¨é€»è¾‘ã€‚
