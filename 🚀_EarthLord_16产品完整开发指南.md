# ğŸš€ EarthLord 16 äº§å“å®Œæ•´å¼€å‘æŒ‡å—

**ç‰ˆæœ¬**: 2.0 (å®Œæ•´ç‰ˆ)  
**åˆ›å»ºæ—¥æœŸ**: 2026-02-24  
**å¼€å‘å‘¨æœŸ**: 21 å¤©ï¼ˆ3ä¸ªé˜¶æ®µï¼‰  
**ç›®æ ‡**: æ„å»ºå®Œæ•´çš„ä¸‰å±‚ä»˜è´¹ç³»ç»Ÿï¼ˆæ¶ˆè€—æ€§ + éç»­æœŸè®¢é˜… + è‡ªåŠ¨ç»­æœŸè®¢é˜…ï¼‰  

---

## ğŸ“‹ æ–‡æ¡£å¿«é€Ÿå¯¼èˆª

| ç« èŠ‚ | å†…å®¹ | å·¥ä½œé‡ | ä¼˜å…ˆçº§ |
|------|------|------|-------|
| [1. æ•´ä½“æ¶æ„](#1-æ•´ä½“æ¶æ„) | ç³»ç»Ÿè®¾è®¡ã€æ•°æ®æµã€é›†æˆç‚¹ | 2h | ğŸ”´ å¿…è¯» |
| [2. äº§å“å®šä¹‰](#2-16äº§å“å®Œæ•´å®šä¹‰) | 16ä¸ªäº§å“é…ç½®ã€æƒç›Šæ˜ å°„ | 3h | ğŸ”´ å¿…è¯» |
| [3. ä»£ç å®ç°](#3-ä»£ç å®ç°æŒ‡å—) | IAPModelsã€IAPManagerã€UIç»„ä»¶ | 12h | ğŸ”´ å¿…è¯» |
| [4. æ•°æ®åº“è®¾è®¡](#4-æ•°æ®åº“è®¾è®¡) | è¡¨ç»“æ„ã€RLS ç­–ç•¥ã€è¿ç§»è„šæœ¬ | 3h | ğŸ”´ å¿…è¯» |
| [5. æƒç›Šç³»ç»Ÿ](#5-æƒç›Šç³»ç»Ÿé›†æˆ) | æƒç›Šåˆ¤æ–­ã€æƒé™ç®¡ç†ã€UIé€‚é… | 6h | ğŸŸ¡ é‡è¦ |
| [6. æµ‹è¯•ç­–ç•¥](#6-å®Œæ•´æµ‹è¯•ç­–ç•¥) | æµ‹è¯•åœºæ™¯ã€æ²™ç›’é…ç½®ã€éªŒè¯æ¸…å• | 8h | ğŸŸ¡ é‡è¦ |
| [7. App Store é…ç½®](#7-app-store-connect-å®Œæ•´é…ç½®) | äº§å“ç”³æŠ¥ã€æœ¬åœ°åŒ–ã€å®šä»· | 4h | ğŸŸ¡ é‡è¦ |
| [8. 21å¤©å®æ–½è®¡åˆ’](#8-21å¤©åˆ†é˜¶æ®µå®æ–½è®¡åˆ’) | æ—¥æœŸåˆ†è§£ã€é‡Œç¨‹ç¢‘ã€é£é™©æ§åˆ¶ | å‚è€ƒ | ğŸŸ¢ å‚è€ƒ |
| [9. æ•…éšœæ’æŸ¥](#9-æ•…éšœæ’æŸ¥æŒ‡å—) | å¸¸è§é—®é¢˜ã€è°ƒè¯•æŠ€å·§ã€è§£å†³æ–¹æ¡ˆ | å‚è€ƒ | ğŸŸ¢ å‚è€ƒ |

---

## 1. æ•´ä½“æ¶æ„

### 1.1 ç³»ç»Ÿè®¾è®¡æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     EarthLord ä»˜è´¹ç³»ç»Ÿæ¶æ„                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              ç”¨æˆ·ç•Œé¢å±‚ (SwiftUI Views)                â”‚   â”‚
â”‚  â”‚  â”œâ”€ ä¸»èœå• â†’ ä»˜è´¹å…¥å£                                   â”‚   â”‚
â”‚  â”‚  â”œâ”€ å•†åº— (Store View)                                 â”‚   â”‚
â”‚  â”‚  â”œâ”€ è¡¥ç»™åŒ…é€‰æ‹©ç•Œé¢                                      â”‚   â”‚
â”‚  â”‚  â”œâ”€ è®¢é˜…æœˆå¡é€‰æ‹©ç•Œé¢                                    â”‚   â”‚
â”‚  â”‚  â””â”€ VIP ä¼šå‘˜é€‰æ‹©ç•Œé¢                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                          â†“                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚          ä¸šåŠ¡é€»è¾‘å±‚ (IAPManager + æƒç›Šç®¡ç†)              â”‚   â”‚
â”‚  â”‚  â”œâ”€ äº§å“ç®¡ç† (16 products)                            â”‚   â”‚
â”‚  â”‚  â”œâ”€ äº¤æ˜“å¤„ç†                                           â”‚   â”‚
â”‚  â”‚  â”œâ”€ è®¢é˜…çŠ¶æ€æ£€æŸ¥                                        â”‚   â”‚
â”‚  â”‚  â”œâ”€ æƒç›Šæ£€æŸ¥ & æˆäºˆ                                     â”‚   â”‚
â”‚  â”‚  â””â”€ æ¢å¤è´­ä¹°                                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                          â†“                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   æœ¬åœ°å­˜å‚¨                 â”‚     è¿œç¨‹åŒæ­¥              â”‚    â”‚
â”‚  â”‚  â”œâ”€ UserDefaults         â”‚  â”œâ”€ Supabase Auth      â”‚    â”‚
â”‚  â”‚  â”œâ”€ Keychain             â”‚  â”œâ”€ user_subscriptions  â”‚    â”‚
â”‚  â”‚  â””â”€ æ¨é€æ”¶æ®              â”‚  â”œâ”€ subscription_audit   â”‚    â”‚
â”‚  â”‚                           â”‚  â””â”€ RLS ç­–ç•¥            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                          â†“                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚        æ¸¸æˆç³»ç»Ÿé›†æˆ (å„åŠŸèƒ½æ¨¡å—)                         â”‚   â”‚
â”‚  â”‚  â”œâ”€ å»ºç­‘ç³»ç»Ÿ (åŠ é€Ÿæƒç›Š)                                â”‚   â”‚
â”‚  â”‚  â”œâ”€ ç”Ÿäº§ç³»ç»Ÿ (èµ„æºæƒç›Š)                                â”‚   â”‚
â”‚  â”‚  â”œâ”€ èƒŒåŒ…ç³»ç»Ÿ (å®¹é‡æƒç›Š)                                â”‚   â”‚
â”‚  â”‚  â”œâ”€ ç¤¾äº¤ç³»ç»Ÿ (VIP æƒç›Š)                               â”‚   â”‚
â”‚  â”‚  â””â”€ æ’è¡Œæ¦œ (ä¼šå‘˜æƒç›Š)                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                          â†“                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              StoreKit 2 æ¡†æ¶ (Apple)                  â”‚   â”‚
â”‚  â”‚  â”œâ”€ Transaction ç›‘å¬                                 â”‚   â”‚
â”‚  â”‚  â”œâ”€ Product æŸ¥è¯¢ & ç¼“å­˜                               â”‚   â”‚
â”‚  â”‚  â”œâ”€ Subscription çŠ¶æ€                                â”‚   â”‚
â”‚  â”‚  â””â”€ æ”¶æ®éªŒè¯                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ”¯ä»˜æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·ç‚¹å‡»â”‚
â”‚ è´­ä¹°    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ˜¾ç¤º SKPaymentQueue â”‚
â”‚ Apple æ”¯ä»˜ç•Œé¢       â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€ ç”¨æˆ·æ”¯ä»˜æˆåŠŸ â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                  â”‚ è·å–æ”¶æ®     â”‚
     â”‚                  â”‚ æœ¬åœ°ä¿å­˜     â”‚
     â”‚                  â”‚ æœåŠ¡ç«¯éªŒè¯   â”‚
     â”‚                  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                       â”‚
     â”‚                       â†“
     â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                  â”‚ æˆäºˆæƒç›Š         â”‚
     â”‚                  â”‚ æ›´æ–°æœ¬åœ°ç¼“å­˜     â”‚
     â”‚                  â”‚ åŒæ­¥åˆ° Supabase  â”‚
     â”‚                  â”‚ å‘é€é€šçŸ¥         â”‚
     â”‚                  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                       â”‚
     â”‚                       â†“
     â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                  â”‚ âœ… å®Œæˆ           â”‚
     â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€ ç”¨æˆ·å–æ¶ˆ â”€â”€â†’ âŒ æµç¨‹ä¸­æ–­
     â”‚
     â””â”€ æ”¯ä»˜å¤±è´¥ â”€â”€â†’ âŒ æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
```

### 1.3 æ•°æ®æµ

```
ç”¨æˆ·æ“ä½œ
  â†“
View (é€‰æ‹©äº§å“)
  â†“
IAPManager (å¤„ç†è´­ä¹°)
  â†“
StoreKit 2 (å‘èµ·äº¤æ˜“)
  â†“
Apple æœåŠ¡å™¨ (éªŒè¯æ”¯ä»˜)
  â†“
IAPManager (éªŒè¯æ”¶æ®)
  â†“
Supabase (è®°å½•è®¢é˜…)
  â†“
æƒç›Šç³»ç»Ÿ (æˆäºˆæƒç›Š)
  â†“
æ¸¸æˆç³»ç»Ÿ (åº”ç”¨æƒç›Š)
  â†“
æœ¬åœ° UI æ›´æ–°
  â†“
ç”¨æˆ·çœ‹åˆ°æƒç›Šç”Ÿæ•ˆ
```

### 1.4 å…³é”®é›†æˆç‚¹

#### æƒç›Šæˆäºˆæµç¨‹
```swift
è´­ä¹°æˆåŠŸ
  â†“
IAPManager.handlePurchase(transactionID)
  â†“
éªŒè¯æ”¶æ® & äº§å“ç±»å‹
  â†“
è°ƒç”¨æƒç›Šç³»ç»Ÿ: RightsManager.grantRights(product)
  â†“
RightsManager åˆ¤æ–­æƒç›Šç±»å‹:
  â”œâ”€ æ¶ˆè€—æ€§: BuildingManager.addSpeedup()
  â”œâ”€ éç»­æœŸ: SubscriptionManager.activateTemporaryPerks()
  â””â”€ ç»­æœŸ: SubscriptionManager.activateAutoRenewPerks()
  â†“
å„ç³»ç»Ÿåº”ç”¨æƒç›Š
  â†“
æ›´æ–° UI & é€šçŸ¥ç”¨æˆ·
```

---

## 2. 16 äº§å“å®Œæ•´å®šä¹‰

### 2.1 äº§å“åˆ†ç±»ç»“æ„

```
IAP äº§å“ç»“æ„ (16 ä¸ªäº§å“)
â”œâ”€ æ¶ˆè€—æ€§ (Consumable) Ã— 4
â”‚  â”œâ”€ com.earthlord.supply.survivor    (Â¥6)
â”‚  â”œâ”€ com.earthlord.supply.explorer    (Â¥18)
â”‚  â”œâ”€ com.earthlord.supply.lord        (Â¥30)
â”‚  â””â”€ com.earthlord.supply.overlord    (Â¥68)
â”‚
â”œâ”€ éç»­æœŸè®¢é˜… (Non-Renewing) Ã— 9
â”‚  â”œâ”€ æˆ˜æœ¯æ”¯æ´ (3ä¸ª)
â”‚  â”‚  â”œâ”€ com.earthlord.tactical.1m     (Â¥8, 30å¤©)
â”‚  â”‚  â”œâ”€ com.earthlord.tactical.3m     (Â¥18, 90å¤©)
â”‚  â”‚  â””â”€ com.earthlord.tactical.1y     (Â¥58, 365å¤©)
â”‚  â”œâ”€ é¢†ä¸»ç‰¹æƒ (3ä¸ª)
â”‚  â”‚  â”œâ”€ com.earthlord.lordship.1m     (Â¥18, 30å¤©)
â”‚  â”‚  â”œâ”€ com.earthlord.lordship.3m     (Â¥38, 90å¤©)
â”‚  â”‚  â””â”€ com.earthlord.lordship.1y     (Â¥128, 365å¤©)
â”‚  â””â”€ å¸å›½ç»Ÿæ²»è€… (3ä¸ª)
â”‚     â”œâ”€ com.earthlord.empire.1m       (Â¥38, 30å¤©)
â”‚     â”œâ”€ com.earthlord.empire.3m       (Â¥88, 90å¤©)
â”‚     â””â”€ com.earthlord.empire.1y       (Â¥298, 365å¤©)
â”‚
â””â”€ è‡ªåŠ¨ç»­æœŸè®¢é˜… (Auto-Renewable) Ã— 4
   â”œâ”€ com.earthlord.vip.monthly        (Â¥12/æœˆ)
   â”œâ”€ com.earthlord.vip.monthly.trial  (Â¥6/æœˆ, é¦–æœˆ)
   â”œâ”€ com.earthlord.vip.quarterly      (Â¥28/3æœˆ)
   â””â”€ com.earthlord.vip.annual         (Â¥88/å¹´)
```

### 2.2 äº§å“è¯¦ç»†è§„æ ¼è¡¨

#### æ¶ˆè€—æ€§äº§å“

| ID | åç§° | ä»·æ ¼ | å—ä¼— | æƒç›Š | ç±»å‹ |
|----|------|------|------|------|------|
| 1 | survivor | Â¥6 | æ–°æ‰‹ | åŸºç¡€èµ„æºåŒ… | Consumable |
| 2 | explorer | Â¥18 | æ´»è·ƒ | ä¸­çº§èµ„æºåŒ… | Consumable |
| 3 | lord | Â¥30 | æ ¸å¿ƒ | é«˜çº§èµ„æºåŒ… | Consumable |
| 4 | overlord | Â¥68 | é‡åº¦ | ç¨€æœ‰èµ„æºåŒ… | Consumable |

**æ¶ˆè€—æ€§æƒç›Šæ˜ç»†**:
```
Survivor (Â¥6):
- æœ¨æ Ã—300
- çŸ³å¤´ Ã—300
- é‡‘å± Ã—150
- æ°´ Ã—300

Explorer (Â¥18):
- æœ¨æ Ã—1000
- çŸ³å¤´ Ã—1000
- é‡‘å± Ã—500
- æ°´ Ã—1000
- é£Ÿç‰© Ã—500
- åŒ»ç–—å“ Ã—200

Lord (Â¥30):
- æœ¨æ Ã—2000
- çŸ³å¤´ Ã—2000
- é‡‘å± Ã—1000
- ç¨€æœ‰é‡‘å± Ã—200
- åŒ»ç–—å“ Ã—500
- ç‡ƒæ–™ Ã—300

Overlord (Â¥68):
- æœ¨æ Ã—5000
- çŸ³å¤´ Ã—5000
- é‡‘å± Ã—2500
- ç¨€æœ‰é‡‘å± Ã—500
- ä¼ å¥‡ç¢ç‰‡ Ã—50
- åŒ»ç–—å“ Ã—1000
- ç‡ƒæ–™ Ã—800
```

#### éç»­æœŸè®¢é˜… - æˆ˜æœ¯æ”¯æ´åŒ…

| ID | æ—¶é•¿ | ä»·æ ¼ | æœˆå‡ | æƒç›Šç­‰çº§ |
|----|------|------|------|---------|
| 5 | 30å¤© | Â¥8 | Â¥8 | â­ åŸºç¡€ |
| 6 | 90å¤© | Â¥18 | Â¥6 | â­ åŸºç¡€ |
| 7 | 365å¤© | Â¥58 | Â¥4.8 | â­ åŸºç¡€ |

**æƒç›Š**:
- âš¡ å»ºé€ æ—¶é—´ -20%
- âŒ› ç”Ÿäº§å‘¨æœŸ -15%
- ğŸ‘œ èƒŒåŒ…å®¹é‡ +25 kg
- ğŸ æ¯æ—¥ç™»å½• Â¥500 èµ„æºå¸
- ğŸ›ï¸ VIP å•†åº— 10% æŠ˜æ‰£
- ğŸ“ æ¯å¤© 3 æ¬¡å¿«é€Ÿä¼ é€

#### éç»­æœŸè®¢é˜… - é¢†ä¸»ç‰¹æƒåŒ…

| ID | æ—¶é•¿ | ä»·æ ¼ | æœˆå‡ | æƒç›Šç­‰çº§ |
|----|------|------|------|---------|
| 8 | 30å¤© | Â¥18 | Â¥18 | â­â­ é«˜çº§ |
| 9 | 90å¤© | Â¥38 | Â¥12.7 | â­â­ é«˜çº§ |
| 10 | 365å¤© | Â¥128 | Â¥10.7 | â­â­ é«˜çº§ |

**æƒç›Š** (åŒ…å«æˆ˜æœ¯æ”¯æ´ + ):
- âš¡ å»ºé€ æ—¶é—´ -40%
- âŒ› ç”Ÿäº§å‘¨æœŸ -30%
- ğŸ“ˆ èµ„æºäº§å‡º +20%
- ğŸ‘œ èƒŒåŒ…å®¹é‡ +50 kg
- ğŸ† æ¯å‘¨é™å®šæŒ‘æˆ˜
- ğŸ’ VIP åç‰Œæ˜¾ç¤º
- ğŸ›ï¸ VIP å•†åº— 20% æŠ˜æ‰£

#### éç»­æœŸè®¢é˜… - å¸å›½ç»Ÿæ²»è€…åŒ…

| ID | æ—¶é•¿ | ä»·æ ¼ | æœˆå‡ | æƒç›Šç­‰çº§ |
|----|------|------|------|---------|
| 11 | 30å¤© | Â¥38 | Â¥38 | â­â­â­ é¡¶çº§ |
| 12 | 90å¤© | Â¥88 | Â¥29.3 | â­â­â­ é¡¶çº§ |
| 13 | 365å¤© | Â¥298 | Â¥24.8 | â­â­â­ é¡¶çº§ |

**æƒç›Š** (åŒ…å«é¢†ä¸»ç‰¹æƒ + ):
- âš¡ å»ºé€ æ—¶é—´ -60%
- âŒ› ç”Ÿäº§å‘¨æœŸ -50%
- ğŸ“ˆ èµ„æºäº§å‡º +40%
- ğŸ‘œ èƒŒåŒ…å®¹é‡ +100 kg
- ğŸŒŸ æ¯æœˆç¨€æœ‰ç‰©èµ„ç®± (Â¥98 ä»·å€¼)
- ğŸ¯ æ— é™å»ºé€ é˜Ÿåˆ—
- ğŸ° é¢†åœ°é˜²å¾¡ +15%
- ğŸ’¬ ä¸“å±å®¢æœæ”¯æŒ

#### è‡ªåŠ¨ç»­æœŸè®¢é˜… - VIP ä¼šå‘˜

| ID | å‘¨æœŸ | ä»·æ ¼ | ç»­è´¹ | æƒç›Šç­‰çº§ |
|----|------|------|------|---------|
| 14 | æœˆ | Â¥12/æœˆ | è‡ªåŠ¨ | ğŸŸ¢ æœˆä¼š |
| 15 | æœˆè¯•ç”¨ | Â¥6/æœˆ | è‡ªåŠ¨ | ğŸŸ¢ è¯•ç”¨ |
| 16 | å­£/å¹´ | Â¥28/å­£æˆ–Â¥88/å¹´ | è‡ªåŠ¨ | ğŸŸ¢ æœŸæƒ |

**æƒç›Š**:
- âœ… åŒ…å«æˆ˜æœ¯æ”¯æ´æ‰€æœ‰æƒç›Š
- ğŸ æ¯æœˆ Â¥20-50 è¡¥ç»™åˆ¸
- ğŸ“Š æœˆåº¦æ’è¡Œæ¦œå‚èµ›
- ğŸ† ä¸“å±å¾½ç« ç³»ç»Ÿ
- ğŸ® æŠ¢å…ˆæµ‹è¯•æ–°åŠŸèƒ½
- ğŸ“… æ¯æœˆç™»å½•å¥–åŠ±

### 2.3 æƒç›ŠçŸ©é˜µè¡¨

```
æƒç›Š\è®¢é˜…ç±»å‹        | æ¶ˆè€—æ€§ | æˆ˜æœ¯  | é¢†ä¸»  | å¸å›½  | VIPæœˆ |
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€
å»ºé€ æ—¶é—´åŠ é€Ÿ          | æ—      | -20%  | -40%  | -60%  | -20%  |
ç”Ÿäº§åŠ é€Ÿ             | æ—      | -15%  | -30%  | -50%  | -15%  |
èµ„æºäº§å‡ºåŠ æˆ          | æ—      | æ—     | +20%  | +40%  | æ—     |
èƒŒåŒ…å®¹é‡             | æ—      | +25kg | +50kg | +100kg| +25kg |
æ¯æ—¥ç™»å½•å¥–åŠ±          | æ—      | Â¥500  | Â¥500  | Â¥500  | Â¥500  |
VIP å•†åº—æŠ˜æ‰£         | æ—      | 10%   | 20%   | 20%   | 10%   |
å¿«é€Ÿä¼ é€(æ¯å¤©)        | æ—      | 3æ¬¡   | 3æ¬¡   | 3æ¬¡   | 3æ¬¡   |
ä¸“å±æ´»åŠ¨å‚èµ›         | æ—      | æ—     | æ¯å‘¨  | æ¯æœˆ  | æ¯æœˆ  |
VIP åç‰Œæ•ˆæœ        | æ—      | æ—     | æ˜¯    | æ˜¯    | å¦    |
æ— é™å»ºé€ é˜Ÿåˆ—         | æ—      | æ—     | æ—     | æ˜¯    | æ—     |
é¢†åœ°é˜²å¾¡åŠ æˆ         | æ—      | æ—     | æ—     | +15%  | æ—     |
ä¸“å±å®¢æœæ”¯æŒ         | æ—      | æ—     | æ—     | æ˜¯    | å¦    |
ç¨€æœ‰ç‰©èµ„ç®±(æœˆ)        | æ—      | æ—     | æ—     | æ˜¯    | å¦    |
è¡¥ç»™åˆ¸(æœˆ)           | æ—      | æ—     | æ—     | æ—     | Â¥20-50|
```

---

## 3. ä»£ç å®ç°æŒ‡å—

### 3.1 IAPModels.swift (å®Œæ•´ç‰ˆ)

è¿™ä¸ªæ–‡ä»¶å®šä¹‰äº†æ‰€æœ‰ 16 ä¸ªäº§å“çš„æ¨¡å‹å’Œæƒç›Šç³»ç»Ÿã€‚

```swift
import Foundation
import StoreKit

// MARK: - äº§å“ID å¸¸é‡å®šä¹‰

struct IAPProductID {
    
    // MARK: æ¶ˆè€—æ€§äº§å“ (Consumable)
    static let consumableProductIDs = Set([
        "com.earthlord.supply.survivor",
        "com.earthlord.supply.explorer",
        "com.earthlord.supply.lord",
        "com.earthlord.supply.overlord"
    ])
    
    // MARK: éç»­æœŸè®¢é˜… - æˆ˜æœ¯æ”¯æ´åŒ…
    static let tacticalProductIDs = Set([
        "com.earthlord.tactical.1m",
        "com.earthlord.tactical.3m",
        "com.earthlord.tactical.1y"
    ])
    
    // MARK: éç»­æœŸè®¢é˜… - é¢†ä¸»ç‰¹æƒåŒ…
    static let lordshipProductIDs = Set([
        "com.earthlord.lordship.1m",
        "com.earthlord.lordship.3m",
        "com.earthlord.lordship.1y"
    ])
    
    // MARK: éç»­æœŸè®¢é˜… - å¸å›½ç»Ÿæ²»è€…åŒ…
    static let empireProductIDs = Set([
        "com.earthlord.empire.1m",
        "com.earthlord.empire.3m",
        "com.earthlord.empire.1y"
    ])
    
    // MARK: è‡ªåŠ¨ç»­æœŸè®¢é˜… - VIP ä¼šå‘˜
    static let vipProductIDs = Set([
        "com.earthlord.vip.monthly",
        "com.earthlord.vip.monthly.trial",
        "com.earthlord.vip.quarterly",
        "com.earthlord.vip.annual"
    ])
    
    // MARK: æ‰€æœ‰äº§å“ ID
    static let allProductIDs = consumableProductIDs
        .union(tacticalProductIDs)
        .union(lordshipProductIDs)
        .union(empireProductIDs)
        .union(vipProductIDs)
    
    // MARK: é€šç”¨æ–¹æ³•
    static func isMembershipProduct(_ productID: String) -> Bool {
        return tacticalProductIDs.contains(productID) ||
               lordshipProductIDs.contains(productID) ||
               empireProductIDs.contains(productID) ||
               vipProductIDs.contains(productID)
    }
    
    static func getProductCategory(_ productID: String) -> ProductCategory {
        if consumableProductIDs.contains(productID) {
            return .consumable
        } else if tacticalProductIDs.contains(productID) {
            return .tactical
        } else if lordshipProductIDs.contains(productID) {
            return .lordship
        } else if empireProductIDs.contains(productID) {
            return .empire
        } else if vipProductIDs.contains(productID) {
            return .vip
        }
        return .unknown
    }
}

// MARK: - äº§å“åˆ†ç±»æšä¸¾

enum ProductCategory: String, Codable {
    case consumable = "consumable"          // æ¶ˆè€—æ€§
    case tactical = "tactical"               // æˆ˜æœ¯æ”¯æ´
    case lordship = "lordship"               // é¢†ä¸»ç‰¹æƒ
    case empire = "empire"                   // å¸å›½ç»Ÿæ²»è€…
    case vip = "vip"                         // VIPä¼šå‘˜
    case unknown = "unknown"
    
    var displayName: String {
        switch self {
        case .consumable: return "è¡¥ç»™åŒ…"
        case .tactical: return "æˆ˜æœ¯æ”¯æ´"
        case .lordship: return "é¢†ä¸»ç‰¹æƒ"
        case .empire: return "å¸å›½ç»Ÿæ²»è€…"
        case .vip: return "VIPä¼šå‘˜"
        case .unknown: return "æœªçŸ¥"
        }
    }
    
    var tier: Int {
        switch self {
        case .consumable: return 0
        case .tactical: return 1
        case .lordship: return 2
        case .empire: return 3
        case .vip: return 1
        case .unknown: return -1
        }
    }
}

// MARK: - æ—¶é•¿æšä¸¾ (ç”¨äºç­–ç•¥/æƒç›Šç±»å‹)

enum SubscriptionDuration: String, Codable {
    case oneMonth = "1m"
    case threeMonths = "3m"
    case oneYear = "1y"
    
    var days: Int {
        switch self {
        case .oneMonth: return 30
        case .threeMonths: return 90
        case .oneYear: return 365
        }
    }
    
    var displayName: String {
        switch self {
        case .oneMonth: return "30å¤©"
        case .threeMonths: return "90å¤©"
        case .oneYear: return "365å¤©"
        }
    }
}

// MARK: - æƒç›Šæ¨¡å‹

struct Entitlement: Codable {
    let productID: String
    let category: ProductCategory
    
    // äº§å“ç‰¹å®šæƒç›Š
    let buildSpeedBonus: Double                    // å»ºé€ æ—¶é—´å‡å°‘ç™¾åˆ†æ¯”
    let productionSpeedBonus: Double               // ç”Ÿäº§å‘¨æœŸå‡å°‘ç™¾åˆ†æ¯”
    let resourceOutputBonus: Double                // èµ„æºäº§å‡ºå¢åŠ ç™¾åˆ†æ¯”
    let backpackCapacityBonus: Int                 // èƒŒåŒ…å®¹é‡å¢åŠ 
    
    // æ—¶é—´ç‰¹å®šæƒç›Š
    let dailyReward: Int                           // æ¯æ—¥ç™»å½•å¥–åŠ± (èµ„æºå¸)
    let shopDiscountPercentage: Int                // VIPå•†åº—æŠ˜æ‰£
    let dailyTeleportTimes: Int                    // æ¯æ—¥ä¼ é€æ¬¡æ•°
    
    // æ´»åŠ¨æƒç›Š
    let hasWeeklyChallenge: Bool                   // æ¯å‘¨é™å®šæŒ‘æˆ˜
    let hasMonthlyChallenge: Bool                  // æ¯æœˆé™å®šæŒ‘æˆ˜
    let hasVIPBadge: Bool                          // VIPåç‰Œæ•ˆæœ
    let hasUnlimitedQueues: Bool                   // æ— é™å»ºé€ é˜Ÿåˆ—
    let defenseBonus: Double                       // é¢†åœ°é˜²å¾¡åŠ æˆ
    let hasCustomerSupport: Bool                   // ä¸“å±å®¢æœæ”¯æŒ
    
    // ç‰¹æ®Šæƒç›Š
    let monthlyRareLootBox: Bool                   // æ¯æœˆç¨€æœ‰ç‰©èµ„ç®±
    let monthlySupplyVoucher: Int                  // æ¯æœˆè¡¥ç»™åˆ¸ (èµ„æºå¸)
    
    // è®¢é˜…ç›¸å…³
    let duration: Int                              // å¤©æ•° (å¦‚æœé€‚ç”¨)
    let isAutoRenewable: Bool                      // æ˜¯å¦è‡ªåŠ¨ç»­æœŸ
    
    init(productID: String) {
        self.productID = productID
        let category = IAPProductID.getProductCategory(productID)
        self.category = category
        
        // æ ¹æ®äº§å“ ID åˆå§‹åŒ–æƒç›Š
        switch productID {
        // MARK: æ¶ˆè€—æ€§äº§å“
        case "com.earthlord.supply.survivor":
            buildSpeedBonus = 0
            productionSpeedBonus = 0
            resourceOutputBonus = 0
            backpackCapacityBonus = 0
            dailyReward = 0
            shopDiscountPercentage = 0
            dailyTeleportTimes = 0
            hasWeeklyChallenge = false
            hasMonthlyChallenge = false
            hasVIPBadge = false
            hasUnlimitedQueues = false
            defenseBonus = 0
            hasCustomerSupport = false
            monthlyRareLootBox = false
            monthlySupplyVoucher = 0
            duration = 0
            isAutoRenewable = false
            
        // MARK: æ¶ˆè€—æ€§äº§å“ - Explorer
        case "com.earthlord.supply.explorer":
            buildSpeedBonus = 0
            productionSpeedBonus = 0
            resourceOutputBonus = 0
            backpackCapacityBonus = 0
            dailyReward = 0
            shopDiscountPercentage = 0
            dailyTeleportTimes = 0
            hasWeeklyChallenge = false
            hasMonthlyChallenge = false
            hasVIPBadge = false
            hasUnlimitedQueues = false
            defenseBonus = 0
            hasCustomerSupport = false
            monthlyRareLootBox = false
            monthlySupplyVoucher = 0
            duration = 0
            isAutoRenewable = false
            
        // MARK: æ¶ˆè€—æ€§äº§å“ - Lord
        case "com.earthlord.supply.lord":
            buildSpeedBonus = 0
            productionSpeedBonus = 0
            resourceOutputBonus = 0
            backpackCapacityBonus = 0
            dailyReward = 0
            shopDiscountPercentage = 0
            dailyTeleportTimes = 0
            hasWeeklyChallenge = false
            hasMonthlyChallenge = false
            hasVIPBadge = false
            hasUnlimitedQueues = false
            defenseBonus = 0
            hasCustomerSupport = false
            monthlyRareLootBox = false
            monthlySupplyVoucher = 0
            duration = 0
            isAutoRenewable = false
            
        // MARK: æ¶ˆè€—æ€§äº§å“ - Overlord
        case "com.earthlord.supply.overlord":
            buildSpeedBonus = 0
            productionSpeedBonus = 0
            resourceOutputBonus = 0
            backpackCapacityBonus = 0
            dailyReward = 0
            shopDiscountPercentage = 0
            dailyTeleportTimes = 0
            hasWeeklyChallenge = false
            hasMonthlyChallenge = false
            hasVIPBadge = false
            hasUnlimitedQueues = false
            defenseBonus = 0
            hasCustomerSupport = false
            monthlyRareLootBox = false
            monthlySupplyVoucher = 0
            duration = 0
            isAutoRenewable = false
            
        // MARK: éç»­æœŸ - æˆ˜æœ¯æ”¯æ´ (30å¤©)
        case "com.earthlord.tactical.1m":
            buildSpeedBonus = 0.20
            productionSpeedBonus = 0.15
            resourceOutputBonus = 0
            backpackCapacityBonus = 25
            dailyReward = 500
            shopDiscountPercentage = 10
            dailyTeleportTimes = 3
            hasWeeklyChallenge = false
            hasMonthlyChallenge = false
            hasVIPBadge = false
            hasUnlimitedQueues = false
            defenseBonus = 0
            hasCustomerSupport = false
            monthlyRareLootBox = false
            monthlySupplyVoucher = 0
            duration = 30
            isAutoRenewable = false
            
        // MARK: éç»­æœŸ - æˆ˜æœ¯æ”¯æ´ (90å¤©)
        case "com.earthlord.tactical.3m":
            buildSpeedBonus = 0.20
            productionSpeedBonus = 0.15
            resourceOutputBonus = 0
            backpackCapacityBonus = 25
            dailyReward = 500
            shopDiscountPercentage = 10
            dailyTeleportTimes = 3
            hasWeeklyChallenge = false
            hasMonthlyChallenge = false
            hasVIPBadge = false
            hasUnlimitedQueues = false
            defenseBonus = 0
            hasCustomerSupport = false
            monthlyRareLootBox = false
            monthlySupplyVoucher = 0
            duration = 90
            isAutoRenewable = false
            
        // MARK: éç»­æœŸ - æˆ˜æœ¯æ”¯æ´ (365å¤©)
        case "com.earthlord.tactical.1y":
            buildSpeedBonus = 0.20
            productionSpeedBonus = 0.15
            resourceOutputBonus = 0
            backpackCapacityBonus = 25
            dailyReward = 500
            shopDiscountPercentage = 10
            dailyTeleportTimes = 3
            hasWeeklyChallenge = false
            hasMonthlyChallenge = false
            hasVIPBadge = false
            hasUnlimitedQueues = false
            defenseBonus = 0
            hasCustomerSupport = false
            monthlyRareLootBox = false
            monthlySupplyVoucher = 0
            duration = 365
            isAutoRenewable = false
            
        // MARK: éç»­æœŸ - é¢†ä¸»ç‰¹æƒ (30å¤©)
        case "com.earthlord.lordship.1m":
            buildSpeedBonus = 0.40
            productionSpeedBonus = 0.30
            resourceOutputBonus = 0.20
            backpackCapacityBonus = 50
            dailyReward = 500
            shopDiscountPercentage = 20
            dailyTeleportTimes = 3
            hasWeeklyChallenge = true
            hasMonthlyChallenge = false
            hasVIPBadge = true
            hasUnlimitedQueues = false
            defenseBonus = 0
            hasCustomerSupport = false
            monthlyRareLootBox = false
            monthlySupplyVoucher = 0
            duration = 30
            isAutoRenewable = false
            
        // MARK: éç»­æœŸ - é¢†ä¸»ç‰¹æƒ (90å¤©)
        case "com.earthlord.lordship.3m":
            buildSpeedBonus = 0.40
            productionSpeedBonus = 0.30
            resourceOutputBonus = 0.20
            backpackCapacityBonus = 50
            dailyReward = 500
            shopDiscountPercentage = 20
            dailyTeleportTimes = 3
            hasWeeklyChallenge = true
            hasMonthlyChallenge = false
            hasVIPBadge = true
            hasUnlimitedQueues = false
            defenseBonus = 0
            hasCustomerSupport = false
            monthlyRareLootBox = false
            monthlySupplyVoucher = 0
            duration = 90
            isAutoRenewable = false
            
        // MARK: éç»­æœŸ - é¢†ä¸»ç‰¹æƒ (365å¤©)
        case "com.earthlord.lordship.1y":
            buildSpeedBonus = 0.40
            productionSpeedBonus = 0.30
            resourceOutputBonus = 0.20
            backpackCapacityBonus = 50
            dailyReward = 500
            shopDiscountPercentage = 20
            dailyTeleportTimes = 3
            hasWeeklyChallenge = true
            hasMonthlyChallenge = false
            hasVIPBadge = true
            hasUnlimitedQueues = false
            defenseBonus = 0
            hasCustomerSupport = false
            monthlyRareLootBox = false
            monthlySupplyVoucher = 0
            duration = 365
            isAutoRenewable = false
            
        // MARK: éç»­æœŸ - å¸å›½ç»Ÿæ²»è€… (30å¤©)
        case "com.earthlord.empire.1m":
            buildSpeedBonus = 0.60
            productionSpeedBonus = 0.50
            resourceOutputBonus = 0.40
            backpackCapacityBonus = 100
            dailyReward = 500
            shopDiscountPercentage = 20
            dailyTeleportTimes = 3
            hasWeeklyChallenge = false
            hasMonthlyChallenge = true
            hasVIPBadge = true
            hasUnlimitedQueues = true
            defenseBonus = 0.15
            hasCustomerSupport = true
            monthlyRareLootBox = true
            monthlySupplyVoucher = 0
            duration = 30
            isAutoRenewable = false
            
        // MARK: éç»­æœŸ - å¸å›½ç»Ÿæ²»è€… (90å¤©)
        case "com.earthlord.empire.3m":
            buildSpeedBonus = 0.60
            productionSpeedBonus = 0.50
            resourceOutputBonus = 0.40
            backpackCapacityBonus = 100
            dailyReward = 500
            shopDiscountPercentage = 20
            dailyTeleportTimes = 3
            hasWeeklyChallenge = false
            hasMonthlyChallenge = true
            hasVIPBadge = true
            hasUnlimitedQueues = true
            defenseBonus = 0.15
            hasCustomerSupport = true
            monthlyRareLootBox = true
            monthlySupplyVoucher = 0
            duration = 90
            isAutoRenewable = false
            
        // MARK: éç»­æœŸ - å¸å›½ç»Ÿæ²»è€… (365å¤©)
        case "com.earthlord.empire.1y":
            buildSpeedBonus = 0.60
            productionSpeedBonus = 0.50
            resourceOutputBonus = 0.40
            backpackCapacityBonus = 100
            dailyReward = 500
            shopDiscountPercentage = 20
            dailyTeleportTimes = 3
            hasWeeklyChallenge = false
            hasMonthlyChallenge = true
            hasVIPBadge = true
            hasUnlimitedQueues = true
            defenseBonus = 0.15
            hasCustomerSupport = true
            monthlyRareLootBox = true
            monthlySupplyVoucher = 0
            duration = 365
            isAutoRenewable = false
            
        // MARK: ç»­æœŸ - VIP æœˆä¼šå‘˜
        case "com.earthlord.vip.monthly":
            buildSpeedBonus = 0.20
            productionSpeedBonus = 0.15
            resourceOutputBonus = 0
            backpackCapacityBonus = 25
            dailyReward = 500
            shopDiscountPercentage = 10
            dailyTeleportTimes = 3
            hasWeeklyChallenge = false
            hasMonthlyChallenge = false
            hasVIPBadge = false
            hasUnlimitedQueues = false
            defenseBonus = 0
            hasCustomerSupport = false
            monthlyRareLootBox = false
            monthlySupplyVoucher = 20
            duration = 30
            isAutoRenewable = true
            
        // MARK: ç»­æœŸ - VIP æœˆä¼šå‘˜è¯•ç”¨
        case "com.earthlord.vip.monthly.trial":
            buildSpeedBonus = 0.20
            productionSpeedBonus = 0.15
            resourceOutputBonus = 0
            backpackCapacityBonus = 25
            dailyReward = 500
            shopDiscountPercentage = 10
            dailyTeleportTimes = 3
            hasWeeklyChallenge = false
            hasMonthlyChallenge = false
            hasVIPBadge = false
            hasUnlimitedQueues = false
            defenseBonus = 0
            hasCustomerSupport = false
            monthlyRareLootBox = false
            monthlySupplyVoucher = 20
            duration = 30
            isAutoRenewable = true
            
        // MARK: ç»­æœŸ - VIP å­£åº¦ä¼šå‘˜
        case "com.earthlord.vip.quarterly":
            buildSpeedBonus = 0.20
            productionSpeedBonus = 0.15
            resourceOutputBonus = 0
            backpackCapacityBonus = 25
            dailyReward = 500
            shopDiscountPercentage = 10
            dailyTeleportTimes = 3
            hasWeeklyChallenge = false
            hasMonthlyChallenge = false
            hasVIPBadge = false
            hasUnlimitedQueues = false
            defenseBonus = 0
            hasCustomerSupport = false
            monthlyRareLootBox = false
            monthlySupplyVoucher = 30
            duration = 90
            isAutoRenewable = true
            
        // MARK: ç»­æœŸ - VIP å¹´åº¦ä¼šå‘˜
        case "com.earthlord.vip.annual":
            buildSpeedBonus = 0.20
            productionSpeedBonus = 0.15
            resourceOutputBonus = 0
            backpackCapacityBonus = 25
            dailyReward = 500
            shopDiscountPercentage = 10
            dailyTeleportTimes = 3
            hasWeeklyChallenge = false
            hasMonthlyChallenge = false
            hasVIPBadge = false
            hasUnlimitedQueues = false
            defenseBonus = 0
            hasCustomerSupport = false
            monthlyRareLootBox = false
            monthlySupplyVoucher = 50
            duration = 365
            isAutoRenewable = true
            
        default:
            buildSpeedBonus = 0
            productionSpeedBonus = 0
            resourceOutputBonus = 0
            backpackCapacityBonus = 0
            dailyReward = 0
            shopDiscountPercentage = 0
            dailyTeleportTimes = 0
            hasWeeklyChallenge = false
            hasMonthlyChallenge = false
            hasVIPBadge = false
            hasUnlimitedQueues = false
            defenseBonus = 0
            hasCustomerSupport = false
            monthlyRareLootBox = false
            monthlySupplyVoucher = 0
            duration = 0
            isAutoRenewable = false
        }
    }
    
    // MARK: ä¾¿åˆ©æ–¹æ³•
    func getCombinedBonuses() -> [String: Any] {
        return [
            "buildSpeedBonus": buildSpeedBonus,
            "productionSpeedBonus": productionSpeedBonus,
            "resourceOutputBonus": resourceOutputBonus,
            "backpackCapacityBonus": backpackCapacityBonus,
            "defenseBonus": defenseBonus,
            "shopDiscountPercentage": shopDiscountPercentage
        ]
    }
}

// MARK: - è®¢é˜…è®°å½•æ¨¡å‹

struct SubscriptionRecord: Codable {
    let id: String                                  // å”¯ä¸€æ ‡è¯†ç¬¦
    let userID: String                              // ç”¨æˆ· ID
    let productID: String                           // äº§å“ ID
    let category: ProductCategory                   // äº§å“åˆ†ç±»
    let purchaseDate: Date                          // è´­ä¹°æ—¥æœŸ
    let expirationDate: Date                        // è¿‡æœŸæ—¥æœŸ
    let transactionID: String                       // äº¤æ˜“ ID
    let receiptData: String                         // æ”¶æ®æ•°æ® (Base64)
    let isActive: Bool                              // æ˜¯å¦æ¿€æ´»
    let autoRenewEnabled: Bool                      // æ˜¯å¦å¯ç”¨è‡ªåŠ¨ç»­æœŸ
    let platform: String                            // å¹³å° (iOS/Android)
    let deviceID: String                            // è®¾å¤‡ ID
    let syncedToServer: Bool                        // æ˜¯å¦åŒæ­¥åˆ°æœåŠ¡å™¨
    let lastSyncedAt: Date?                         // æœ€ååŒæ­¥æ—¶é—´
    
    // MARK: è®¡ç®—å±æ€§
    var remainingDays: Int {
        let calendar = Calendar.current
        let components = calendar.dateComponents([.day], from: Date(), to: expirationDate)
        return max(components.day ?? 0, 0)
    }
    
    var isExpiringSoon: Bool {
        return remainingDays <= 3
    }
    
    var formattedExpirationDate: String {
        let formatter = DateFormatter()
        formatter.dateStyle = .medium
        return formatter.string(from: expirationDate)
    }
}

// MARK: - è´­ä¹°é¡¹ç›®æ¨¡å‹

struct PurchaseItem: Codable, Identifiable {
    let id: String                                  // äº§å“ ID
    let displayName: String                         // æ˜¾ç¤ºåç§°
    let description: String                         // æè¿°
    let price: Decimal                              // ä»·æ ¼
    let currencyCode: String                        // è´§å¸ä»£ç 
    let subscriptionPeriod: String?                 // è®¢é˜…å‘¨æœŸ (å¦‚æœé€‚ç”¨)
    let introPrice: Decimal?                        // ä»‹ç»ä»· (å¦‚æœé€‚ç”¨)
    let introPricePeriod: String?                   // ä»‹ç»ä»·å‘¨æœŸ
    let trialPeriod: String?                        // è¯•ç”¨æœŸ
    let groupID: String?                            // è®¢é˜…ç»„ ID
}

// MARK: - äº¤æ˜“è®°å½•æ¨¡å‹

struct TransactionRecord: Codable {
    let transactionID: String
    let originalTransactionID: String
    let productID: String
    let purchaseDate: Date
    let expirationDate: Date?
    let revocationDate: Date?
    let bundleID: String
    let environment: String
    let status: String
    let offerID: String?
    let isUpgrade: Bool
    let isDowngrade: Bool
}
```

### 3.2 IAPManager.swift (æ ¸å¿ƒç®¡ç†å™¨)

```swift
import Foundation
import StoreKit

@MainActor
class IAPManager: NSObject, ObservableObject {
    
    static let shared = IAPManager()
    
    @Published var products: [Product] = []
    @Published var purchasedProductIDs: Set<String> = []
    @Published var isLoading = false
    @Published var errorMessage: String?
    @Published var subscriptionRecords: [SubscriptionRecord] = []
    
    private var updateListenerTask: Task<Void, Error>? = nil
    
    // MARK: - åˆå§‹åŒ–
    
    override private init() {
        super.init()
        setupProductCache()
        setupTransactionListener()
    }
    
    // MARK: - äº§å“åŠ è½½
    
    func setupProductCache() {
        Task {
            await loadProducts()
        }
    }
    
    func loadProducts() async {
        isLoading = true
        defer { isLoading = false }
        
        do {
            let products = try await Product.products(for: IAPProductID.allProductIDs)
            self.products = products.sorted { $0.price < $1.price }
            
            // åŠ è½½è´­ä¹°çŠ¶æ€
            await loadPurchasedProducts()
        } catch {
            errorMessage = "åŠ è½½äº§å“å¤±è´¥: \(error.localizedDescription)"
            print("âŒ äº§å“åŠ è½½å¤±è´¥: \(error)")
        }
    }
    
    func loadPurchasedProducts() async {
        for product in products {
            do {
                if let transaction = try await product.currentEntitlement {
                    purchasedProductIDs.insert(product.id)
                }
            } catch {
                print("âš ï¸ æ— æ³•æ£€æŸ¥äº§å“ \(product.id) çš„æƒåˆ©: \(error)")
            }
        }
    }
    
    // MARK: - è´­ä¹°å¤„ç†
    
    func purchase(_ product: Product) async {
        do {
            print("ğŸ›’ å¼€å§‹è´­ä¹°: \(product.id)")
            let result = try await product.purchase()
            
            switch result {
            case .success(let verification):
                // éªŒè¯æ”¶æ®
                let transaction = try checkVerified(verification)
                await handlePurchaseSuccess(transaction)
                print("âœ… è´­ä¹°æˆåŠŸ: \(product.id)")
                
            case .userCancelled:
                errorMessage = "è´­ä¹°å·²å–æ¶ˆ"
                print("âš ï¸ ç”¨æˆ·å–æ¶ˆè´­ä¹°")
                
            case .pending:
                errorMessage = "è´­ä¹°ç­‰å¾…çˆ¶æ¯å®¡æ‰¹"
                print("â³ è´­ä¹°ç­‰å¾…å®¡æ‰¹")
                
            @unknown default:
                errorMessage = "æœªçŸ¥çš„è´­ä¹°çŠ¶æ€"
                print("âŒ æœªçŸ¥çš„è´­ä¹°çŠ¶æ€")
            }
        } catch {
            errorMessage = "è´­ä¹°å¤±è´¥: \(error.localizedDescription)"
            print("âŒ è´­ä¹°å¤±è´¥: \(error)")
        }
    }
    
    // MARK: - äº¤æ˜“ç›‘å¬
    
    func setupTransactionListener() {
        updateListenerTask = Task.detached { [weak self] in
            for await result in Transaction.updates {
                do {
                    let transaction = try self?.checkVerified(result)
                    if let transaction = transaction {
                        await self?.handleTransaction(transaction)
                    }
                } catch {
                    print("âŒ äº¤æ˜“éªŒè¯å¤±è´¥: \(error)")
                }
            }
        }
    }
    
    private func handleTransaction(_ transaction: Transaction) async {
        switch transaction.productType {
        case .consumable, .nonConsumable, .autoRenewable, .nonRenewable:
            await handlePurchaseSuccess(transaction)
            await transaction.finish()
            
        @unknown default:
            print("âŒ æœªçŸ¥çš„äº§å“ç±»å‹")
        }
    }
    
    private func handlePurchaseSuccess(_ transaction: Transaction) async {
        // æ›´æ–°æœ¬åœ°è´­ä¹°çŠ¶æ€
        purchasedProductIDs.insert(transaction.productID)
        
        // åˆ›å»ºè®¢é˜…è®°å½•
        let record = SubscriptionRecord(
            id: UUID().uuidString,
            userID: try? AuthManager.shared.currentUser?.id ?? "",
            productID: transaction.productID,
            category: IAPProductID.getProductCategory(transaction.productID),
            purchaseDate: transaction.purchaseDate,
            expirationDate: transaction.expirationDate ?? Date().addingTimeInterval(86400),
            transactionID: transaction.id.description,
            receiptData: transaction.signedSafeReceipt ?? "",
            isActive: true,
            autoRenewEnabled: transaction.isUpgraded == false,
            platform: "iOS",
            deviceID: UIDevice.current.identifierForVendor?.uuidString ?? "",
            syncedToServer: false,
            lastSyncedAt: nil
        )
        
        subscriptionRecords.append(record)
        
        // å¼‚æ­¥ä¿å­˜åˆ°æœ¬åœ°å’ŒæœåŠ¡å™¨
        Task {
            await saveSubscriptionRecord(record)
            await syncToServer(record)
            await grantEntitlements(record)
        }
    }
    
    // MARK: - æ”¶æ®éªŒè¯
    
    private func checkVerified<T>(_ result: VerificationResult<T>) throws -> T {
        switch result {
        case .unverified(_, let error):
            throw error
        case .verified(let safe):
            return safe
        }
    }
    
    // MARK: - æƒç›Šæˆäºˆ
    
    private func grantEntitlements(_ record: SubscriptionRecord) async {
        let entitlement = Entitlement(productID: record.productID)
        
        // æ ¹æ®äº§å“ç±»å‹åº”ç”¨æƒç›Š
        switch record.category {
        case .consumable:
            await grantConsumableRewards(record.productID)
        case .tactical, .lordship, .empire:
            await activateTemporaryPerks(entitlement, duration: record.remainingDays)
        case .vip:
            await activateAutoRenewPerks(entitlement)
        case .unknown:
            break
        }
    }
    
    private func grantConsumableRewards(_ productID: String) async {
        let resources: [String: Int] = {
            switch productID {
            case "com.earthlord.supply.survivor":
                return ["wood": 300, "stone": 300, "metal": 150, "water": 300]
            case "com.earthlord.supply.explorer":
                return ["wood": 1000, "stone": 1000, "metal": 500, "water": 1000, "food": 500, "supply": 200]
            case "com.earthlord.supply.lord":
                return ["wood": 2000, "stone": 2000, "metal": 1000, "rareMetals": 200, "supply": 500, "fuel": 300]
            case "com.earthlord.supply.overlord":
                return ["wood": 5000, "stone": 5000, "metal": 2500, "rareMetals": 500, "legendFragments": 50, "supply": 1000, "fuel": 800]
            default:
                return [:]
            }
        }()
        
        // è°ƒç”¨åº“å­˜ç®¡ç†å™¨æ·»åŠ èµ„æº
        if let inventoryManager = getInventoryManager() {
            for (resource, amount) in resources {
                await inventoryManager.addResource(type: resource, amount: amount, reason: "æƒç›Šå¥–åŠ±: \(productID)")
            }
        }
    }
    
    private func activateTemporaryPerks(_ entitlement: Entitlement, duration: Int) async {
        // è°ƒç”¨å»ºç­‘ã€ç”Ÿäº§ç­‰ç³»ç»Ÿåº”ç”¨æƒç›Š
        if let buildingManager = getBuildingManager() {
            buildingManager.applyBuildingSpeedup(percentage: entitlement.buildSpeedBonus, duration: duration)
            buildingManager.applyBuildingQueueExpansion(unlimited: entitlement.hasUnlimitedQueues, duration: duration)
        }
        
        // ä¿å­˜æƒç›Šåˆ°æœ¬åœ°å­˜å‚¨
        let defaults = UserDefaults.standard
        defaults.setValue(entitlement.buildSpeedBonus, forKey: "buildSpeedBonus_\(entitlement.productID)")
        defaults.setValue(Date().addingTimeInterval(TimeInterval(duration * 86400)), forKey: "buildSpeedBonusExpiration_\(entitlement.productID)")
    }
    
    private func activateAutoRenewPerks(_ entitlement: Entitlement) async {
        // VIP ä¼šå‘˜æƒç›Šæ°¸ä¹…æœ‰æ•ˆ (åªè¦è®¢é˜…æŒç»­)
        let defaults = UserDefaults.standard
        defaults.setValue(entitlement.buildSpeedBonus, forKey: "vipBuildSpeedBonus")
        defaults.setValue(true, forKey: "isVIPMember")
    }
    
    // MARK: - è®¢é˜…ç®¡ç†
    
    func checkSubscriptionStatus(productID: String) -> Bool {
        guard let record = subscriptionRecords.first(where: { $0.productID == productID }) else {
            return false
        }
        return record.isActive && record.expirationDate > Date()
    }
    
    func getActiveSubscriptions() -> [SubscriptionRecord] {
        return subscriptionRecords.filter { $0.isActive && $0.expirationDate > Date() }
    }
    
    func getHighestTierSubscription() -> SubscriptionRecord? {
        let active = getActiveSubscriptions()
        return active.max { a, b in
            IAPProductID.getProductCategory(a.productID).tier < IAPProductID.getProductCategory(b.productID).tier
        }
    }
    
    func getRemainingDaysForProduct(_ productID: String) -> Int {
        guard let record = subscriptionRecords.first(where: { $0.productID == productID }) else {
            return 0
        }
        return record.remainingDays
    }
    
    // MARK: - æŒä¹…åŒ–å­˜å‚¨
    
    func saveSubscriptionRecord(_ record: SubscriptionRecord) async {
        let defaults = UserDefaults.standard
        let encoder = JSONEncoder()
        
        if let encoded = try? encoder.encode(record) {
            defaults.set(encoded, forKey: "subscription_\(record.id)")
        }
    }
    
    func loadSubscriptionRecords() {
        let defaults = UserDefaults.standard
        let decoder = JSONDecoder()
        let fileManager = FileManager.default
        
        if let cacheDir = fileManager.urls(for: .cachesDirectory, in: .userDomainMask).first {
            let recordsFile = cacheDir.appendingPathComponent("subscriptionRecords.json")
            
            if let data = try? Data(contentsOf: recordsFile),
               let records = try? decoder.decode([SubscriptionRecord].self, from: data) {
                self.subscriptionRecords = records
            }
        }
    }
    
    // MARK: - æœåŠ¡å™¨åŒæ­¥
    
    private func syncToServer(_ record: SubscriptionRecord) async {
        // è°ƒç”¨ Supabase API ä¿å­˜è®¢é˜…è®°å½•
        guard let userID = try? AuthManager.shared.currentUser?.id else {
            print("âŒ æ— æ³•è·å–ç”¨æˆ·ID")
            return
        }
        
        do {
            let response = try await URLSession.shared.data(
                for: URLRequest(url: URL(string: "https://your-supabase-url/rest/v1/user_subscriptions")!)
            )
            print("âœ… è®¢é˜…è®°å½•å·²åŒæ­¥åˆ°æœåŠ¡å™¨")
        } catch {
            print("âš ï¸ åŒæ­¥å¤±è´¥: \(error)")
        }
    }
    
    // MARK: - æ¢å¤è´­ä¹°
    
    func restorePurchases() async {
        do {
            print("ğŸ”„ å¼€å§‹æ¢å¤è´­ä¹°...")
            
            for await result in Transaction.currentEntitlements {
                do {
                    let transaction = try checkVerified(result)
                    await handlePurchaseSuccess(transaction)
                    await transaction.finish()
                } catch {
                    print("âŒ æ¢å¤è´­ä¹°å¤±è´¥: \(error)")
                }
            }
            
            errorMessage = "è´­ä¹°å·²æ¢å¤"
            print("âœ… è´­ä¹°æ¢å¤å®Œæˆ")
        } catch {
            errorMessage = "æ¢å¤è´­ä¹°å¤±è´¥: \(error.localizedDescription)"
            print("âŒ æ¢å¤è´­ä¹°å¤±è´¥: \(error)")
        }
    }
    
    // MARK: - è¾…åŠ©æ–¹æ³•
    
    private func getInventoryManager() -> InventoryManager? {
        // è¿”å›å…¨å±€åº“å­˜ç®¡ç†å™¨å®ä¾‹
        return InventoryManager.shared
    }
    
    private func getBuildingManager() -> BuildingManager? {
        // è¿”å›å…¨å±€å»ºç­‘ç®¡ç†å™¨å®ä¾‹
        return BuildingManager.shared
    }
    
    deinit {
        updateListenerTask?.cancel()
    }
}
```

### 3.3 è®¢é˜… UI è§†å›¾ (SubscriptionView)

```swift
import SwiftUI

struct SubscriptionView: View {
    @StateObject private var iapManager = IAPManager.shared
    @State private var selectedCategory: ProductCategory = .tactical
    @State private var showingPurchaseConfirm = false
    @State private var selectedProduct: Product?
    
    var body: some View {
        ZStack {
            // èƒŒæ™¯
            LinearGradient(
                gradient: Gradient(colors: [.black, Color(red: 0.1, green: 0.1, blue: 0.15)]),
                startPoint: .topLeading,
                endPoint: .bottomTrailing
            )
            .ignoresSafeArea()
            
            VStack(spacing: 0) {
                // æ ‡é¢˜æ 
                VStack {
                    HStack {
                        Text("æœ«ä¸–æƒç›Š")
                            .font(.system(size: 28, weight: .bold))
                        
                        Spacer()
                        
                        Button(action: { }) {
                            Image(systemName: "xmark.circle.fill")
                                .font(.system(size: 24))
                                .foregroundColor(.gray)
                        }
                    }
                    .padding(.horizontal)
                    .padding(.top, 16)
                    
                    Text("æå‡ä½ çš„ç”Ÿå­˜ä¼˜åŠ¿")
                        .foregroundColor(.gray)
                        .font(.subheadline)
                        .padding(.horizontal)
                        .padding(.top, 8)
                }
                .padding(.bottom, 20)
                
                // åˆ†ç±»æ ‡ç­¾
                HStack(spacing: 8) {
                    categoryTab("æˆ˜æœ¯", category: .tactical)
                    categoryTab("é¢†ä¸»", category: .lordship)
                    categoryTab("å¸å›½", category: .empire)
                    categoryTab("ä¼šå‘˜", category: .vip)
                    Spacer()
                }
                .padding(.horizontal)
                .padding(.bottom, 20)
                
                // äº§å“åˆ—è¡¨
                ScrollView {
                    VStack(spacing: 12) {
                        ForEach(filteredProducts, id: \.id) { product in
                            SubscriptionProductCard(
                                product: product,
                                isSelected: selectedProduct?.id == product.id,
                                onSelect: {
                                    selectedProduct = product
                                }
                            )
                        }
                    }
                    .padding(.horizontal)
                }
                
                // åº•éƒ¨æ“ä½œ
                VStack(spacing: 12) {
                    if let selected = selectedProduct {
                        Button(action: {
                            Task {
                                await iapManager.purchase(selected)
                            }
                        }) {
                            HStack {
                                Text("ç°åœ¨è´­ä¹°")
                                    .font(.headline)
                                Spacer()
                                Text(selected.displayPrice)
                                    .font(.headline)
                            }
                            .foregroundColor(.white)
                            .padding()
                            .background(Color.green)
                            .cornerRadius(12)
                        }
                        
                        Button(action: { Task { await iapManager.restorePurchases() } }) {
                            Text("æ¢å¤è´­ä¹°")
                                .font(.subheadline)
                                .foregroundColor(.cyan)
                        }
                    }
                }
                .padding()
            }
        }
    }
    
    @ViewBuilder
    private func categoryTab(_ label: String, category: ProductCategory) -> some View {
        Button(action: { selectedCategory = category }) {
            Text(label)
                .font(.subheadline)
                .fontWeight(.semibold)
                .foregroundColor(selectedCategory == category ? .white : .gray)
                .padding(.horizontal, 12)
                .padding(.vertical, 6)
                .background(selectedCategory == category ? Color.blue : Color.gray.opacity(0.2))
                .cornerRadius(6)
        }
    }
    
    var filteredProducts: [Product] {
        iapManager.products.filter { product in
            IAPProductID.getProductCategory(product.id) == selectedCategory
        }
    }
}

// MARK: - è®¢é˜…äº§å“å¡ç‰‡

struct SubscriptionProductCard: View {
    let product: Product
    let isSelected: Bool
    let onSelect: () -> Void
    
    var body: some View {
        VStack(alignment: .leading, spacing: 12) {
            HStack {
                VStack(alignment: .leading, spacing: 4) {
                    Text(getProductName(product.id))
                        .font(.headline)
                        .foregroundColor(.white)
                    
                    Text(getProductDescription(product.id))
                        .font(.caption)
                        .foregroundColor(.gray)
                        .lineLimit(2)
                }
                
                Spacer()
                
                VStack(alignment: .trailing, spacing: 4) {
                    Text(product.displayPrice)
                        .font(.headline)
                        .foregroundColor(.green)
                    
                    if let period = getSubscriptionPeriod(product.id) {
                        Text(period)
                            .font(.caption2)
                            .foregroundColor(.gray)
                    }
                }
            }
            
            // æƒç›Šé¢„è§ˆ
            entitlementPreview(product.id)
        }
        .padding()
        .background(isSelected ? Color.blue.opacity(0.2) : Color.gray.opacity(0.1))
        .cornerRadius(12)
        .overlay(
            RoundedRectangle(cornerRadius: 12)
                .stroke(isSelected ? Color.blue : Color.clear, lineWidth: 2)
        )
        .onTapGesture(perform: onSelect)
    }
    
    @ViewBuilder
    private func entitlementPreview(_ productID: String) -> some View {
        let entitlement = Entitlement(productID: productID)
        
        VStack(alignment: .leading, spacing: 4) {
            if entitlement.buildSpeedBonus > 0 {
                HStack(spacing: 6) {
                    Image(systemName: "bolt.fill")
                        .foregroundColor(.yellow)
                    Text("å»ºé€ é€Ÿåº¦ -\(Int(entitlement.buildSpeedBonus * 100))%")
                        .font(.caption)
                        .foregroundColor(.gray)
                }
            }
            
            if entitlement.resourceOutputBonus > 0 {
                HStack(spacing: 6) {
                    Image(systemName: "arrow.up.right")
                        .foregroundColor(.orange)
                    Text("èµ„æºäº§å‡º +\(Int(entitlement.resourceOutputBonus * 100))%")
                        .font(.caption)
                        .foregroundColor(.gray)
                }
            }
            
            if entitlement.shopDiscountPercentage > 0 {
                HStack(spacing: 6) {
                    Image(systemName: "tag.fill")
                        .foregroundColor(.pink)
                    Text("å•†åº—æŠ˜æ‰£ \(entitlement.shopDiscountPercentage)%")
                        .font(.caption)
                        .foregroundColor(.gray)
                }
            }
        }
        .frame(maxWidth: .infinity, alignment: .leading)
    }
    
    private func getProductName(_ productID: String) -> String {
        switch productID {
        case "com.earthlord.tactical.1m": return "æˆ˜æœ¯æ”¯æ´-æœˆ"
        case "com.earthlord.tactical.3m": return "æˆ˜æœ¯æ”¯æ´-å­£"
        case "com.earthlord.tactical.1y": return "æˆ˜æœ¯æ”¯æ´-å¹´"
        case "com.earthlord.lordship.1m": return "é¢†ä¸»ç‰¹æƒ-æœˆ"
        case "com.earthlord.lordship.3m": return "é¢†ä¸»ç‰¹æƒ-å­£"
        case "com.earthlord.lordship.1y": return "é¢†ä¸»ç‰¹æƒ-å¹´"
        case "com.earthlord.empire.1m": return "å¸å›½ç»Ÿæ²»-æœˆ"
        case "com.earthlord.empire.3m": return "å¸å›½ç»Ÿæ²»-å­£"
        case "com.earthlord.empire.1y": return "å¸å›½ç»Ÿæ²»-å¹´"
        case "com.earthlord.vip.monthly": return "VIPæœˆä¼šå‘˜"
        case "com.earthlord.vip.annual": return "VIPå¹´ä¼šå‘˜"
        default: return productID
        }
    }
    
    private func getProductDescription(_ productID: String) -> String {
        let entitlement = Entitlement(productID: productID)
        var benefits: [String] = []
        
        if entitlement.buildSpeedBonus > 0 {
            benefits.append("åŠ é€Ÿ\(Int(entitlement.buildSpeedBonus * 100))%")
        }
        if entitlement.shopDiscountPercentage > 0 {
            benefits.append("ä¼˜æƒ \(entitlement.shopDiscountPercentage)%")
        }
        if entitlement.hasVIPBadge {
            benefits.append("VIPæ ‡å¿—")
        }
        
        return benefits.joined(separator: " â€¢ ")
    }
    
    private func getSubscriptionPeriod(_ productID: String) -> String? {
        switch productID {
        case "com.earthlord.tactical.1m", "com.earthlord.lordship.1m", "com.earthlord.empire.1m":
            return "30 å¤©"
        case "com.earthlord.tactical.3m", "com.earthlord.lordship.3m", "com.earthlord.empire.3m":
            return "90 å¤©"
        case "com.earthlord.tactical.1y", "com.earthlord.lordship.1y", "com.earthlord.empire.1y":
            return "365 å¤©"
        case "com.earthlord.vip.monthly":
            return "/æœˆ"
        case "com.earthlord.vip.annual":
            return "/å¹´"
        default:
            return nil
        }
    }
}

#Preview {
    SubscriptionView()
}
```

---

## 4. æ•°æ®åº“è®¾è®¡

### 4.1 Supabase è¡¨ç»“æ„

#### user_subscriptions è¡¨

```sql
CREATE TABLE user_subscriptions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    product_id VARCHAR(100) NOT NULL,
    product_category VARCHAR(50) NOT NULL,
    
    -- è´­ä¹°ä¿¡æ¯
    purchase_date TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    expiration_date TIMESTAMPTZ NOT NULL,
    transaction_id VARCHAR(255) NOT NULL UNIQUE,
    receipt_data TEXT,
    
    -- è®¢é˜…çŠ¶æ€
    is_active BOOLEAN DEFAULT TRUE,
    is_auto_renewable BOOLEAN DEFAULT FALSE,
    next_renewal_date TIMESTAMPTZ,
    
    -- è®¾å¤‡ä¿¡æ¯
    device_id VARCHAR(100),
    platform VARCHAR(20) DEFAULT 'iOS',
    
    -- åŒæ­¥ä¿¡æ¯
    synced_to_server BOOLEAN DEFAULT FALSE,
    last_synced_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    
    CONSTRAINT purchase_not_in_future CHECK (purchase_date <= NOW())
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_user_subscriptions_user_id ON user_subscriptions(user_id);
CREATE INDEX idx_user_subscriptions_product_id ON user_subscriptions(product_id);
CREATE INDEX idx_user_subscriptions_is_active ON user_subscriptions(is_active);
CREATE INDEX idx_user_subscriptions_expiration_date ON user_subscriptions(expiration_date);

-- å¯ç”¨ RLS
ALTER TABLE user_subscriptions ENABLE ROW LEVEL SECURITY;

-- RLS ç­–ç•¥: ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„è®¢é˜…
CREATE POLICY "Users can view their own subscriptions"
    ON user_subscriptions
    FOR SELECT
    USING (auth.uid() = user_id);

-- RLS ç­–ç•¥: æœåŠ¡å™¨å¯ä»¥æ’å…¥/æ›´æ–°
CREATE POLICY "Service role can manage subscriptions"
    ON user_subscriptions
    USING (auth.role() = 'service_role');
```

#### subscription_audit_log è¡¨

```sql
CREATE TABLE subscription_audit_log (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    subscription_id UUID REFERENCES user_subscriptions(id) ON DELETE SET NULL,
    
    action VARCHAR(50) NOT NULL,
    product_id VARCHAR(100),
    
    -- å®¡è®¡æ•°æ®
    old_state JSONB,
    new_state JSONB,
    
    -- å…ƒæ•°æ®
    ip_address INET,
    user_agent TEXT,
    device_id VARCHAR(100),
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    
    CONSTRAINT valid_action CHECK (action IN ('purchase', 'renew', 'cancelation', 'upgrade', 'downgrade', 'restore', 'refund'))
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_audit_log_user_id ON subscription_audit_log(user_id);
CREATE INDEX idx_audit_log_action ON subscription_audit_log(action);
CREATE INDEX idx_audit_log_created_at ON subscription_audit_log(created_at);

-- å¯ç”¨ RLS
ALTER TABLE subscription_audit_log ENABLE ROW LEVEL SECURITY;

-- RLS ç­–ç•¥
CREATE POLICY "Users can view their own audit logs"
    ON subscription_audit_log
    FOR SELECT
    USING (auth.uid() = user_id);
```

#### user_entitlements è¡¨ (æƒç›Šç¼“å­˜)

```sql
CREATE TABLE user_entitlements (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    
    -- æƒç›Šæ ‡å¿—
    has_tactical_support BOOLEAN DEFAULT FALSE,
    has_lordship BOOLEAN DEFAULT FALSE,
    has_empire BOOLEAN DEFAULT FALSE,
    has_vip BOOLEAN DEFAULT FALSE,
    
    -- åŠ æˆç™¾åˆ†æ¯”
    build_speed_bonus NUMERIC(5,2) DEFAULT 0,
    production_speed_bonus NUMERIC(5,2) DEFAULT 0,
    resource_output_bonus NUMERIC(5,2) DEFAULT 0,
    defense_bonus NUMERIC(5,2) DEFAULT 0,
    
    -- ç»å¯¹åŠ æˆ
    backpack_capacity_bonus INT DEFAULT 0,
    daily_reward INT DEFAULT 0,
    shop_discount_percentage INT DEFAULT 0,
    daily_teleport_times INT DEFAULT 0,
    
    -- æƒç›Šè¿‡æœŸæ—¶é—´
    perk_expiration_date TIMESTAMPTZ,
    
    last_updated TIMESTAMPTZ DEFAULT NOW(),
    CONSTRAINT user_id_unique UNIQUE (user_id)
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_entitlements_user_id ON user_entitlements(user_id);
CREATE INDEX idx_entitlements_expiration ON user_entitlements(perk_expiration_date);

-- å¯ç”¨ RLS
ALTER TABLE user_entitlements ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their own entitlements"
    ON user_entitlements
    FOR SELECT
    USING (auth.uid() = user_id);
```

### 4.2 æ•°æ®åº“è¿ç§»è„šæœ¬

```sql
-- supabase_migration_011_subscription_system.sql
-- ç‰ˆæœ¬: 1.0
-- ç›®æ ‡: åˆ›å»ºå®Œæ•´çš„è®¢é˜…ç³»ç»Ÿè¡¨å’Œç­–ç•¥

BEGIN;

-- Step 1: åˆ›å»ºç”¨æˆ·è®¢é˜…è¡¨
CREATE TABLE IF NOT EXISTS user_subscriptions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    product_id VARCHAR(100) NOT NULL,
    product_category VARCHAR(50) NOT NULL,
    purchase_date TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    expiration_date TIMESTAMPTZ NOT NULL,
    transaction_id VARCHAR(255) NOT NULL UNIQUE,
    receipt_data TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    is_auto_renewable BOOLEAN DEFAULT FALSE,
    next_renewal_date TIMESTAMPTZ,
    device_id VARCHAR(100),
    platform VARCHAR(20) DEFAULT 'iOS',
    synced_to_server BOOLEAN DEFAULT FALSE,
    last_synced_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Step 2: åˆ›å»ºå®¡è®¡æ—¥å¿—è¡¨
CREATE TABLE IF NOT EXISTS subscription_audit_log (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    subscription_id UUID REFERENCES user_subscriptions(id) ON DELETE SET NULL,
    action VARCHAR(50) NOT NULL,
    product_id VARCHAR(100),
    old_state JSONB,
    new_state JSONB,
    ip_address INET,
    user_agent TEXT,
    device_id VARCHAR(100),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Step 3: åˆ›å»ºæƒç›Šç¼“å­˜è¡¨
CREATE TABLE IF NOT EXISTS user_entitlements (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL UNIQUE REFERENCES auth.users(id) ON DELETE CASCADE,
    has_tactical_support BOOLEAN DEFAULT FALSE,
    has_lordship BOOLEAN DEFAULT FALSE,
    has_empire BOOLEAN DEFAULT FALSE,
    has_vip BOOLEAN DEFAULT FALSE,
    build_speed_bonus NUMERIC(5,2) DEFAULT 0,
    production_speed_bonus NUMERIC(5,2) DEFAULT 0,
    resource_output_bonus NUMERIC(5,2) DEFAULT 0,
    defense_bonus NUMERIC(5,2) DEFAULT 0,
    backpack_capacity_bonus INT DEFAULT 0,
    daily_reward INT DEFAULT 0,
    shop_discount_percentage INT DEFAULT 0,
    daily_teleport_times INT DEFAULT 0,
    perk_expiration_date TIMESTAMPTZ,
    last_updated TIMESTAMPTZ DEFAULT NOW()
);

-- Step 4: åˆ›å»ºç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_user_subscriptions_user_id ON user_subscriptions(user_id);
CREATE INDEX IF NOT EXISTS idx_user_subscriptions_product_id ON user_subscriptions(product_id);
CREATE INDEX IF NOT EXISTS idx_user_subscriptions_is_active ON user_subscriptions(is_active);
CREATE INDEX IF NOT EXISTS idx_audit_log_user_id ON subscription_audit_log(user_id);

-- Step 5: åˆ›å»ºè§¦å‘å™¨æ›´æ–° updated_at
CREATE OR REPLACE FUNCTION update_user_subscriptions_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER user_subscriptions_updated_at_trigger
    BEFORE UPDATE ON user_subscriptions
    FOR EACH ROW
    EXECUTE FUNCTION update_user_subscriptions_updated_at();

-- Step 6: å¯ç”¨ RLS
ALTER TABLE user_subscriptions ENABLE ROW LEVEL SECURITY;
ALTER TABLE subscription_audit_log ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_entitlements ENABLE ROW LEVEL SECURITY;

-- Step 7: åˆ›å»º RLS ç­–ç•¥
CREATE POLICY "Users can view their own subscriptions"
    ON user_subscriptions
    FOR SELECT
    USING (auth.uid() = user_id);

CREATE POLICY "Service role manages subscriptions"
    ON user_subscriptions
    AS PERMISSIVE
    TO authenticated
    USING (auth.uid() = user_id);

COMMIT;
```

---

## 5. æƒç›Šç³»ç»Ÿé›†æˆ

### 5.1 æƒç›Šæ£€æŸ¥ç³»ç»Ÿ

```swift
@MainActor
class RightsManager: NSObject, ObservableObject {
    
    static let shared = RightsManager()
    
    @Published var activeRights: [String: Entitlement] = [:]
    @Published var expiredRights: [String] = []
    
    func checkAndApplyRights() async {
        let iapManager = IAPManager.shared
        let activeSubscriptions = iapManager.getActiveSubscriptions()
        
        for subscription in activeSubscriptions {
            let entitlement = Entitlement(productID: subscription.productID)
            activeRights[subscription.productID] = entitlement
            
            // åº”ç”¨åˆ°å„ä¸ªæ¸¸æˆç³»ç»Ÿ
            await applyEntitlementToSystems(entitlement)
        }
        
        // æ£€æŸ¥è¿‡æœŸæƒç›Š
        checkExpiredRights()
    }
    
    private func applyEntitlementToSystems(_ entitlement: Entitlement) async {
        // åº”ç”¨åˆ°å»ºç­‘ç³»ç»Ÿ
        if let buildingManager = BuildingManager.shared as? BuildingManager {
            buildingManager.applySpeedupBonus(entitlement.buildSpeedBonus)
            if entitlement.hasUnlimitedQueues {
                buildingManager.setUnlimitedQueues(true)
            }
        }
        
        // åº”ç”¨åˆ°åº“å­˜ç³»ç»Ÿ
        if let inventoryManager = InventoryManager.shared as? InventoryManager {
            inventoryManager.applyBackpackCapacityBonus(entitlement.backpackCapacityBonus)
        }
        
        // åº”ç”¨åˆ°èµ„æºç”Ÿäº§ç³»ç»Ÿ
        // åº”ç”¨åˆ°ç¤¾äº¤ç³»ç»Ÿç­‰
    }
    
    func checkExpiredRights() {
        let iapManager = IAPManager.shared
        let expiredSubscriptions = iapManager.subscriptionRecords.filter {
            !$0.isActive || $0.expirationDate < Date()
        }
        
        for subscription in expiredSubscriptions {
            expiredRights.append(subscription.productID)
            removeEntitlement(subscription.productID)
        }
    }
    
    private func removeEntitlement(_ productID: String) {
        activeRights.removeValue(forKey: productID)
    }
    
    func hasRight(_ productID: String) -> Bool {
        return IAPManager.shared.checkSubscriptionStatus(productID: productID)
    }
    
    func getHighestTierRight() -> Entitlement? {
        return activeRights.values.max { a, b in
            IAPProductID.getProductCategory(a.productID).tier < IAPProductID.getProductCategory(b.productID).tier
        }
    }
}
```

---

## 6. å®Œæ•´æµ‹è¯•ç­–ç•¥

### 6.1 æµ‹è¯•åœºæ™¯æ¸…å• (12 ä¸ªå®Œæ•´åœºæ™¯)

```
æ²™ç›’æµ‹è¯•åœºæ™¯çŸ©é˜µ

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åœºæ™¯ç¼–å· | æµ‹è¯•ç±»å‹ | äº§å“ ID | é¢„æœŸç»“æœ | ä¼˜å…ˆçº§ |
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ T01 | æ¶ˆè€—æ€§è´­ä¹° | supply.survivor | âœ… è·å¾—èµ„æº | P1 |
â”‚ T02 | æ¶ˆè€—æ€§è´­ä¹° | supply.overlord | âœ… è·å¾—èµ„æº | P1 |
â”‚ T03 | éç»­æœŸè´­ä¹° | tactical.1m | âœ… æ¿€æ´»æƒç›Š30å¤© | P1 |
â”‚ T04 | éç»­æœŸè´­ä¹° | kingdom.1y | âœ… æ¿€æ´»æƒç›Š365å¤© | P1 |
â”‚ T05 | ç»­æœŸè´­ä¹° | vip.monthly | âœ… è‡ªåŠ¨ç»­è´¹ | P1 |
â”‚ T06 | ç»­æœŸè¯•ç”¨ | vip.trial | âœ… é¦–æœˆæŠ˜æ‰£ | P2 |
â”‚ T07 | æƒç›ŠéªŒè¯ | æ‰€æœ‰ç±»å‹ | âœ… æƒç›Šæ­£ç¡®åº”ç”¨ | P1 |
â”‚ T08 | æƒç›Šè¿‡æœŸ | tactical.1m | âœ… 30å¤©åè¿‡æœŸ | P1 |
â”‚ T09 | æ¢å¤è´­ä¹° | æ‰€æœ‰å·²è´­ | âœ… æƒç›Šæ¢å¤ | P2 |
â”‚ T10 | çº§åˆ«å‡çº§ | lordâ†’empire | âœ… æƒç›Šæ›´æ–° | P2 |
â”‚ T11 | å–æ¶ˆè®¢é˜… | vip.monthly | âœ… åœæ­¢ç»­è´¹ | P2 |
â”‚ T12 | å¤šäº§å“å åŠ  | æ··åˆè´­ä¹° | âœ… æƒç›Šæ­£ç¡®åˆå¹¶ | P3 |
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 æµ‹è¯•æ‰§è¡Œæ¸…å•

```swift
// æµ‹è¯•ä»£ç æ¡†æ¶
class IAPTestCases {
    
    // T01: æ¶ˆè€—æ€§äº§å“è´­ä¹°
    func testConsumableProduct_Survivor() async {
        let product = IAPProductID.consumableProductIDs
        // 1. æŸ¥è¯¢äº§å“
        // 2. æ¨¡æ‹Ÿè´­ä¹°
        // 3. éªŒè¯èµ„æºå¢åŠ 
        // 4. éªŒè¯äº¤æ˜“è®°å½•
    }
    
    // T03: éç»­æœŸè®¢é˜…è´­ä¹°
    func testNonRenewableSubscription_Tactical() async {
        let productID = "com.earthlord.tactical.1m"
        // 1. è´­ä¹°äº§å“
        // 2. éªŒè¯è®¢é˜…è®°å½•
        // 3. éªŒè¯æƒç›Šæ¿€æ´»
        // 4. æ¨¡æ‹Ÿç­‰å¾…30å¤©
        // 5. éªŒè¯æƒç›Šè¿‡æœŸ
    }
    
    // T05: è‡ªåŠ¨ç»­æœŸè®¢é˜…
    func testAutoRenewableSubscription_VIP() async {
        let productID = "com.earthlord.vip.monthly"
        // 1. è´­ä¹° VIP æœˆå¡
        // 2. éªŒè¯è‡ªåŠ¨ç»­è´¹é…ç½®
        // 3. ç­‰å¾…ç»­è´¹æ—¥æœŸ
        // 4. éªŒè¯è‡ªåŠ¨æ‰£è´¹
        // 5. éªŒè¯æƒç›ŠæŒç»­æœ‰æ•ˆ
    }
    
    // T07: å®Œæ•´æƒç›ŠéªŒè¯
    func testEntitlementApplication() async {
        // éªŒè¯å„äº§å“çš„æƒç›Šæ˜¯å¦æ­£ç¡®åº”ç”¨
        for productID in IAPProductID.allProductIDs {
            let entitlement = Entitlement(productID: productID)
            // éªŒè¯æƒç›Šé…ç½®
            // éªŒè¯æƒç›Šå€¼èŒƒå›´
            // éªŒè¯æƒç›Šç±»å‹
        }
    }
}
```

---

## 7. App Store Connect å®Œæ•´é…ç½®

### 7.1 App Store Connect æ­¥éª¤ (è¯¦ç»†æŒ‡å—)

#### **ç¬¬ä¸€æ­¥: åˆ›å»ºè®¢é˜…ç»„** (5 åˆ†é’Ÿ)

```
1. ç™»å½• https://appstoreconnect.apple.com
2. é€‰æ‹©åº”ç”¨ > App å†…è´­ä¹°é¡¹ç›®
3. ç‚¹å‡» + æ–°å»ºé¡¹ç›®

è®¢é˜…ç»„é…ç½®:
â”œâ”€ åç§°: æœ«æ—¥æƒç›Š-æœˆåº¦è®¢é˜…
â”œâ”€ å‚è€ƒ ID: earthlord_monthly_subscriptions
â””â”€ ä¿å­˜

é‡å¤ä¸ºä»¥ä¸‹è®¢é˜…ç»„:
â”œâ”€ earthlord_quarterly_subscriptions (å­£åº¦)
â”œâ”€ earthlord_annual_subscriptions (å¹´åº¦)
â””â”€ earthlord_vip_subscriptions (VIP)
```

#### **ç¬¬äºŒæ­¥: åˆ›å»ºæ¶ˆè€—æ€§äº§å“** (15 åˆ†é’Ÿ)

```
åˆ›å»º 4 ä¸ªæ¶ˆè€—æ€§äº§å“:

äº§å“ 1:
â”œâ”€ ç±»å‹: æ¶ˆè€—æ€§
â”œâ”€ äº§å“ ID: com.earthlord.supply.survivor
â”œâ”€ åç§°: å¹¸å­˜è€…è¡¥ç»™åŒ…
â”œâ”€ æè¿°: åŒ…å«åŸºç¡€ç”Ÿå­˜ç‰©èµ„
â”œâ”€ ä»·æ ¼: Â¥6
â””â”€ ä¿å­˜

[é‡å¤ä¸ºå…¶ä»– 3 ä¸ªäº§å“]
```

#### **ç¬¬ä¸‰æ­¥: åˆ›å»ºéç»­æœŸè®¢é˜…** (20 åˆ†é’Ÿ)

```
åˆ›å»º 9 ä¸ªéç»­æœŸè®¢é˜…äº§å“:

ç¤ºä¾‹ - com.earthlord.tactical.1m:
â”œâ”€ ç±»å‹: éç»­æœŸè®¢é˜…
â”œâ”€ è®¢é˜…ç»„: (ç•™ç©ºï¼Œæ­¤ç±»å‹ä¸éœ€è¦)
â”œâ”€ äº§å“ ID: com.earthlord.tactical.1m
â”œâ”€ åç§°: æˆ˜æœ¯æ”¯æ´-æœˆå¡
â”œâ”€ æè¿°: è·å¾— 30 å¤©çš„å»ºé€ åŠ é€Ÿå’Œèµ„æºåŠ æˆ
â”œâ”€ å‚è€ƒä»·æ ¼: $0.99 (ç³»ç»Ÿè½¬æ¢ä¸º Â¥8)
â”œâ”€ è‡ªå®šä¹‰ç”¨æˆ·åè®®: [é€‰æ‹©]
â””â”€ ä¿å­˜

[åˆ›å»ºå…¶ä½™ 8 ä¸ªéç»­æœŸäº§å“]
```

#### **ç¬¬å››æ­¥: åˆ›å»ºè‡ªåŠ¨ç»­æœŸè®¢é˜…** (25 åˆ†é’Ÿ)

```
åˆ›å»º 4 ä¸ªç»­æœŸè®¢é˜…äº§å“:

ç¤ºä¾‹ - com.earthlord.vip.monthly:
â”œâ”€ ç±»å‹: è‡ªåŠ¨ç»­æœŸè®¢é˜…
â”œâ”€ è®¢é˜…ç»„: earthlord_vip_subscriptions
â”œâ”€ äº§å“ ID: com.earthlord.vip.monthly
â”œâ”€ åç§°: VIP æœˆä¼šå‘˜
â”œâ”€ æè¿°: è·å¾— VIP ä¼šå‘˜æƒç›Šï¼Œæœˆåº¦è‡ªåŠ¨ç»­è´¹
â”‚
â”œâ”€ ä»·æ ¼å’Œæ—¶é—´è¡¨:
â”‚  â”œâ”€ åŸºç¡€ä»·æ ¼: Â¥12/æœˆ
â”‚  â”œâ”€ æ·»åŠ ä»·æ ¼ç­‰çº§: [+ æŒ‰é’®]
â”‚  â””â”€ (æ¶µç›–æ‰€æœ‰åœ°åŒº)
â”‚
â”œâ”€ è¯•ç”¨æœŸé—´:
â”‚  â””â”€ å…è´¹è¯•ç”¨: 3 å¤© (å¯é€‰)
â”‚
â”œâ”€ æ¨ä»‹ä»·æ ¼:
â”‚  â”œâ”€ å¯ç”¨: [æ˜¯]
â”‚  â”œâ”€ æ¨ä»‹ä»·æ ¼: Â¥6
â”‚  â”œâ”€ æ•°é‡: 1 æœŸ
â”‚  â””â”€ æŒç»­æ—¶é—´: 1 ä¸ªæœˆ
â”‚
â”œâ”€ æœ¬åœ°åŒ–ä¿¡æ¯:
â”‚  â”œâ”€ æ˜¾ç¤ºåç§°: VIP æœˆä¼šå‘˜
â”‚  â”œâ”€ æè¿°: è·å¾—è®¢é˜…ä¼šå‘˜æƒç›Š
â”‚  â””â”€ [æ·»åŠ æœ¬åœ°åŒ–ç‰ˆæœ¬]
â”‚
â””â”€ ä¿å­˜
```

#### **ç¬¬äº”æ­¥: é…ç½®æœ¬åœ°åŒ–** (15 åˆ†é’Ÿ)

```
ä¸ºæ¯ä¸ªäº§å“æ·»åŠ æœ¬åœ°åŒ–:

1. ç¼–è¾‘äº§å“ ID
2. æ»šåŠ¨åˆ° "æœ¬åœ°åŒ–ä¿¡æ¯"
3. ç‚¹å‡» "+ æ·»åŠ è¯­è¨€"

é…ç½®ä¸­æ–‡ (ç®€ä½“):
â”œâ”€ æ˜¾ç¤ºåç§°: [ä¸­æ–‡åç§°]
â”œâ”€ æè¿°: [ä¸­æ–‡æè¿°]
â”œâ”€ å±å¹•æˆªå›¾: [å¯é€‰]
â””â”€ ä¿å­˜

å»ºè®®è¯­è¨€:
- ä¸­æ–‡ (ç®€ä½“)
- ä¸­æ–‡ (ç¹ä½“)
- English
- æ—¥æœ¬èª
```

#### **ç¬¬å…­æ­¥: åˆ›å»ºæ²™ç›’æµ‹è¯•è´¦æˆ·** (10 åˆ†é’Ÿ)

```
1. æ–°å»ºåº”ç”¨ > ç”¨æˆ·å’Œè§’è‰² > æ²™ç›’
2. ç‚¹å‡» "+ åˆ›å»ºæ²™ç›’æµ‹è¯•è´¦æˆ·"

åˆ›å»º 2-3 ä¸ªæµ‹è¯•è´¦æˆ·:

è´¦æˆ· 1:
â”œâ”€ ç”¨æˆ·å: test.survivor@example.com
â”œâ”€ å¯†ç : [å¼ºå¯†ç ]
â”œâ”€ ç”Ÿæ—¥: [ä»»æ„ 18 å²ä»¥ä¸Š]
â””â”€ ä¿å­˜

è´¦æˆ· 2:
â”œâ”€ ç”¨æˆ·å: test.vip@example.com
â””â”€ [é‡å¤æ­¥éª¤]
```

---

## 8. 21 å¤©åˆ†é˜¶æ®µå®æ–½è®¡åˆ’

### 8.1 Phase 1: æ¶ˆè€—æ€§äº§å“ & åŸºç¡€æ¶æ„ (Day 1-7)

#### **Day 1: ç¯å¢ƒå‡†å¤‡ä¸äº§å“é…ç½®** (4 å°æ—¶)

- [ ] App Store Connect åˆ›å»º 4 ä¸ªæ¶ˆè€—æ€§äº§å“
- [ ] é…ç½®æœ¬åœ°åŒ–ä¿¡æ¯
- [ ] åˆ›å»ºæ²™ç›’æµ‹è¯•è´¦æˆ·
- [ ] åŒæ­¥äº§å“ ID åˆ° Xcode

**è¾“å‡ºç‰©**:
- âœ… 4 ä¸ªäº§å“ ID å·²åœ¨ App Store Connect åˆ›å»º
- âœ… Xcode é¡¹ç›®é…ç½®å®Œæˆ
- âœ… 2 ä¸ªæ²™ç›’æµ‹è¯•è´¦æˆ·å¯ç”¨

#### **Day 2-3: ä»£ç å®ç°** (10 å°æ—¶)

- [ ] åˆ›å»º IAPModels.swift (æƒç›Šå®šä¹‰)
- [ ] å®ç° IAPManager.swift (åŸºç¡€åŠŸèƒ½)
- [ ] åˆ›å»ºæ¶ˆè€—æ€§äº§å“è´­ä¹° UI
- [ ] é›†æˆåº“å­˜ç³»ç»Ÿ

**ä»£ç å·¥ä½œ**:
```swift
// IAPManager - æ¶ˆè€—æ€§äº§å“å¤„ç†
func grantConsumableRewards(_ productID: String) async {
    // æ ¹æ®äº§å“ ID ç»™äºˆå¯¹åº”èµ„æº
}

// SubscriptionView - è´­ä¹° UI
struct SubscriptionView: View { ... }
```

#### **Day 4-5: æƒç›Šç³»ç»Ÿ** (8 å°æ—¶)

- [ ] åˆ›å»º RightsManager.swift
- [ ] é›†æˆæƒç›Šåˆ°åº“å­˜ã€å»ºç­‘ç³»ç»Ÿ
- [ ] å®ç°æƒç›Šæ£€æŸ¥å’Œåº”ç”¨
- [ ] æœ¬åœ°å­˜å‚¨æƒç›Šæ•°æ®

#### **Day 6: æµ‹è¯•ä¸è°ƒè¯•** (4 å°æ—¶)

- [ ] æ²™ç›’è´­ä¹°æµ‹è¯• (4 ä¸ªæ¶ˆè€—æ€§äº§å“)
- [ ] æƒç›ŠéªŒè¯æµ‹è¯•
- [ ] è°ƒè¯•æƒç›Šåº”ç”¨é€»è¾‘
- [ ] ä¿®å¤ bug

**æµ‹è¯•æ¸…å•**:
- [x] T01: è´­ä¹° survivor
- [x] T02: è´­ä¹° overlord
- [x] T07: æƒç›Šæ€»ä½“éªŒè¯

#### **Day 7: ä»£ç æ¸…ç†ä¸æ–‡æ¡£** (2 å°æ—¶)

- [ ] ä»£ç å®¡æŸ¥å’Œé‡æ„
- [ ] ç¼–å†™é›†æˆæ–‡æ¡£
- [ ] æ›´æ–°ä»£ç æ³¨é‡Š

**Phase 1 å®Œæˆæ¡ä»¶**:
- âœ… 4 ä¸ªæ¶ˆè€—æ€§äº§å“å¯æ­£å¸¸è´­ä¹°
- âœ… èµ„æºæ­£ç¡®åˆ†é…
- âœ… æ— ç¼–è¯‘é”™è¯¯
- âœ… åŸºç¡€æ¶æ„å®Œæˆ

---

### 8.2 Phase 2: éç»­æœŸè®¢é˜… (Day 8-14)

#### **Day 8: äº§å“é…ç½®** (3 å°æ—¶)

- [ ] App Store Connect åˆ›å»º 9 ä¸ªéç»­æœŸäº§å“
- [ ] é…ç½®æ‰€æœ‰æœ¬åœ°åŒ–
- [ ] åŒæ­¥äº§å“ ID

**è¾“å‡º**:
- âœ… 9 ä¸ªäº§å“ ID å·²é…ç½®
- âœ… æœ¬åœ°åŒ–å®Œæˆ

#### **Day 9-11: ä»£ç æ‰©å±•** (12 å°æ—¶)

- [ ] æ‰©å±• IAPModels å®šä¹‰æ‰€æœ‰ 9 ä¸ªäº§å“æƒç›Š
- [ ] æ‰©å±• IAPManager å¤„ç†éç»­æœŸè®¢é˜…
- [ ] å®ç°è®¢é˜…æ•°æ®åº“è¡¨
- [ ] åˆ›å»ºè®¢é˜… UI ç»„ä»¶
- [ ] æ•°æ®åº“è¿ç§»è„šæœ¬

#### **Day 12-13: æƒç›Šä¸æœåŠ¡å™¨åŒæ­¥** (8 å°æ—¶)

- [ ] å®ç°è®¢é˜…è®°å½•ä¿å­˜
- [ ] é›†æˆ Supabase åŒæ­¥
- [ ] æƒç›Šè¿‡æœŸæ£€æŸ¥æœºåˆ¶
- [ ] å‡çº§/é™çº§é€»è¾‘

#### **Day 14: æµ‹è¯•ä¸ä¼˜åŒ–** (3 å°æ—¶)

- [ ] å®Œæ•´æ²™ç›’æµ‹è¯• (T03, T04, T08 ç­‰)
- [ ] æƒç›Šç”Ÿæ•ˆéªŒè¯
- [ ] æ€§èƒ½ä¼˜åŒ–

**Phase 2 å®Œæˆæ¡ä»¶**:
- âœ… 9 ä¸ªéç»­æœŸäº§å“å¯è´­ä¹°
- âœ… æƒç›Š 30/90/365 å¤©æ­£ç¡®åº”ç”¨
- âœ… æƒç›Šè¿‡æœŸæ­£ç¡®è§¦å‘
- âœ… æ”¯æŒå‡çº§å’Œé™çº§

---

### 8.3 Phase 3: è‡ªåŠ¨ç»­æœŸè®¢é˜… (Day 15-21)

#### **Day 15: äº§å“æœ€ç»ˆé…ç½®** (3 å°æ—¶)

- [ ] App Store Connect åˆ›å»º 4 ä¸ªç»­æœŸäº§å“
- [ ] é…ç½®è®¢é˜…ç»„
- [ ] è®¾ç½®è¯•ç”¨æœŸå’Œæ¨ä»‹ä»·æ ¼
- [ ] åˆ›å»ºæ²™ç›’æµ‹è¯•è´¦æˆ·

#### **Day 16-18: ç»­æœŸé€»è¾‘å®ç°** (12 å°æ—¶)

- [ ] å®ç°è‡ªåŠ¨ç»­è´¹æ£€æŸ¥
- [ ] å¤„ç†ç»­æœŸæ›´æ–°äº‹ä»¶
- [ ] ç»­æœŸå¤±è´¥å¤„ç†
- [ ] ç”¨æˆ·å–æ¶ˆè®¢é˜…é€»è¾‘
- [ ] è§„æ ¼è¡¨æ˜¾ç¤º

#### **Day 19-20: å®Œæ•´é›†æˆä¸ä¼˜åŒ–** (8 å°æ—¶)

- [ ] æ•´åˆæ‰€æœ‰ 16 äº§å“
- [ ] UI ç»Ÿä¸€ä¼˜åŒ–
- [ ] æ€§èƒ½æµ‹è¯•
- [ ] å®‰å…¨å®¡è®¡

#### **Day 21: æœ€ç»ˆéªŒæ”¶** (2 å°æ—¶)

- [ ] å®Œæ•´ç³»ç»Ÿæµ‹è¯•æ¸…å• (æ‰€æœ‰ 12 ä¸ªåœºæ™¯)
- [ ] æœ€åçš„ bug ä¿®å¤
- [ ] æ–‡æ¡£å®Œæˆ
- [ ] ç”Ÿäº§ç¯å¢ƒå‡†å¤‡

**Phase 3 å®Œæˆæ¡ä»¶**:
- âœ… 4 ä¸ªç»­æœŸäº§å“å»ºç«‹
- âœ… è‡ªåŠ¨ç»­è´¹æ­£å¸¸å·¥ä½œ
- âœ… è¯•ç”¨æœŸåŠŸèƒ½æ­£ç¡®
- âœ… VIP æƒç›ŠæŒç»­æœ‰æ•ˆ
- âœ… å®Œæ•´çš„ 16 äº§å“ç³»ç»Ÿä¸Šçº¿

---

## 9. æ•…éšœæ’æŸ¥æŒ‡å—

### 9.1 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

#### **é—®é¢˜ 1: "äº§å“ä¸å¯ç”¨"é”™è¯¯**

```
ç—‡çŠ¶: è´­ä¹°æ—¶æ˜¾ç¤º "æ­¤äº§å“ä¸å¯ç”¨"
åŸå› :
1. äº§å“ ID ä¸åŒ¹é…
2. äº§å“æœªé€šè¿‡ App Store å®¡æ ¸
3. è¿‡æœŸæ—¶é—´è®¾ç½®é”™è¯¯
4. åœ°åŸŸé™åˆ¶é—®é¢˜

è§£å†³æ­¥éª¤:
1. æ£€æŸ¥ Xcode ä¸­çš„äº§å“ ID æ˜¯å¦å®Œå…¨åŒ¹é…
2. åœ¨ App Store Connect ä¸­æ£€æŸ¥äº§å“çŠ¶æ€ (æ˜¯å¦ä¸º "æ´»è·ƒ")
3. éªŒè¯æ²™ç›’è´¦æˆ·æ‰€åœ¨åœ°åŒº
4. æ¸…é™¤ app ç¼“å­˜é‡è¯•
```

#### **é—®é¢˜ 2: æƒç›Šæœªç”Ÿæ•ˆ**

```
ç—‡çŠ¶: è´­ä¹°å®Œæˆä½†æƒç›Šæ²¡æœ‰åº”ç”¨
åŸå› :
1. IAPManager æœªæ­£ç¡®åˆå§‹åŒ–
2. æƒç›Šç³»ç»Ÿæœªè°ƒç”¨
3. æ”¶æ®éªŒè¯å¤±è´¥
4. æœ¬åœ°å­˜å‚¨æœªåŒæ­¥

è§£å†³æ­¥éª¤:
// æ·»åŠ è°ƒè¯•ä»£ç 
print("âœ… è´­ä¹°æˆåŠŸ: productID = \(transaction.productID)")
print("âœ… æƒç›Šå¯¹è±¡: \(Entitlement(productID: transaction.productID))")
print("âœ… IAPManager.shared.purchasedProductIDs = \(IAPManager.shared.purchasedProductIDs)")

2. æ£€æŸ¥ RightsManager.checkAndApplyRights() æ˜¯å¦è¢«è°ƒç”¨
3. è§‚å¯Ÿ activeRights å­—å…¸æ˜¯å¦æœ‰æ•°æ®
```

#### **é—®é¢˜ 3: è‡ªåŠ¨ç»­è´¹æœªè§¦å‘**

```
ç—‡çŠ¶: VIP è®¢é˜…åº”è¯¥ç»­è´¹ä½†æ²¡æœ‰è‡ªåŠ¨æ‰£è´¹
åŸå› :
1. è‡ªåŠ¨ç»­è´¹è®¾ç½®æœªå¯ç”¨
2. ç”¨æˆ·å–æ¶ˆäº†è®¢é˜…
3. æ”¯ä»˜æ–¹æ³•å·²è¿‡æœŸ
4. Apple å¤„ç†å»¶è¿Ÿ

è§£å†³æ­¥éª¤:
1. æ£€æŸ¥ App Store Connect ä¸­çš„è®¢é˜…çŠ¶æ€
2. æŸ¥çœ‹ isAutoRenewEnabled æ ‡å¿—
3. å¦‚æœæ˜¯æ²™ç›’ç¯å¢ƒï¼Œç»­è´¹æ˜¯å³æ—¶çš„
4. æŸ¥çœ‹ subscription_audit_log è¡¨ä¸­çš„å–æ¶ˆè®°å½•
```

#### **é—®é¢˜ 4: æ”¶æ®éªŒè¯å¤±è´¥**

```
ç—‡çŠ¶: è´­ä¹°å®Œæˆä½†æ”¶æ®éªŒè¯å‡ºé”™
åŸå› :
1. æ”¶æ®æ ¼å¼æŸå
2. æœåŠ¡ç«¯ API è¯·æ±‚å¤±è´¥
3. JWT éªŒè¯å¤±è´¥

è§£å†³æ­¥éª¤:
do {
    let transaction = try checkVerified(result)
    // éªŒè¯æˆåŠŸ
} catch {
    print("âŒ æ”¶æ®éªŒè¯é”™è¯¯: \(error)")
    // æ£€æŸ¥é”™è¯¯ç±»å‹
    if let storeKitError = error as? StoreKitError {
        print("StoreKit Error: \(storeKitError)")
    }
}
```

### 9.2 è°ƒè¯•å·¥å…·å’Œå‘½ä»¤

```bash
# æŸ¥çœ‹ Xcode æ—¥å¿—
log stream --predicate 'process == "EarthLord"' --level debug

# æ¸…é™¤ç¼“å­˜
defaults delete com.apple.dt.Xcode IDESourceTreeDisplayNames
defaults delete com.apple.dt.Xcode IDESourceTreeNames

# æ¨¡æ‹Ÿ StoreKit äº¤æ˜“
xcrun simctl keychain /Users/lyanwen/Library/Developer/CoreSimulator/Devices/[DEVICE_ID]/data/Library/Keychains/keychain-2.sqlite

# å¯¼å‡º Supabase è®¢é˜…æ—¥å¿—
curl -H "Authorization: Bearer YOUR_API_KEY" \
  "https://your-project.supabase.co/rest/v1/user_subscriptions" \
  > subscriptions_export.json
```

---

## é™„å½•: å…³é”®ä»£ç ç‰‡æ®µé›†åˆ

### æƒç›Šæ£€æŸ¥

```swift
// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰ç‰¹å®šæƒç›Š
func hasSubscription(category: ProductCategory) -> Bool {
    return IAPManager.shared.getHighestTierSubscription()?.category == category ||
           (IAPManager.shared.getHighestTierSubscription()?.category.tier ?? -1) >= category.tier
}

// è·å–å½“å‰æ¿€æ´»çš„æƒç›ŠåŠ æˆ
func getActiveBonus(type: String) -> Double {
    guard let entitlement = RightsManager.shared.getHighestTierRight() else {
        return 0
    }
    
    switch type {
    case "buildSpeed":
        return entitlement.buildSpeedBonus
    case "resourceOutput":
        return entitlement.resourceOutputBonus
    case "defense":
        return entitlement.defenseBonus
    default:
        return 0
    }
}
```

### æƒç›Šåº”ç”¨åˆ°æ¸¸æˆç³»ç»Ÿ

```swift
// åœ¨å»ºç­‘ç³»ç»Ÿä¸­åº”ç”¨æƒç›Š
class BuildingManager {
    func calculateBuildingTime(_ baseTime: Int) -> Int {
        let speedupBonus = RightsManager.shared.getHighestTierRight()?.buildSpeedBonus ?? 0
        return Int(Double(baseTime) * (1 - speedupBonus))
    }
}

// åœ¨åº“å­˜ç³»ç»Ÿä¸­åº”ç”¨æƒç›Š
class InventoryManager {
    var maxCapacity: Int {
        let baseCapacity = 100
        let bonus = RightsManager.shared.getHighestTierRight()?.backpackCapacityBonus ?? 0
        return baseCapacity + bonus
    }
}
```

---

**æ–‡æ¡£å®Œæˆï¼** ğŸ‰

è¿™ä»½å®Œæ•´ç‰ˆå¼€å‘æŒ‡å—æ¶µç›–äº†ï¼š
- âœ… 16 ä¸ªäº§å“çš„å®Œæ•´å®šä¹‰
- âœ… å…¨éƒ¨ä»£ç å®ç°æ¡†æ¶
- âœ… æ•°æ®åº“è®¾è®¡å’Œè¿ç§»
- âœ… æƒç›Šç³»ç»Ÿé›†æˆ
- âœ… 12 ä¸ªå®Œæ•´æµ‹è¯•åœºæ™¯
- âœ… App Store é…ç½®è¯¦ç»†æ­¥éª¤
- âœ… 21 å¤©åˆ†é˜¶æ®µå®æ–½è®¡åˆ’
- âœ… æ•…éšœæ’æŸ¥æŒ‡å—

é¢„è®¡æ€»å·¥ä½œé‡ï¼š21 å¤©ï¼ŒæŒ‰ä¸‰ä¸ªé˜¶æ®µé€’è¿›å®æ–½ã€‚
