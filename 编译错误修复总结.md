# ğŸ”§ ï¿½ï¿½ï¿½å°±æ’è¡Œæ¦œç³»ç»Ÿ - ç¼–è¯‘é”™è¯¯ä¿®å¤æ€»ç»“

## âœ… å·²ä¿®å¤çš„é—®é¢˜

### 1. SupabaseClient è®¿é—®æ–¹å¼é”™è¯¯
**é”™è¯¯**ï¼š`Type 'SupabaseClient' has no member 'shared'`

**åŸå› **ï¼šé¡¹ç›®ä¸­ä½¿ç”¨çš„æ˜¯å…¨å±€å˜é‡ `supabaseClient`ï¼Œä¸æ˜¯å•ä¾‹ `SupabaseClient.shared`

**ï¿½ï¿½å¤**ï¼š
```swift
// âŒ é”™è¯¯å†™æ³•
private let supabase = SupabaseClient.shared

// âœ… æ­£ç¡®å†™æ³•
private let supabase = supabaseClient
```

### 2. AuthManager ç”¨æˆ·IDè®¿é—®é”™è¯¯
**é”™è¯¯**ï¼š`Value of type 'AuthManager' has no member 'currentUserId'`

**åŸå› **ï¼šåº”é€šè¿‡ `currentUser?.id` è®¿é—®ç”¨æˆ·ID

**ä¿®å¤**ï¼š
```swift
// âŒ é”™è¯¯å†™æ³•
guard let userId = AuthManager.shared.currentUserId else { return }

// âœ… æ­£ç¡®å†™æ³•
guard let userId = AuthManager.shared.currentUser?.id else { return }
```

### 3. Supabase æ•°æ®åº“æŸ¥è¯¢APIä½¿ç”¨é”™è¯¯
**é”™è¯¯**ï¼š`No calls to throwing functions occur within 'try' expression`

**åŸå› **ï¼šä¸èƒ½ç›´æ¥ä½¿ç”¨ `.database.rpc("execute_sql")` æ‰§è¡ŒSQLå­—ç¬¦ä¸²

**ä¿®å¤**ï¼šä½¿ç”¨ Supabase çš„ç±»å‹å®‰å…¨æŸ¥è¯¢API
```swift
// âŒ é”™è¯¯å†™æ³•
let query = "SELECT * FROM table..."
let response: [LeaderboardEntry] = try await supabase.database.rpc(
    fn: "execute_sql",
    params: ["sql": query]
).value

// âœ… æ­£ç¡®å†™æ³•
let response: [LeaderboardEntry] = try await supabase.database
    .from("v_leaderboard_with_user")
    .select()
    .order("total_points", ascending: false)
    .range(from: offset, to: offset + limit - 1)
    .execute()
    .value
```

### 4. æœªä½¿ç”¨çš„å˜é‡è­¦å‘Š
**é”™è¯¯**ï¼š`Initialization of immutable value 'xxxQuery' was never used`

**åŸå› **ï¼šæ„å»ºäº†SQLæŸ¥è¯¢å­—ç¬¦ä¸²ä½†æ²¡æœ‰ä½¿ç”¨

**ä¿®å¤**ï¼šç§»é™¤æœªä½¿ç”¨çš„SQLå­—ç¬¦ä¸²ï¼Œç›´æ¥ä½¿ç”¨ Supabase API

---

## ğŸ“ ä¿®å¤åçš„ä»£ç ç»“æ„

### LeaderboardManager.swift

```swift
@MainActor
class LeaderboardManager: ObservableObject {
    @Published var isLoading = false
    @Published var errorMessage: String?

    private let supabase = supabaseClient  // âœ… ä½¿ç”¨å…¨å±€å˜é‡
    private let authManager = AuthManager.shared

    // âœ… æ­£ç¡®çš„æ•°æ®åº“æŸ¥è¯¢æ–¹å¼
    func fetchPointsLeaderboard(limit: Int = 100, offset: Int = 0) async throws -> [LeaderboardEntry] {
        isLoading = true
        defer { isLoading = false }

        let response: [LeaderboardEntry] = try await supabase.database
            .from("v_leaderboard_with_user")
            .select()
            .order("total_points", ascending: false)
            .range(from: offset, to: offset + limit - 1)
            .execute()
            .value

        return response
    }

    // âœ… æ­£ç¡®çš„è®¤è¯æ£€æŸ¥
    func updateUserLeaderboard() async throws {
        guard let userId = authManager.currentUser?.id else {  // âœ… é€šè¿‡ currentUser è·å– ID
            throw LeaderboardError.notAuthenticated
        }

        isLoading = true
        defer { isLoading = false }

        let _: [String: Any] = try await supabase.database.rpc(
            fn: "update_user_achievement_leaderboard",
            params: ["p_user_id": userId.uuidString]
        ).value
    }
}
```

### AchievementStatsView.swift

```swift
private func loadStats() {
    guard let userId = AuthManager.shared.currentUser?.id else { return }  // âœ… ä¿®å¤

    isLoading = true

    Task {
        do {
            let stats = try await manager.fetchUserLeaderboardStats(userId: userId)
            await MainActor.run {
                self.userStats = stats
                self.isLoading = false
            }
        } catch {
            await MainActor.run {
                self.isLoading = false
            }
        }
    }
}
```

---

## ğŸ¯ å…³é”®ä¿®å¤ç‚¹

### Supabase API ä½¿ç”¨è§„èŒƒ

| æ“ä½œ | æ­£ç¡®ç”¨æ³• |
|------|----------|
| æŸ¥è¯¢æ•°æ® | `.from("table").select().execute().value` |
| æ’åº | `.order("column", ascending: false)` |
| è¿‡æ»¤ | `.eq("column", value: xxx)` |
| åˆ†é¡µ | `.range(from: x, to: y)` |
| è°ƒç”¨RPC | `.database.rpc(fn: "name", params: [...])` |

### ç”¨æˆ·è®¤è¯è®¿é—®

```swift
// âœ… æ­£ç¡®æ–¹å¼
AuthManager.shared.currentUser?.id

// âŒ é”™è¯¯æ–¹å¼
AuthManager.shared.currentUserId
```

---

## ğŸš€ ç°åœ¨å¯ä»¥ç¼–è¯‘è¿è¡Œ

æ‰€æœ‰ç¼–è¯‘é”™è¯¯å·²ä¿®å¤ï¼æ¥ä¸‹æ¥å¯ä»¥ï¼š

1. âœ… ç¼–è¯‘é¡¹ç›®
2. âœ… æ‰§è¡Œæ•°æ®åº“è¿ç§»ï¼ˆå¦‚æœè¿˜æ²¡æ‰§è¡Œï¼‰
3. âœ… åœ¨ ProfileTabView ä¸­é›†æˆ
4. âœ… æµ‹è¯•åŠŸèƒ½

---

## ğŸ“‹ å¿«é€Ÿé›†æˆæ£€æŸ¥

### ç¼–è¯‘æ£€æŸ¥
```bash
cd /Users/lyanwen/Desktop/EarthLord
xcodebuild -scheme EarthLord -sdk iphonesimulator clean build
```

### é›†æˆåˆ° ProfileTabView
```swift
// 1. æ·»åŠ çŠ¶æ€å˜é‡
@State private var showAchievementDetail = false

// 2. åœ¨ ScrollView ä¸­æ·»åŠ 
AchievementStatsView(showFullLeaderboard: $showAchievementDetail)
    .padding(.horizontal, 20)
    .padding(.bottom, 16)

// 3. æ·»åŠ  sheet
.sheet(isPresented: $showAchievementDetail) {
    CategoryAchievementStatsView()
}
```

---

## ğŸ‰ ä¿®å¤å®Œæˆ

- âœ… æ‰€æœ‰ç¼–è¯‘é”™è¯¯å·²è§£å†³
- âœ… ä»£ç ç¬¦åˆé¡¹ç›®è§„èŒƒ
- âœ… API è°ƒç”¨æ–¹å¼æ­£ç¡®
- âœ… è®¤è¯è®¿é—®æ–¹å¼æ­£ç¡®
- âœ… æ— æœªä½¿ç”¨å˜é‡è­¦å‘Š

**ç°åœ¨å¯ä»¥æ­£å¸¸ç¼–è¯‘å’Œè¿è¡Œäº†ï¼** ğŸš€
