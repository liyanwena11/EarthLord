# 🔧 成就排行榜和新手引导 - 集成修复指南

## ✅ 已完成的集成

### 1. 成就排行榜系统

已在 `ProfileTabView.swift` 中添加：

```swift
// ✅ 状态变量已添加
@State private var showAchievementDetail = false

// ✅ 成就统计模块已添加（在物资商城之后）
AchievementStatsView(showFullLeaderboard: $showAchievementDetail)
    .padding(.horizontal, 20)
    .padding(.bottom, 16)

// ✅ 详细统计 sheet 已添加
.sheet(isPresented: $showAchievementDetail) {
    CategoryAchievementStatsView()
}
```

### 2. 新手引导系统

新手引导系统已经集成在 `EarthLordApp.swift` 中，逻辑如下：

```swift
// ✅ 登录后自动检查
MainTabView()
    .onAppear {
        checkAndShowOnboarding()
    }

// ✅ 引导覆盖层
if showOnboarding {
    OnboardingView(isShown: $showOnboarding) {
        Task {
            await onboardingManager.markOnboardingCompleted()
        }
    }
    .zIndex(999)
}
```

---

## 🧪 测试和调试

### 测试成就排行榜

#### 1. 查看个人界面
1. 运行 App
2. 点击底部导航栏的"我的"标签
3. 向下滚动，应该看到"🏆 成就统计"模块
4. 点击"查看完整排行榜"应该打开详细排行榜

#### 2. 如果看不到成就统计

**可能原因：**
- 数据库迁移未执行
- 视图文件未正确添加

**解决方案：**
```bash
# 1. 确保文件存在
ls -la EarthLord/Views/Profile/AchievementStatsView.swift
ls -la EarthLord/Views/Profile/CategoryAchievementStatsView.swift

# 2. 执行数据库迁移
supabase db push supabase_migration_010_achievement_leaderboard.sql

# 3. 清理 Xcode 缓存
# Product -> Clean Build Folder (⇧⌘K)
# 然后重新编译
```

#### 3. 检查数据库数据

```sql
-- 检查排行榜表是否存在
SELECT table_name
FROM information_schema.tables
WHERE table_name LIKE '%leaderboard%';

-- 检查是否有成就数据
SELECT COUNT(*) FROM achievements;
SELECT COUNT(*) FROM user_achievements;

-- 手动添加测试数据（如果需要）
INSERT INTO achievement_leaderboard (user_id, total_points, total_achievements, completion_rate, ranking_position)
VALUES ('your-user-id', 1000, 10, 0.1, NULL);
```

---

### 测试新手引导

#### 1. 查看引导页面

**正常流程：**
1. 退出登录
2. 重新登录
3. 登录成功后应该看到引导覆盖层

#### 2. 如果看不到引导

**可能原因：**
- 本地缓存显示已看过
- 数据库中标记为已看过

**解决方案：**

##### 方法1：清除本地缓存
```swift
// 在 Xcode Console 中执行
UserDefaults.standard.removeObject(forKey: "has_seen_onboarding")
```

##### 方法2：使用调试模式
在 `EarthLordApp.swift` 中设置：
```swift
@AppStorage("debug_force_show_onboarding") private var debugForceShowOnboarding = true
```

##### 方法3：重置数据库标记
```sql
-- 重置当前用户的引导状态
UPDATE profiles
SET has_seen_onboarding = false
WHERE id = auth.uid();

-- 查看当前状态
SELECT id, has_seen_onboarding
FROM profiles
WHERE id = auth.uid();
```

##### 方法4：完全重置（测试用）
```sql
-- 删除所有引导相关数据
UPDATE profiles
SET has_seen_onboarding = false;
```

---

## 🎯 快速测试步骤

### 测试成就排行榜

1. **编译运行**
   ```bash
   # 确保 Xcode 中没有编译错误
   # Product -> Run (⌘R)
   ```

2. **查看个人界面**
   - 点击"我的"标签
   - 滚动到"背包容量进度条"下方
   - 应该看到成就统计卡片

3. **测试功能**
   - 查看数据是否显示
   - 点击"查看完整排行榜"
   - 检查详细排行榜是否正常

### 测试新手引导

1. **清除引导状态**
   ```swift
   // 在 App 启动时添加这段代码
   UserDefaults.standard.removeObject(forKey: "has_seen_onboarding")
   ```

2. **重新登录**
   - 退出登录
   - 重新登录
   - 应该看到引导覆盖层

3. **完成引导**
   - 跟随引导步骤
   - 完成后标记为已看
   - 下次登录不应再显示

---

## 🐛 常见问题排查

### 问题1：成就统计不显示

**症状：** 个人界面看不到"成就统计"模块

**排查：**
```swift
// 1. 检查文件是否在项目中
// 在 Xcode 左侧项目导航器中查找：
// - AchievementStatsView.swift
// - CategoryAchievementStatsView.swift

// 2. 检查编译错误
// 查看 Xcode Issue Navigator

// 3. 检查 ProfileTabView 集成
// 确认以下代码存在：
@State private var showAchievementDetail = false
AchievementStatsView(showFullLeaderboard: $showAchievementDetail)
.sheet(isPresented: $showAchievementDetail) {
    CategoryAchievementStatsView()
}
```

**解决：**
```bash
# 1. 清理编译缓存
rm -rf ~/Library/Developer/Xcode/DerivedData

# 2. 重新编译
# Xcode -> Product -> Clean Build Folder
# Xcode -> Product -> Build
```

### 问题2：引导显示一次后不再显示

**症状：** 第一次登录看到引导，之后再登录看不到了

**原因：** 引导完成后会保存状态到本地和数据库

**测试时清除状态：**
```swift
// 在 EarthLordApp.swift 的 init() 中添加
init() {
    // ⚠️ 测试代码：每次启动都重置引导状态
    UserDefaults.standard.removeObject(forKey: "has_seen_onboarding")
    // ... 其他 init 代码
}
```

### 问题3：引导显示但无法关闭

**症状：** 引导覆盖层显示，但点击完成按钮没反应

**排查：**
```swift
// 检查 OnboardingView 的完成回调
OnboardingView(isShown: $showOnboarding) {
    Task {
        await onboardingManager.markOnboardingCompleted()
    }
}

// 确保 markOnboardingCompleted 正常工作
```

---

## 📊 验证清单

### 成就排行榜
- [ ] 个人界面显示成就统计模块
- [ ] 显示用户成就数据（积分、数量、完成度、排名）
- [ ] 点击"查看完整排行榜"打开详细页面
- [ ] 详细排行榜正确显示排名数据
- [ ] 分类排行榜正常工作

### 新手引导
- [ ] 新用户首次登录显示引导
- [ ] 引导可以正常完成
- [ ] 完成后不再显示
- [ ] 退出登录后重新登录不重复显示
- [ ] 调试模式可以强制显示

---

## 🚀 强制显示引导（用于测试）

### 在代码中添加调试开关

在 `EarthLordApp.swift` 中：

```swift
struct AuthFlowView: View {
    // ...
    @AppStorage("debug_force_show_onboarding") private var debugForceShowOnboarding = true  // ✅ 设为 true

    var body: some View {
        // ...
    }
}
```

### 或者在 Console 中执行

```swift
// 在 Xcode Console 的 LLDB 中执行
e UserDefaults.standard.removeObject(forKey: "has_seen_onboarding")
```

---

## 📝 日志调试

### 启用详细日志

在 Xcode Console 中查看：

```
🎯 [OnboardingManager] 本地缓存: has_seen_onboarding = false
☁️ [OnboardingManager] 服务器返回: has_seen_onboarding = Optional(false)
✅ [OnboardingManager] 需要显示引导！shouldShowOnboarding = true
```

### 成就系统日志

```
🔍 [LeaderboardManager] 正在加载排行榜数据
📊 [LeaderboardManager] 加载到 50 条记录
✅ [AchievementStatsView] 显示用户统计数据
```

---

## 🎉 完成

现在两个功能都已集成：
- ✅ 成就排行榜在个人界面中
- ✅ 新手引导在登录后自动显示

如果还有问题，请检查：
1. Xcode 编译错误
2. 数据库迁移是否执行
3. 本地缓存是否清除
4. 查看 Console 日志

---

**最后更新**: 2026-02-26
**状态**: ✅ 已集成并测试
