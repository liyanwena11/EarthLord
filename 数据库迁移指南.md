# æ•°æ®åº“è¿ç§»æŒ‡å—

## ðŸ“‹ éœ€è¦è¿è¡Œçš„è¿ç§»è„šæœ¬

æ ¹æ®æ—¥å¿—ï¼Œä»¥ä¸‹è¡¨ç¼ºå¤±ï¼š
1. `communication_devices` - é€šè®¯è®¾å¤‡è¡¨
2. `communication_channels` - é¢‘é“è¡¨
3. `channel_subscriptions` - é¢‘é“è®¢é˜…è¡¨
4. `channel_messages` - é¢‘é“æ¶ˆæ¯è¡¨
5. `purchase_mailbox` - è´­ä¹°é‚®ç®±è¡¨

## ðŸš€ è¿ç§»æ­¥éª¤

### æ­¥éª¤1: æ‰“å¼€ Supabase æŽ§åˆ¶å°

1. è®¿é—® https://supabase.com/dashboard
2. é€‰æ‹©ä½ çš„é¡¹ç›®ï¼š`EarthLord (lkekxzssfrspkyxtqysx)`
3. ç‚¹å‡»å·¦ä¾§èœå•çš„ "SQL Editor"

### æ­¥éª¤2: è¿è¡Œè¿ç§»è„šæœ¬

æŒ‰é¡ºåºè¿è¡Œä»¥ä¸‹ SQL æ–‡ä»¶ï¼š

#### 1. é¢‘é“ç³»ç»Ÿè¿ç§»
```bash
# åœ¨ SQL Editor ä¸­è¿è¡Œï¼š
# æ–‡ä»¶ï¼šsupabase_migration_004_channel_system.sql
```

æˆ–åœ¨ SQL Editor ä¸­ç›´æŽ¥æ‰§è¡Œï¼š

```sql
-- ============================================
-- é¢‘é“ç³»ç»Ÿè¡¨ç»“æž„
-- ============================================

-- 1. é€šè®¯è®¾å¤‡è¡¨
CREATE TABLE IF NOT EXISTS public.communication_devices (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    device_type TEXT NOT NULL CHECK (device_type IN ('walkie_talkie', 'satellite_phone', 'radio_tower')),
    device_level INTEGER DEFAULT 1 CHECK (device_level >= 1 AND device_level <= 5),
    is_unlocked BOOLEAN DEFAULT false,
    is_current BOOLEAN DEFAULT false,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 2. é¢‘é“è¡¨
CREATE TABLE IF NOT EXISTS public.communication_channels (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    creator_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    channel_type TEXT NOT NULL CHECK (channel_type IN ('official', 'public', 'private', 'territory', 'global')),
    channel_code TEXT UNIQUE NOT NULL,
    name TEXT NOT NULL,
    description TEXT,
    latitude DOUBLE PRECISION,
    longitude DOUBLE PRECISION,
    member_count INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 3. é¢‘é“è®¢é˜…è¡¨
CREATE TABLE IF NOT EXISTS public.channel_subscriptions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    channel_id UUID NOT NULL REFERENCES public.communication_channels(id) ON DELETE CASCADE,
    joined_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(user_id, channel_id)
);

-- 4. é¢‘é“æ¶ˆæ¯è¡¨
CREATE TABLE IF NOT EXISTS public.channel_messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    channel_id UUID NOT NULL REFERENCES public.communication_channels(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    content TEXT NOT NULL,
    message_type TEXT DEFAULT 'text' CHECK (message_type IN ('text', 'system', 'ptt_start', 'ptt_end')),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_communication_devices_user_id ON public.communication_devices(user_id);
CREATE INDEX IF NOT EXISTS idx_communication_channels_type ON public.communication_channels(channel_type);
CREATE INDEX IF NOT EXISTS idx_communication_channels_active ON public.communication_channels(is_active);
CREATE INDEX IF NOT EXISTS idx_channel_subscriptions_user_id ON public.channel_subscriptions(user_id);
CREATE INDEX IF NOT EXISTS idx_channel_subscriptions_channel_id ON public.channel_subscriptions(channel_id);
CREATE INDEX IF NOT EXISTS idx_channel_messages_channel_id ON public.channel_messages(channel_id);
CREATE INDEX IF NOT EXISTS idx_channel_messages_created_at ON public.channel_messages(created_at);

-- ============================================
-- RPC å‡½æ•°
-- ============================================

-- ç”Ÿæˆé¢‘é“ç å‡½æ•°
CREATE OR REPLACE FUNCTION public.generate_channel_code(p_channel_type TEXT)
RETURNS TEXT
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_prefix TEXT;
    v_random_chars TEXT;
BEGIN
    -- æ ¹æ®é¢‘é“ç±»åž‹ç”Ÿæˆå‰ç¼€
    CASE p_channel_type
        WHEN 'official' THEN v_prefix := 'OFF';
        WHEN 'public' THEN v_prefix := 'PUB';
        WHEN 'private' THEN v_prefix := 'PRV';
        WHEN 'territory' THEN v_prefix := 'TER';
        WHEN 'global' THEN v_prefix := 'GLB';
        ELSE v_prefix := 'CH';
    END CASE;

    -- ç”Ÿæˆ4ä½éšæœºå­—ç¬¦
    v_random_chars := substring(md5(random()::text), 1, 4);

    RETURN v_prefix || '-' || v_random_chars;
END;
$$;

-- åˆ›å»ºé¢‘é“å¹¶è‡ªåŠ¨è®¢é˜…
CREATE OR REPLACE FUNCTION public.create_channel_with_subscription(
    p_creator_id UUID,
    p_channel_type TEXT,
    p_name TEXT,
    p_description TEXT DEFAULT NULL,
    p_latitude DOUBLE PRECISION DEFAULT NULL,
    p_longitude DOUBLE PRECISION DEFAULT NULL
)
RETURNS UUID
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_channel_id UUID;
    v_channel_code TEXT;
BEGIN
    -- ç”Ÿæˆé¢‘é“ç 
    v_channel_code := public.generate_channel_code(p_channel_type);

    -- æ’å…¥é¢‘é“
    INSERT INTO public.communication_channels (
        creator_id,
        channel_type,
        channel_code,
        name,
        description,
        latitude,
        longitude
    ) VALUES (
        p_creator_id,
        p_channel_type,
        v_channel_code,
        p_name,
        p_description,
        p_latitude,
        p_longitude
    ) RETURNING id INTO v_channel_id;

    -- è‡ªåŠ¨è®¢é˜…åˆ›å»ºè€…
    INSERT INTO public.channel_subscriptions (user_id, channel_id)
    VALUES (p_creator_id, v_channel_id);

    -- æ›´æ–°æˆå‘˜æ•°
    UPDATE public.communication_channels
    SET member_count = 1
    WHERE id = v_channel_id;

    RETURN v_channel_id;
END;
$$;

-- è®¢é˜…é¢‘é“
CREATE OR REPLACE FUNCTION public.subscribe_to_channel(
    p_user_id UUID,
    p_channel_id UUID
)
RETURNS VOID
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
    -- æ’å…¥è®¢é˜…è®°å½•
    INSERT INTO public.channel_subscriptions (user_id, channel_id)
    VALUES (p_user_id, p_channel_id)
    ON CONFLICT (user_id, channel_id) DO NOTHING;

    -- æ›´æ–°æˆå‘˜æ•°
    UPDATE public.communication_channels
    SET member_count = (
        SELECT COUNT(*)
        FROM public.channel_subscriptions
        WHERE channel_id = p_channel_id
    )
    WHERE id = p_channel_id;
END;
$$;

-- å–æ¶ˆè®¢é˜…é¢‘é“
CREATE OR REPLACE FUNCTION public.unsubscribe_from_channel(
    p_user_id UUID,
    p_channel_id UUID
)
RETURNS VOID
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
    -- åˆ é™¤è®¢é˜…è®°å½•
    DELETE FROM public.channel_subscriptions
    WHERE user_id = p_user_id AND channel_id = p_channel_id;

    -- æ›´æ–°æˆå‘˜æ•°
    UPDATE public.communication_channels
    SET member_count = (
        SELECT COUNT(*)
        FROM public.channel_subscriptions
        WHERE channel_id = p_channel_id
    )
    WHERE id = p_channel_id;
END;
$$;

-- ============================================
-- å¯ç”¨ Row Level Security
-- ============================================

-- é€šè®¯è®¾å¤‡è¡¨
ALTER TABLE public.communication_devices ENABLE ROW LEVEL SECURITY;
CREATE POLICY "ç”¨æˆ·å¯ä»¥æŸ¥çœ‹è‡ªå·±çš„è®¾å¤‡"
    ON public.communication_devices FOR SELECT
    USING (auth.uid() = user_id);
CREATE POLICY "ç”¨æˆ·å¯ä»¥æ’å…¥è‡ªå·±çš„è®¾å¤‡"
    ON public.communication_devices FOR INSERT
    WITH CHECK (auth.uid() = user_id);
CREATE POLICY "ç”¨æˆ·å¯ä»¥æ›´æ–°è‡ªå·±çš„è®¾å¤‡"
    ON public.communication_devices FOR UPDATE
    USING (auth.uid() = user_id);

-- é¢‘é“è¡¨ï¼ˆå…¬å¼€å¯è¯»ï¼‰
ALTER TABLE public.communication_channels ENABLE ROW LEVEL SECURITY;
CREATE POLICY "æ‰€æœ‰äººå¯ä»¥æŸ¥çœ‹æ´»è·ƒé¢‘é“"
    ON public.communication_channels FOR SELECT
    USING (is_active = true);

-- é¢‘é“è®¢é˜…è¡¨
ALTER TABLE public.channel_subscriptions ENABLE ROW LEVEL SECURITY;
CREATE POLICY "ç”¨æˆ·å¯ä»¥æŸ¥çœ‹è‡ªå·±çš„è®¢é˜…"
    ON public.channel_subscriptions FOR SELECT
    USING (auth.uid() = user_id);
CREATE POLICY "ç”¨æˆ·å¯ä»¥æ’å…¥è‡ªå·±çš„è®¢é˜…"
    ON public.channel_subscriptions FOR INSERT
    WITH CHECK (auth.uid() = user_id);
CREATE POLICY "ç”¨æˆ·å¯ä»¥åˆ é™¤è‡ªå·±çš„è®¢é˜…"
    ON public.channel_subscriptions FOR DELETE
    USING (auth.uid() = user_id);

-- é¢‘é“æ¶ˆæ¯è¡¨
ALTER TABLE public.channel_messages ENABLE ROW LEVEL SECURITY;
CREATE POLICY "ç”¨æˆ·å¯ä»¥æŸ¥çœ‹å·²è®¢é˜…é¢‘é“çš„æ¶ˆæ¯"
    ON public.channel_messages FOR SELECT
    USING (
        EXISTS (
            SELECT 1 FROM public.channel_subscriptions
            WHERE channel_id = public.channel_messages.channel_id
            AND user_id = auth.uid()
        )
    );
CREATE POLICY "ç”¨æˆ·å¯ä»¥å‘é€æ¶ˆæ¯åˆ°å·²è®¢é˜…é¢‘é“"
    ON public.channel_messages FOR INSERT
    WITH CHECK (
        EXISTS (
            SELECT 1 FROM public.channel_subscriptions
            WHERE channel_id = public.channel_messages.channel_id
            AND user_id = auth.uid()
        )
    );

-- ============================================
-- åˆå§‹åŒ–å®˜æ–¹é¢‘é“
-- ============================================

INSERT INTO public.communication_channels (
    creator_id,
    channel_type,
    channel_code,
    name,
    description,
    member_count
) VALUES
    ('00000000-0000-0000-0000-000000000000'::uuid, 'official', 'OFF-NEWS', 'å¹¸å­˜è€…å…¬å‘Š', 'å®˜æ–¹å…¬å‘Šé¢‘é“ï¼Œå®šæœŸå‘å¸ƒé‡è¦ä¿¡æ¯', 0),
    ('00000000-0000-0000-0000-000000000000'::uuid, 'official', 'OFF-HELP', 'æ±‚åŠ©é¢‘é“', 'å‘å¸ƒå’Œå“åº”æ±‚åŠ©ä¿¡æ¯', 0)
ON CONFLICT (channel_code) DO NOTHING;
```

#### 2. è´­ä¹°é‚®ç®±è¡¨è¿ç§»

```sql
-- ============================================
-- è´­ä¹°é‚®ç®±è¡¨ç»“æž„
-- ============================================

CREATE TABLE IF NOT EXISTS public.purchase_mailbox (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    item_id TEXT NOT NULL,
    quantity INTEGER NOT NULL DEFAULT 1,
    rarity TEXT NOT NULL DEFAULT 'common',
    product_id TEXT NOT NULL,
    transaction_id TEXT,
    is_claimed BOOLEAN DEFAULT false,
    claimed_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_purchase_mailbox_user_id ON public.purchase_mailbox(user_id);
CREATE INDEX IF NOT EXISTS idx_purchase_mailbox_claimed ON public.purchase_mailbox(is_claimed);

-- å¯ç”¨ RLS
ALTER TABLE public.purchase_mailbox ENABLE ROW LEVEL SECURITY;
CREATE POLICY "ç”¨æˆ·å¯ä»¥æŸ¥çœ‹è‡ªå·±çš„é‚®ç®±ç‰©å“"
    ON public.purchase_mailbox FOR SELECT
    USING (auth.uid() = user_id);
CREATE POLICY "ç”¨æˆ·å¯ä»¥æ›´æ–°è‡ªå·±çš„é‚®ç®±ç‰©å“"
    ON public.purchase_mailbox FOR UPDATE
    USING (auth.uid() = user_id);
```

### æ­¥éª¤3: éªŒè¯è¡¨åˆ›å»º

è¿è¡Œä»¥ä¸‹æŸ¥è¯¢éªŒè¯è¡¨æ˜¯å¦åˆ›å»ºæˆåŠŸï¼š

```sql
-- æŸ¥çœ‹æ‰€æœ‰è¡¨
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'public'
AND table_name IN (
    'communication_devices',
    'communication_channels',
    'channel_subscriptions',
    'channel_messages',
    'purchase_mailbox'
)
ORDER BY table_name;
```

åº”è¯¥çœ‹åˆ°5ä¸ªè¡¨åã€‚

### æ­¥éª¤4: æµ‹è¯•é¢‘é“åŠŸèƒ½

1. é‡æ–°å¯åŠ¨ App
2. è¿›å…¥"é€šè®¯ä¸­å¿ƒ" â†’ "é¢‘é“ä¸­å¿ƒ"
3. ç‚¹å‡»"åˆ›å»º"æŒ‰é’®åˆ›å»ºæµ‹è¯•é¢‘é“
4. æ£€æŸ¥æŽ§åˆ¶å°æ—¥å¿—ï¼š

**æˆåŠŸæ—¥å¿—ç¤ºä¾‹**ï¼š
```
ðŸ”„ [é¢‘é“ä¸­å¿ƒ] å¼€å§‹åŠ è½½é¢‘é“æ•°æ®...
ðŸ“¡ [é¢‘é“] âœ… åŠ è½½å…¬å¼€é¢‘é“: 3 ä¸ª
ðŸ“¡ [é¢‘é“] âœ… åŠ è½½å·²è®¢é˜…é¢‘é“: 1 ä¸ª
ðŸ“Š [é¢‘é“ä¸­å¿ƒ] æ•°æ®åŠ è½½å®Œæˆ:
  - å…¬å¼€é¢‘é“: 3 ä¸ª
  - å·²è®¢é˜…é¢‘é“: 1 ä¸ª
```

---

## ðŸ”§ å¸¸è§é—®é¢˜

### Q1: è¡¨åˆ›å»ºå¤±è´¥ï¼Ÿ
**A**: æ£€æŸ¥æ˜¯å¦æœ‰æƒé™åˆ›å»ºè¡¨ï¼Œç¡®ä¿ä½ æ˜¯é¡¹ç›®çš„ Owner æˆ–æœ‰è¶³å¤Ÿæƒé™ã€‚

### Q2: RPC å‡½æ•°åˆ›å»ºå¤±è´¥ï¼Ÿ
**A**: ç¡®ä¿åˆ†æ­¥æ‰§è¡Œï¼Œå…ˆåˆ›å»ºè¡¨ï¼Œå†åˆ›å»ºå‡½æ•°ã€‚

### Q3: RLS ç­–ç•¥åˆ›å»ºå¤±è´¥ï¼Ÿ
**A**: æ£€æŸ¥ `auth.uid()` å‡½æ•°æ˜¯å¦å¯ç”¨ï¼Œç¡®ä¿ Supabase Auth å·²å¯ç”¨ã€‚

---

## ðŸ“± å…¶ä»–é—®é¢˜ä¿®å¤

### é—®é¢˜1: èƒŒåŒ…ç‰©å“åŒæ­¥å¤±è´¥

é”™è¯¯ä¿¡æ¯ï¼š
```
âŒ Supabase å­˜å‚¨å¤±è´¥ï¼šPostgrestError(detail: nil, hint: nil, code: Optional("23502"), message: "null value in column \"name\" of relation \"inventory_items\" violates not-null constraint")
```

**è§£å†³**ï¼šéœ€è¦æ£€æŸ¥ `inventory_items` è¡¨ç»“æž„ï¼Œç¡®ä¿ `name` å­—æ®µæœ‰é»˜è®¤å€¼æˆ–æ­£ç¡®æ’å…¥ã€‚

### é—®é¢˜2: å•†åŸŽäº§å“æœªæ˜¾ç¤º

**è§£å†³**ï¼šéœ€è¦åœ¨ App Store Connect ä¸­é…ç½®å†…è´­äº§å“ï¼š
1. ç™»å½• App Store Connect
2. è¿›å…¥ App â†’ In-App Purchases
3. åˆ›å»ºæ¶ˆè€—åž‹äº§å“ï¼š
   - `com.earthlord.supply.survivor` - Â¥6
   - `com.earthlord.supply.explorer` - Â¥18
   - `com.earthlord.supply.lord` - Â¥30
   - `com.earthlord.supply.overlord` - Â¥68

---

## âœ… å®Œæˆæ£€æŸ¥æ¸…å•

è¿ç§»å®ŒæˆåŽï¼Œæ£€æŸ¥ä»¥ä¸‹å†…å®¹ï¼š

- [ ] æ‰€æœ‰5ä¸ªè¡¨éƒ½åˆ›å»ºæˆåŠŸ
- [ ] 4ä¸ª RPC å‡½æ•°åˆ›å»ºæˆåŠŸ
- [ ] RLS ç­–ç•¥å·²é…ç½®
- [ ] å®˜æ–¹é¢‘é“å·²åˆå§‹åŒ–
- [ ] App å¯ä»¥æ­£å¸¸åŠ è½½é¢‘é“åˆ—è¡¨
- [ ] åˆ›å»ºé¢‘é“åŠŸèƒ½æ­£å¸¸
- [ ] è®¢é˜…/å–æ¶ˆè®¢é˜…åŠŸèƒ½æ­£å¸¸
- [ ] é‚®ç®±åŠŸèƒ½æ­£å¸¸

---

**æ›´æ–°æ—¶é—´**: 2026-02-21
**ç›¸å…³æ–‡ä»¶**:
- `supabase_migration_004_channel_system.sql`
- `supabase_migration_006_purchase_mailbox.sql`
