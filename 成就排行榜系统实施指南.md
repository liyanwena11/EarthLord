# ğŸ† EarthLord æˆå°±æ’è¡Œæ¦œç³»ç»Ÿ - å®Œæ•´å®æ–½æŒ‡å—

## ğŸ“‹ ç›®å½•
- [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
- [åŠŸèƒ½ç‰¹æ€§](#åŠŸèƒ½ç‰¹æ€§)
- [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
- [ä»£ç æ¶æ„](#ä»£ç æ¶æ„)
- [å®æ–½æ­¥éª¤](#å®æ–½æ­¥éª¤)
- [UIè®¾è®¡](#uiè®¾è®¡)
- [APIæ¥å£](#apiæ¥å£)
- [å¥–åŠ±ç³»ç»Ÿ](#å¥–åŠ±ç³»ç»Ÿ)
- [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
- [æµ‹è¯•è®¡åˆ’](#æµ‹è¯•è®¡åˆ’)

---

## ç³»ç»Ÿæ¦‚è¿°

æˆå°±æ’è¡Œæ¦œç³»ç»Ÿæ˜¯ä¸º **EarthLord** æ¸¸æˆè®¾è®¡çš„ç«äº‰æ€§åŠŸèƒ½ï¼Œé€šè¿‡å±•ç¤ºç©å®¶åœ¨æˆå°±ç³»ç»Ÿä¸­çš„æ’åï¼Œå¢å¼ºæ¸¸æˆçš„ç«äº‰æ€§å’Œå¯ç©æ€§ã€‚

### æ ¸å¿ƒç›®æ ‡
1. **å¢å¼ºç«äº‰æ€§** - è®©ç©å®¶å¯ä»¥æ¯”è¾ƒæˆå°±è¿›åº¦
2. **æ¿€åŠ±å‚ä¸** - é€šè¿‡èµ›å­£å’Œå¥–åŠ±æ¿€åŠ±ç©å®¶å‚ä¸
3. **ç¤¾äº¤äº’åŠ¨** - è®©ç©å®¶å¯ä»¥çœ‹åˆ°å…¶ä»–ç©å®¶çš„æˆå°±
4. **é•¿æœŸç•™å­˜** - é€šè¿‡èµ›å­£æ›´æ–°ä¿æŒå†…å®¹æ–°é²œæ„Ÿ

---

## åŠŸèƒ½ç‰¹æ€§

### ğŸ“Š äº”å¤§æ’è¡Œæ¦œç±»å‹

#### 1. **æˆå°±ç§¯åˆ†æ’è¡Œæ¦œ**ï¼ˆä¸»æ¦œï¼‰
- æ ¹æ®æˆå°±éš¾åº¦è®¡ç®—ç§¯åˆ†
- æˆå°±éš¾åº¦åˆ†çº§ï¼š
  - æ™®é€šï¼ˆCommonï¼‰ï¼š10åˆ†
  - ç¨€æœ‰ï¼ˆRareï¼‰ï¼š30åˆ†
  - å²è¯—ï¼ˆEpicï¼‰ï¼š50åˆ†
  - ä¼ è¯´ï¼ˆLegendaryï¼‰ï¼š100åˆ†
- æ’åä¾æ®ï¼šæ€»ç§¯åˆ†é™åº

#### 2. **æˆå°±æ•°é‡æ’è¡Œæ¦œ**
- æŒ‰è§£é”æˆå°±æ€»æ•°æ’å
- å±•ç¤ºç©å®¶å®é™…è§£é”çš„æˆå°±æ•°é‡
- é€‚åˆä¸“æ³¨äºæ”¶é›†æ‰€æœ‰æˆå°±çš„ç©å®¶

#### 3. **æˆå°±å®Œæˆåº¦æ’è¡Œæ¦œ**
- æŒ‰å®Œæˆç™¾åˆ†æ¯”æ’å
- è®¡ç®—å…¬å¼ï¼šå·²è§£é”æˆå°±æ•° / æ€»æˆå°±æ•°
- æ¿€åŠ±ç©å®¶è¿½æ±‚100%å®Œæˆåº¦

#### 4. **åˆ†ç±»æˆå°±æ’è¡Œæ¦œ**
- æŒ‰æˆå°±ç±»åˆ«åˆ†åˆ«æ’åï¼š
  - å»ºç­‘æˆå°±
  - èµ„æºæˆå°±
  - é¢†åœ°æˆå°±
  - æ¢ç´¢æˆå°±
  - äº¤æ˜“æˆå°±
  - ç¤¾äº¤æˆå°±
- è®©ä¸åŒä¸“é•¿çš„ç©å®¶éƒ½èƒ½å±•ç¤ºä¼˜åŠ¿

#### 5. **é€Ÿåº¦æ’è¡Œæ¦œ**
- è®°å½•è¾¾æˆç‰¹å®šæˆå°±é‡Œç¨‹ç¢‘çš„æœ€å¿«æ—¶é—´
- é‡Œç¨‹ç¢‘ç±»å‹ï¼š
  - é¦–æ¬¡è¾¾æˆ10ä¸ªæˆå°±
  - é¦–æ¬¡è¾¾æˆ50ä¸ªæˆå°±
  - é¦–æ¬¡è¾¾æˆ100ä¸ªæˆå°±
  - è§£é”å…¨éƒ¨æˆå°±
- æŒ‰æ‰€éœ€å¤©æ•°å‡åºæ’åˆ—

### ğŸ å¥–åŠ±ç³»ç»Ÿ

#### æ’åå¥–åŠ±
- ç¬¬1åï¼šä¸“å±å¾½ç«  + ç§°å· + 5000èµ„æº
- ç¬¬2-3åï¼šä¸“å±å¾½ç«  + 3000èµ„æº
- ç¬¬4-10åï¼šä¸“å±å¾½ç«  + 1000èµ„æº
- ç¬¬11-50åï¼š500èµ„æº
- ç¬¬51-100åï¼š200èµ„æº

#### èµ›å­£ç³»ç»Ÿ
- æ¯èµ›å­£æŒç»­2-3ä¸ªæœˆ
- èµ›å­£ç»“æŸå‘æ”¾å¥–åŠ±
- æ–°èµ›å­£é‡ç½®æ’å
- ä¿ç•™æˆå°±è¿›åº¦

---

## æ•°æ®åº“è®¾è®¡

### æ ¸å¿ƒæ•°æ®è¡¨

#### 1. `achievement_leaderboard` - æˆå°±æ€»æ¦œ
```sql
- id: UUID (ä¸»é”®)
- user_id: UUID (ç”¨æˆ·ID)
- total_points: INTEGER (æ€»ç§¯åˆ†)
- total_achievements: INTEGER (æ€»æˆå°±æ•°)
- completion_rate: DOUBLE (å®Œæˆç‡)
- ranking_position: INTEGER (æ’å)
- last_updated_at: TIMESTAMP (æœ€åæ›´æ–°æ—¶é—´)
```

#### 2. `category_leaderboard` - åˆ†ç±»æ¦œ
```sql
- id: UUID (ä¸»é”®)
- user_id: UUID (ç”¨æˆ·ID)
- category: TEXT (æˆå°±åˆ†ç±»)
- category_points: INTEGER (åˆ†ç±»ç§¯åˆ†)
- category_achievements: INTEGER (åˆ†ç±»æˆå°±æ•°)
- ranking_position: INTEGER (æ’å)
```

#### 3. `achievement_speed_records` - é€Ÿåº¦è®°å½•
```sql
- id: UUID (ä¸»é”®)
- user_id: UUID (ç”¨æˆ·ID)
- milestone_type: TEXT (é‡Œç¨‹ç¢‘ç±»å‹)
- days_taken: INTEGER (æ‰€éœ€å¤©æ•°)
- achieved_at: TIMESTAMP (è¾¾æˆæ—¶é—´)
```

#### 4. `leaderboard_rewards` - æ’è¡Œæ¦œå¥–åŠ±
```sql
- id: UUID (ä¸»é”®)
- rank_min: INTEGER (æ’åæœ€å°å€¼)
- rank_max: INTEGER (æ’åæœ€å¤§å€¼)
- reward_type: TEXT (å¥–åŠ±ç±»å‹)
- reward_data: JSONB (å¥–åŠ±æ•°æ®)
- season_id: TEXT (èµ›å­£ID)
```

#### 5. `leaderboard_seasons` - èµ›å­£ä¿¡æ¯
```sql
- id: TEXT (ä¸»é”®)
- name: TEXT (èµ›å­£åç§°)
- description: TEXT (èµ›å­£æè¿°)
- start_date: TIMESTAMP (å¼€å§‹æ—¥æœŸ)
- end_date: TIMESTAMP (ç»“æŸæ—¥æœŸ)
- is_active: BOOLEAN (æ˜¯å¦æ´»è·ƒ)
```

### æ•°æ®åº“è§†å›¾

#### `v_leaderboard_with_user`
- å…³è”æ’è¡Œæ¦œæ•°æ®å’Œç”¨æˆ·ä¿¡æ¯
- ç”¨äºæŸ¥è¯¢å¸¦ç”¨æˆ·åçš„æ’è¡Œæ¦œ

#### `v_category_leaderboard_with_user`
- å…³è”åˆ†ç±»æ’è¡Œæ¦œå’Œç”¨æˆ·ä¿¡æ¯
- æŒ‰åˆ†ç±»å±•ç¤ºæ’è¡Œæ¦œ

#### `v_speed_leaderboard`
- å…³è”é€Ÿåº¦è®°å½•å’Œç”¨æˆ·ä¿¡æ¯
- è‡ªåŠ¨è®¡ç®—æ’å

### å…³é”®å‡½æ•°

#### `update_user_achievement_leaderboard(p_user_id UUID)`
- æ›´æ–°æŒ‡å®šç”¨æˆ·çš„æ’è¡Œæ¦œæ•°æ®
- è®¡ç®—æ€»ç§¯åˆ†ã€æˆå°±æ•°ã€å®Œæˆåº¦
- ç”±è§¦å‘å™¨è‡ªåŠ¨è°ƒç”¨

#### `update_user_category_leaderboard(p_user_id UUID)`
- æ›´æ–°ç”¨æˆ·åœ¨æ‰€æœ‰åˆ†ç±»çš„æ’è¡Œæ¦œæ•°æ®
- éå†æ‰€æœ‰æˆå°±åˆ†ç±»
- åˆ†åˆ«è®¡ç®—åˆ†ç±»ç§¯åˆ†å’Œæ’å

#### `recalculate_leaderboard_rankings()`
- é‡æ–°è®¡ç®—æ‰€æœ‰æ’å
- æ›´æ–°æ€»æ¦œå’Œåˆ†ç±»æ¦œçš„ ranking_position
- å»ºè®®å®šæ—¶è°ƒç”¨ï¼ˆå¦‚æ¯å°æ—¶ä¸€æ¬¡ï¼‰

#### `check_achievement_milestone(p_user_id UUID)`
- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¾¾æˆæ–°çš„é‡Œç¨‹ç¢‘
- è‡ªåŠ¨è®°å½•é€Ÿåº¦æ•°æ®
- å½“ç”¨æˆ·è§£é”æ–°æˆå°±æ—¶è§¦å‘

---

## ä»£ç æ¶æ„

### æ–‡ä»¶ç»“æ„
```
EarthLord/
â”œâ”€â”€ Models/
â”‚   â””â”€â”€ LeaderboardModels.swift          # æ’è¡Œæ¦œæ•°æ®æ¨¡å‹
â”œâ”€â”€ Managers/
â”‚   â””â”€â”€ LeaderboardManager.swift         # æ’è¡Œæ¦œç®¡ç†å™¨
â”œâ”€â”€ Views/
â”‚   â””â”€â”€ Leaderboard/
â”‚       â”œâ”€â”€ LeaderboardView.swift        # ä¸»æ’è¡Œæ¦œè§†å›¾
â”‚       â”œâ”€â”€ LeaderboardDetailView.swift  # æ’è¡Œæ¦œè¯¦æƒ…
â”‚       â””â”€â”€ LeaderboardRewardsView.swift # å¥–åŠ±å±•ç¤º
â””â”€â”€ supabase_migration_010_achievement_leaderboard.sql
```

### æ•°æ®æ¨¡å‹

#### æ ¸å¿ƒæ¨¡å‹
- `LeaderboardEntry` - æ’è¡Œæ¦œæ¡ç›®
- `CategoryLeaderboardEntry` - åˆ†ç±»æ’è¡Œæ¦œæ¡ç›®
- `SpeedRecord` - é€Ÿåº¦è®°å½•
- `LeaderboardReward` - æ’è¡Œæ¦œå¥–åŠ±
- `LeaderboardSeason` - èµ›å­£ä¿¡æ¯
- `UserLeaderboardStats` - ç”¨æˆ·ç»Ÿè®¡æ•°æ®

#### æšä¸¾ç±»å‹
- `LeaderboardTab` - æ’è¡Œæ¦œæ ‡ç­¾é¡µ
- `MilestoneType` - é‡Œç¨‹ç¢‘ç±»å‹
- `RewardType` - å¥–åŠ±ç±»å‹

### ç®¡ç†å™¨

#### `LeaderboardManager`
**ä¸»è¦èŒè´£ï¼š**
- ä»æ•°æ®åº“è·å–æ’è¡Œæ¦œæ•°æ®
- æ›´æ–°ç”¨æˆ·æ’è¡Œæ¦œç»Ÿè®¡
- è·å–èµ›å­£å’Œå¥–åŠ±ä¿¡æ¯
- æŸ¥è¯¢"æˆ‘çš„æ’å"å‘¨è¾¹æ•°æ®

**æ ¸å¿ƒæ–¹æ³•ï¼š**
```swift
// è·å–ç§¯åˆ†æ¦œ
func fetchPointsLeaderboard(limit: Int, offset: Int) async throws -> [LeaderboardEntry]

// è·å–åˆ†ç±»æ¦œ
func fetchCategoryLeaderboard(category: AchievementCategory) async throws -> [CategoryLeaderboardEntry]

// è·å–é€Ÿåº¦æ¦œ
func fetchSpeedLeaderboard(milestone: MilestoneType) async throws -> [SpeedRecord]

// è·å–ç”¨æˆ·ç»Ÿè®¡
func fetchUserLeaderboardStats(userId: UUID) async throws -> UserLeaderboardStats

// è·å–èµ›å­£ä¿¡æ¯
func fetchCurrentSeason() async throws -> LeaderboardSeason?
```

---

## å®æ–½æ­¥éª¤

### é˜¶æ®µ 1ï¼šæ•°æ®åº“éƒ¨ç½²ï¼ˆDay 1ï¼‰

1. **æ‰§è¡Œæ•°æ®åº“è¿ç§»**
```bash
# è¿æ¥åˆ° Supabase
supabase db reset

# æ‰§è¡Œè¿ç§»è„šæœ¬
supabase db push supabase_migration_010_achievement_leaderboard.sql
```

2. **éªŒè¯æ•°æ®åº“ç»“æ„**
```sql
-- æ£€æŸ¥è¡¨æ˜¯å¦åˆ›å»ºæˆåŠŸ
SELECT table_name FROM information_schema.tables
WHERE table_schema = 'public'
AND table_name LIKE '%leaderboard%';

-- æ£€æŸ¥å‡½æ•°æ˜¯å¦åˆ›å»ºæˆåŠŸ
SELECT routine_name FROM information_schema.routines
WHERE routine_schema = 'public'
AND routine_name LIKE '%leaderboard%';
```

3. **åˆå§‹åŒ–æˆå°±æ•°æ®**
```sql
-- ä¸ºç°æœ‰æˆå°±è®¾ç½®éš¾åº¦å’Œç§¯åˆ†
UPDATE achievements
SET difficulty = 'common', points = 10
WHERE category IN ('building', 'resource');

UPDATE achievements
SET difficulty = 'rare', points = 30
WHERE category IN ('territory', 'exploration');

UPDATE achievements
SET difficulty = 'epic', points = 50
WHERE id LIKE '%master%';

UPDATE achievements
SET difficulty = 'legendary', points = 100
WHERE id LIKE '%legend%' OR id LIKE '%god%';
```

### é˜¶æ®µ 2ï¼šä»£ç é›†æˆï¼ˆDay 2-3ï¼‰

1. **æ·»åŠ  Manager åˆ° EarthLordApp**
```swift
// EarthLordApp.swift
@StateObject private var leaderboardManager = LeaderboardManager()
```

2. **æ·»åŠ æ’è¡Œæ¦œå…¥å£**
```swift
// MainTabView.swift
TabView {
    // ... å…¶ä»–æ ‡ç­¾
    NavigationLink(destination: LeaderboardView()) {
        Label("æ’è¡Œæ¦œ", systemImage: "list.number")
    }
}
```

3. **è¿æ¥ç°æœ‰æˆå°±ç³»ç»Ÿ**
```swift
// AchievementManager.swift
// å½“ç”¨æˆ·è§£é”æˆå°±æ—¶ï¼Œè‡ªåŠ¨æ›´æ–°æ’è¡Œæ¦œ
func unlockAchievement(_ achievementId: String) async throws {
    // è§£é”æˆå°±
    // ...

    // è§¦å‘æ’è¡Œæ¦œæ›´æ–°ï¼ˆæ•°æ®åº“è‡ªåŠ¨å¤„ç†ï¼‰
    // update_user_achievement_leaderboard() è¢«è§¦å‘å™¨è‡ªåŠ¨è°ƒç”¨
}
```

### é˜¶æ®µ 3ï¼šUI å¼€å‘ï¼ˆDay 4-5ï¼‰

1. **åˆ›å»ºæ’è¡Œæ¦œä¸»è§†å›¾**
   - âœ… å·²å®Œæˆ `LeaderboardView.swift`

2. **åˆ›å»ºè¯¦æƒ…è§†å›¾**ï¼ˆå¯é€‰ï¼‰
   - ç‚¹å‡»ç”¨æˆ·æŸ¥çœ‹è¯¦ç»†æˆå°±
   - æŸ¥çœ‹å¥–åŠ±é¢†å–å†å²

3. **åˆ›å»ºå¥–åŠ±å±•ç¤ºè§†å›¾**ï¼ˆå¯é€‰ï¼‰
   - å±•ç¤ºå½“å‰èµ›å­£å¥–åŠ±
   - å±•ç¤ºå†å²èµ›å­£å¥–åŠ±

### é˜¶æ®µ 4ï¼šæµ‹è¯•å’Œä¼˜åŒ–ï¼ˆDay 6-7ï¼‰

1. **åŠŸèƒ½æµ‹è¯•**
   - æ’è¡Œæ¦œæ•°æ®æ­£ç¡®åŠ è½½
   - æ’åè®¡ç®—å‡†ç¡®
   - å¥–åŠ±å‘æ”¾æ­£å¸¸
   - èµ›å­£åˆ‡æ¢æ­£å¸¸

2. **æ€§èƒ½ä¼˜åŒ–**
   - æ·»åŠ ç¼“å­˜æœºåˆ¶
   - å®ç°åˆ†é¡µåŠ è½½
   - ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢

3. **UI/UX ä¼˜åŒ–**
   - æ·»åŠ åŠ è½½åŠ¨ç”»
   - ä¼˜åŒ–åˆ—è¡¨æ»šåŠ¨æ€§èƒ½
   - æ·»åŠ ç©ºçŠ¶æ€è§†å›¾

---

## UIè®¾è®¡

### ä¸»è¦ç•Œé¢

#### 1. **æ’è¡Œæ¦œä¸»ç•Œé¢**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ† ç¬¬ä¸€å­£ï¼šè’åŸå¼€æ‹“ (å‰©ä½™ 45 å¤©)   â”‚
â”‚  â–“â–“â–“â–“â–“â–“â–“â–‘â–‘â–‘â–‘ 75%                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [ç§¯åˆ†æ¦œ] [æ•°é‡æ¦œ] [å®Œæˆåº¦] [åˆ†ç±»æ¦œ] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ¥‡                        [å¤´åƒ]     â”‚
â”‚    è’åŸå¹¸å­˜è€…                          â”‚
â”‚    â­ï¸ 3500 ç§¯åˆ†                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ¥ˆ                        [å¤´åƒ]     â”‚
â”‚    å»ºç­‘ä¹‹ç‹                            â”‚
â”‚    â­ï¸ 3200 ç§¯åˆ†                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ¥‰                        [å¤´åƒ]     â”‚
â”‚    æ¢ç´¢ä¸“å®¶                            â”‚
â”‚    â­ï¸ 2800 ç§¯åˆ†                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  æˆ‘çš„æ’å: #12                       â”‚
â”‚  â­ï¸ 1250  ğŸ† 45  âœ”ï¸ 45%             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2. **åˆ†ç±»æ’è¡Œæ¦œ**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [å»ºç­‘] [èµ„æº] [é¢†åœ°] [æ¢ç´¢] [äº¤æ˜“]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ #1   å»ºç­‘å¤§å¸ˆ                         â”‚
â”‚     ğŸ—ï¸ 800 ç§¯åˆ†  â€¢  20 ä¸ªæˆå°±        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ #2   å»ºé€ è€…                           â”‚
â”‚     ğŸ—ï¸ 650 ç§¯åˆ†  â€¢  17 ä¸ªæˆå°±        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3. **é€Ÿåº¦æ’è¡Œæ¦œ**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [10æˆå°±] [50æˆå°±] [100æˆå°±] [å…¨æˆå°±]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ #1   é€Ÿåº¦æ¶é­”                         â”‚
â”‚     âš¡ï¸ 7 å¤©  â€¢  2026-02-19 è¾¾æˆ      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ #2   å¿«é€Ÿå­¦ä¹ è€…                       â”‚
â”‚     âš¡ï¸ 10 å¤©  â€¢  2026-02-16 è¾¾æˆ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é¢œè‰²æ–¹æ¡ˆ

- **æ’å 1-3**ï¼šé‡‘ã€é“¶ã€é“œè‰²ï¼ˆğŸ¥‡ğŸ¥ˆğŸ¥‰ï¼‰
- **å…¶ä»–æ’å**ï¼šç°è‰²
- **å½“å‰ç”¨æˆ·**ï¼šä¸»é¢˜è‰²é«˜äº®
- **åˆ†ç±»å›¾æ ‡**ï¼šä½¿ç”¨åˆ†ç±»ä¸“å±é¢œè‰²

### åŠ¨ç”»æ•ˆæœ

- åˆ‡æ¢æ ‡ç­¾é¡µï¼šæ·¡å…¥æ·¡å‡º
- åˆ—è¡¨åŠ è½½ï¼šæ¸å…¥åŠ¨ç”»
- æ’åå˜åŒ–ï¼šæ•°å­—æ»šåŠ¨æ•ˆæœ
- æ–°çºªå½•ï¼šé—ªçƒæç¤º

---

## APIæ¥å£

### Supabase RPC å‡½æ•°

#### 1. è·å–æ’è¡Œæ¦œæ•°æ®
```sql
-- è°ƒç”¨æ–¹å¼
SELECT * FROM fetch_leaderboard(
    p_type := 'points',
    p_limit := 100,
    p_offset := 0
);
```

#### 2. è·å–ç”¨æˆ·æ’å
```sql
-- è°ƒç”¨æ–¹å¼
SELECT * FROM fetch_user_ranking(p_user_id := '...');
```

#### 3. æ›´æ–°æ’è¡Œæ¦œ
```sql
-- è°ƒç”¨æ–¹å¼ï¼ˆç”±è§¦å‘å™¨è‡ªåŠ¨è°ƒç”¨ï¼‰
SELECT update_user_achievement_leaderboard(p_user_id := '...');
```

### REST APIï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦å¤–éƒ¨è®¿é—®ï¼Œå¯ä»¥åˆ›å»º REST APIï¼š

```typescript
// è·å–æ’è¡Œæ¦œ
GET /api/leaderboard?type=points&limit=100

// è·å–ç”¨æˆ·æ’å
GET /api/leaderboard/user/:userId

// è·å–èµ›å­£ä¿¡æ¯
GET /api/leaderboard/season/current

// è·å–æ’è¡Œæ¦œå¥–åŠ±
GET /api/leaderboard/rewards?season=season_1
```

---

## å¥–åŠ±ç³»ç»Ÿ

### å¥–åŠ±å‘æ”¾æµç¨‹

1. **èµ›å­£ç»“æŸæ—¶è‡ªåŠ¨å‘æ”¾**
   ```sql
   -- åˆ›å»ºå‡½æ•°è‡ªåŠ¨å‘æ”¾å¥–åŠ±
   CREATE FUNCTION distribute_season_rewards(p_season_id TEXT)
   ```

2. **å¥–åŠ±é¢†å–**
   - ç©å®¶è¿›å…¥å¥–åŠ±ç•Œé¢
   - æŸ¥çœ‹è‡ªå·±è·å¾—çš„å¥–åŠ±
   - ç‚¹å‡»é¢†å–æŒ‰é’®
   - å¥–åŠ±è‡ªåŠ¨å‘é€åˆ°ç©å®¶èƒŒåŒ…

3. **å¥–åŠ±é€šçŸ¥**
   - æ’è¡Œæ¦œæ›´æ–°æ—¶æ˜¾ç¤ºæ’å
   - èµ›å­£ç»“æŸæ¨é€é€šçŸ¥
   - å¥–åŠ±åˆ°è´¦æç¤º

### å¥–åŠ±ç±»å‹

#### èµ„æºå¥–åŠ±
```json
{
  "food": 5000,
  "water": 5000,
  "wood": 5000,
  "metal": 5000
}
```

#### å¾½ç« å¥–åŠ±
```json
{
  "id": "champion_emblem",
  "name": "æˆå°±ç‹è€…",
  "description": "èµ›å­£ç¬¬1åä¸“å±å¾½ç« ",
  "icon": "trophy.fill",
  "rarity": "legendary"
}
```

#### ç§°å·å¥–åŠ±
```json
{
  "id": "champion_title",
  "text": "è’åŸä¼ å¥‡",
  "color": "#FFD700",
  "duration": "permanent"
}
```

---

## æ€§èƒ½ä¼˜åŒ–

### æ•°æ®åº“ä¼˜åŒ–

#### 1. ç´¢å¼•ä¼˜åŒ–
```sql
-- å¤åˆç´¢å¼•ç”¨äºå¸¸è§æŸ¥è¯¢
CREATE INDEX idx_leaderboard_points_rank
ON achievement_leaderboard(total_points DESC, created_at ASC);

-- åˆ†ç±»æ¦œå¤åˆç´¢å¼•
CREATE INDEX idx_category_leaderboard_points
ON category_leaderboard(category, category_points DESC);
```

#### 2. åˆ†åŒºè¡¨ï¼ˆå¤§æ•°æ®é‡æ—¶ï¼‰
```sql
-- æŒ‰èµ›å­£åˆ†åŒº
CREATE TABLE achievement_leaderboard_y2026m01
PARTITION OF achievement_leaderboard
FOR VALUES FROM ('2026-01-01') TO ('2026-02-01');
```

#### 3. ç¼“å­˜ç­–ç•¥
- Redis ç¼“å­˜ Top 100 æ’è¡Œæ¦œ
- ç¼“å­˜ç”¨æˆ·è‡ªå·±çš„æ’åæ•°æ®
- ç¼“å­˜èµ›å­£ä¿¡æ¯
- TTL: 5-15åˆ†é’Ÿ

### åº”ç”¨å±‚ä¼˜åŒ–

#### 1. åˆ†é¡µåŠ è½½
```swift
// é¦–æ¬¡åŠ è½½å‰50æ¡
let initialEntries = await manager.fetchPointsLeaderboard(limit: 50)

// æ»šåŠ¨åˆ°åº•éƒ¨æ—¶åŠ è½½æ›´å¤š
func loadMore() async {
    let moreEntries = await manager.fetchPointsLeaderboard(
        limit: 50,
        offset: entries.count
    )
    entries.append(contentsOf: moreEntries)
}
```

#### 2. å¢é‡æ›´æ–°
```swift
// åªæ›´æ–°å˜åŒ–çš„æ’å
func watchLeaderboardChanges() {
    supabase.channel("leaderboard")
        .on("postgres_changes", filter: SupabaseSubscriptionFilter(
            event: .update,
            schema: "public",
            table: "achievement_leaderboard"
        )) { payload in
            // æ›´æ–°æœ¬åœ°æ•°æ®
        }
        .subscribe()
}
```

#### 3. æ‡’åŠ è½½è§†å›¾
```swift
// ä½¿ç”¨ LazyVStack ä»£æ›¿ VStack
LazyVStack(spacing: 12) {
    ForEach(entries) { entry in
        LeaderboardRow(entry: entry)
    }
}
```

---

## æµ‹è¯•è®¡åˆ’

### å•å…ƒæµ‹è¯•

#### LeaderboardManager æµ‹è¯•
```swift
func testFetchPointsLeaderboard() async throws {
    let manager = LeaderboardManager()
    let entries = try await manager.fetchPointsLeaderboard(limit: 10)

    XCTAssertFalse(entries.isEmpty)
    XCTAssertEqual(entries.count, 10)
    XCTAssertTrue(entries[0].totalPoints >= entries[1].totalPoints)
}

func testFetchUserStats() async throws {
    let manager = LeaderboardManager()
    let userId = UUID()
    let stats = try await manager.fetchUserLeaderboardStats(userId: userId)

    XCTAssertNotNil(stats)
    XCTAssertGreaterThanOrEqual(stats.totalPoints, 0)
}
```

### é›†æˆæµ‹è¯•

#### æ•°æ®åº“è§¦å‘å™¨æµ‹è¯•
```sql
-- æµ‹è¯•æˆï¿½ï¿½ï¿½è§£é”è§¦å‘æ’è¡Œæ¦œæ›´æ–°
INSERT INTO user_achievements (user_id, achievement_id, progress, is_unlocked)
VALUES ('test-user-id', 'test-achievement-id', 1.0, true);

-- æ£€æŸ¥æ’è¡Œæ¦œæ˜¯å¦æ›´æ–°
SELECT * FROM achievement_leaderboard WHERE user_id = 'test-user-id';
```

### æ€§èƒ½æµ‹è¯•

#### æ’è¡Œæ¦œæŸ¥è¯¢æ€§èƒ½
```sql
-- æµ‹è¯•æŸ¥è¯¢æ—¶é—´ï¼ˆåº” < 100msï¼‰
EXPLAIN ANALYZE
SELECT * FROM v_leaderboard_with_user
ORDER BY total_points DESC
LIMIT 100;
```

#### æ’åé‡ç®—æ€§èƒ½
```sql
-- æµ‹è¯•é‡ç®—æ—¶é—´ï¼ˆåº” < 5sï¼‰
EXPLAIN ANALYZE
SELECT recalculate_leaderboard_rankings();
```

### UI æµ‹è¯•

#### UI æµ‹è¯•ç”¨ä¾‹
- [ ] æ’è¡Œæ¦œæ­£å¸¸åŠ è½½
- [ ] æ ‡ç­¾é¡µåˆ‡æ¢æµç•…
- [ ] ä¸‹æ‹‰åˆ·æ–°æœ‰æ•ˆ
- [ ] æˆ‘çš„æ’åæ­£ç¡®æ˜¾ç¤º
- [ ] åˆ†ç±»ç­›é€‰æœ‰æ•ˆ
- [ ] ç©ºçŠ¶æ€æ­£ç¡®æ˜¾ç¤º
- [ ] ç½‘ç»œé”™è¯¯å¤„ç†æ­£ç¡®

---

## æ‰©å±•åŠŸèƒ½ï¼ˆæœªæ¥è®¡åˆ’ï¼‰

### 1. å¥½å‹æ’è¡Œæ¦œ
- åªæ˜¾ç¤ºå¥½å‹çš„æ’å
- æ–¹ä¾¿ä¸å¥½å‹æ¯”è¾ƒ

### 2. å…¬ä¼šæ’è¡Œæ¦œ
- å…¬ä¼šæˆå‘˜çš„æˆå°±æ€»å’Œ
- å…¬ä¼šä¹‹é—´çš„ç«äº‰

### 3. åŒºåŸŸæ’è¡Œæ¦œ
- æŒ‰åœ°åŒº/è¯­è¨€åˆ†ç»„
- æœ¬åœ°åŒ–ç«äº‰

### 4. å†å²æ’è¡Œæ¦œ
- ä¿å­˜å†å²æ’åæ•°æ®
- å±•ç¤ºæ’åè¶‹åŠ¿å›¾

### 5. æˆå°±å¯¹æ¯”
- é€‰æ‹©ä¸¤ä¸ªç©å®¶å¯¹æ¯”æˆå°±
- å±•ç¤ºå„è‡ªçš„å¼ºé¡¹å’Œå¼±é¡¹

### 6. æ’è¡Œæ¦œé¢„æµ‹
- æ ¹æ®å½“å‰è¿›åº¦é¢„æµ‹æœªæ¥æ’å
- æä¾›è¾¾æˆç›®æ ‡çš„å»ºè®®

---

## å¸¸è§é—®é¢˜

### Q1: æ’è¡Œæ¦œå¤šä¹…æ›´æ–°ä¸€æ¬¡ï¼Ÿ
**A:**
- ç”¨æˆ·æ•°æ®ï¼šè§£é”æˆå°±æ—¶ç«‹å³æ›´æ–°ï¼ˆé€šè¿‡è§¦å‘å™¨ï¼‰
- å…¨å±€æ’åï¼šå»ºè®®æ¯å°æ—¶é‡ç®—ä¸€æ¬¡
- ç¼“å­˜æ•°æ®ï¼š5-15åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡

### Q2: å¦‚ä½•å¤„ç†ä½œå¼Šï¼Ÿ
**A:**
- æ•°æ®åº“å±‚ï¼šçº¦æŸæ£€æŸ¥ï¼ˆå¦‚è¿›åº¦ä¸èƒ½è¶…è¿‡ç›®æ ‡ï¼‰
- åº”ç”¨å±‚ï¼šéªŒè¯æˆå°±è§£é”æ¡ä»¶
- å¼‚å¸¸æ£€æµ‹ï¼šç›‘æ§å¼‚å¸¸å¿«çš„æˆå°±è¿›åº¦

### Q3: èµ›å­£å¦‚ä½•åˆ‡æ¢ï¼Ÿ
**A:**
- è‡ªåŠ¨æ£€æµ‹èµ›å­£ç»“æŸ
- è‡ªåŠ¨å‘æ”¾å¥–åŠ±
- åˆ›å»ºæ–°èµ›å­£æ•°æ®
- ä¿ç•™å†å²è®°å½•

### Q4: æ€§èƒ½å¦‚ä½•ä¿è¯ï¼Ÿ
**A:**
- ç´¢å¼•ä¼˜åŒ–
- åˆ†é¡µåŠ è½½
- ç¼“å­˜ç­–ç•¥
- å¼‚æ­¥æ›´æ–°

### Q5: å¦‚ä½•é¼“åŠ±å‚ä¸ï¼Ÿ
**A:**
- å¸å¼•äººçš„å¥–åŠ±
- èµ›å­£ä¸»é¢˜
- å®æ—¶æ’åæ›´æ–°
- ç¤¾äº¤åˆ†äº«åŠŸèƒ½

---

## æ€»ç»“

æœ¬æˆå°±æ’è¡Œæ¦œç³»ç»Ÿæä¾›äº†å®Œæ•´çš„ç«äº‰æ€§åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š

âœ… **5ç§æ’è¡Œæ¦œç±»å‹** - æ»¡è¶³ä¸åŒç©å®¶éœ€æ±‚
âœ… **èµ›å­£ç³»ç»Ÿ** - ä¿æŒå†…å®¹æ–°é²œæ„Ÿ
âœ… **å¥–åŠ±æœºåˆ¶** - æ¿€åŠ±ç©å®¶å‚ä¸
âœ… **å®Œæ•´çš„æ•°æ®åº“è®¾è®¡** - æ”¯æŒæ‰©å±•
âœ… **ä¼˜åŒ–çš„æ€§èƒ½** - æµç•…çš„ç”¨æˆ·ä½“éªŒ
âœ… **è¯¦å°½çš„æ–‡æ¡£** - æ˜“äºç»´æŠ¤

### ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³å¼€å§‹ï¼š** æ‰§è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬
2. **ä»£ç é›†æˆï¼š** å°† LeaderboardManager é›†æˆåˆ°æ¸¸æˆ
3. **UI æ·»åŠ ï¼š** åœ¨ä¸»ç•Œé¢æ·»åŠ æ’è¡Œæ¦œå…¥å£
4. **æµ‹è¯•éªŒè¯ï¼š** è¿›è¡Œå®Œæ•´çš„åŠŸèƒ½æµ‹è¯•
5. **ä¸Šçº¿å‘å¸ƒï¼š** æ¨é€ç»™ç©å®¶ä½¿ç”¨

---

## é™„å½•

### A. æˆå°±éš¾åº¦å»ºè®®

**æ™®é€šæˆå°±ï¼ˆ10åˆ†ï¼‰**
- è§£é”ç¬¬ä¸€ä¸ªå»ºç­‘
- æ”¶é›†1000å•ä½èµ„æº
- æ¢ç´¢ç¬¬ä¸€ä¸ªPOI

**ç¨€æœ‰æˆå°±ï¼ˆ30åˆ†ï¼‰**
- å»ºé€ 10ä¸ªå»ºç­‘
- æ”¶é›†10000å•ä½èµ„æº
- æ‹¥æœ‰5ä¸ªé¢†åœ°

**å²è¯—æˆå°±ï¼ˆ50åˆ†ï¼‰**
- å»ºé€ 50ä¸ªå»ºç­‘
- æ”¶é›†100000å•ä½èµ„æº
- é¢†åœ°ç­‰çº§è¾¾åˆ°10

**ä¼ è¯´æˆå°±ï¼ˆ100åˆ†ï¼‰**
- è§£é”æ‰€æœ‰å»ºç­‘ç±»å‹
- æ”¶é›†1000000å•ä½èµ„æº
- æ‹¥æœ‰100ä¸ªé¢†åœ°

### B. SQL å¿«é€Ÿå‚è€ƒ

```sql
-- æŸ¥çœ‹å½“å‰æ’è¡Œæ¦œ
SELECT * FROM v_leaderboard_with_user
ORDER BY total_points DESC
LIMIT 100;

-- æŸ¥çœ‹ç”¨æˆ·æ’å
SELECT * FROM v_leaderboard_with_user
WHERE user_id = 'your-user-id';

-- æŸ¥çœ‹åˆ†ç±»æ¦œ
SELECT * FROM v_category_leaderboard_with_user
WHERE category = 'building'
ORDER BY category_points DESC
LIMIT 50;

-- æ‰‹åŠ¨æ›´æ–°ç”¨æˆ·æ•°æ®
SELECT update_user_achievement_leaderboard('user-id');

-- é‡æ–°è®¡ç®—æ‰€æœ‰æ’å
SELECT recalculate_leaderboard_rankings();
```

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** 1.0
**åˆ›å»ºæ—¥æœŸï¼š** 2026-02-26
**æœ€åæ›´æ–°ï¼š** 2026-02-26
**ä½œè€…ï¼š** Claude
