# EarthLord è®¤è¯æµç¨‹è¯´æ˜

## ğŸ“± åº”ç”¨å¯åŠ¨æµç¨‹

```
App å¯åŠ¨
   â†“
EarthLordApp.swift
   â†“
RootView.swiftï¼ˆæ ¹è§†å›¾ï¼‰
   â†“
åˆ¤æ–­ splashFinishedï¼Ÿ
   â”œâ”€ å¦ â†’ SplashViewï¼ˆå¯åŠ¨é¡µï¼‰
   â”‚         â”œâ”€ æ˜¾ç¤º Logo + åŠ è½½åŠ¨ç”»
   â”‚         â”œâ”€ æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼ˆcheckSessionï¼‰
   â”‚         â””â”€ å®Œæˆå splashFinished = true
   â”‚
   â””â”€ æ˜¯ â†’ åˆ¤æ–­ isAuthenticatedï¼Ÿ
            â”œâ”€ å¦ â†’ AuthViewï¼ˆè®¤è¯é¡µé¢ï¼‰
            â”‚         â”œâ”€ ç™»å½• Tab
            â”‚         â””â”€ æ³¨å†Œ Tab
            â”‚
            â””â”€ æ˜¯ â†’ MainTabViewï¼ˆä¸»ç•Œé¢ï¼‰
```

## ğŸ” è®¤è¯çŠ¶æ€ç®¡ç†

### AuthManagerï¼ˆè®¤è¯ç®¡ç†å™¨ï¼‰

**èŒè´£ï¼š**
- ç®¡ç†ç”¨æˆ·ç™»å½•çŠ¶æ€
- å¤„ç†æ³¨å†Œã€ç™»å½•ã€æ‰¾å›å¯†ç æµç¨‹
- ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–

**æ ¸å¿ƒå±æ€§ï¼š**
- `isAuthenticated: Bool` - æ˜¯å¦å·²å®Œæˆè®¤è¯
- `currentUser: User?` - å½“å‰ç™»å½•ç”¨æˆ·
- `needsPasswordSetup: Bool` - æ˜¯å¦éœ€è¦è®¾ç½®å¯†ç 

**çŠ¶æ€ç›‘å¬ï¼š**
```swift
// è‡ªåŠ¨ç›‘å¬ Supabase è®¤è¯çŠ¶æ€å˜åŒ–
setupAuthStateListener()
  â”œâ”€ signedIn â†’ ç”¨æˆ·ç™»å½•
  â”œâ”€ signedOut â†’ ç”¨æˆ·é€€å‡º
  â”œâ”€ tokenRefreshed â†’ Token åˆ·æ–°
  â”œâ”€ userUpdated â†’ ç”¨æˆ·ä¿¡æ¯æ›´æ–°
  â””â”€ passwordRecovery â†’ å¯†ç æ¢å¤
```

## ğŸ“ æ³¨å†Œæµç¨‹

### ç¬¬ä¸€æ­¥ï¼šè¾“å…¥é‚®ç®±
```swift
await authManager.sendRegisterOTP(email: "user@example.com")
```
- è°ƒç”¨ `supabase.auth.signInWithOTP(email:shouldCreateUser:true)`
- æˆåŠŸå `otpSent = true`ï¼Œè¿›å…¥ç¬¬äºŒæ­¥

### ç¬¬äºŒæ­¥ï¼šéªŒè¯ç éªŒè¯
```swift
await authManager.verifyRegisterOTP(email: "user@example.com", code: "123456")
```
- è°ƒç”¨ `supabase.auth.verifyOTP(email:token:type:.email)`
- æˆåŠŸåï¼š
  - `otpVerified = true`
  - `needsPasswordSetup = true`
  - ç”¨æˆ·å·²ç™»å½•ä½† `isAuthenticated = false`
  - è‡ªåŠ¨è§¦å‘ `authStateChanges` äº‹ä»¶ï¼ˆsignedInï¼‰
  - è‡ªåŠ¨è¿›å…¥ç¬¬ä¸‰æ­¥

### ç¬¬ä¸‰æ­¥ï¼šè®¾ç½®å¯†ç 
```swift
await authManager.completeRegistration(password: "securePassword")
```
- è°ƒç”¨ `supabase.auth.update(user: UserAttributes(password:))`
- æˆåŠŸåï¼š
  - `needsPasswordSetup = false`
  - `isAuthenticated = true`
  - è‡ªåŠ¨è§¦å‘ `authStateChanges` äº‹ä»¶ï¼ˆuserUpdatedï¼‰
  - **è‡ªåŠ¨è·³è½¬åˆ° MainTabView**

## ğŸ”‘ ç™»å½•æµç¨‹

```swift
await authManager.signIn(email: "user@example.com", password: "password")
```
- è°ƒç”¨ `supabase.auth.signIn(email:password:)`
- æˆåŠŸåï¼š
  - `isAuthenticated = true`
  - è‡ªåŠ¨è§¦å‘ `authStateChanges` äº‹ä»¶ï¼ˆsignedInï¼‰
  - **è‡ªåŠ¨è·³è½¬åˆ° MainTabView**

## ğŸ”„ æ‰¾å›å¯†ç æµç¨‹

### ç¬¬ä¸€æ­¥ï¼šå‘é€éªŒè¯ç 
```swift
await authManager.sendResetOTP(email: "user@example.com")
```
- è°ƒç”¨ `supabase.auth.resetPasswordForEmail(email)`

### ç¬¬äºŒæ­¥ï¼šéªŒè¯ç éªŒè¯
```swift
await authManager.verifyResetOTP(email: "user@example.com", code: "123456")
```
- è°ƒç”¨ `supabase.auth.verifyOTP(email:token:type:.recovery)`
- âš ï¸ æ³¨æ„ï¼šä½¿ç”¨ `.recovery` ç±»å‹ï¼Œä¸æ˜¯ `.email`

### ç¬¬ä¸‰æ­¥ï¼šè®¾ç½®æ–°å¯†ç 
```swift
await authManager.resetPassword(newPassword: "newPassword")
```
- è°ƒç”¨ `supabase.auth.update(user: UserAttributes(password:))`
- æˆåŠŸåè‡ªåŠ¨ç™»å½•

## ğŸšª é€€å‡ºç™»å½•

```swift
await authManager.signOut()
```
- è°ƒç”¨ `supabase.auth.signOut()`
- è‡ªåŠ¨è§¦å‘ `authStateChanges` äº‹ä»¶ï¼ˆsignedOutï¼‰
- æ¸…ç©ºæ‰€æœ‰çŠ¶æ€
- **è‡ªåŠ¨è·³è½¬åˆ° AuthView**

## ğŸ”” è®¤è¯çŠ¶æ€å˜åŒ–ç›‘å¬

AuthManager ä¼šè‡ªåŠ¨ç›‘å¬ä»¥ä¸‹äº‹ä»¶ï¼š

| äº‹ä»¶ | è§¦å‘æ—¶æœº | è‡ªåŠ¨å¤„ç† |
|------|---------|---------|
| `signedIn` | ç™»å½•æˆåŠŸ | æ›´æ–° currentUser, isAuthenticated |
| `signedOut` | é€€å‡ºç™»å½• | æ¸…ç©ºçŠ¶æ€ï¼Œè·³è½¬åˆ°è®¤è¯é¡µ |
| `tokenRefreshed` | Token è‡ªåŠ¨åˆ·æ–° | æ›´æ–° currentUser |
| `userUpdated` | ç”¨æˆ·ä¿¡æ¯æ›´æ–° | æ›´æ–° currentUser |
| `passwordRecovery` | å¯†ç æ¢å¤æµç¨‹ | è®°å½•æ—¥å¿— |

## ğŸ¯ å…³é”®è®¾è®¡

### 1. å•ä¾‹æ¨¡å¼
```swift
@StateObject private var authManager = AuthManager.shared
```
- å…¨å±€å”¯ä¸€å®ä¾‹
- çŠ¶æ€åœ¨æ•´ä¸ªåº”ç”¨ä¸­å…±äº«

### 2. è‡ªåŠ¨é¡µé¢è·³è½¬
- RootView ç›‘å¬ `authManager.isAuthenticated`
- çŠ¶æ€å˜åŒ–è‡ªåŠ¨è§¦å‘é¡µé¢åˆ‡æ¢
- æ— éœ€æ‰‹åŠ¨å¯¼èˆª

### 3. æ³¨å†Œæµç¨‹å¼ºåˆ¶è®¾ç½®å¯†ç 
- OTP éªŒè¯å `isAuthenticated` ä¿æŒ `false`
- å¿…é¡»å®Œæˆå¯†ç è®¾ç½®æ‰èƒ½è¿›å…¥ä¸»é¡µ
- `needsPasswordSetup` æ§åˆ¶æµç¨‹

### 4. å¯åŠ¨æ—¶ä¼šè¯æ£€æŸ¥
- SplashView å¯åŠ¨æ—¶è°ƒç”¨ `checkSession()`
- è‡ªåŠ¨æ¢å¤ç™»å½•çŠ¶æ€
- å·²ç™»å½•ç”¨æˆ·ç›´æ¥è¿›å…¥ä¸»é¡µ

## ğŸ“± UI é¡µé¢

### SplashViewï¼ˆå¯åŠ¨é¡µï¼‰
- æ˜¾ç¤º Logo å’ŒåŠ è½½åŠ¨ç”»
- æ£€æŸ¥ç™»å½•çŠ¶æ€
- åŠ è½½èµ„æº

### AuthViewï¼ˆè®¤è¯é¡µï¼‰
- Tab åˆ‡æ¢ï¼ˆç™»å½•/æ³¨å†Œï¼‰
- å¤šæ­¥éª¤è¡¨å•
- æ‰¾å›å¯†ç å¼¹çª—
- ç¬¬ä¸‰æ–¹ç™»å½•å ä½

### RootViewï¼ˆæ ¹è§†å›¾ï¼‰
- æ§åˆ¶é¡µé¢æµç¨‹
- ç›‘å¬è®¤è¯çŠ¶æ€
- è‡ªåŠ¨é¡µé¢åˆ‡æ¢

## ğŸ”§ æµ‹è¯•æµç¨‹

1. **é¦–æ¬¡å¯åŠ¨**
   - æ˜¾ç¤ºå¯åŠ¨é¡µ â†’ æ£€æŸ¥ä¼šè¯ï¼ˆæ— ä¼šè¯ï¼‰â†’ æ˜¾ç¤ºè®¤è¯é¡µ

2. **æ³¨å†Œæ–°ç”¨æˆ·**
   - è¾“å…¥é‚®ç®± â†’ æ¥æ”¶éªŒè¯ç  â†’ éªŒè¯ â†’ è®¾ç½®å¯†ç  â†’ è¿›å…¥ä¸»é¡µ

3. **é€€å‡ºé‡æ–°ç™»å½•**
   - é€€å‡ºç™»å½• â†’ è¿”å›è®¤è¯é¡µ â†’ è¾“å…¥é‚®ç®±å¯†ç  â†’ è¿›å…¥ä¸»é¡µ

4. **å…³é—­é‡æ–°æ‰“å¼€**
   - æ˜¾ç¤ºå¯åŠ¨é¡µ â†’ æ£€æŸ¥ä¼šè¯ï¼ˆæœ‰ä¼šè¯ï¼‰â†’ ç›´æ¥è¿›å…¥ä¸»é¡µ

5. **æ‰¾å›å¯†ç **
   - è®¤è¯é¡µç‚¹å‡»"å¿˜è®°å¯†ç " â†’ éªŒè¯ç  â†’ è®¾ç½®æ–°å¯†ç  â†’ è‡ªåŠ¨ç™»å½•

---

âœ… **è®¤è¯æµç¨‹å·²å®Œæ•´å®ç°ï¼**
