# 🚀 EarthLord 订阅系统完整优化版开发指南

**版本**: 3.0 (优化版)  
**创建日期**: 2026-02-24  
**基于**: 官方订阅系统设计文档优化  
**开发周期**: 21 天（3个阶段）  

---

## 📋 核心架构设计

### 整体权益等级体系

```
┌────────────────────────────────────────────────────────────┐
│                    EarthLord 权益等级体系                      │
├────────────────────────────────────────────────────────────┤
│                                                              │
│  Level 0: 基础用户 (免费)                                    │
│  ├─ 建筑时间: 基础                                           │
│  ├─ 生产周期: 基础                                           │
│  ├─ 背包容量: 100 kg                                        │
│  └─ 其他: 无特殊权益                                         │
│                                                              │
│  Level 1: 快速支援包 (临时权益)                              │
│  ├─ 建筑加速: -20%                                          │
│  ├─ 生产加速: -15%                                          │
│  ├─ 背包容量: +25 kg                                        │
│  ├─ 传送次数: 3次/天                                        │
│  └─ VIP 商店: 10% 折扣                                      │
│                                                              │
│  Level 2: 领主权益 (高级权益)                                │
│  ├─ 建筑加速: -40%                                          │
│  ├─ 生产加速: -30%                                          │
│  ├─ 资源产出: +20%                                          │
│  ├─ 背包容量: +50 kg                                        │
│  ├─ VIP 名牌: 显示身份                                      │
│  └─ 限定活动: 每周挑战                                       │
│                                                              │
│  Level 3: 帝国统治者 (顶级权益)                              │
│  ├─ 建筑加速: -60%                                          │
│  ├─ 生产加速: -50%                                          │
│  ├─ 资源产出: +40%                                          │
│  ├─ 背包容量: +100 kg (无限扩展)                            │
│  ├─ 领地防御: +15%                                          │
│  ├─ 限定活动: 每月活动 + 稀有物资                            │
│  ├─ 客服支援: 24/7 专属                                     │
│  └─ 无限队列: 可同时建造                                     │
│                                                              │
└────────────────────────────────────────────────────────────┘
```

---

## 📊 完整产品体系 (16 产品)

### 产品分类结构

```
消耗性产品 (4个)
├── 幸存者补给 (¥6)      - 新手入门
├── 探险家补给 (¥18)     - 初级玩家
├── 领主补给 (¥30)       - 核心玩家
└── 霸主补给 (¥68)       - 重度玩家

非续期订阅 (9个) - 临时权益激活
├── 快速支援包 (30/90/365天)    - Level 1
├── 领主权益包 (30/90/365天)    - Level 2
└── 帝国统治者 (30/90/365天)    - Level 3

自动续期订阅 (3个) - 持续权益
├── VIP 月会员 (¥12/月)  - Level 1 + 月补给
├── VIP 季会员 (¥28/季)  - Level 1 + 季补给
└── VIP 年会员 (¥88/年)  - Level 1 + 年补给
```

---

## 💰 完整定价体系

### 消耗性产品 - 资源补给包

```
等级 | 产品名称 | 价格 | 主要资源 | 目标用户 |
-----|--------|------|--------|--------|
⭐   | 幸存者补给 | ¥6 | 木材300 石头300 | 新手尝试 |
⭐⭐  | 探险家补给 | ¥18 | 木材1000 食物500 | 活跃玩家 |
⭐⭐⭐ | 领主补给 | ¥30 | 稀有金属200 医疗500 | 核心玩家 |
⭐⭐⭐⭐| 霸主补给 | ¥68 | 传奇碎片50 稀有物资 | 重度玩家 |
```

### 非续期订阅 - 权益激活包

#### 快速支援包 (Level 1)

| 时长 | 价格 | 月均 | 权益等级 |
|------|------|------|--------|
| 30 天 | ¥8 | ¥8/月 | ⭐ 基础 |
| 90 天 | ¥18 | ¥6/月 | ⭐ 基础 (省¥24) |
| 365 天 | ¥58 | ¥4.8/月 | ⭐ 基础 (省¥38) |

**包含权益**:
- 建造时间 -20%
- 生产周期 -15%
- 背包容量 +25 kg
- VIP 商店 10% 折扣
- 每天 3 次传送

#### 领主权益包 (Level 2)

| 时长 | 价格 | 月均 | 权益等级 |
|------|------|------|--------|
| 30 天 | ¥18 | ¥18/月 | ⭐⭐ 高级 |
| 90 天 | ¥38 | ¥12.7/月 | ⭐⭐ 高级 (省¥16) |
| 365 天 | ¥128 | ¥10.7/月 | ⭐⭐ 高级 (省¥80) |

**包含权益** (包含快速支援 +):
- 建造时间 -40%
- 生产周期 -30%
- 资源产出 +20%
- 背包容量 +50 kg
- 每周限定挑战
- VIP 名牌效果
- VIP 商店 20% 折扣

#### 帝国统治者包 (Level 3)

| 时长 | 价格 | 月均 | 权益等级 |
|------|------|------|--------|
| 30 天 | ¥38 | ¥38/月 | ⭐⭐⭐ 顶级 |
| 90 天 | ¥88 | ¥29.3/月 | ⭐⭐⭐ 顶级 (省¥36) |
| 365 天 | ¥298 | ¥24.8/月 | ⭐⭐⭐ 顶级 (省¥116) |

**包含权益** (包含领主权益 +):
- 建造时间 -60%
- 生产周期 -50%
- 资源产出 +40%
- 背包容量 +100 kg
- 每月稀有物资箱 (¥98价值)
- 无限建造队列
- 领地防御 +15%
- 24/7 专属客服
- VIP 商店 20% 折扣

### 自动续期订阅 - VIP 会员 (持续权益)

| 产品 | 周期 | 价格 | 月均 | 节省 | 试用 |
|------|------|------|------|------|------|
| VIP 月会员 | 每月 | ¥12/月 | ¥12 | - | 3天免费 |
| VIP 季会员 | 每3个月 | ¥28 | ¥9.3 | 22% | - |
| VIP 年会员 | 每年 | ¥88 | ¥7.3 | 39% | - |

**VIP 会员权益**:
- 所有快速支援权益 (Level 1)
- 每月补给券 (¥20-50)
- 月度排行榜参赛
- 专属徽章系统
- 抢先测试新功能
- 专属社区访问

---

## 📱 产品 ID 完整配置

### 消耗性产品 ID

```swift
com.earthlord.supply.survivor    // 幸存者补给 ¥6
com.earthlord.supply.explorer    // 探险家补给 ¥18
com.earthlord.supply.lord        // 领主补给 ¥30
com.earthlord.supply.overlord    // 霸主补给 ¥68
```

### 非续期订阅 ID

```swift
// 快速支援包 (Level 1)
com.earthlord.support.1m         // 30天 ¥8
com.earthlord.support.3m         // 90天 ¥18
com.earthlord.support.1y         // 365天 ¥58

// 领主权益包 (Level 2)
com.earthlord.lordship.1m        // 30天 ¥18
com.earthlord.lordship.3m        // 90天 ¥38
com.earthlord.lordship.1y        // 365天 ¥128

// 帝国统治者 (Level 3)
com.earthlord.empire.1m          // 30天 ¥38
com.earthlord.empire.3m          // 90天 ¥88
com.earthlord.empire.1y          // 365天 ¥298
```

### 自动续期订阅 ID

```swift
com.earthlord.vip.monthly        // VIP月会员 ¥12/月
com.earthlord.vip.quarterly      // VIP季会员 ¥28/季
com.earthlord.vip.annual         // VIP年会员 ¥88/年
```

---

## 🎯 权益对比矩阵

### 完整权益表

| 权益项 | 基础用户 | 快速支援 | 领主权益 | 帝国统治 | VIP会员 |
|--------|--------|--------|--------|--------|--------|
| **加速权益** | | | | | |
| 建造时间 | 标准 | -20% | -40% | -60% | -20% |
| 生产周期 | 标准 | -15% | -30% | -50% | -15% |
| 资源产出 | 1倍 | 1倍 | +20% | +40% | 1倍 |
| | | | | | |
| **容量权益** | | | | | |
| 背包容量 | 100kg | +25kg | +50kg | +100kg | +25kg |
| 建造队列 | 5个 | 5个 | 5个 | 无限 | 5个 |
| | | | | | |
| **特殊权益** | | | | | |
| VIP 折扣 | 0% | 10% | 20% | 20% | 10% |
| 传送次数 | 0 | 3次/天 | 3次/天 | 3次/天 | 3次/天 |
| 每日奖励 | 无 | ¥500 | ¥500 | ¥500 | ¥500 |
| | | | | | |
| **社交权益** | | | | | |
| VIP名牌 | 否 | 否 | 是 | 是 | 否 |
| 限定活动 | 否 | 否 | 每周 | 每月 | 否 |
| 稀有物资 | 否 | 否 | 否 | 每月 | 否 |
| 客服支援 | 基础 | 基础 | 基础 | 专属 | 基础 |
| | | | | | |
| **时效性** | | | | | |
| 持续时间 | 永久 | 30/90/365天 | 30/90/365天 | 30/90/365天 | 自动续费 |
| 自动续费 | - | 否 | 否 | 否 | 是 |

---

## 📋 用户转化路径

### 推荐转化漏斗

```
免费用户 (100%)
    ↓
    ├─ 15-20% ──→ 购买补给包 (消耗性)
    │             ↓
    │             └─ 5-8% ──→ 升级到快速支援 (30天体验)
    │                         ↓
    │                         └─ 2-4% ──→ 升级到领主权益 (高级体验)
    │                                      ↓
    │                                      └─ 1-2% ──→ 升级到VIP年会 (持续订阅)
    │
    └─ 直接转化:
        └─ 2-3% ──→ 订阅VIP月会 (直接决策)
```

### 用户分群推荐策略

| 玩家类型 | 日活等级 | 推荐路径 | 关键引导 |
|---------|--------|--------|--------|
| **新手** | <7天 | 补给→快速支援月 | 低价尝试、首月折扣 |
| **成长** | 7-30天 | 补给→快速支援季 | 性价比对比、时间加速 |
| **活跃** | 30-90天 | 补给→领主权益月 | 产出加成、社交权益 |
| **核心** | >90天 | 补给→VIP年会 | 终极体验、长期订阅 |

---

## 🛠️ 数据库设计优化

### 核心表结构

#### user_subscriptions (用户订阅表)

```sql
CREATE TABLE user_subscriptions (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL,
    product_id VARCHAR(100) NOT NULL,
    
    -- 权益等级映射
    tier_level INT,  -- 0:免费, 1:快速支援, 2:领主, 3:帝国, 4:VIP
    tier_name VARCHAR(50),  -- support/lordship/empire/vip
    
    purchase_date TIMESTAMPTZ,
    expiration_date TIMESTAMPTZ,
    
    -- 权益激活时间
    started_date TIMESTAMPTZ,
    ended_date TIMESTAMPTZ,
    
    is_active BOOLEAN,
    is_auto_renewable BOOLEAN,
    
    remaining_days INT,  -- 计算属性
    
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### user_entitlements (权益缓存表)

```sql
CREATE TABLE user_entitlements (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL UNIQUE,
    
    -- 等级信息
    current_tier INT,  -- 0-4
    tier_name VARCHAR(50),
    
    -- 权益加成
    build_speed_bonus DECIMAL(5,2),
    production_speed_bonus DECIMAL(5,2),
    resource_output_bonus DECIMAL(5,2),
    backpack_capacity_bonus INT,
    defense_bonus DECIMAL(5,2),
    shop_discount_percentage INT,
    
    -- 特殊权益
    has_vip_badge BOOLEAN,
    has_unlimited_queues BOOLEAN,
    has_24h_support BOOLEAN,
    
    -- 过期时间
    perk_expiration_date TIMESTAMPTZ,
    
    last_updated TIMESTAMPTZ DEFAULT NOW()
);
```

---

## 🧪 完整测试场景 (优化版)

### 12 个核心测试场景

#### Tier 1: 消耗性产品测试

| T ID | 场景 | 操作 | 验证点 | 优先级 |
|------|------|------|-------|--------|
| T01 | 购买基础补给 | 购买 survivor (¥6) | 资源正确增加 | P1 |
| T02 | 购买高阶补给 | 购买 overlord (¥68) | 稀有资源增加 | P1 |

#### Tier 2: 非续期订阅测试

| T ID | 场景 | 操作 | 验证点 | 优先级 |
|------|------|------|-------|--------|
| T03 | 快速支援体验 | 购买 support.1m | 权益30天后过期 | P1 |
| T04 | 领主权益激活 | 购买 lordship.1y | 365天权益激活 | P1 |
| T05 | 帝国统治激活 | 购买 empire.3m | 90天顶级权益 | P1 |
| T06 | 权益升级流程 | support.1m → lordship.1m | 权益无缝升级 | P2 |
| T07 | 权益降级流程 | lordship.1m → support.1m | 降级提示和处理 | P2 |
| T08 | 权益过期处理 | 等待过期时间 | 权益自动移除 | P1 |

#### Tier 3: 续期订阅测试

| T ID | 场景 | 操作 | 验证点 | 优先级 |
|------|------|------|-------|--------|
| T09 | VIP 订阅开始 | 购买 vip.monthly | 月度续费配置 | P1 |
| T10 | VIP 续费成功 | 模拟续费周期 | 自动扣费并续期 | P1 |
| T11 | VIP 取消订阅 | 用户主动取消 | 停止后续续费 | P2 |
| T12 | 多产品叠加 | 混合购买多个产品 | 权益正确合并 | P3 |

---

## 🔑 关键逻辑实现

### 权益等级计算

```swift
// 根据订阅情况计算用户的当前等级
func calculateUserTier() -> Int {
    guard let highestSubscription = getHighestActiveSubscription() else {
        return 0  // 免费用户
    }
    
    switch highestSubscription.tierName {
    case "support":
        return 1  // 快速支援
    case "lordship":
        return 2  // 领主权益
    case "empire":
        return 3  // 帝国统治
    case "vip":
        return 1  // VIP = 快速支援级别
    default:
        return 0
    }
}

// 权益应用
func applyEntitlements(tier: Int) {
    switch tier {
    case 0:  // 免费
        applyBaseEntitlements()
    case 1:  // 快速支援
        applySupportBenefits()
    case 2:  // 领主权益
        applyLordshipBenefits()
    case 3:  // 帝国统治
        applyEmpireBenefits()
    default:
        break
    }
}
```

### 权益过期检查

```swift
// 每日检查权益过期
func checkEntitlementExpiration() {
    let expiredSubscriptions = subscriptions.filter { 
        $0.expirationDate < Date() && $0.isActive 
    }
    
    for subscription in expiredSubscriptions {
        // 降级到下一个等级或免费
        downgradeSubscription(subscription)
        
        // 记录审计日志
        logAudit("entitlement_expired", subscription)
        
        // 推送续期建议
        sendRenewalNotification(subscription)
    }
}
```

---

## 📊 收入模型优化

### 财务预期 (100K MAU)

```
用户分群          占比   数量    月均消费   月度收入
─────────────────────────────────────────────────
完全免费用户      76%  76,000      ¥0       ¥0
补给包购买者      12%  12,000     ¥12    ¥144,000
快速支援订户       7%   7,000     ¥25    ¥175,000
领主权益订户       3%   3,000     ¥38    ¥114,000
VIP会员用户       2%   2,000     ¥50    ¥100,000
─────────────────────────────────────────────────
总计             100% 100,000   ¥12.61  ¥533,000

整体 ARPPU: ¥12.61 (付费用户 ARPPU: ¥36.5)
年度总收入: ¥533,000 × 12 = ¥6,396,000

👑 关键指标:
├─ 转化率: 24% (行业平均 3-5%)
├─ 月活跃支付用户: 24,000
├─ 年订阅新增收入: ~¥320万
└─ 总体收入增长: +35% vs 基础版
```

### 价格优化建议

```
定价策略:
├─ 新手/试玩: 补给包 (¥6-18)
│  └─ 目标: 测试购买意愿
├─ 成长激励: 支援包 + 折扣 (¥8/月 → ¥4.8/月)
│  └─ 目标: 体验权益价值
├─ 价值提升: 领主权益 (¥18-128/月)
│  └─ 目标: 深度玩家留存
└─ 终极体验: VIP年会 (¥88/年 = ¥7.3/月)
   └─ 目标: 长期用户锁定

季节性促销:
├─ 新用户首月: -50% 优惠
├─ 节日活动: 补给包 +30% 资源
├─ 登录奖励: 每连续登录送补给券
└─ 推荐奖励: 邀请好友送 VIP 试用券
```

---

## 🎓 实施路径优化

### Phase 优先级调整

```
Phase 1 (Week 1): 消耗性 + 基础权益
├─ 完成度: 100% (4 个产品)
├─ 投入: 30-40 小时
└─ 收益: 基础变现 + 快速反馈

Phase 2 (Week 2): 非续期订阅系统
├─ 完成度: 9 个产品 (三个等级)
├─ 投入: 40-50 小时
├─ 收益: 用户分级 + 权益体验
└─ 关键: 等级体系验证

Phase 3 (Week 3): VIP 续期 + 优化
├─ 完成度: 3 个产品
├─ 投入: 20-30 小时
├─ 收益: 稳定月活收入
└─ 关键: 续费率优化
```

---

## ✅ 验收标准 (优化版)

### 功能完整性

```
消耗性产品:
├─ T01/T02 通过
├─ 4 个产品 100% 配置
└─ 资源分配正确

非续期订阅:
├─ T03-T08 全部通过
├─ 等级升降正确
├─ 权益过期处理完善

续期订阅:
├─ T09-T11 全部通过
├─ 自动续费正常
├─ 取消流程完整

系统集成:
├─ T12 多产品叠加正确
├─ 权益应用无冲突
└─ 数据同步完整
```

### 性能指标

```
响应时间:
├─ 购买流程: < 5 秒
├─ 权益检查: < 100ms
├─ 页面加载: < 2 秒
└─ API 响应: < 500ms

资源占用:
├─ 内存: < 200MB
├─ CPU: < 30% (权益检查时)
├─ 电池: < 5% 额外消耗
└─ 网络: 优化带宽

用户体验:
├─ 帧率: ≥ 60fps
├─ 崩溃率: < 0.1%
├─ 未捕获异常: 0
└─ 用户评分: ≥ 4.5
```

---

## 📞 快速参考表

### 产品-权益 快速查询

| 产品 | 等级 | 时长 | 价格 | 关键权益 |
|------|------|------|------|---------|
| survivor | L0 | 一次 | ¥6 | 补给 |
| support.1m | L1 | 30d | ¥8 | 加速-20% |
| lordship.3m | L2 | 90d | ¥38 | 加速-40% 产出+20% |
| empire.1y | L3 | 365d | ¥298 | 加速-60% 无限队列 |
| vip.annual | L1 | 12m | ¥88 | 订阅+月补给 |

### API 端点优化

```
GET  /api/subscriptions/tiers      # 获取用户等级
GET  /api/subscriptions/current    # 获取当前订阅
POST /api/subscriptions/purchase   # 购买
POST /api/subscriptions/upgrade    # 升级
POST /api/subscriptions/cancel     # 取消
GET  /api/entitlements/active      # 获取活跃权益
```

---

## 🎯 关键改进点总结

### vs 之前版本的优化

| 方面 | 之前 | 优化后 | 提升 |
|------|------|-------|------|
| 权益等级 | 4层 (无明确等级) | 4层 (清晰等级体系) | +清晰 |
| 产品分类 | 消耗/非续期/续期 | 按等级 + 按时长 | +灵活 |
| 价格体系 | 个别定价 | 等级 × 时长矩阵 | +规范 |
| 权益对应 | 散状 | 矩阵表明确 | +易维护 |
| 用户转化 | 通用漏斗 | 分群推荐 | +精准 |
| 财务预期 | ¥388K/月 | ¥533K/月 | +37% |
| 实施复杂度 | 中等 | 优化分层 | ±易理解 |
| 测试覆盖 | 12 场景 | 12 场景 (优化) | +清晰 |

---

## 📝 使用建议

### 阅读顺序

1. **先读这份文档** (本文件)
   - 理解优化的等级体系
   - 掌握新的价格体系
   - 了解权益对应关系

2. **再对比原版文档** (开发指南.md)
   - 查看具体代码实现
   - 理解数据库结构
   - 学习集成方案

3. **最后查看实施计划** (实施日历.md)
   - 按计划执行开发
   - 参考代码框架
   - 执行测试场景

### 快速迁移

如果已有之前的代码实现:
1. 更新 `Entitlement` 模型 (添加 tier_level 字段)
2. 修改权益判断逻辑 (按等级而非产品)
3. 优化 UI 展示 (按等级分类产品)
4. 调整数据库 (添加 tier 字段)

---

**版本历史**:
- v3.0 (2026-02-24): 基于官方设计优化版本
- v2.0: 16 产品完整版本
- v1.0: 初始版本

**下一步**: 继续按 21 天计划实施开发！ 🚀
