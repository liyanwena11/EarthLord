## 交易系统 UI 层实现计划

### 1. 项目结构分析
- **现有结构**：
  - 通讯标签页 (`CommunicationTabView.swift`)
  - 末日主题配色 (`ApocalypseTheme.swift`)
  - 交易管理器 (`TradeManager.swift`)
  - 交易模型 (`TradeModels.swift`)

### 2. 页面实现计划

#### 2.1 交易主页面
- **集成方式**：在通讯标签页中添加交易模块
- **布局**：使用分段控制器，包含四个模块
  - 交易市场
  - 我的挂单
  - 交易历史
  - 发布挂单
- **设计风格**：采用末日主题配色，深色背景，橙色强调色

#### 2.2 发布挂单页面
- **功能**：创建新的交易挂单
- **布局**：
  - 我要出的物品列表
  - 我想要的物品列表
  - 有效期选择器
  - 留言输入框
  - 发布按钮
- **交互**：
  - 点击添加物品弹出物品选择器
  - 可编辑/删除已选物品
  - 两边都有物品时发布按钮才可点击

#### 2.3 我的挂单页面
- **功能**：管理自己发布的挂单
- **布局**：
  - 发布新挂单按钮
  - 挂单卡片列表
  - 状态标签和剩余时间
- **功能**：
  - 显示不同状态的挂单
  - 等待中的挂单可取消
  - 已完成的挂单显示接受者信息

#### 2.4 交易市场页面
- **功能**：浏览其他用户的挂单
- **布局**：
  - 挂单卡片列表
  - 每个卡片显示发布者、物品信息、剩余时间
- **交互**：
  - 点击挂单进入详情页
  - 按时间倒序排列

#### 2.5 交易历史页面
- **功能**：查看已完成的交易并评价
- **布局**：
  - 交易记录卡片列表
  - 每个卡片显示交易双方、交换物品、完成时间
- **交互**：
  - 点击"去评价"弹出评价弹窗
  - 显示已有的评价和评分

#### 2.6 物品选择器组件
- **功能**：选择交易物品和数量
- **布局**：底部弹窗
  - 搜索栏
  - 物品分类
  - 物品网格
- **交互**：
  - 支持搜索和筛选
  - 点击物品后弹出数量选择器
  - 两种模式：选择库存物品和选择任意物品

#### 2.7 挂单详情页面
- **功能**：查看挂单详细信息并接受交易
- **布局**：
  - 发布者信息和时间
  - 提供的物品列表
  - 想要的物品列表
  - 留言内容
  - 库存检查
  - 接受交易按钮
- **交互**：
  - 自动检查用户库存
  - 物品足够时可接受交易
  - 点击接受后弹出确认框

#### 2.8 确认交易弹窗
- **功能**：确认交易详情
- **布局**：
  - 交易摘要
  - 付出物品列表
  - 获得物品列表
  - 取消和确认按钮
- **交互**：
  - 防止误操作
  - 确认后执行交易

#### 2.9 评价交易弹窗
- **功能**：对交易进行评分和评价
- **布局**：
  - 交易对象信息
  - 星级评分（1-5星）
  - 评语输入框
  - 取消和提交按钮
- **交互**：
  - 选择星级评分
  - 输入评语
  - 提交评价

### 3. 状态管理
- **页面数据状态**：
  - 我的挂单列表：`@Published` 属性
  - 可用挂单列表：`@Published` 属性
  - 交易历史列表：`@Published` 属性
- **加载状态**：
  - 是否正在加载：`@State` 布尔值
  - 是否正在提交：`@State` 布尔值
- **表单状态**：
  - 已选物品列表：`@State` 数组
  - 有效期选择：`@State` 整数
  - 留言内容：`@State` 字符串
- **弹窗状态**：
  - 是否显示物品选择器：`@State` 布尔值
  - 是否显示确认框：`@State` 布尔值
  - 是否显示评价弹窗：`@State` 布尔值

### 4. 错误处理与提示
- **操作结果提示**：
  - 成功提示：使用 `Alert` 或自定义 Toast
  - 失败提示：显示具体错误信息
- **边界情况处理**：
  - 列表为空：显示空状态插图和文字
  - 网络错误：显示错误提示，提供重试按钮
  - 物品不足：禁用按钮，显示缺少的物品和数量
  - 挂单已失效：显示提示信息，返回列表
  - 正在加载：显示加载指示器，禁用重复操作

### 5. 与数据层对接
- **调用 TradeManager 方法**：
  - 发布挂单：`createTradeOffer()`
  - 接受交易：`acceptTradeOffer()`
  - 取消挂单：`cancelTradeOffer()`
  - 加载我的挂单：`fetchMyOffers()`
  - 加载市场挂单：`fetchMarketOffers()`
  - 加载交易历史：`fetchTradeHistory()`
  - 提交评价：`addRating()`
- **交易成功后的联动**：
  - 显示成功提示
  - 刷新用户库存
  - 刷新市场列表
  - 刷新交易历史

### 6. 代码结构
- **主要文件**：
  - `TradeMainView.swift` - 交易主页面
  - `TradeCreateView.swift` - 发布挂单页面
  - `TradeMyOffersView.swift` - 我的挂单页面
  - `TradeMarketView.swift` - 交易市场页面
  - `TradeHistoryView.swift` - 交易历史页面
  - `TradeOfferDetailView.swift` - 挂单详情页面
  - `TradeItemSelector.swift` - 物品选择器组件
- **组件文件**：
  - `TradeOfferCard.swift` - 挂单卡片组件
  - `TradeHistoryCard.swift` - 交易历史卡片组件
  - `TradeStatusBadge.swift` - 状态标签组件

### 7. 实现步骤
1. **修改通讯标签页**：添加交易模块
2. **创建交易主页面**：实现分段控制器
3. **实现核心页面**：发布挂单、我的挂单、交易市场、交易历史
4. **实现组件**：物品选择器、确认交易弹窗、评价交易弹窗
5. **集成数据层**：与 TradeManager 交互
6. **测试和优化**：确保功能正常和用户体验良好

### 8. 设计风格保持一致
- **配色**：使用 `ApocalypseTheme` 中的颜色
- **字体**：采用与其他页面一致的字体样式
- **布局**：遵循现有的卡片式布局和间距规范
- **图标**：使用系统图标或与主题匹配的自定义图标
- **交互**：保持与其他模块一致的交互模式

### 9. 预期成果
- 完整的交易系统用户界面
- 流畅的用户体验
- 符合末日主题的设计风格
- 与现有系统的无缝集成
- 支持所有交易相关功能
- 响应式设计适配不同设备