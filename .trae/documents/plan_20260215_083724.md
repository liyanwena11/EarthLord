## 《地球新主》交易系统实现计划

### 1. 数据库结构设计
- **创建交易挂单表** (`trade_offers`)
  - 字段：id(UUID)、owner_id(UUID)、owner_username(text)、offering_items(JSONB)、requesting_items(JSONB)、status(text)、message(text)、created_at(timestamp)、expires_at(timestamp)、completed_at(timestamp)、completed_by_user_id(UUID)、completed_by_username(text)
- **创建交易历史表** (`trade_history`)
  - 字段：id(UUID)、offer_id(UUID)、seller_id(UUID)、seller_username(text)、buyer_id(UUID)、buyer_username(text)、items_exchanged(JSONB)、completed_at(timestamp)、seller_rating(integer)、buyer_rating(integer)、seller_comment(text)、buyer_comment(text)
- **添加数据库迁移文件** (`supabase_migration_003_trade_system.sql`)
  - 包含表结构创建
  - 配置 RLS 策略
  - 添加索引优化
  - 记录迁移历史

### 2. 数据库函数实现
- **创建挂单函数** (`create_trade_offer`)
  - 验证用户权限
  - 创建挂单记录
  - 返回挂单ID
- **接受挂单函数** (`accept_trade_offer`)
  - 使用行级锁防止并发
  - 验证挂单状态和过期时间
  - 执行物品交换
  - 更新挂单状态
  - 创建交易历史记录
- **取消挂单函数** (`cancel_trade_offer`)
  - 验证用户权限
  - 验证挂单状态
  - 更新挂单状态
- **处理过期挂单函数** (`process_expired_trade_offers`)
  - 查询过期的活跃挂单
  - 更新状态为过期
  - 退还物品到发布者库存

### 3. 交易管理器完善
- **完善 `TradeManager.swift`**
  - **创建挂单**：验证物品、锁定物品、调用创建函数
  - **接受挂单**：验证挂单状态、验证库存、调用接受函数、处理物品交换
  - **取消挂单**：验证权限、调用取消函数、处理物品退回
  - **查询挂单**：获取我的挂单、获取可接受挂单
  - **查询历史**：获取交易历史
  - **处理过期**：定期调用处理过期函数
  - **评价交易**：添加交易评分和评价

### 4. 并发安全处理
- **实现行级锁**
  - 在接受交易函数中使用 `SELECT ... FOR UPDATE`
  - 防止并发接受导致的物品复制问题
- **使用事务**
  - 将交易操作封装在数据库事务中
  - 确保物品交换的原子性
  - 要么全部成功，要么全部回滚

### 5. 过期处理机制
- **实现定时任务**
  - 在 `TradeManager` 中添加定时检查
  - 每60秒检查一次过期挂单
  - 自动处理过期挂单并退回物品
- **查询时过滤**
  - 在查询可接受挂单时过滤过期挂单
  - 确保用户只能看到有效的挂单

### 6. 权限与安全设计
- **实现 RLS 策略**
  - `trade_offers` 表：所有人可查看 active 状态，发布者可查看所有状态
  - `trade_history` 表：只能看到自己参与的交易
- **防作弊检查**
  - 物品数量验证：发布前和接受前验证库存
  - 重复提交防护：使用行级锁
  - 自交易防护：不能接受自己的挂单
  - 状态验证：接受前检查状态和过期时间

### 7. 与现有系统集成
- **用户系统集成**
  - 使用 `AuthManager.shared.currentUser` 获取当前用户
  - 确保用户已登录才能进行交易操作
- **背包系统集成**
  - 使用 `InventoryManager.shared` 管理物品
  - 利用现有 `removeItem` 和 `addItem` 方法
  - 确保交易操作的原子性

### 8. 测试和验证
- **编写测试代码**
  - 测试挂单创建和物品锁定
  - 测试挂单接受和物品交换
  - 测试挂单取消和物品退回
  - 测试挂单过期处理
  - 测试交易历史记录
  - 测试评价功能
  - 测试并发安全
- **验证数据一致性**
  - 确保交易前后物品数量正确
  - 确保挂单状态正确更新
  - 确保交易历史正确记录

### 9. 性能优化
- **数据库优化**
  - 添加适当的索引
  - 优化查询语句
  - 合理使用 JSONB 字段
- **代码优化**
  - 减少数据库查询次数
  - 优化物品处理逻辑
  - 实现批量操作
- **并发优化**
  - 合理使用锁机制
  - 减少事务持有时间

### 技术要点
- 使用 Supabase 进行数据库操作
- 实现 RLS 策略确保数据安全
- 使用 Swift 的 async/await 进行异步操作
- 实现事务确保交易操作的原子性
- 定期检查和处理过期挂单
- 与现有背包系统无缝集成
- 确保并发安全防止物品复制