# ğŸ“‹ EarthLord App å®Œæ•´é—®é¢˜è¯Šæ–­ä¸ä¿®å¤æŠ¥å‘Š

**ç”Ÿæˆæ—¶é—´**: 2026-02-21
**ç‰ˆæœ¬**: v1.0

---

## ğŸ”´ é—®é¢˜ 1: é¢‘é“åˆ›å»ºæˆåŠŸä½†æ— æ³•åŠ è½½ï¼ˆæœ€ä¸¥é‡ï¼‰

### ç—‡çŠ¶
- âœ… åˆ›å»ºæˆåŠŸæ—¥å¿—ï¼š`ğŸ“¡ [é¢‘é“] âœ… åˆ›å»ºé¢‘é“æˆåŠŸ: Wod`
- âŒ åŠ è½½å¤±è´¥æ—¥å¿—ï¼š`âŒ [é¢‘é“] åŠ è½½å…¬å¼€é¢‘é“å¤±è´¥: æœªèƒ½è¯»å–æ•°æ®ï¼Œå› ä¸ºæ•°æ®ç¼ºå¤±ã€‚`

### æ ¹æœ¬åŸå› 

**æ•°æ®åº“ï¿½ï¿½æ®µç¼ºå¤±å¯¼è‡´è§£ç å¤±è´¥**ï¼š

1. **communication_channels è¡¨ç¼ºå°‘ `updated_at` å­—æ®µ**
   - Swift æ¨¡å‹æœŸæœ›ï¼š`updated_at`
   - æ•°æ®åº“å®é™…ï¼š**æ²¡æœ‰æ­¤å­—æ®µ**
   - ä½ç½®ï¼š`CommunicationModels.swift:234`

2. **channel_subscriptions è¡¨ç¼ºå°‘ `is_muted` å­—æ®µ**
   - Swift æ¨¡å‹æœŸæœ›ï¼š`is_muted`
   - æ•°æ®åº“å®é™…ï¼š**æ²¡æœ‰æ­¤å­—æ®µ**
   - ä½ç½®ï¼š`CommunicationModels.swift:284`

3. **channel_messages è¡¨ç¼ºå°‘å¤šä¸ªå­—æ®µ**
   - Swift æ¨¡å‹æœŸæœ›ï¼š`sender_callsign`, `metadata`, `sender_device_type`
   - æ•°æ®åº“å®é™…ï¼š**ç¼ºå°‘è¿™äº›å­—æ®µ**
   - ä½ç½®ï¼š`CommunicationModels.swift:342`

### ä¸ºä»€ä¹ˆåˆ›å»ºæˆåŠŸä½†åŠ è½½å¤±è´¥ï¼Ÿ

```
åˆ›å»ºæµç¨‹ï¼š
1. Swift è°ƒç”¨ RPC å‡½æ•° create_channel_with_subscription()
2. SQL ä½¿ç”¨ INSERT æ’å…¥æ•°æ®ï¼ˆä¸éœ€è¦ updated_atï¼‰
3. è¿”å›æˆåŠŸ â†’ âœ… "åˆ›å»ºé¢‘é“æˆåŠŸ"

åŠ è½½æµç¨‹ï¿½ï¿½
1. Swift è°ƒç”¨ SELECT æŸ¥è¯¢æ‰€æœ‰å­—æ®µ
2. Supabase å°è¯•å°†æ•°æ®è§£ç ä¸º CommunicationChannel ç»“æ„ä½“
3. è§£ç å™¨æ‰¾ä¸åˆ° updated_at å­—æ®µ â†’ âŒ è§£ç å¤±è´¥
4. Swift æ•è·é”™è¯¯ï¼šæœªèƒ½è¯»å–æ•°æ®ï¼Œå› ä¸ºæ•°æ®ç¼ºå¤±
```

### ä¿®å¤æ–¹æ¡ˆ

**å·²åœ¨ `fix_all_channel_issues.sql` ä¸­ä¿®å¤**ï¼š

```sql
-- 1. æ·»åŠ ç¼ºå¤±çš„ updated_at å­—æ®µ
ALTER TABLE public.communication_channels ADD COLUMN updated_at TIMESTAMPTZ DEFAULT NOW();

-- 2. æ·»åŠ ç¼ºå¤±çš„ is_muted å­—æ®µ
ALTER TABLE public.channel_subscriptions ADD COLUMN is_muted BOOLEAN DEFAULT false;

-- 3. æ·»åŠ ç¼ºå¤±çš„ sender_callsign å’Œ metadata å­—æ®µ
ALTER TABLE public.channel_messages ADD COLUMN sender_callsign TEXT;
ALTER TABLE public.channel_messages ADD COLUMN metadata JSONB;
```

### éªŒè¯æ­¥éª¤

1. åœ¨ Supabase SQL Editor ä¸­è¿è¡Œ `fix_all_channel_issues.sql`
2. é‡å¯ App
3. åˆ›å»ºæµ‹è¯•é¢‘é“
4. æ£€æŸ¥æ§åˆ¶å°è¾“å‡ºï¼š

```
é¢„æœŸæ—¥å¿—ï¼š
âœ… [åˆ›å»ºé¢‘é“] é¢‘é“åˆ›å»ºæˆåŠŸ: æµ‹è¯•é¢‘é“
âœ… [é¢‘é“] åŠ è½½å…¬å¼€é¢‘é“: 3 ä¸ª
âœ… [é¢‘é“] åŠ è½½å·²è®¢é˜…é¢‘é“: 1 ä¸ª
```

---

## ğŸŸ¡ é—®é¢˜ 2: äº¤æ˜“ç³»ç»Ÿåˆ—åä¸åŒ¹é…

### ç—‡çŠ¶
```
âŒ Could not find the table 'public.trade_offers'
âŒ column trade_offers.status does not exist
âŒ column trade_offers.owner_id does not exist
```

### æ ¹æœ¬åŸå› 

**Swift ä»£ç ä¸æ•°æ®åº“è¡¨ç»“æ„ä¸åŒ¹é…**ï¼š

| Swift æœŸæœ›å­—æ®µ | æ•°æ®åº“å®é™…å­—æ®µ | çŠ¶æ€ |
|---|---|---|
| `owner_id` | `user_id` | âŒ ä¸åŒ¹é… |
| `status` | `is_active` | âŒ ä¸åŒ¹é… |
| `completed_at` | `created_at` | âŒ ä¸åŒ¹é… |

### ä¿®å¤æ–¹æ¡ˆ

**å·²åœ¨ `fix_all_channel_issues.sql` ä¸­é‡æ–°åˆ›å»ºè¡¨**ï¼š

```sql
-- åˆ é™¤æ—§è¡¨å¹¶é‡æ–°åˆ›å»º
DROP TABLE IF EXISTS public.trade_offers CASCADE;
DROP TABLE IF EXISTS public.trade_history CASCADE;

-- åˆ›å»ºæ­£ç¡®çš„è¡¨ç»“æ„
CREATE TABLE public.trade_offers (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    owner_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    title TEXT NOT NULL,
    description TEXT,
    offer_items JSONB NOT NULL DEFAULT '[]'::jsonb,
    request_items JSONB NOT NULL DEFAULT '[]'::jsonb,
    status TEXT NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'completed', 'cancelled')),
    territory_id TEXT,
    latitude DOUBLE PRECISION,
    longitude DOUBLE PRECISION,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE public.trade_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    trader1_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    trader2_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    items1 JSONB NOT NULL DEFAULT '[]'::jsonb,
    items2 JSONB NOT NULL DEFAULT '[]'::jsonb,
    territory_id TEXT,
    completed_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## ğŸŸ¡ é—®é¢˜ 3: èƒŒåŒ…ç‰©å“åŒæ­¥å¤±è´¥

### ç—‡çŠ¶
```
âŒ Supabase å­˜å‚¨å¤±è´¥ï¼šPostgrestError(detail: nil, hint: nil, code: Optional("23502"),
message: "null value in column \"name\" of relation \"inventory_items\" violates not-null constraint")
```

### æ ¹æœ¬åŸå› 

**Swift ä»£ç æ²¡æœ‰å‘é€ `name` å­—æ®µ**ï¼š

ä½ç½®ï¼š`ExplorationManager.swift:226-242`

```swift
struct InventoryUpsert: Encodable {
    let user_id: String
    let item_id: String
    // âŒ ç¼ºå°‘ name å­—æ®µ
    let quantity: Int
}

let upsertData = InventoryUpsert(
    user_id: userId,
    item_id: item.itemId,
    // âŒ ç¼ºå°‘ name: item.name
    quantity: currentQuantity
)
```

### ä¿®å¤æ–¹æ¡ˆ

**å·²ä¿®å¤**ï¼šåœ¨ `ExplorationManager.swift:240` æ·»åŠ  `name` å­—æ®µ

```swift
struct InventoryUpsert: Encodable {
    let user_id: String
    let item_id: String
    let name: String  // âœ… æ·»åŠ 
    let quantity: Int
}

let upsertData = InventoryUpsert(
    user_id: userId,
    item_id: item.itemId,
    name: item.name,  // âœ… æ·»åŠ 
    quantity: currentQuantity
)
```

### éªŒè¯æ­¥éª¤

1. é‡æ–°å¯åŠ¨ App
2. æ¢ç´¢ POI è·å–ç‰©å“
3. æ£€æŸ¥æ§åˆ¶å°ï¼š

```
é¢„æœŸæ—¥å¿—ï¼š
â˜ï¸ ç‰©å“å·²å­˜å…¥äº‘ç«¯ï¼šçŸ¿æ³‰æ°´ x6
```

---

## ğŸ”µ é—®é¢˜ 4: Google ç™»å½•æ— æ³•ä½¿ç”¨

### ç—‡çŠ¶
ç”¨æˆ·æŠ¥å‘Š Google è´¦å·æ— æ³•ç™»å½•ã€‚

### å¯èƒ½åŸå› 

1. **Info.plist é…ç½®é—®é¢˜**
   - ç¼ºå°‘ `CFBundleURLTypes`
   - ç¼ºå°‘ `GIDClientID` æˆ–é…ç½®é”™è¯¯

2. **Supabase Auth é…ç½®é—®é¢˜**
   - Google Provider æœªå¯ç”¨
   - Callback URL é…ç½®é”™è¯¯

### ä¿®å¤æ­¥éª¤

#### æ­¥éª¤ 1: æ£€æŸ¥ Info.plist

```xml
<key>CFBundleURLTypes</key>
<array>
    <dict>
        <key>CFBundleURLSchemes</key>
        <array>
            <string>com.googleusercontent.apps.YOUR_CLIENT_ID</string>
        </array>
    </dict>
</array>

<key>GIDClientID</key>
<string>YOUR_CLIENT_ID</string>
```

#### æ­¥éª¤ 2: æ£€æŸ¥ Supabase è®¾ç½®

1. è®¿é—® https://supabase.com/dashboard
2. è¿›å…¥é¡¹ç›® â†’ Authentication â†’ Providers
3. ç¡®ä¿ **Google Provider** å·²å¯ç”¨
4. æ£€æŸ¥ **Callback URL**ï¼š
   ```
   com.earthlord.app://auth/callback/*
   ```

#### æ­¥éª¤ 3: æ£€æŸ¥ Google Cloud Console

1. è®¿é—® https://console.cloud.google.com
2. é€‰æ‹©é¡¹ç›® â†’ API & Services â†’ Credentials
3. æ£€æŸ¥ OAuth 2.0 å®¢æˆ·ç«¯ ID
4. ç¡®ä¿ **æˆæƒé‡å®šå‘ URI** åŒ…å«ï¼š
   ```
   com.earthlord.app://auth/callback/*
   ```

### éªŒè¯æ­¥éª¤

1. æ¸…ç† App æ•°æ®
2. é‡æ–°å¯åŠ¨ App
3. ç‚¹å‡»"Google ç™»å½•"
4. æ£€æŸ¥æ§åˆ¶å°è¾“å‡ºï¼š

```
é¢„æœŸæ—¥å¿—ï¼ˆæˆåŠŸï¼‰ï¼š
âœ… [Auth] Google ç™»å½•æˆåŠŸ: user@example.com
```

```
é”™è¯¯æ—¥å¿—ï¼ˆå¤±è´¥ï¼‰ï¼š
âŒ [Auth] Google ç™»å½•å¤±è´¥: Error Domain=com.google.SignIn Code=-5 "keychain error"
```

---

## ğŸŸ¢ é—®é¢˜ 5: å•†åŸäº§å“ä¸æ˜¾ç¤º

### ç—‡çŠ¶
ç‰©èµ„å•†åŸé¡µé¢ä¸æ˜¾ç¤ºå…·ä½“å†…å®¹ã€‚

### æ ¹æœ¬åŸå› 

**App Store Connect æœªé…ç½®å†…è´­äº§å“**

### ä¿®å¤æ­¥éª¤

1. ç™»å½• [App Store Connect](https://appstoreconnect.apple.com)
2. è¿›å…¥ App â†’ In-App Purchases
3. åˆ›å»ºä»¥ä¸‹æ¶ˆè€—å‹äº§å“ï¼š

| Product ID | åç§° | ä»·æ ¼ | è¯´æ˜ |
|---|---|---|---|
| `com.earthlord.supply.survivor` | å¹¸å­˜è€…è¡¥ç»™åŒ… | Â¥6 | å°å‹ç‰©èµ„åŒ… |
| `com.earthlord.supply.explorer` | æ¢é™©å®¶è¡¥ç»™åŒ… | Â¥18 | ä¸­å‹ç‰©èµ„åŒ… |
| `com.earthlord.supply.lord` | é¢†ä¸»è¡¥ç»™åŒ… | Â¥30 | å¤§å‹ç‰©èµ„åŒ… |
| `com.earthlord.supply.overlord` | éœ¸ä¸»è¡¥ç»™åŒ… | Â¥68 | è¶…çº§ç‰©èµ„åŒ… |

4. æäº¤å®¡æ ¸
5. åœ¨ **Sandbox æ¨¡å¼**ä¸‹æµ‹è¯•

### éªŒè¯æ­¥éª¤

1. åœ¨ iPhone è®¾ç½®ä¸­ç™»å½• Sandbox æµ‹è¯•è´¦å·
2. å¯åŠ¨ App
3. è¿›å…¥ç‰©èµ„å•†åŸ
4. æ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºäº§å“åˆ—è¡¨

```
é¢„æœŸç»“æœï¼š
æ˜¾ç¤º 4 ä¸ªè¡¥ç»™åŒ…äº§å“ï¼Œå¸¦æœ‰ä»·æ ¼å’Œè´­ä¹°æŒ‰é’®
```

---

## ğŸ“Š å®Œæ•´ä¿®å¤æ¸…å•

### âœ… å·²ä¿®å¤çš„é—®é¢˜

- âœ… é¢‘é“è¡¨å­—æ®µç¼ºå¤±ï¼ˆ`updated_at`ï¼‰
- âœ… è®¢é˜…è¡¨å­—æ®µç¼ºå¤±ï¼ˆ`is_muted`ï¼‰
- âœ… æ¶ˆæ¯è¡¨å­—æ®µç¼ºå¤±ï¼ˆ`sender_callsign`, `metadata`ï¼‰
- âœ… èƒŒåŒ…åŒæ­¥ç¼ºå°‘ `name` å­—æ®µ
- âœ… äº¤æ˜“ç³»ç»Ÿè¡¨ç»“æ„é”™è¯¯

### ğŸ”§ éœ€è¦æ‰‹åŠ¨æ‰§è¡Œçš„ä¿®å¤

1. **åœ¨ Supabase ä¸­è¿è¡Œ `fix_all_channel_issues.sql`**
   - ä¿®å¤æ‰€æœ‰æ•°æ®åº“è¡¨å’Œå­—æ®µ
   - é‡æ–°åˆ›å»º RPC å‡½æ•°
   - åˆå§‹åŒ–å®˜æ–¹é¢‘é“

2. **æ£€æŸ¥ Google ç™»å½•é…ç½®**
   - éªŒè¯ Info.plist
   - éªŒè¯ Supabase Auth è®¾ç½®
   - éªŒè¯ Google Cloud Console

3. **åœ¨ App Store Connect ä¸­é…ç½®å†…è´­äº§å“**
   - åˆ›å»º 4 ä¸ªæ¶ˆè€—å‹äº§å“
   - è®¾ç½®ä»·æ ¼
   - æµ‹è¯•è´­ä¹°æµç¨‹

---

## ğŸš€ æ‰§è¡Œä¿®å¤çš„æ­¥éª¤

### æ­¥éª¤ 1: è¿è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬

```bash
1. è®¿é—® https://supabase.com/dashboard
2. é€‰æ‹©é¡¹ç›®ï¼šEarthLord (lkekxzssfrspkyxtqysx)
3. ç‚¹å‡» "SQL Editor"
4. æ–°å»ºæŸ¥è¯¢
5. å¤åˆ¶ fix_all_channel_issues.sql çš„å…¨éƒ¨å†…å®¹
6. ç‚¹å‡» "Run" æ‰§è¡Œ
7. æ£€æŸ¥è¾“å‡ºï¼Œç¡®ä¿æ‰€æœ‰è¡¨å’Œå‡½æ•°åˆ›å»ºæˆåŠŸ
```

### æ­¥éª¤ 2: é‡å¯ App å¹¶æµ‹è¯•

```
1. å®Œå…¨å…³é—­ Appï¼ˆä»åå°æ¸…é™¤ï¼‰
2. é‡æ–°å¯åŠ¨ App
3. æµ‹è¯•é¢‘é“åŠŸèƒ½ï¼š
   - åˆ›å»ºå…¬å¼€é¢‘é“
   - æŸ¥çœ‹é¢‘é“åˆ—è¡¨
   - è®¢é˜…é¢‘é“
4. æµ‹è¯•èƒŒåŒ…åŠŸèƒ½ï¼š
   - æ¢ç´¢ POI
   - æ£€æŸ¥ç‰©å“æ˜¯å¦åŒæ­¥åˆ°äº‘ç«¯
```

### æ­¥éª¤ 3: æ£€æŸ¥ Google ç™»å½•

```
1. æ£€æŸ¥ Info.plist é…ç½®
2. æ£€æŸ¥ Supabase Auth è®¾ç½®
3. æµ‹è¯•ç™»å½•æµç¨‹
```

### æ­¥éª¤ 4: é…ç½®å•†åŸäº§å“

```
1. ç™»å½• App Store Connect
2. åˆ›å»º 4 ä¸ªå†…è´­äº§å“
3. åœ¨ Sandbox ç¯å¢ƒæµ‹è¯•
```

---

## ğŸ“ é—®é¢˜ä»ç„¶å­˜åœ¨ï¼Ÿ

### é¢‘é“åŠ è½½å¤±è´¥çš„è°ƒè¯•æ­¥éª¤

1. **æ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦æœ‰æ•°æ®**ï¼š

```sql
-- åœ¨ Supabase SQL Editor ä¸­è¿è¡Œ
SELECT id, name, channel_type, is_active, created_at, updated_at
FROM public.communication_channels
WHERE is_active = true;
```

2. **æ£€æŸ¥ RLS ç­–ç•¥**ï¼š

```sql
-- æŸ¥çœ‹è¡¨çš„ RLS ç­–ç•¥
SELECT schemaname, tablename, policyname, permissive, roles, cmd, qual
FROM pg_policies
WHERE tablename IN ('communication_channels', 'channel_subscriptions', 'channel_messages');
```

3. **æ‰‹åŠ¨æµ‹è¯•æŸ¥è¯¢**ï¼š

```sql
-- æ‰‹åŠ¨æµ‹è¯•æŸ¥è¯¢æ˜¯å¦è¿”å›æ•°æ®
SELECT * FROM public.communication_channels WHERE is_active = true LIMIT 5;
```

### èƒŒåŒ…åŒæ­¥å¤±è´¥çš„è°ƒè¯•æ­¥éª¤

1. **æ£€æŸ¥ inventory_items è¡¨ç»“æ„**ï¼š

```sql
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_schema = 'public' AND table_name = 'inventory_items';
```

2. **æŸ¥çœ‹é”™è¯¯æ—¥å¿—**ï¼š

```
åœ¨ Xcode æ§åˆ¶å°ä¸­æœç´¢ï¼š
- "Supabase å­˜å‚¨å¤±è´¥"
- "âŒ [æœ¬åœ°] ä¿å­˜èƒŒåŒ…å¤±è´¥"
```

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|---|---|
| `fix_all_channel_issues.sql` | å®Œæ•´æ•°æ®åº“ä¿®å¤è„šæœ¬ |
| `CommunicationModels.swift` | é¢‘é“æ•°æ®æ¨¡å‹å®šä¹‰ |
| `CommunicationManager.swift` | é¢‘é“ç®¡ç†å™¨ |
| `ExplorationManager.swift` | æ¢ç´¢å’ŒèƒŒåŒ…ç®¡ç†å™¨ |
| `æ•°æ®åº“è¿ç§»æŒ‡å—.md` | æ•°æ®åº“è¿ç§»è¯¦ç»†æŒ‡å— |

---

**æ›´æ–°æ—¶é—´**: 2026-02-21
**çŠ¶æ€**: âš ï¸ ç­‰å¾…ç”¨æˆ·æ‰§è¡Œä¿®å¤è„šæœ¬
