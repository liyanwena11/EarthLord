# 沙盒测试指南
## EarthLord IAP 系统测试

本文档提供了完整的沙盒测试流程，包括测试账号创建、测试步骤和常见问题解决方案。

---

## 📋 目录

1. [沙盒测试简介](#沙盒测试简介)
2. [创建测试账号](#创建测试账号)
3. [配置测试环境](#配置测试环境)
4. [测试流程](#测试流程)
5. [验证清单](#验证清单)
6. [常见问题](#常见问题)

---

## 🎮 沙盒测试简介

### 什么是沙盒测试？

沙盒测试是 Apple 提供的模拟 App Store 购买环境的测试方式，允许开发者在不产生实际费用的情况下测试 IAP（应用内购买）功能。

### 沙盒测试的特点

- ✅ **不产生实际费用** - 所有购买都是虚拟的
- ✅ **模拟真实购买流程** - 完整的购买体验
- ✅ **测试订阅续期** - 可以加快订阅续期测试
- ✅ **测试恢复购买** - 验证跨设备恢复功能
- ⚠️ **仅在测试环境有效** - 无法在生产环境使用

---

## 👤 创建测试账号

### 步骤 1：登录 App Store Connect

1. 访问 [App Store Connect](https://appstoreconnect.apple.com)
2. 使用开发者账号登录

### 步骤 2：进入沙盒测试员页面

1. 点击右上角头像
2. 选择"用户和角色"
3. 点击"沙盒测试员"
4. 点击"+"按钮创建新测试员

### 步骤 3：填写测试账号信息

**必填字段：**

| 字段 | 说明 | 示例 |
|------|------|------|
| 名字 | 测试员姓名 | Test User |
| 姓氏 | 测试员姓氏 | EarthLord |
| Apple ID | 测试账号邮箱 | `test.earthlord+01@example.com` |
| 密码 | 测试账号密码 | `Test1234` |
| 确认密码 | 再次输入密码 | `Test1234` |
| 安全性问题 | 密码找回问题 | 任选 |
| 答案 | 安全问题答案 | 任选 |
| 出生日期 | 测试账号生日 | 任选 |

**重要提示：**
- ⚠️ 测试账号邮箱必须是真实邮箱格式，但不需要真实邮箱
- ⚠️ 测试账号不能与已有的 Apple ID 相同
- ⚠️ 密码必须包含数字和字母，至少8位
- ✅ 建议使用 `+` 后缀创建多个测试账号

### 推荐的测试账号配置

为了全面测试，建议创建以下测试账号：

| 账号邮箱 | 用途 | 测试场景 |
|----------|------|----------|
| `test.earthlord+explorer@example.com` | 探索者通行证测试 | 月付订阅 |
| `test.earthlord+lord@example.com` | 领主通行证测试 | 年付订阅 |
| `test.earthlord+apocalypse@example.com` | 末日通行证测试 | 试用转付费 |
| `test.earthlord+supply@example.com` | 补给包测试 | 消耗品购买 |
| `test.earthlord+restore@example.com` | 恢复购买测试 | 跨设备恢复 |

**示例密码：** `EarthTest2026`

### 步骤 4：记录测试账号信息

创建完成后，**立即保存**测试账号信息到安全位置：

```markdown
### 沙盒测试账号清单

**账号 1：探索者测试**
- 邮箱: test.earthlord+explorer@example.com
- 密码: EarthTest2026
- 用途: 测试探索者通行证月付订阅

**账号 2：领主测试**
- 邮箱: test.earthlord+lord@example.com
- 密码: EarthTest2026
- 用途: 测试领主通行证年付订阅

...
```

⚠️ **注意：创建后无法查看密码，请务必保存！**

---

## 🔧 配置测试环境

### 在 iOS 设备上配置

#### 1. 进入设置

1. 打开 iPhone/iPad 的"设置"
2. 点击你的 Apple ID（顶部）
3. 选择"媒体与购买项目"

#### 2. 退出当前账号

1. 点击"退出登录"
2. 确认退出

#### 3. 登录沙盒测试账号

1. 点击"登录"
2. 输入沙盒测试账号和密码
3. 完成登录

⚠️ **重要：**
- 不要在真实 App Store 登录测试账号
- 只在测试环境使用（设置 → iTunes Store 与 App Store）
- 测试账号登录后可能会有"验证失败"提示，这是正常的

### 在 Xcode 中配置

#### 1. 选择正确的 Team

```bash
# 在 Xcode 项目设置中
TARGETS → EarthLord → Signing & Capabilities
# 确保 Team 已选择
```

#### 2. 配置 Bundle Identifier

```bash
# 确保 Bundle Identifier 与 App Store Connect 一致
# 例如: com.yourcompany.earthlord
```

#### 3. 启用 In-App Purchase Capability

```bash
# 在 Signing & Capabilities 中
# 添加: + Capability → In-App Purchase
```

---

## 🧪 测试流程

### 第一阶段：订阅购买测试

#### 测试 1.1：探索者通行证 - 月付

**测试步骤：**

1. **启动 App**
   ```bash
   # 在 Xcode 中运行到真机
   Product → Run (⌘R)
   ```

2. **进入订阅页面**
   - 点击"订阅"或"通行证"
   - 查看"探索者通行证"卡片

3. **点击购买**
   - 选择"月付"选项
   - 点击"立即订阅"按钮

4. **验证购买流程**
   - ✅ 弹出 Apple Pay Sheet（系统支付界面）
   - ✅ 显示价格：¥12/月
   - ✅ 显示"订阅 - 探索者通行证"
   - ✅ 输入沙盒账号密码（可能需要 Face ID）

5. **验证购买结果**
   - ✅ 显示"购买成功"提示
   - ✅ 用户等级变为"支持者"（探索者）
   - ✅ 权益已激活（建造加速、背包容量等）

**预期结果：**
- 购买成功，无错误提示
- 用户 Tier 更新为支持者
- 权益生效

#### 测试 1.2：领主通行证 - 年付

**测试步骤：**

1. 返回订阅页面
2. 选择"领主通行证"
3. 选择"年付"选项
4. 点击"立即订阅"
5. 完成支付

**验证点：**
- 价格显示：¥168/年
- 折扣信息：省44%
- 用户等级更新为"领主"

#### 测试 1.3：末日通行证 - 7天试用

**测试步骤：**

1. 选择"末日通行证"
2. 点击"开始7天免费试用"
3. 完成试用注册

**验证点：**
- 显示"7天免费试用"
- 试用结束后自动续费提示
- 可以在试用期内取消

#### 测试 1.4：恢复购买

**测试步骤：**

1. 卸载 App 并重新安装
2. 启动 App
3. 进入订阅页面
4. 点击"恢复购买"按钮

**验证点：**
- ✅ 显示"恢复成功"提示
- ✅ 之前的订阅状态恢复
- ✅ 权益继续生效

---

### 第二阶段：消耗品购买测试

#### 测试 2.1：幸存者补给包

**测试步骤：**

1. **进入物资商城**
   - 点击"商城"或"物资"
   - 选择"补给包"标签

2. **查看补给包**
   - 找到"幸存者补给包"
   - 价格：¥6

3. **点击购买**
   - 点击"购买"按钮
   - 确认购买弹窗

4. **验证购买流程**
   - ✅ 弹出确认对话框
   - ✅ 显示价格和商品信息
   - ✅ 点击"确认购买"

5. **验证购买结果**
   - ✅ 支付成功
   - ✅ 显示"物品已发送到待领取"
   - ✅ 跳转到"待领取"标签

6. **领取物品**
   - 在"待领取"中找到补给包
   - 点击"领取"
   - ✅ 物品进入背包

**预期结果：**
- 购买成功
- 物品发送到邮箱
- 领取后背包中物品增加

#### 测试 2.2：霸主补给包（最高级）

**测试步骤：**

1. 选择"霸主补给包"
2. 验证价格：¥68
3. 完成购买
4. 验证稀有物品（史诗/传说）有掉落

#### 测试 2.3：多次购买

**测试步骤：**

1. 连续购买3个"探险家补给包"
2. 验证每次都成功
3. 验证待领取中有3个物品
4. 逐个领取

---

### 第三阶段：订阅续期测试

#### 测试 3.1：订阅过期（加快测试）

**沙盒环境时间加速：**

沙盒环境中的订阅会加速过期：

| 订阅类型 | �真实时间 | 沙盒时间 |
|----------|----------|----------|
| 月付订阅 | 1个月 | ~3分钟 |
| 年付订阅 | 1年 | ~5分钟 |
| 试用 | 7天 | ~3分钟 |

**测试步骤：**

1. 购买月付订阅
2. 等待约3分钟
3. 重启 App
4. 验证订阅是否续费

#### 测试 3.2：取消订阅

**测试步骤：**

1. 购买订阅
2. 进入设置 → Apple ID → 订阅
3. 取消该订阅
4. 返回 App
5. 验证订阅状态

---

### 第四阶段：错误场景测试

#### 测试 4.1：取消购买流程

**测试步骤：**

1. 点击购买
2. 在 Apple Pay Sheet 中点击"取消"
3. 验证回到 App，无错误

#### 测试 4.2：网络中断

**测试步骤：**

1. 开启飞行模式
2. 点击购买
3. 验��显示网络错误提示

#### 测试 4.3：重复购买

**测试步骤：**

1. 购买"领主通行证"
2. 尝试再次购买"探索者通行证"
3. 验证：应该升级或提示升级选项

---

## ✅ 验证清单

### 订阅功能验证

- [ ] 探索者通行证月付购买成功
- [ ] 领主通行证年付购买成功
- [ ] 末日通行证试用注册成功
- [ ] 价格显示正确（¥12, ¥25, ¥50）
- [ ] 年付价格显示正确（¥88, ¥168, ¥328）
- [ ] 购买后用户等级正确更新
- [ ] 权益正确激活（建造加速、背包容量等）
- [ ] 恢复购买功能正常
- [ ] 取消订阅功能正常
- [ ] 订阅状态正确显示

### 消耗品功能验证

- [ ] 幸存者补给包（¥6）购买成功
- [ ] 探险家补给包（¥18）购买成功
- [ ] 领主补给包（¥30）购买成功
- [ ] 霸主补给包（¥68）购买成功
- [ ] 购买确认对话框显示正确
- [ ] 物品正确发送到待领取
- [ ] 待领取角标数量正确
- [ ] 领取后物品正确进入背包
- [ ] 背包容量正确增加

### UI/UX 验证

- [ ] 价格显示本地化（¥符号）
- [ ] 订阅卡片设计一致
- [ ] 购买按钮状态正确（loading/enabled）
- [ ] 成功提示清晰友好
- [ ] 错误提示清晰有用
- [ ] "待领取"标签工作正常
- [ ] 补给包详情页显示完整内容
- [ ] 稀有度颜色标识正确

---

## 🔧 常见问题

### 问题 1：沙盒账号登录失败

**现象：**
```
无法验证 Apple ID
```

**解决方案：**
1. 确保在"设置 → iTunes Store 与 App Store"中登录
2. 不要在 App Store 应用中登录
3. 检查账号密码是否正确
4. 等待几分钟后重试

---

### 问题 2：无法加载产品

**现象：**
```
商城显示空状态
"未加载到任何产品"
```

**可能原因：**
1. App Store Connect 未配置产品
2. Product ID 不匹配
3. 沙盒账号未正确登录
4. 网络连接问题

**解决方案：**
1. 检查 App Store Connect 中产品配置
2. 验证代码中的 Product ID 是否与配置一致
3. 重新登录沙盒账号
4. 检查网络连接
5. 重启 App

---

### 问题 3：购买失败

**现象：**
```
购买时显示"无效的商品ID"
或"无法连接到App Store"
```

**解决方案：**
1. 检查 Bundle Identifier 是否匹配
2. 确保 Xcode 选择了正确的 Team
3. 在 App Store Connect 中验证产品状态
4. 等待产品生效（可能需要几分钟到几小时）
5. 清理项目并重新编译

---

### 问题 4：订阅状态不更新

**现象：**
购���成功但用户等级没有更新

**解决方案：**
1. 检查收据验证逻辑
2. 查看日志中的错误信息
3. 验证 Product ID 与 Tier 配置的对应关系
4. 重启 App

---

### 问题 5：试用期不生效

**现象：**
试用订阅立即扣费

**可能原因：**
1. 之前已经使用过试用
2. 沙盒环境试用限制
3. 产品配置错误

**解决方案：**
1. 使用新的沙盒账号
2. 检查试用配置是否正确
3. 确认试用期天数设置

---

### 问题 6：恢复购买无响应

**现象：**
点击恢复购买没有反应

**解决方案：**
1. 确保之前已成功购买
2. 检查网络连接
3. 验证 restoreCompletedTransactions 调用
4. 查看日志错误信息

---

## 📱 测试设备要求

### 最低要求

- iOS 15.0 或更高版本
- iPhone 7 或更新机型
- iPad (第6代) 或更新机型

### 推荐配置

- iOS 17.0 或更高版本
- iPhone 12 或更新机型
- 最新 Xcode 版本

### 不支持的场景

- ❌ 模拟器（StoreKit 不支持）
- ❌ 越狱设备
- ❌ 未登录沙盒账号的设备

---

## 🎯 测试最佳实践

### 1. 每次测试前

- [ ] 清理 App 数据（卸载重装）
- [ ] 确认沙盒账号已登录
- [ ] 检查网络连接
- [ ] 查看控制台日志

### 2. 测试过程中

- [ ] 逐步测试，不要跳过步骤
- [ ] 记录每次操作和结果
- [ ] 截图保存重要界面
- [ ] 记录错误信息

### 3. 测试完成后

- [ ] 整理测试结果
- [ ] 报告发现的问题
- [ ] 更新验证清单
- [ ] 归档测试截图

---

## 📊 测试报告模板

### 测试会话信息

```
测试日期：2026-02-25
测试人员：[姓名]
测试设备：iPhone 15 Pro, iOS 17.2
沙盒账号：test.earthlord+explorer@example.com
Xcode 版本：15.2
```

### 测试结果

```
✅ 探索者通行证月付 - 通过
✅ 领主通行证年付 - 通过
✅ 幸存者补给包 - 通过
⚠️ 恢复购买 - 部分问题
   问题描述：[详细描述]
   复现步骤：[步骤列表]
```

### 问题清单

| 优先级 | 问题描述 | 状态 |
|--------|----------|------|
| P0 | 购买后崩溃 | 待修复 |
| P1 | 价格显示错误 | 待修复 |
| P2 | UI 不对齐 | 已记录 |

---

## 🔗 相关资源

### Apple 官方文档

- [StoreKit Testing](https://developer.apple.com/documentation/storekit/testing_in-app_purchases)
- [Sandbox Testing](https://developer.apple.com/app-store/connect/sandbox/)
- [Managing Sandbox Testers](https://developer.apple.com/help/app-store-connect/manage-sandbox-testers)

### 项目文档

- `AppStoreConnectGuide.md` - App Store Connect 配置指南
- `SubscriptionProducts.swift` - 订阅产品定义
- `StoreManager.swift` - 购买管理器

---

## 📞 支持

如果遇到无法解决的问题：

1. 查看 Xcode 控制台日志
2. 检查 App Store Connect 配置
3. 参考 Apple 官方文档
4. 联系技术支持

---

**文档版本**: 1.0
**最后更新**: 2026-02-25
**下次审查**: 测试完成后更新
